<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plateforme d'Analyse - Inspecteurs Éducation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #9b59b6;
            --dark-color: #2c3e50;
            --light-color: #f5f5f5;
            --gray-color: #7f8c8d;
            --border-radius: 10px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-color);
            padding: 20px;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        /* Header */
        header {
            text-align: center;
            padding: 25px 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            position: relative;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .platform-name {
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        header h1 {
            color: white;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        /* Navigation */
        .tabs-container {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }

        .tabs {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            min-width: 800px;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-color);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .tab:hover {
            background-color: #e9ecef;
            color: var(--dark-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background-color: white;
        }

        /* Contenu des onglets */
        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        /* Section d'importation */
        .import-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            border: 2px dashed var(--primary-color);
            text-align: center;
        }

        .import-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .import-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .import-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
        }

        .import-card i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .import-card h3 {
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        .import-card p {
            color: var(--gray-color);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Onglets de type de fichier */
        .file-type-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .file-type-tab {
            padding: 10px 20px;
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-type-tab:hover {
            background: var(--primary-color);
            color: white;
        }

        .file-type-tab.active {
            background: var(--primary-color);
            color: white;
        }

        /* Boutons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--success-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #d68910;
            transform: translateY(-2px);
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
        }

        .btn-light {
            background-color: #f8f9fa;
            color: var(--dark-color);
            border: 1px solid #dee2e6;
        }

        .btn-light:hover {
            background-color: #e9ecef;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .btn-xs {
            padding: 5px 8px;
            font-size: 0.8rem;
        }

        /* Bouton Retour */
        .btn-return {
            background-color: white;
            color: var(--primary-color);
            border: 2px solid white;
        }

        .btn-return:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Sections de données */
        .data-section {
            margin-bottom: 30px;
            padding: 25px;
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .data-section h2 {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            margin: -25px -25px 25px -25px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        /* Tableaux */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .data-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .dashboard-card h3 {
            margin-bottom: 15px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
            position: relative;
        }

        /* Statistiques */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        /* Filtres */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
            padding: 15px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .search-box input {
            padding-left: 40px;
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        /* Onglets secondaires */
        .sub-tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 25px;
            overflow-x: auto;
        }

        .sub-tab {
            padding: 12px 25px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-color);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
        }

        .sub-tab:hover {
            color: var(--dark-color);
        }

        .sub-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 5px;
        }

        .badge-primary {
            background-color: #e3f2fd;
            color: var(--primary-color);
        }

        .badge-success {
            background-color: #e8f5e9;
            color: var(--success-color);
        }

        .badge-warning {
            background-color: #fff3e0;
            color: var(--warning-color);
        }

        .badge-danger {
            background-color: #ffebee;
            color: var(--danger-color);
        }

        .badge-info {
            background-color: #f3e5f5;
            color: var(--info-color);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success-color);
            color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        /* Loader */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }

        .loader.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-color);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 0;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .data-section {
                padding: 20px;
            }
            
            .import-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-bar {
                flex-direction: column;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .sub-tabs {
                flex-wrap: wrap;
            }
            
            .sub-tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .file-type-tabs {
                flex-direction: column;
            }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .header-actions {
                display: flex;
                gap: 10px;
                width: 100%;
                justify-content: space-between;
            }
        }

        /* Utilitaires */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-30 {
            margin-bottom: 30px;
        }

        .mt-30 {
            margin-top: 30px;
        }

        .d-flex {
            display: flex;
        }

        .align-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-10 {
            gap: 10px;
        }

        .gap-15 {
            gap: 15px;
        }

        .gap-20 {
            gap: 20px;
        }

        .w-100 {
            width: 100%;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Cartes enseignants */
        .teacher-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .teacher-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
            cursor: pointer;
        }

        .teacher-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .teacher-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .teacher-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .teacher-matricule {
            background: var(--primary-color);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .teacher-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .teacher-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray-color);
        }

        .teacher-info-item i {
            color: var(--primary-color);
        }

        /* Fichiers par type */
        .files-by-type {
            margin: 20px 0;
        }

        .file-type-group {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .file-list {
            margin-top: 10px;
            padding-left: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        /* Visualisation données */
        .data-preview {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }

        /* Header actions */
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle" id="notificationIcon"></i>
        <span id="notificationMessage"></span>
    </div>

    <!-- Container principal -->
    <div class="container">
        <header>
            <div class="header-content">
                <div class="platform-name">
                    <i class="fas fa-chart-line"></i>
                    <span>Plateforme d'Analyse - Inspecteurs Éducation</span>
                </div>
                <div class="header-actions">
                    <div class="user-info">
                        <i class="fas fa-user-shield"></i>
                        <span>Inspecteur - <span id="currentYear"></span></span>
                    </div>
                    <a href="index.html" class="btn btn-return">
                        <i class="fas fa-home"></i> Retour à l'accueil
                    </a>
                </div>
            </div>
            <h1><i class="fas fa-analytics"></i> ANALYSE DES FICHES ENSEIGNANTS</h1>
            <p>Importation, visualisation et analyse des données pédagogiques complètes</p>
        </header>

        <!-- Navigation principale -->
        <div class="tabs-container">
            <ul class="tabs">
                <li class="tab active" data-tab="tab-import">
                    <i class="fas fa-upload"></i> Importation
                </li>
                <li class="tab" data-tab="tab-dashboard">
                    <i class="fas fa-tachometer-alt"></i> Tableau de bord
                </li>
                <li class="tab" data-tab="tab-teachers">
                    <i class="fas fa-users"></i> Enseignants
                </li>
                <li class="tab" data-tab="tab-pedagogy">
                    <i class="fas fa-chalkboard-teacher"></i> Pédagogie
                </li>
                <li class="tab" data-tab="tab-training">
                    <i class="fas fa-graduation-cap"></i> Formation
                </li>
                <li class="tab" data-tab="tab-projects">
                    <i class="fas fa-project-diagram"></i> Projets
                </li>
                <li class="tab" data-tab="tab-retirement">
                    <i class="fas fa-umbrella-beach"></i> Retraite
                </li>
                <li class="tab" data-tab="tab-export">
                    <i class="fas fa-download"></i> Export Excel
                </li>
            </ul>
        </div>

        <!-- Onglet Importation -->
        <div id="tab-import" class="tab-content active">
            <div class="import-section">
                <h2><i class="fas fa-file-import"></i> IMPORTATION DES DONNÉES</h2>
                <p>Sélectionnez le type d'importation ou choisissez un type de fichier spécifique</p>
                
                <!-- Sélecteur de type de fichier -->
                <div class="file-type-tabs" id="fileTypeTabs">
                    <div class="file-type-tab active" data-file-type="all">
                        <i class="fas fa-file"></i> Tous les fichiers
                    </div>
                    <div class="file-type-tab" data-file-type="tab1">
                        <i class="fas fa-user-tie"></i> Informations Générales
                    </div>
                    <div class="file-type-tab" data-file-type="tab2">
                        <i class="fas fa-chalkboard-teacher"></i> Enseignement
                    </div>
                    <div class="file-type-tab" data-file-type="tab3">
                        <i class="fas fa-graduation-cap"></i> Formation
                    </div>
                    <div class="file-type-tab" data-file-type="tab4">
                        <i class="fas fa-chart-line"></i> Évaluations
                    </div>
                    <div class="file-type-tab" data-file-type="tab5">
                        <i class="fas fa-project-diagram"></i> Projets
                    </div>
                    <div class="file-type-tab" data-file-type="tab7">
                        <i class="fas fa-dashboard"></i> Dashboard
                    </div>
                </div>
                
                <div class="import-grid">
                    <!-- Import fichier unique -->
                    <div class="import-card">
                        <i class="fas fa-file-import"></i>
                        <h3>Import fichier unique</h3>
                        <p>Importez un fichier JSON spécifique (tab1, tab2, etc.)</p>
                        <div class="file-input-wrapper">
                            <button class="btn btn-primary" id="singleFileBtn">
                                <i class="fas fa-upload"></i> Choisir un fichier
                            </button>
                            <input type="file" id="singleFileInput" accept=".json" style="display: none;">
                        </div>
                    </div>

                    <!-- Import multiple -->
                    <div class="import-card">
                        <i class="fas fa-folder-open"></i>
                        <h3>Import multiple</h3>
                        <p>Importez tous les fichiers JSON d'un enseignant</p>
                        <div class="file-input-wrapper">
                            <button class="btn btn-secondary" id="multiFileBtn">
                                <i class="fas fa-folder-open"></i> Choisir des fichiers
                            </button>
                            <input type="file" id="multiFileInput" accept=".json" multiple style="display: none;">
                        </div>
                    </div>

                    <!-- Import dossier -->
                    <div class="import-card">
                        <i class="fas fa-database"></i>
                        <h3>Import complet</h3>
                        <p>Importez un fichier JSON complet (export total)</p>
                        <div class="file-input-wrapper">
                            <button class="btn btn-info" id="completeFileBtn">
                                <i class="fas fa-database"></i> Choisir un fichier
                            </button>
                            <input type="file" id="completeFileInput" accept=".json" style="display: none;">
                        </div>
                    </div>
                </div>

                <!-- Liste des fichiers importés par type -->
                <div class="data-section mt-30" id="importedFilesSection" style="display: none;">
                    <h2><i class="fas fa-list-check"></i> FICHIERS IMPORTÉS PAR TYPE</h2>
                    <div id="importedFilesList"></div>
                </div>

                <!-- Vue d'ensemble -->
                <div class="data-section mt-30" id="overviewSection" style="display: none;">
                    <h2><i class="fas fa-eye"></i> VUE D'ENSEMBLE</h2>
                    <div class="stats-grid" id="overviewStats"></div>
                </div>

                <!-- Visualisation des données -->
                <div class="data-section mt-30" id="dataPreviewSection" style="display: none;">
                    <h2><i class="fas fa-eye"></i> VISUALISATION DES DONNÉES</h2>
                    <select id="dataPreviewSelect" class="w-100 mb-20" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Sélectionner un enseignant pour prévisualiser...</option>
                    </select>
                    <div id="dataPreviewContent"></div>
                </div>
            </div>
        </div>

        <!-- Onglet Tableau de bord -->
        <div id="tab-dashboard" class="tab-content">
            <div class="filter-bar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Rechercher un enseignant..." id="dashboardSearch">
                </div>
                <select id="dashboardFilterSubject">
                    <option value="">Toutes les matières</option>
                </select>
                <select id="dashboardFilterCategory">
                    <option value="">Toutes les catégories</option>
                </select>
                <select id="dashboardFilterEstablishment">
                    <option value="">Tous les établissements</option>
                </select>
            </div>

            <!-- Statistiques globales -->
            <div class="data-section">
                <h2><i class="fas fa-chart-bar"></i> STATISTIQUES GLOBALES</h2>
                <div class="stats-grid" id="globalStats"></div>
            </div>

            <!-- Graphiques -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-pie"></i> Répartition par matière</h3>
                    <div class="chart-container">
                        <canvas id="subjectChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-line"></i> Évolution des retraites</h3>
                    <div class="chart-container">
                        <canvas id="retirementChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-bar"></i> Heures d'enseignement</h3>
                    <div class="chart-container">
                        <canvas id="hoursChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-graduation-cap"></i> Niveau de formation</h3>
                    <div class="chart-container">
                        <canvas id="trainingChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Dernières activités -->
            <div class="data-section">
                <h2><i class="fas fa-history"></i> DERNIÈRES ACTIVITÉS PÉDAGOGIQUES</h2>
                <div id="recentActivities"></div>
            </div>
        </div>

        <!-- Onglet Enseignants -->
        <div id="tab-teachers" class="tab-content">
            <div class="filter-bar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Rechercher par nom, matricule..." id="teacherSearch">
                </div>
                <button class="btn btn-light" onclick="sortTeachers('name')">
                    <i class="fas fa-sort-alpha-down"></i> Trier par nom
                </button>
                <button class="btn btn-light" onclick="sortTeachers('retirement')">
                    <i class="fas fa-calendar"></i> Trier par retraite
                </button>
                <button class="btn btn-light" onclick="filterCompleteOnly()">
                    <i class="fas fa-check-circle"></i> Fiches complètes
                </button>
            </div>

            <!-- Liste des enseignants -->
            <div id="teachersListContainer">
                <div class="teacher-cards" id="teachersCards"></div>
            </div>

            <!-- Détails enseignant (modal) -->
            <div class="modal" id="teacherDetailModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="teacherModalTitle"></h3>
                        <button class="modal-close" onclick="closeTeacherDetail()">&times;</button>
                    </div>
                    <div id="teacherModalContent"></div>
                </div>
            </div>
        </div>

        <!-- Onglet Pédagogie -->
        <div id="tab-pedagogy" class="tab-content">
            <!-- Sous-onglets pédagogie -->
            <div class="sub-tabs">
                <div class="sub-tab active" data-subtab="pedagogy-overview">Vue d'ensemble</div>
                <div class="sub-tab" data-subtab="pedagogy-subjects">Matières enseignées</div>
                <div class="sub-tab" data-subtab="pedagogy-timetable">Emplois du temps</div>
                <div class="sub-tab" data-subtab="pedagogy-lessons">Leçons</div>
                <div class="sub-tab" data-subtab="pedagogy-tp">Travaux pratiques</div>
                <div class="sub-tab" data-subtab="pedagogy-resources">Ressources</div>
            </div>

            <!-- Sous-contenus -->
            <div class="sub-tab-content active" data-subtab="pedagogy-overview">
                <div class="data-section">
                    <h2><i class="fas fa-chart-bar"></i> STATISTIQUES PÉDAGOGIQUES</h2>
                    <div id="pedagogyStats"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="pedagogy-subjects">
                <div class="data-section">
                    <h2><i class="fas fa-book"></i> MATIÈRES ENSEIGNÉES</h2>
                    <div id="subjectsAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="pedagogy-timetable">
                <div class="data-section">
                    <h2><i class="fas fa-calendar-alt"></i> EMPLOIS DU TEMPS</h2>
                    <div id="timetableAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="pedagogy-lessons">
                <div class="data-section">
                    <h2><i class="fas fa-chalkboard"></i> LEÇONS ENREGISTRÉES</h2>
                    <div id="lessonsAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="pedagogy-tp">
                <div class="data-section">
                    <h2><i class="fas fa-flask"></i> TRAVAUX PRATIQUES</h2>
                    <div id="tpAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="pedagogy-resources">
                <div class="data-section">
                    <h2><i class="fas fa-folder-open"></i> RESSOURCES PÉDAGOGIQUES</h2>
                    <div id="resourcesAnalysis"></div>
                </div>
            </div>
        </div>

        <!-- Onglet Formation -->
        <div id="tab-training" class="tab-content">
            <!-- Sous-onglets formation -->
            <div class="sub-tabs">
                <div class="sub-tab active" data-subtab="training-overview">Vue d'ensemble</div>
                <div class="sub-tab" data-subtab="training-diplomas">Diplômes</div>
                <div class="sub-tab" data-subtab="training-continuous">Formations continues</div>
                <div class="sub-tab" data-subtab="training-languages">Compétences linguistiques</div>
                <div class="sub-tab" data-subtab="training-it">Compétences informatiques</div>
            </div>

            <!-- Sous-contenus -->
            <div class="sub-tab-content active" data-subtab="training-overview">
                <div class="data-section">
                    <h2><i class="fas fa-graduation-cap"></i> STATISTIQUES DE FORMATION</h2>
                    <div id="trainingStats"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="training-diplomas">
                <div class="data-section">
                    <h2><i class="fas fa-award"></i> DIPLÔMES ACADÉMIQUES ET PROFESSIONNELS</h2>
                    <div id="diplomasAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="training-continuous">
                <div class="data-section">
                    <h2><i class="fas fa-chalkboard-teacher"></i> FORMATIONS CONTINUES</h2>
                    <div id="continuousTrainingAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="training-languages">
                <div class="data-section">
                    <h2><i class="fas fa-language"></i> COMPÉTENCES LINGUISTIQUES</h2>
                    <div id="languagesAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="training-it">
                <div class="data-section">
                    <h2><i class="fas fa-laptop-code"></i> COMPÉTENCES INFORMATIQUES</h2>
                    <div id="itSkillsAnalysis"></div>
                </div>
            </div>
        </div>

        <!-- Onglet Projets -->
        <div id="tab-projects" class="tab-content">
            <!-- Sous-onglets projets -->
            <div class="sub-tabs">
                <div class="sub-tab active" data-subtab="projects-overview">Vue d'ensemble</div>
                <div class="sub-tab" data-subtab="projects-pedagogical">Projets pédagogiques</div>
                <div class="sub-tab" data-subtab="projects-activities">Activités extrascolaires</div>
                <div class="sub-tab" data-subtab="projects-meetings">Réunions</div>
            </div>

            <!-- Sous-contenus -->
            <div class="sub-tab-content active" data-subtab="projects-overview">
                <div class="data-section">
                    <h2><i class="fas fa-project-diagram"></i> STATISTIQUES DES PROJETS</h2>
                    <div id="projectsStats"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="projects-pedagogical">
                <div class="data-section">
                    <h2><i class="fas fa-project-diagram"></i> PROJETS PÉDAGOGIQUES</h2>
                    <div id="pedagogicalProjectsAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="projects-activities">
                <div class="data-section">
                    <h2><i class="fas fa-futbol"></i> ACTIVITÉS EXTRASCOLAIRES</h2>
                    <div id="activitiesAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="projects-meetings">
                <div class="data-section">
                    <h2><i class="fas fa-users"></i> RÉUNIONS ET CONSEILS</h2>
                    <div id="meetingsAnalysis"></div>
                </div>
            </div>
        </div>

        <!-- Onglet Retraite -->
        <div id="tab-retirement" class="tab-content">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3><i class="fas fa-calendar-times"></i> Prochaines retraites</h3>
                    <div id="upcomingRetirements"></div>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-bar"></i> Répartition par année</h3>
                    <div class="chart-container">
                        <canvas id="retirementYearChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="data-section">
                <h2><i class="fas fa-table"></i> TABLEAU DES RETRAITES</h2>
                <div id="retirementTable"></div>
            </div>

            <!-- Analyse de la retraite -->
            <div class="data-section">
                <h2><i class="fas fa-chart-pie"></i> ANALYSE PAR CATÉGORIE</h2>
                <div class="stats-grid" id="retirementAnalysis"></div>
            </div>
        </div>

        <!-- Onglet Export Excel -->
        <div id="tab-export" class="tab-content">
            <div class="import-section">
                <h2><i class="fas fa-file-excel"></i> EXPORT EXCEL</h2>
                <p>Exportez toutes les données analysées au format Excel</p>

                <div class="export-options">
                    <button class="btn btn-success" onclick="exportAllToExcel()">
                        <i class="fas fa-file-excel"></i> Export complet
                    </button>
                    <button class="btn btn-primary" onclick="exportTeachersToExcel()">
                        <i class="fas fa-users"></i> Liste enseignants
                    </button>
                    <button class="btn btn-info" onclick="exportPedagogyToExcel()">
                        <i class="fas fa-chalkboard-teacher"></i> Données pédagogiques
                    </button>
                    <button class="btn btn-warning" onclick="exportTrainingToExcel()">
                        <i class="fas fa-graduation-cap"></i> Données formation
                    </button>
                    <button class="btn btn-secondary" onclick="exportRetirementToExcel()">
                        <i class="fas fa-umbrella-beach"></i> Planification retraite
                    </button>
                    <button class="btn btn-secondary" onclick="exportProjectsToExcel()">
                        <i class="fas fa-project-diagram"></i> Projets et activités
                    </button>
                </div>

                <!-- Aperçu des données à exporter -->
                <div class="data-section mt-30">
                    <h2><i class="fas fa-eye"></i> APERÇU DES DONNÉES À EXPORTER</h2>
                    <div id="exportPreview"></div>
                </div>

                <!-- Options d'export -->
                <div class="data-section mt-20">
                    <h2><i class="fas fa-cog"></i> OPTIONS D'EXPORT</h2>
                    <div class="filter-bar">
                        <select id="exportFilterEstablishment" class="w-100">
                            <option value="">Tous les établissements</option>
                        </select>
                        <select id="exportFilterSubject" class="w-100">
                            <option value="">Toutes les matières</option>
                        </select>
                        <select id="exportFilterCategory" class="w-100">
                            <option value="">Toutes les catégories</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions globales -->
        <div class="filter-bar" style="margin-top: 30px;">
            <a href="index.html" class="btn btn-light">
                <i class="fas fa-home"></i> Retour à l'accueil
            </a>
            <button class="btn btn-light" onclick="clearAllData()">
                <i class="fas fa-trash"></i> Effacer toutes les données
            </button>
            <button class="btn btn-info" onclick="generateReport()">
                <i class="fas fa-file-pdf"></i> Générer rapport
            </button>
            <button class="btn btn-primary" onclick="saveSession()">
                <i class="fas fa-save"></i> Sauvegarder la session
            </button>
            <button class="btn btn-secondary" onclick="backupData()">
                <i class="fas fa-download"></i> Exporter session
            </button>
        </div>
    </div>

    <script>
        // Variables globales
        let teachersData = [];
        let currentTeacherIndex = -1;
        let charts = {};
        let filteredTeachers = [];
        let currentFileType = 'all';

        // Types de fichiers supportés
        const FILE_TYPES = {
            'tab1': {
                name: 'Informations Générales',
                icon: 'fa-user-tie',
                description: 'Données personnelles, professionnelles et établissement'
            },
            'tab2': {
                name: 'Enseignement & Pédagogie',
                icon: 'fa-chalkboard-teacher',
                description: 'Planning, thèmes, leçons, TP, ressources'
            },
            'tab3': {
                name: 'Formation & Compétences',
                icon: 'fa-graduation-cap',
                description: 'Diplômes, formations, langues, compétences IT'
            },
            'tab4': {
                name: 'Évaluations & Statistiques',
                icon: 'fa-chart-line',
                description: 'Évaluations, performances, statistiques'
            },
            'tab5': {
                name: 'Projets & Activités',
                icon: 'fa-project-diagram',
                description: 'Projets pédagogiques, activités, réunions'
            },
            'tab6': {
                name: 'Données & Archives',
                icon: 'fa-database',
                description: 'Sauvegardes, logs, données techniques'
            },
            'tab7': {
                name: 'Tableau de bord',
                icon: 'fa-tachometer-alt',
                description: 'Statistiques, synthèses, rapports'
            },
            'complete': {
                name: 'Fichier complet',
                icon: 'fa-database',
                description: 'Toutes les données en un seul fichier'
            }
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            // Initialiser l'année
            const currentYear = new Date().getFullYear();
            document.getElementById('currentYear').textContent = currentYear;
            
            // Gestion des onglets
            initTabs();
            
            // Gestion des sous-onglets
            initSubTabs();
            
            // Gestion des types de fichiers
            initFileTypeTabs();
            
            // Initialiser les événements des boutons
            initButtons();
            
            // Charger les données de session
            loadSessionData();
            
            // Initialiser les événements
            initEvents();
            
            showNotification('Plateforme d\'analyse prête', 'success');
        }

        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
        }

        function initSubTabs() {
            const subTabs = document.querySelectorAll('.sub-tab');
            subTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const subtabId = this.getAttribute('data-subtab');
                    switchSubTab(subtabId);
                });
            });
        }

        function initFileTypeTabs() {
            const fileTypeTabs = document.querySelectorAll('.file-type-tab');
            fileTypeTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const fileType = this.getAttribute('data-file-type');
                    switchFileTypeTab(fileType);
                });
            });
        }

        function initButtons() {
            // Boutons d'importation
            document.getElementById('singleFileBtn').addEventListener('click', function() {
                document.getElementById('singleFileInput').click();
            });
            
            document.getElementById('multiFileBtn').addEventListener('click', function() {
                document.getElementById('multiFileInput').click();
            });
            
            document.getElementById('completeFileBtn').addEventListener('click', function() {
                document.getElementById('completeFileInput').click();
            });
            
            // Gestion des inputs de fichiers
            document.getElementById('singleFileInput').addEventListener('change', handleSingleFileImport);
            document.getElementById('multiFileInput').addEventListener('change', handleMultiFileImport);
            document.getElementById('completeFileInput').addEventListener('change', handleCompleteFileImport);
        }

        function switchTab(tabId) {
            // Désactiver tous les onglets
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Activer l'onglet sélectionné
            const tabElement = document.querySelector(`[data-tab="${tabId}"]`);
            const tabContent = document.getElementById(tabId);
            
            if (tabElement) tabElement.classList.add('active');
            if (tabContent) tabContent.classList.add('active');
            
            // Mettre à jour l'interface spécifique
            updateTabUI(tabId);
        }

        function switchSubTab(subtabId) {
            // Désactiver tous les sous-onglets
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
            
            // Activer le sous-onglet sélectionné
            const subTabElement = document.querySelector(`.sub-tab[data-subtab="${subtabId}"]`);
            const subTabContent = document.querySelector(`.sub-tab-content[data-subtab="${subtabId}"]`);
            
            if (subTabElement) subTabElement.classList.add('active');
            if (subTabContent) subTabContent.classList.add('active');
            
            // Mettre à jour le contenu spécifique
            updateSubTabUI(subtabId);
        }

        function switchFileTypeTab(fileType) {
            // Désactiver tous les onglets de type de fichier
            document.querySelectorAll('.file-type-tab').forEach(t => t.classList.remove('active'));
            
            // Activer l'onglet sélectionné
            const tabElement = document.querySelector(`[data-file-type="${fileType}"]`);
            if (tabElement) tabElement.classList.add('active');
            
            currentFileType = fileType;
        }

        function initEvents() {
            // Recherche
            const dashboardSearch = document.getElementById('dashboardSearch');
            if (dashboardSearch) {
                dashboardSearch.addEventListener('input', filterDashboard);
            }
            
            const teacherSearch = document.getElementById('teacherSearch');
            if (teacherSearch) {
                teacherSearch.addEventListener('input', filterTeachers);
            }
            
            // Prévisualisation des données
            const dataPreviewSelect = document.getElementById('dataPreviewSelect');
            if (dataPreviewSelect) {
                dataPreviewSelect.addEventListener('change', function() {
                    previewTeacherData(this.value);
                });
            }
            
            // Filtres dashboard
            const subjectFilter = document.getElementById('dashboardFilterSubject');
            const categoryFilter = document.getElementById('dashboardFilterCategory');
            const establishmentFilter = document.getElementById('dashboardFilterEstablishment');
            
            if (subjectFilter) subjectFilter.addEventListener('change', filterDashboard);
            if (categoryFilter) categoryFilter.addEventListener('change', filterDashboard);
            if (establishmentFilter) establishmentFilter.addEventListener('change', filterDashboard);
        }

        // Gestion de l'importation
        function handleSingleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoader(true);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const fileType = detectFileTypeFromContent(data, file.name);
                    const teacherInfo = extractTeacherInfo(data);
                    
                    // Vérifier si l'enseignant existe déjà
                    let teacherIndex = findTeacherIndex(teacherInfo);
                    
                    if (teacherIndex === -1) {
                        // Créer un nouvel enseignant
                        const newTeacher = createNewTeacher(teacherInfo, file, data, fileType);
                        teachersData.push(newTeacher);
                        teacherIndex = teachersData.length - 1;
                    } else {
                        // Ajouter le fichier à l'enseignant existant
                        addFileToTeacher(teacherIndex, file, data, fileType);
                    }
                    
                    // Mettre à jour l'interface
                    updateUIAfterImport();
                    showNotification(`Fichier ${file.name} importé avec succès (${FILE_TYPES[fileType]?.name || fileType})`, 'success');
                    
                } catch (error) {
                    showNotification('Erreur lors de l\'importation du fichier', 'error');
                    console.error('Erreur d\'importation:', error);
                } finally {
                    showLoader(false);
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function handleMultiFileImport(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            showLoader(true);
            let importedCount = 0;
            const totalFiles = files.length;
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        const fileType = detectFileTypeFromContent(data, file.name);
                        const teacherInfo = extractTeacherInfo(data);
                        
                        let teacherIndex = findTeacherIndex(teacherInfo);
                        
                        if (teacherIndex === -1) {
                            const newTeacher = createNewTeacher(teacherInfo, file, data, fileType);
                            teachersData.push(newTeacher);
                        } else {
                            addFileToTeacher(teacherIndex, file, data, fileType);
                        }
                        
                        importedCount++;
                        
                        if (importedCount === totalFiles) {
                            updateUIAfterImport();
                            showNotification(`${files.length} fichiers importés avec succès`, 'success');
                            showLoader(false);
                        }
                        
                    } catch (error) {
                        console.error(`Erreur avec le fichier ${file.name}:`, error);
                        importedCount++;
                        
                        if (importedCount === totalFiles) {
                            updateUIAfterImport();
                            showNotification('Importation terminée avec quelques erreurs', 'warning');
                            showLoader(false);
                        }
                    }
                };
                reader.readAsText(file);
            });
            
            // Réinitialiser l'input
            event.target.value = '';
        }

        function handleCompleteFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoader(true);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const teacherInfo = extractTeacherInfo(data);
                    
                    // Créer un enseignant avec toutes les données
                    const newTeacher = {
                        id: Date.now(),
                        ...teacherInfo,
                        files: [{
                            name: file.name,
                            type: 'complete',
                            data: data,
                            importDate: new Date().toISOString()
                        }],
                        complete: true,
                        data: data
                    };
                    
                    // Calculer les statistiques
                    calculateTeacherStatistics(newTeacher);
                    
                    teachersData.push(newTeacher);
                    
                    // Mettre à jour l'interface
                    updateUIAfterImport();
                    showNotification(`Fichier complet importé avec succès`, 'success');
                    
                } catch (error) {
                    showNotification('Erreur lors de l\'importation du fichier complet', 'error');
                    console.error(error);
                } finally {
                    showLoader(false);
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function detectFileTypeFromContent(data, fileName) {
            // Essayer de détecter le type à partir du contenu
            if (fileName.includes('tab1') || fileName.includes('informations')) return 'tab1';
            if (fileName.includes('tab2') || fileName.includes('enseignement') || fileName.includes('pédagogie')) return 'tab2';
            if (fileName.includes('tab3') || fileName.includes('formation')) return 'tab3';
            if (fileName.includes('tab4') || fileName.includes('évaluation')) return 'tab4';
            if (fileName.includes('tab5') || fileName.includes('projet')) return 'tab5';
            if (fileName.includes('tab6') || fileName.includes('données')) return 'tab6';
            if (fileName.includes('tab7') || fileName.includes('dashboard')) return 'tab7';
            if (fileName.includes('complete')) return 'complete';
            
            // Détection basée sur la structure des données
            if (data.establishment && data.personal && data.professional) return 'tab1';
            if (data.themes || data.lessons || data.tps || data.timetable) return 'tab2';
            if (data.diplomas || data.trainings || data.languages || data.itskills) return 'tab3';
            if (data.evaluations || data.statistics) return 'tab4';
            if (data.projects || data.activities || data.meetings) return 'tab5';
            if (data.backups || data.logs) return 'tab6';
            if (data.dashboard || data.summary) return 'tab7';
            
            return 'unknown';
        }

        function extractTeacherInfo(data) {
            let lastName = '';
            let firstName = '';
            let matricule = '';
            let establishment = '';
            
            // Essayer différentes structures de données
            if (data.personal) {
                lastName = data.personal.lastName || '';
                firstName = data.personal.firstName || '';
                matricule = data.professional?.matricule || '';
                establishment = data.establishment?.name || '';
            } else if (data.lastName) {
                lastName = data.lastName;
                firstName = data.firstName || '';
            } else if (data.teacher) {
                lastName = data.teacher.lastName || '';
                firstName = data.teacher.firstName || '';
            }
            
            // Si pas de nom, utiliser des valeurs par défaut
            if (!lastName) {
                lastName = 'Enseignant';
                firstName = 'Non spécifié';
            }
            
            return {
                lastName,
                firstName,
                matricule,
                establishment,
                fullName: `${lastName} ${firstName}`.trim()
            };
        }

        function findTeacherIndex(teacherInfo) {
            return teachersData.findIndex(t => 
                t.lastName === teacherInfo.lastName && 
                t.firstName === teacherInfo.firstName
            );
        }

        function createNewTeacher(teacherInfo, file, data, fileType) {
            const newTeacher = {
                id: Date.now(),
                ...teacherInfo,
                files: [{
                    name: file.name,
                    type: fileType,
                    data: data,
                    importDate: new Date().toISOString()
                }],
                complete: false
            };
            
            // Traiter les données selon le type
            processTeacherData(newTeacher, data, fileType);
            
            return newTeacher;
        }

        function addFileToTeacher(teacherIndex, file, data, fileType) {
            const teacher = teachersData[teacherIndex];
            
            // Vérifier si ce type de fichier existe déjà
            const existingFileIndex = teacher.files.findIndex(f => f.type === fileType);
            
            if (existingFileIndex === -1) {
                // Ajouter le nouveau fichier
                teacher.files.push({
                    name: file.name,
                    type: fileType,
                    data: data,
                    importDate: new Date().toISOString()
                });
            } else {
                // Mettre à jour le fichier existant
                teacher.files[existingFileIndex] = {
                    name: file.name,
                    type: fileType,
                    data: data,
                    importDate: new Date().toISOString()
                };
            }
            
            // Traiter les données
            processTeacherData(teacher, data, fileType);
            
            // Vérifier la complétude
            checkTeacherCompleteness(teacherIndex);
        }

        function processTeacherData(teacher, data, fileType) {
            // Initialiser l'objet data si nécessaire
            if (!teacher.data) {
                teacher.data = {};
            }
            
            // Fusionner les données selon le type
            switch(fileType) {
                case 'tab1':
                    teacher.data.establishment = data.establishment || {};
                    teacher.data.personal = data.personal || {};
                    teacher.data.professional = data.professional || {};
                    teacher.data.subjects = data.subjects || [];
                    break;
                    
                case 'tab2':
                    // Gestion des sous-onglets de tab2
                    if (data.timetable) teacher.data.timetable = data.timetable;
                    if (data.themes) teacher.data.themes = data.themes;
                    if (data.lessons) teacher.data.lessons = data.lessons;
                    if (data.tps) teacher.data.tps = data.tps;
                    if (data.resources) teacher.data.resources = data.resources;
                    break;
                    
                case 'tab3':
                    teacher.data.diplomas = data.diplomas || [];
                    teacher.data.trainings = data.trainings || [];
                    teacher.data.languages = data.languages || [];
                    teacher.data.itskills = data.itskills || [];
                    break;
                    
                case 'tab4':
                    teacher.data.evaluations = data.evaluations || [];
                    teacher.data.statistics = data.statistics || {};
                    break;
                    
                case 'tab5':
                    teacher.data.projects = data.projects || [];
                    teacher.data.activities = data.activities || [];
                    teacher.data.meetings = data.meetings || [];
                    break;
                    
                case 'complete':
                    // Fusionner toutes les données
                    Object.assign(teacher.data, data);
                    break;
            }
            
            // Recalculer les statistiques
            calculateTeacherStatistics(teacher);
        }

        function checkTeacherCompleteness(teacherIndex) {
            const teacher = teachersData[teacherIndex];
            if (!teacher) return;
            
            const fileTypes = teacher.files.map(f => f.type);
            const requiredTypes = ['tab1', 'tab2', 'tab3'];
            const hasAllRequired = requiredTypes.every(type => fileTypes.includes(type));
            
            teacher.complete = hasAllRequired;
            
            if (teacher.complete) {
                showNotification(`${teacher.fullName} - Fiche maintenant complète`, 'success');
            }
        }

        function calculateTeacherStatistics(teacher) {
            if (!teacher.data) return;
            
            // Âge
            if (teacher.data.personal && teacher.data.personal.birthDate) {
                teacher.age = calculateAge(teacher.data.personal.birthDate);
            }
            
            // Années de service
            if (teacher.data.professional && teacher.data.professional.engagementDate) {
                teacher.serviceYears = calculateServiceYears(teacher.data.professional.engagementDate);
            }
            
            // Années avant retraite
            if (teacher.data.professional && teacher.data.professional.retirementDate) {
                teacher.yearsToRetirement = calculateYearsToDate(teacher.data.professional.retirementDate);
            }
            
            // Nombre de matières
            if (teacher.data.subjects) {
                teacher.subjectCount = teacher.data.subjects.length;
            }
            
            // Nombre de leçons
            if (teacher.data.lessons) {
                teacher.lessonCount = teacher.data.lessons.length;
            }
            
            // Nombre de TP
            if (teacher.data.tps) {
                teacher.tpCount = teacher.data.tps.length;
            }
            
            // Nombre d'évaluations
            if (teacher.data.evaluations) {
                teacher.evaluationCount = teacher.data.evaluations.length;
            }
            
            // Nombre de projets
            if (teacher.data.projects) {
                teacher.projectCount = teacher.data.projects.length;
            }
            
            // Nombre de formations
            if (teacher.data.trainings) {
                teacher.trainingCount = teacher.data.trainings.length;
            }
        }

        function calculateAge(birthDate) {
            if (!birthDate) return null;
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        function calculateServiceYears(startDate) {
            if (!startDate) return null;
            const start = new Date(startDate);
            const today = new Date();
            let years = today.getFullYear() - start.getFullYear();
            const monthDiff = today.getMonth() - start.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < start.getDate())) {
                years--;
            }
            
            return Math.max(years, 0);
        }

        function calculateYearsToDate(futureDate) {
            if (!futureDate) return null;
            const future = new Date(futureDate);
            const today = new Date();
            let years = future.getFullYear() - today.getFullYear();
            const monthDiff = future.getMonth() - today.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && future.getDate() < today.getDate())) {
                years--;
            }
            
            return Math.max(years, 0);
        }

        function updateUIAfterImport() {
            updateImportedFilesList();
            updateOverview();
            updateDataPreviewSelect();
            updateDashboard();
            updateTeachersList();
        }

        function updateImportedFilesList() {
            const container = document.getElementById('importedFilesList');
            const section = document.getElementById('importedFilesSection');
            
            if (!container || !section) return;
            
            if (teachersData.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            // Grouper les fichiers par type
            const filesByType = {};
            Object.keys(FILE_TYPES).forEach(type => {
                filesByType[type] = [];
            });
            
            teachersData.forEach(teacher => {
                teacher.files.forEach(file => {
                    if (filesByType[file.type]) {
                        filesByType[file.type].push({
                            teacher: teacher.fullName,
                            fileName: file.name,
                            date: file.importDate
                        });
                    }
                });
            });
            
            let html = '';
            
            Object.keys(FILE_TYPES).forEach(type => {
                const files = filesByType[type];
                if (files.length > 0) {
                    html += `
                        <div class="file-type-group">
                            <h4><i class="fas ${FILE_TYPES[type].icon}"></i> ${FILE_TYPES[type].name} (${files.length})</h4>
                            <div class="file-list">
                    `;
                    
                    files.forEach(file => {
                        const date = new Date(file.date).toLocaleDateString();
                        html += `
                            <div class="file-item">
                                <span><strong>${file.teacher}</strong> - ${file.fileName}</span>
                                <span class="badge badge-primary">${date}</span>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }

        function updateOverview() {
            const container = document.getElementById('overviewStats');
            const section = document.getElementById('overviewSection');
            
            if (!container || !section) return;
            
            if (teachersData.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            const totalTeachers = teachersData.length;
            const completeTeachers = teachersData.filter(t => t.complete).length;
            const totalFiles = teachersData.reduce((sum, t) => sum + t.files.length, 0);
            
            const subjectSet = new Set();
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.subjects) {
                    teacher.data.subjects.forEach(subject => {
                        if (subject && subject.name) subjectSet.add(subject.name);
                    });
                }
            });
            
            const uniqueSubjects = subjectSet.size;
            
            const html = `
                <div class="stat-card">
                    <div><i class="fas fa-users"></i> Enseignants</div>
                    <div class="stat-value">${totalTeachers}</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-check-circle"></i> Fiches complètes</div>
                    <div class="stat-value">${completeTeachers}</div>
                    <div>${Math.round((completeTeachers / totalTeachers) * 100)}%</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-file"></i> Fichiers</div>
                    <div class="stat-value">${totalFiles}</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-book"></i> Matières</div>
                    <div class="stat-value">${uniqueSubjects}</div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function updateDataPreviewSelect() {
            const container = document.getElementById('dataPreviewSelect');
            const section = document.getElementById('dataPreviewSection');
            
            if (!container || !section) return;
            
            if (teachersData.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            let html = '<option value="">Sélectionner un enseignant...</option>';
            
            teachersData.forEach((teacher, index) => {
                const fileTypes = teacher.files.map(f => FILE_TYPES[f.type]?.name || f.type).join(', ');
                html += `<option value="${index}">${teacher.fullName} - ${teacher.files.length} fichiers (${fileTypes})</option>`;
            });
            
            container.innerHTML = html;
        }

        function previewTeacherData(teacherIndex) {
            const container = document.getElementById('dataPreviewContent');
            if (!container) return;
            
            if (!teacherIndex) {
                container.innerHTML = '<p class="text-center">Sélectionnez un enseignant</p>';
                return;
            }
            
            const teacher = teachersData[teacherIndex];
            if (!teacher) return;
            
            let html = `
                <h4>${teacher.fullName}</h4>
                <div class="files-by-type">
            `;
            
            // Afficher les données par type de fichier
            teacher.files.forEach(file => {
                const fileTypeInfo = FILE_TYPES[file.type] || { name: file.type, icon: 'fa-file' };
                
                html += `
                    <div class="file-type-group">
                        <h5><i class="fas ${fileTypeInfo.icon}"></i> ${fileTypeInfo.name}</h5>
                        <div class="data-preview">
                `;
                
                // Afficher un aperçu des données
                const previewData = getDataPreview(file.data, file.type);
                html += JSON.stringify(previewData, null, 2);
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function getDataPreview(data, type) {
            // Créer un aperçu limité des données
            const preview = {};
            
            switch(type) {
                case 'tab1':
                    preview.establishment = data.establishment?.name || 'Non spécifié';
                    preview.personal = {
                        nom: data.personal?.lastName,
                        prenom: data.personal?.firstName,
                        age: calculateAge(data.personal?.birthDate)
                    };
                    preview.professional = {
                        matricule: data.professional?.matricule,
                        fonction: data.professional?.position,
                        categorie: data.professional?.professionalCategory
                    };
                    preview.subjects = data.subjects?.length || 0;
                    break;
                    
                case 'tab2':
                    preview.timetable = data.timetable ? 'Disponible' : 'Non disponible';
                    preview.themes = data.themes ? Object.keys(data.themes).length + ' thèmes' : 'Non disponible';
                    preview.lessons = data.lessons?.length || 0;
                    preview.tps = data.tps?.length || 0;
                    preview.resources = data.resources?.length || 0;
                    break;
                    
                case 'tab3':
                    preview.diplomas = data.diplomas?.length || 0;
                    preview.trainings = data.trainings?.length || 0;
                    preview.languages = data.languages?.length || 0;
                    preview.itskills = data.itskills?.length || 0;
                    break;
                    
                case 'tab4':
                    preview.evaluations = data.evaluations?.length || 0;
                    preview.statistics = data.statistics || 'Non disponible';
                    break;
                    
                case 'tab5':
                    preview.projects = data.projects?.length || 0;
                    preview.activities = data.activities?.length || 0;
                    preview.meetings = data.meetings?.length || 0;
                    break;
                    
                default:
                    preview.type = type;
                    preview.keys = Object.keys(data).slice(0, 5);
            }
            
            return preview;
        }

        function updateTabUI(tabId) {
            switch(tabId) {
                case 'tab-dashboard':
                    updateDashboard();
                    break;
                case 'tab-teachers':
                    updateTeachersList();
                    break;
                case 'tab-pedagogy':
                    updatePedagogyAnalysis();
                    break;
                case 'tab-training':
                    updateTrainingAnalysis();
                    break;
                case 'tab-projects':
                    updateProjectsAnalysis();
                    break;
                case 'tab-retirement':
                    updateRetirementAnalysis();
                    break;
                case 'tab-export':
                    updateExportPreview();
                    break;
            }
        }

        function updateSubTabUI(subtabId) {
            // Implémenter la mise à jour pour chaque sous-onglet
            switch(subtabId) {
                case 'pedagogy-overview':
                    updatePedagogyStats();
                    break;
                case 'pedagogy-subjects':
                    updateSubjectsAnalysis();
                    break;
                case 'pedagogy-timetable':
                    updateTimetableAnalysis();
                    break;
                case 'pedagogy-lessons':
                    updateLessonsAnalysis();
                    break;
                case 'pedagogy-tp':
                    updateTPAnalysis();
                    break;
                case 'pedagogy-resources':
                    updateResourcesAnalysis();
                    break;
                case 'training-overview':
                    updateTrainingStats();
                    break;
                case 'training-diplomas':
                    updateDiplomasAnalysis();
                    break;
                case 'training-continuous':
                    updateContinuousTrainingAnalysis();
                    break;
                case 'training-languages':
                    updateLanguagesAnalysis();
                    break;
                case 'training-it':
                    updateITSkillsAnalysis();
                    break;
                case 'projects-overview':
                    updateProjectsStats();
                    break;
                case 'projects-pedagogical':
                    updatePedagogicalProjectsAnalysis();
                    break;
                case 'projects-activities':
                    updateActivitiesAnalysis();
                    break;
                case 'projects-meetings':
                    updateMeetingsAnalysis();
                    break;
            }
        }

        function updateDashboard() {
            if (teachersData.length === 0) {
                document.getElementById('globalStats').innerHTML = '<p class="text-center">Aucune donnée importée</p>';
                return;
            }
            
            // Mettre à jour les statistiques globales
            updateGlobalStats();
            
            // Mettre à jour les graphiques
            updateCharts();
            
            // Mettre à jour les activités récentes
            updateRecentActivities();
            
            // Mettre à jour les filtres
            updateFilters();
        }

        function updateGlobalStats() {
            const container = document.getElementById('globalStats');
            if (!container) return;
            
            const totalTeachers = teachersData.length;
            const completeTeachers = teachersData.filter(t => t.complete).length;
            
            // Calculer la moyenne d'âge
            const ages = teachersData
                .map(t => t.age)
                .filter(age => age !== null);
            const avgAge = ages.length > 0 ? 
                Math.round(ages.reduce((a, b) => a + b, 0) / ages.length) : 0;
            
            // Calculer la moyenne d'années de service
            const serviceYears = teachersData
                .map(t => t.serviceYears)
                .filter(years => years !== null);
            const avgServiceYears = serviceYears.length > 0 ? 
                Math.round(serviceYears.reduce((a, b) => a + b, 0) / serviceYears.length) : 0;
            
            // Compter les prochaines retraites (moins de 5 ans)
            const upcomingRetirements = teachersData
                .map(t => t.yearsToRetirement)
                .filter(years => years !== null && years <= 5)
                .length;
            
            // Total des leçons
            const totalLessons = teachersData.reduce((sum, t) => sum + (t.lessonCount || 0), 0);
            
            const html = `
                <div class="stat-card">
                    <div>Enseignants analysés</div>
                    <div class="stat-value">${totalTeachers}</div>
                </div>
                <div class="stat-card">
                    <div>Âge moyen</div>
                    <div class="stat-value">${avgAge}</div>
                </div>
                <div class="stat-card">
                    <div>Service moyen</div>
                    <div class="stat-value">${avgServiceYears} ans</div>
                </div>
                <div class="stat-card">
                    <div>Retraites ≤ 5 ans</div>
                    <div class="stat-value">${upcomingRetirements}</div>
                </div>
                <div class="stat-card">
                    <div>Fiches complètes</div>
                    <div class="stat-value">${completeTeachers}</div>
                    <div>${totalTeachers > 0 ? Math.round((completeTeachers / totalTeachers) * 100) : 0}%</div>
                </div>
                <div class="stat-card">
                    <div>Leçons totales</div>
                    <div class="stat-value">${totalLessons}</div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function updateCharts() {
            // Détruire les anciens graphiques
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
            
            // Créer les nouveaux graphiques
            createSubjectChart();
            createRetirementChart();
            createHoursChart();
            createTrainingChart();
        }

        function createSubjectChart() {
            const ctx = document.getElementById('subjectChart');
            if (!ctx) return;
            
            // Compter les matières
            const subjectCounts = {};
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.subjects) {
                    teacher.data.subjects.forEach(subject => {
                        if (subject && subject.name) {
                            subjectCounts[subject.name] = (subjectCounts[subject.name] || 0) + 1;
                        }
                    });
                }
            });
            
            // Trier et prendre les 10 principales
            const sortedSubjects = Object.entries(subjectCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const labels = sortedSubjects.map(s => s[0]);
            const data = sortedSubjects.map(s => s[1]);
            
            charts.subjectChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6',
                            '#1abc9c', '#d35400', '#c0392b', '#16a085', '#8e44ad'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        title: {
                            display: true,
                            text: 'Matières les plus enseignées'
                        }
                    }
                }
            });
        }

        function createRetirementChart() {
            const ctx = document.getElementById('retirementChart');
            if (!ctx) return;
            
            // Grouper par année de retraite
            const retirementYears = {};
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.professional && teacher.data.professional.retirementDate) {
                    const year = new Date(teacher.data.professional.retirementDate).getFullYear();
                    retirementYears[year] = (retirementYears[year] || 0) + 1;
                }
            });
            
            const sortedYears = Object.keys(retirementYears).sort();
            const data = sortedYears.map(year => retirementYears[year]);
            
            charts.retirementChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedYears,
                    datasets: [{
                        label: 'Nombre de retraites',
                        data: data,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Évolution des départs à la retraite'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nombre d\'enseignants'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Année'
                            }
                        }
                    }
                }
            });
        }

        function createHoursChart() {
            const ctx = document.getElementById('hoursChart');
            if (!ctx) return;
            
            // Distribution des heures d'enseignement
            const hoursDistribution = { '0-10': 0, '11-20': 0, '21-30': 0, '31+': 0 };
            
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.professional && teacher.data.professional.weeklyHours) {
                    const hours = parseInt(teacher.data.professional.weeklyHours) || 0;
                    if (hours <= 10) hoursDistribution['0-10']++;
                    else if (hours <= 20) hoursDistribution['11-20']++;
                    else if (hours <= 30) hoursDistribution['21-30']++;
                    else hoursDistribution['31+']++;
                }
            });
            
            charts.hoursChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-10h', '11-20h', '21-30h', '31h+'],
                    datasets: [{
                        label: 'Nombre d\'enseignants',
                        data: Object.values(hoursDistribution),
                        backgroundColor: '#3498db'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribution des heures d\'enseignement'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nombre d\'enseignants'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Heures/semaine'
                            }
                        }
                    }
                }
            });
        }

        function createTrainingChart() {
            const ctx = document.getElementById('trainingChart');
            if (!ctx) return;
            
            // Niveau de formation (basé sur les diplômes)
            const trainingLevels = { 'Licence': 0, 'Master': 0, 'Doctorat': 0, 'Autre': 0 };
            
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.diplomas && teacher.data.diplomas.length > 0) {
                    let hasDoctorat = false;
                    let hasMaster = false;
                    let hasLicence = false;
                    
                    teacher.data.diplomas.forEach(diploma => {
                        const name = diploma.name || '';
                        if (name.includes('Doctorat') || name.includes('PhD')) hasDoctorat = true;
                        else if (name.includes('Master')) hasMaster = true;
                        else if (name.includes('Licence') || name.includes('Bachelor')) hasLicence = true;
                    });
                    
                    if (hasDoctorat) trainingLevels['Doctorat']++;
                    else if (hasMaster) trainingLevels['Master']++;
                    else if (hasLicence) trainingLevels['Licence']++;
                    else trainingLevels['Autre']++;
                } else {
                    trainingLevels['Autre']++;
                }
            });
            
            charts.trainingChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(trainingLevels),
                    datasets: [{
                        data: Object.values(trainingLevels),
                        backgroundColor: ['#2ecc71', '#3498db', '#9b59b6', '#f39c12']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Niveau de formation des enseignants'
                        },
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function updateRecentActivities() {
            const container = document.getElementById('recentActivities');
            if (!container) return;
            
            // Collecter les activités récentes
            const recentActivities = [];
            
            teachersData.forEach(teacher => {
                // Dernières leçons
                if (teacher.data && teacher.data.lessons) {
                    teacher.data.lessons.slice(-3).forEach(lesson => {
                        if (lesson.date) {
                            recentActivities.push({
                                type: 'lesson',
                                date: lesson.date,
                                teacher: teacher.fullName,
                                title: lesson.title || 'Leçon'
                            });
                        }
                    });
                }
                
                // Derniers TP
                if (teacher.data && teacher.data.tps) {
                    teacher.data.tps.slice(-2).forEach(tp => {
                        if (tp.date) {
                            recentActivities.push({
                                type: 'tp',
                                date: tp.date,
                                teacher: teacher.fullName,
                                title: tp.title || 'TP'
                            });
                        }
                    });
                }
                
                // Dernières évaluations
                if (teacher.data && teacher.data.evaluations) {
                    teacher.data.evaluations.slice(-2).forEach(eval => {
                        if (eval.date) {
                            recentActivities.push({
                                type: 'evaluation',
                                date: eval.date,
                                teacher: teacher.fullName,
                                title: eval.type || 'Évaluation'
                            });
                        }
                    });
                }
            });
            
            // Trier par date
            recentActivities.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (recentActivities.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune activité récente</p>';
                return;
            }
            
            let html = '<table class="data-table"><thead><tr><th>Date</th><th>Type</th><th>Enseignant</th><th>Description</th></tr></thead><tbody>';
            
            recentActivities.slice(0, 10).forEach(activity => {
                const typeIcon = activity.type === 'lesson' ? 'fa-chalkboard' : 
                                activity.type === 'tp' ? 'fa-flask' : 'fa-clipboard-check';
                const typeLabel = activity.type === 'lesson' ? 'Leçon' : 
                                 activity.type === 'tp' ? 'TP' : 'Évaluation';
                
                html += `
                    <tr>
                        <td>${new Date(activity.date).toLocaleDateString()}</td>
                        <td><i class="fas ${typeIcon}"></i> ${typeLabel}</td>
                        <td>${activity.teacher}</td>
                        <td>${activity.title}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function updateFilters() {
            // Mettre à jour les filtres de matière
            const subjectFilter = document.getElementById('dashboardFilterSubject');
            const subjectSet = new Set();
            
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.subjects) {
                    teacher.data.subjects.forEach(subject => {
                        if (subject && subject.name) subjectSet.add(subject.name);
                    });
                }
            });
            
            let subjectOptions = '<option value="">Toutes les matières</option>';
            Array.from(subjectSet).sort().forEach(subject => {
                subjectOptions += `<option value="${subject}">${subject}</option>`;
            });
            
            if (subjectFilter) subjectFilter.innerHTML = subjectOptions;
            
            // Mettre à jour les filtres de catégorie
            const categoryFilter = document.getElementById('dashboardFilterCategory');
            const categorySet = new Set();
            
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.professional && teacher.data.professional.professionalCategory) {
                    categorySet.add(teacher.data.professional.professionalCategory);
                }
            });
            
            let categoryOptions = '<option value="">Toutes les catégories</option>';
            Array.from(categorySet).sort().forEach(category => {
                categoryOptions += `<option value="${category}">${category}</option>`;
            });
            
            if (categoryFilter) categoryFilter.innerHTML = categoryOptions;
            
            // Mettre à jour les filtres d'établissement
            const establishmentFilter = document.getElementById('dashboardFilterEstablishment');
            const establishmentSet = new Set();
            
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.establishment && teacher.data.establishment.name) {
                    establishmentSet.add(teacher.data.establishment.name);
                }
            });
            
            let establishmentOptions = '<option value="">Tous les établissements</option>';
            Array.from(establishmentSet).sort().forEach(establishment => {
                establishmentOptions += `<option value="${establishment}">${establishment}</option>`;
            });
            
            if (establishmentFilter) establishmentFilter.innerHTML = establishmentOptions;
        }

        function filterDashboard() {
            const searchTerm = document.getElementById('dashboardSearch')?.value.toLowerCase() || '';
            const subject = document.getElementById('dashboardFilterSubject')?.value || '';
            const category = document.getElementById('dashboardFilterCategory')?.value || '';
            const establishment = document.getElementById('dashboardFilterEstablishment')?.value || '';
            
            // Filtrer les enseignants pour les statistiques
            const filtered = teachersData.filter(teacher => {
                // Recherche par nom
                if (searchTerm && !teacher.fullName.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // Filtre par matière
                if (subject && (!teacher.data || !teacher.data.subjects || 
                    !teacher.data.subjects.some(s => s && s.name === subject))) {
                    return false;
                }
                
                // Filtre par catégorie
                if (category && (!teacher.data || !teacher.data.professional || 
                    teacher.data.professional.professionalCategory !== category)) {
                    return false;
                }
                
                // Filtre par établissement
                if (establishment && (!teacher.data || !teacher.data.establishment || 
                    teacher.data.establishment.name !== establishment)) {
                    return false;
                }
                
                return true;
            });
            
            // Mettre à jour les statistiques avec les données filtrées
            updateFilteredStats(filtered);
        }

        function updateFilteredStats(filteredTeachers) {
            const container = document.getElementById('globalStats');
            if (!container) return;
            
            const totalTeachers = filteredTeachers.length;
            
            if (totalTeachers === 0) {
                container.innerHTML = '<p class="text-center">Aucun enseignant ne correspond aux critères</p>';
                return;
            }
            
            const completeTeachers = filteredTeachers.filter(t => t.complete).length;
            
            // Calculer la moyenne d'âge
            const ages = filteredTeachers
                .map(t => t.age)
                .filter(age => age !== null);
            const avgAge = ages.length > 0 ? 
                Math.round(ages.reduce((a, b) => a + b, 0) / ages.length) : 0;
            
            const html = `
                <div class="stat-card">
                    <div>Enseignants filtrés</div>
                    <div class="stat-value">${totalTeachers}</div>
                </div>
                <div class="stat-card">
                    <div>Âge moyen</div>
                    <div class="stat-value">${avgAge}</div>
                </div>
                <div class="stat-card">
                    <div>Fiches complètes</div>
                    <div class="stat-value">${completeTeachers}</div>
                    <div>${Math.round((completeTeachers / totalTeachers) * 100)}%</div>
                </div>
                <div class="stat-card">
                    <div>Leçons totales</div>
                    <div class="stat-value">${filteredTeachers.reduce((sum, t) => sum + (t.lessonCount || 0), 0)}</div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function updateTeachersList() {
            const container = document.getElementById('teachersCards');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucun enseignant importé</p>';
                return;
            }
            
            // Appliquer le filtre si nécessaire
            filteredTeachers = [...teachersData];
            applyTeacherFilters();
            
            let html = '';
            filteredTeachers.forEach((teacher, index) => {
                const mainSubject = teacher.data && teacher.data.subjects && teacher.data.subjects.length > 0 ? 
                    teacher.data.subjects[0].name : 'Non spécifié';
                
                const establishment = teacher.data && teacher.data.establishment ? 
                    teacher.data.establishment.name : 'Non spécifié';
                
                const serviceYears = teacher.serviceYears || '?';
                const age = teacher.age || '?';
                const yearsToRetirement = teacher.yearsToRetirement !== null ? teacher.yearsToRetirement + ' ans' : 'N/A';
                
                const fileCount = teacher.files.length;
                const fileTypes = teacher.files.map(f => FILE_TYPES[f.type]?.name?.substring(0, 3) || f.type.substring(0, 3)).join(', ');
                
                html += `
                    <div class="teacher-card" onclick="showTeacherDetail(${index})">
                        <div class="teacher-header">
                            <div class="teacher-name">${teacher.fullName}</div>
                            <div>
                                ${teacher.complete ? 
                                    '<span class="badge badge-success">Complet</span>' : 
                                    `<span class="badge badge-warning">${fileCount} fichiers</span>`}
                            </div>
                        </div>
                        <div class="teacher-info">
                            <div class="teacher-info-item">
                                <i class="fas fa-id-badge"></i>
                                <span>${teacher.data && teacher.data.professional ? teacher.data.professional.matricule : 'N/A'}</span>
                            </div>
                            <div class="teacher-info-item">
                                <i class="fas fa-book"></i>
                                <span>${mainSubject}</span>
                            </div>
                            <div class="teacher-info-item">
                                <i class="fas fa-school"></i>
                                <span>${establishment}</span>
                            </div>
                            <div class="teacher-info-item">
                                <i class="fas fa-clock"></i>
                                <span>${serviceYears} ans</span>
                            </div>
                            <div class="teacher-info-item">
                                <i class="fas fa-user"></i>
                                <span>${age} ans</span>
                            </div>
                            <div class="teacher-info-item">
                                <i class="fas fa-umbrella-beach"></i>
                                <span>${yearsToRetirement}</span>
                            </div>
                        </div>
                        <div class="teacher-info-item mt-10">
                            <i class="fas fa-file"></i>
                            <small>Types: ${fileTypes}</small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function applyTeacherFilters() {
            const searchTerm = document.getElementById('teacherSearch')?.value.toLowerCase() || '';
            
            if (searchTerm) {
                filteredTeachers = filteredTeachers.filter(teacher => {
                    const fullName = teacher.fullName.toLowerCase();
                    const matricule = teacher.data && teacher.data.professional ? 
                        (teacher.data.professional.matricule || '').toLowerCase() : '';
                    const establishment = teacher.data && teacher.data.establishment ? 
                        (teacher.data.establishment.name || '').toLowerCase() : '';
                    
                    return fullName.includes(searchTerm) || 
                           matricule.includes(searchTerm) || 
                           establishment.includes(searchTerm);
                });
            }
        }

        function filterCompleteOnly() {
            filteredTeachers = teachersData.filter(teacher => teacher.complete);
            updateTeachersList();
            showNotification(`${filteredTeachers.length} fiches complètes affichées`, 'info');
        }

        function sortTeachers(criteria) {
            filteredTeachers.sort((a, b) => {
                switch(criteria) {
                    case 'name':
                        return a.fullName.localeCompare(b.fullName);
                    case 'retirement':
                        const aYears = a.yearsToRetirement !== null ? a.yearsToRetirement : 99;
                        const bYears = b.yearsToRetirement !== null ? b.yearsToRetirement : 99;
                        return aYears - bYears;
                    default:
                        return 0;
                }
            });
            
            updateTeachersList();
            showNotification(`Trié par ${criteria === 'name' ? 'nom' : 'retraite'}`, 'info');
        }

        function showTeacherDetail(index) {
            const teacher = teachersData[index];
            if (!teacher) return;
            
            currentTeacherIndex = index;
            
            const modalTitle = document.getElementById('teacherModalTitle');
            const modalContent = document.getElementById('teacherModalContent');
            const modal = document.getElementById('teacherDetailModal');
            
            if (!modalTitle || !modalContent || !modal) return;
            
            modalTitle.textContent = `${teacher.fullName} - Détails`;
            
            // Générer le contenu détaillé
            let content = `
                <div class="teacher-detail">
                    <div class="filter-bar">
                        <button class="btn btn-primary" onclick="exportTeacherToExcel(${index})">
                            <i class="fas fa-file-excel"></i> Exporter cet enseignant
                        </button>
                        <button class="btn btn-info" onclick="showTeacherFiles(${index})">
                            <i class="fas fa-folder-open"></i> Voir les fichiers
                        </button>
                    </div>
                    
                    <div class="data-section">
                        <h3><i class="fas fa-info-circle"></i> Informations générales</h3>
                        ${generateTeacherGeneralInfo(teacher)}
                    </div>
                    
                    <div class="data-section">
                        <h3><i class="fas fa-chart-bar"></i> Statistiques</h3>
                        ${generateTeacherStatistics(teacher)}
                    </div>
                    
                    <div class="data-section">
                        <h3><i class="fas fa-book"></i> Matières enseignées</h3>
                        ${generateTeacherSubjects(teacher)}
                    </div>
                    
                    ${teacher.data && teacher.data.lessons && teacher.data.lessons.length > 0 ? `
                        <div class="data-section">
                            <h3><i class="fas fa-chalkboard"></i> Dernières leçons</h3>
                            ${generateTeacherRecentLessons(teacher)}
                        </div>
                    ` : ''}
                    
                    ${teacher.data && teacher.data.evaluations && teacher.data.evaluations.length > 0 ? `
                        <div class="data-section">
                            <h3><i class="fas fa-clipboard-check"></i> Évaluations récentes</h3>
                            ${generateTeacherRecentEvaluations(teacher)}
                        </div>
                    ` : ''}
                </div>
            `;
            
            modalContent.innerHTML = content;
            modal.classList.add('active');
        }

        function generateTeacherGeneralInfo(teacher) {
            if (!teacher.data) return '<p>Aucune donnée disponible</p>';
            
            const personal = teacher.data.personal || {};
            const professional = teacher.data.professional || {};
            const establishment = teacher.data.establishment || {};
            
            return `
                <table class="data-table">
                    <tr>
                        <td><strong>Matricule:</strong></td>
                        <td>${professional.matricule || 'N/A'}</td>
                        <td><strong>Fonction:</strong></td>
                        <td>${professional.position || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td><strong>Date de naissance:</strong></td>
                        <td>${personal.birthDate ? new Date(personal.birthDate).toLocaleDateString() : 'N/A'}</td>
                        <td><strong>Lieu de naissance:</strong></td>
                        <td>${personal.birthPlace || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td><strong>Date d'engagement:</strong></td>
                        <td>${professional.engagementDate ? new Date(professional.engagementDate).toLocaleDateString() : 'N/A'}</td>
                        <td><strong>Catégorie:</strong></td>
                        <td>${professional.professionalCategory || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td><strong>Établissement:</strong></td>
                        <td colspan="3">${establishment.name || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td><strong>Type d'établissement:</strong></td>
                        <td>${establishment.type || 'N/A'}</td>
                        <td><strong>Téléphone:</strong></td>
                        <td>${establishment.phone || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td><strong>Email:</strong></td>
                        <td>${personal.personalEmail || 'N/A'}</td>
                        <td><strong>Téléphone personnel:</strong></td>
                        <td>${personal.personalPhone || 'N/A'}</td>
                    </tr>
                </table>
            `;
        }

        function generateTeacherStatistics(teacher) {
            const stats = [];
            
            if (teacher.age !== null) stats.push(['Âge', teacher.age + ' ans']);
            if (teacher.serviceYears !== null) stats.push(['Service', teacher.serviceYears + ' ans']);
            if (teacher.yearsToRetirement !== null) stats.push(['Retraite dans', teacher.yearsToRetirement + ' ans']);
            if (teacher.lessonCount) stats.push(['Leçons', teacher.lessonCount]);
            if (teacher.tpCount) stats.push(['TP', teacher.tpCount]);
            if (teacher.evaluationCount) stats.push(['Évaluations', teacher.evaluationCount]);
            if (teacher.projectCount) stats.push(['Projets', teacher.projectCount]);
            if (teacher.trainingCount) stats.push(['Formations', teacher.trainingCount]);
            
            if (stats.length === 0) return '<p>Aucune statistique disponible</p>';
            
            let html = '<div class="stats-grid">';
            stats.forEach(([label, value]) => {
                html += `
                    <div class="stat-card">
                        <div>${label}</div>
                        <div class="stat-value">${value}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            return html;
        }

        function generateTeacherSubjects(teacher) {
            if (!teacher.data || !teacher.data.subjects || teacher.data.subjects.length === 0) {
                return '<p>Aucune matière renseignée</p>';
            }
            
            let html = '<table class="data-table"><thead><tr><th>Matière</th><th>Type</th><th>Heures/semaine</th></tr></thead><tbody>';
            
            teacher.data.subjects.forEach(subject => {
                html += `
                    <tr>
                        <td>${subject.name || 'N/A'}</td>
                        <td>${subject.type === 'main' ? 'Principale' : 
                              subject.type === 'secondary' ? 'Secondaire' : 
                              'Supplémentaire'}</td>
                        <td>${subject.hours || 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            return html;
        }

        function generateTeacherRecentLessons(teacher) {
            const lessons = teacher.data.lessons.slice(-5).reverse();
            
            let html = '<table class="data-table"><thead><tr><th>Date</th><th>Titre</th><th>Durée</th><th>Classe</th></tr></thead><tbody>';
            
            lessons.forEach(lesson => {
                html += `
                    <tr>
                        <td>${lesson.date ? new Date(lesson.date).toLocaleDateString() : 'N/A'}</td>
                        <td>${lesson.title || 'Sans titre'}</td>
                        <td>${lesson.duration || 'N/A'}</td>
                        <td>${lesson.class || 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            return html;
        }

        function generateTeacherRecentEvaluations(teacher) {
            const evaluations = teacher.data.evaluations.slice(-5).reverse();
            
            let html = '<table class="data-table"><thead><tr><th>Date</th><th>Type</th><th>Matière</th><th>Classe</th><th>Moyenne</th></tr></thead><tbody>';
            
            evaluations.forEach(eval => {
                html += `
                    <tr>
                        <td>${eval.date ? new Date(eval.date).toLocaleDateString() : 'N/A'}</td>
                        <td>${eval.type || 'N/A'}</td>
                        <td>${eval.subject || 'N/A'}</td>
                        <td>${eval.class || 'N/A'}</td>
                        <td>${eval.average || 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            return html;
        }

        function showTeacherFiles(index) {
            const teacher = teachersData[index];
            if (!teacher) return;
            
            let content = `
                <div class="data-section">
                    <h3><i class="fas fa-folder-open"></i> Fichiers de ${teacher.fullName}</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Nom du fichier</th>
                                <th>Date d'import</th>
                                <th>Taille (approx)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            teacher.files.forEach(file => {
                const fileType = FILE_TYPES[file.type] || { name: file.type, icon: 'fa-file' };
                const size = JSON.stringify(file.data).length;
                const sizeFormatted = formatFileSize(size);
                const date = new Date(file.importDate).toLocaleString();
                
                content += `
                    <tr>
                        <td><i class="fas ${fileType.icon}"></i> ${fileType.name}</td>
                        <td>${file.name}</td>
                        <td>${date}</td>
                        <td>${sizeFormatted}</td>
                    </tr>
                `;
            });
            
            content += `
                        </tbody>
                    </table>
                </div>
            `;
            
            const modalTitle = document.getElementById('teacherModalTitle');
            const modalContent = document.getElementById('teacherModalContent');
            
            if (modalTitle && modalContent) {
                modalTitle.textContent = `Fichiers - ${teacher.fullName}`;
                modalContent.innerHTML = content;
            }
        }

        function closeTeacherDetail() {
            const modal = document.getElementById('teacherDetailModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function viewTeacherDetails(index) {
            currentTeacherIndex = index;
            switchTab('tab-teachers');
            setTimeout(() => {
                showTeacherDetail(index);
            }, 100);
        }

        function removeTeacher(index) {
            if (confirm('Voulez-vous vraiment supprimer cet enseignant et toutes ses données ?')) {
                teachersData.splice(index, 1);
                updateUIAfterImport();
                showNotification('Enseignant supprimé', 'success');
            }
        }

        // Analyse pédagogique
        function updatePedagogyAnalysis() {
            updatePedagogyStats();
        }

        function updatePedagogyStats() {
            const container = document.getElementById('pedagogyStats');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Calculer les statistiques pédagogiques
            const totalLessons = teachersData.reduce((sum, t) => sum + (t.lessonCount || 0), 0);
            const totalTPs = teachersData.reduce((sum, t) => sum + (t.tpCount || 0), 0);
            
            // Compter les enseignants avec emploi du temps
            const teachersWithTimetable = teachersData.filter(t => 
                t.data && t.data.timetable && Object.keys(t.data.timetable).length > 0
            ).length;
            
            // Compter les ressources pédagogiques
            const totalResources = teachersData.reduce((sum, t) => 
                sum + (t.data && t.data.resources ? t.data.resources.length : 0), 0
            );
            
            // Moyenne d'heures par semaine
            const totalHours = teachersData.reduce((sum, t) => 
                sum + (parseInt(t.data?.professional?.weeklyHours) || 0), 0
            );
            const avgHours = teachersData.length > 0 ? Math.round(totalHours / teachersData.length * 10) / 10 : 0;
            
            // Nombre moyen de matières par enseignant
            const totalSubjects = teachersData.reduce((sum, t) => sum + (t.subjectCount || 0), 0);
            const avgSubjects = teachersData.length > 0 ? Math.round(totalSubjects / teachersData.length * 10) / 10 : 0;
            
            const html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div>Leçons totales</div>
                        <div class="stat-value">${totalLessons}</div>
                    </div>
                    <div class="stat-card">
                        <div>Travaux pratiques</div>
                        <div class="stat-value">${totalTPs}</div>
                    </div>
                    <div class="stat-card">
                        <div>Emplois du temps</div>
                        <div class="stat-value">${teachersWithTimetable}</div>
                        <div>${teachersData.length > 0 ? Math.round((teachersWithTimetable / teachersData.length) * 100) : 0}%</div>
                    </div>
                    <div class="stat-card">
                        <div>Ressources</div>
                        <div class="stat-value">${totalResources}</div>
                    </div>
                    <div class="stat-card">
                        <div>Heures/semaine moy.</div>
                        <div class="stat-value">${avgHours}</div>
                    </div>
                    <div class="stat-card">
                        <div>Matières moy./enseig.</div>
                        <div class="stat-value">${avgSubjects}</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function updateSubjectsAnalysis() {
            const container = document.getElementById('subjectsAnalysis');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Analyser les matières enseignées
            const subjectsCount = {};
            const subjectsByLevel = {};
            
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.subjects) {
                    teacher.data.subjects.forEach(subject => {
                        if (subject && subject.name) {
                            // Compter les matières
                            subjectsCount[subject.name] = (subjectsCount[subject.name] || 0) + 1;
                            
                            // Grouper par niveau
                            if (subject.level) {
                                if (!subjectsByLevel[subject.level]) {
                                    subjectsByLevel[subject.level] = new Set();
                                }
                                subjectsByLevel[subject.level].add(subject.name);
                            }
                        }
                    });
                }
            });
            
            // Trier les matières par fréquence
            const sortedSubjects = Object.entries(subjectsCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);
            
            // Compter les matières par niveau
            const levelStats = Object.entries(subjectsByLevel)
                .map(([level, subjects]) => ({
                    level,
                    count: subjects.size,
                    subjects: Array.from(subjects).join(', ')
                }))
                .sort((a, b) => b.count - a.count);
            
            let html = `
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-bar"></i> Matières les plus enseignées</h4>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Matière</th>
                                    <th>Nombre d'enseignants</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            sortedSubjects.forEach(([subject, count]) => {
                const percentage = Math.round((count / teachersData.length) * 100);
                html += `
                    <tr>
                        <td>${subject}</td>
                        <td>${count} (${percentage}%)</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-layer-group"></i> Répartition par niveau</h4>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Niveau</th>
                                    <th>Matières uniques</th>
                                    <th>Matières</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            levelStats.forEach(stat => {
                html += `
                    <tr>
                        <td>${stat.level}</td>
                        <td>${stat.count}</td>
                        <td title="${stat.subjects}">${stat.subjects.length > 50 ? stat.subjects.substring(0, 50) + '...' : stat.subjects}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-lightbulb"></i> Recommandations</h4>
                    <ul>
                        <li>${sortedSubjects.length > 0 ? `La matière <strong>${sortedSubjects[0][0]}</strong> est la plus enseignée (${sortedSubjects[0][1]} enseignants)` : 'Aucune donnée de matière disponible'}</li>
                        <li>${levelStats.length > 0 ? `Le niveau <strong>${levelStats[0].level}</strong> présente la plus grande diversité de matières (${levelStats[0].count} matières uniques)` : 'Aucune donnée de niveau disponible'}</li>
                        <li>${teachersData.length > 0 ? `Moyenne de ${Math.round(Object.keys(subjectsCount).length / teachersData.length * 10) / 10} matières uniques par niveau scolaire` : ''}</li>
                    </ul>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function updateTimetableAnalysis() {
            const container = document.getElementById('timetableAnalysis');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Analyser les emplois du temps
            const teachersWithTimetable = teachersData.filter(t => 
                t.data && t.data.timetable && Object.keys(t.data.timetable).length > 0
            );
            
            if (teachersWithTimetable.length === 0) {
                container.innerHTML = '<p class="text-center">Aucun emploi du temps disponible</p>';
                return;
            }
            
            // Analyser les jours de cours
            const daysOfWeek = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            const dayStats = {};
            
            daysOfWeek.forEach(day => {
                dayStats[day] = 0;
            });
            
            teachersWithTimetable.forEach(teacher => {
                const timetable = teacher.data.timetable;
                Object.keys(timetable).forEach(day => {
                    if (timetable[day] && timetable[day].length > 0) {
                        const dayName = day.charAt(0).toUpperCase() + day.slice(1);
                        if (daysOfWeek.includes(dayName)) {
                            dayStats[dayName] = (dayStats[dayName] || 0) + 1;
                        }
                    }
                });
            });
            
            // Analyser les heures de cours
            const timeSlots = {};
            
            teachersWithTimetable.forEach(teacher => {
                const timetable = teacher.data.timetable;
                Object.values(timetable).forEach(sessions => {
                    if (Array.isArray(sessions)) {
                        sessions.forEach(session => {
                            if (session && session.time) {
                                const hour = session.time.split(':')[0];
                                if (hour) {
                                    const hourInt = parseInt(hour);
                                    if (hourInt >= 8 && hourInt <= 18) {
                                        timeSlots[hourInt] = (timeSlots[hourInt] || 0) + 1;
                                    }
                                }
                            }
                        });
                    }
                });
            });
            
            let html = `
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-calendar-day"></i> Jours de cours</h4>
                        <div class="chart-container">
                            <canvas id="daysChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-clock"></i> Horaires de cours</h4>
                        <div class="chart-container">
                            <canvas id="hoursDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-chart-line"></i> Statistiques des emplois du temps</h4>
                    <div class="stats-grid">
            `;
            
            // Calculer les statistiques
            const totalSessions = teachersWithTimetable.reduce((sum, teacher) => {
                let sessions = 0;
                const timetable = teacher.data.timetable;
                Object.values(timetable).forEach(s => {
                    if (Array.isArray(s)) sessions += s.length;
                });
                return sum + sessions;
            }, 0);
            
            const avgSessionsPerTeacher = Math.round(totalSessions / teachersWithTimetable.length * 10) / 10;
            const avgSessionsPerDay = Math.round(totalSessions / (daysOfWeek.length * teachersWithTimetable.length) * 10) / 10;
            
            // Jour le plus chargé
            const busiestDay = Object.entries(dayStats).sort((a, b) => b[1] - a[1])[0];
            // Heure la plus chargée
            const busiestHour = Object.entries(timeSlots).sort((a, b) => b[1] - a[1])[0];
            
            html += `
                        <div class="stat-card">
                            <div>Enseignants avec EDT</div>
                            <div class="stat-value">${teachersWithTimetable.length}</div>
                            <div>${Math.round((teachersWithTimetable.length / teachersData.length) * 100)}%</div>
                        </div>
                        <div class="stat-card">
                            <div>Sessions totales</div>
                            <div class="stat-value">${totalSessions}</div>
                        </div>
                        <div class="stat-card">
                            <div>Sessions moy./enseig.</div>
                            <div class="stat-value">${avgSessionsPerTeacher}</div>
                        </div>
                        <div class="stat-card">
                            <div>Jour le plus chargé</div>
                            <div class="stat-value">${busiestDay ? busiestDay[0] : 'N/A'}</div>
                            <div>${busiestDay ? busiestDay[1] : 0} enseignants</div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Créer les graphiques
            setTimeout(() => {
                // Graphique des jours
                const daysCtx = document.getElementById('daysChart');
                if (daysCtx) {
                    const daysChart = new Chart(daysCtx, {
                        type: 'bar',
                        data: {
                            labels: daysOfWeek,
                            datasets: [{
                                label: 'Nombre d\'enseignants',
                                data: daysOfWeek.map(day => dayStats[day] || 0),
                                backgroundColor: '#3498db'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Répartition par jour de la semaine'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre d\'enseignants'
                                    }
                                }
                            }
                        }
                    });
                    charts.daysChart = daysChart;
                }
                
                // Graphique des heures
                const hoursCtx = document.getElementById('hoursDistributionChart');
                if (hoursCtx) {
                    const hoursData = [];
                    const hourLabels = [];
                    for (let hour = 8; hour <= 18; hour++) {
                        hourLabels.push(`${hour}h`);
                        hoursData.push(timeSlots[hour] || 0);
                    }
                    
                    const hoursChart = new Chart(hoursCtx, {
                        type: 'line',
                        data: {
                            labels: hourLabels,
                            datasets: [{
                                label: 'Nombre de sessions',
                                data: hoursData,
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Distribution des horaires de cours'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre de sessions'
                                    }
                                }
                            }
                        }
                    });
                    charts.hoursDistributionChart = hoursChart;
                }
            }, 100);
        }

        function updateLessonsAnalysis() {
            const container = document.getElementById('lessonsAnalysis');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Analyser les leçons
            const teachersWithLessons = teachersData.filter(t => t.lessonCount && t.lessonCount > 0);
            
            if (teachersWithLessons.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune leçon enregistrée</p>';
                return;
            }
            
            // Compter les leçons par mois
            const lessonsByMonth = {};
            const lessonTypes = {};
            const lessonDurations = [];
            
            teachersWithLessons.forEach(teacher => {
                if (teacher.data && teacher.data.lessons) {
                    teacher.data.lessons.forEach(lesson => {
                        if (lesson.date) {
                            const date = new Date(lesson.date);
                            const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                            lessonsByMonth[monthKey] = (lessonsByMonth[monthKey] || 0) + 1;
                        }
                        
                        if (lesson.type) {
                            lessonTypes[lesson.type] = (lessonTypes[lesson.type] || 0) + 1;
                        }
                        
                        if (lesson.duration) {
                            const duration = parseInt(lesson.duration) || 0;
                            if (duration > 0) lessonDurations.push(duration);
                        }
                    });
                }
            });
            
            // Statistiques de durée
            const avgDuration = lessonDurations.length > 0 ? 
                Math.round(lessonDurations.reduce((a, b) => a + b, 0) / lessonDurations.length) : 0;
            const maxDuration = lessonDurations.length > 0 ? Math.max(...lessonDurations) : 0;
            const minDuration = lessonDurations.length > 0 ? Math.min(...lessonDurations) : 0;
            
            // Trier les mois
            const sortedMonths = Object.entries(lessonsByMonth)
                .sort(([a], [b]) => a.localeCompare(b))
                .slice(-6); // Derniers 6 mois
            
            let html = `
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-line"></i> Évolution mensuelle</h4>
                        <div class="chart-container">
                            <canvas id="lessonsMonthlyChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-pie"></i> Types de leçons</h4>
                        <div class="chart-container">
                            <canvas id="lessonTypesChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-chart-bar"></i> Statistiques des leçons</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div>Enseignants avec leçons</div>
                            <div class="stat-value">${teachersWithLessons.length}</div>
                            <div>${Math.round((teachersWithLessons.length / teachersData.length) * 100)}%</div>
                        </div>
                        <div class="stat-card">
                            <div>Leçons totales</div>
                            <div class="stat-value">${teachersWithLessons.reduce((sum, t) => sum + (t.lessonCount || 0), 0)}</div>
                        </div>
                        <div class="stat-card">
                            <div>Durée moyenne</div>
                            <div class="stat-value">${avgDuration}min</div>
                        </div>
                        <div class="stat-card">
                            <div>Types différents</div>
                            <div class="stat-value">${Object.keys(lessonTypes).length}</div>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-list"></i> Dernières leçons enregistrées</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Enseignant</th>
                                <th>Titre</th>
                                <th>Type</th>
                                <th>Durée</th>
                                <th>Classe</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Récupérer les 10 dernières leçons
            const allLessons = [];
            teachersWithLessons.forEach(teacher => {
                if (teacher.data && teacher.data.lessons) {
                    teacher.data.lessons.forEach(lesson => {
                        allLessons.push({
                            ...lesson,
                            teacher: teacher.fullName,
                            dateObj: lesson.date ? new Date(lesson.date) : new Date(0)
                        });
                    });
                }
            });
            
            allLessons.sort((a, b) => b.dateObj - a.dateObj);
            
            allLessons.slice(0, 10).forEach(lesson => {
                html += `
                    <tr>
                        <td>${lesson.date ? new Date(lesson.date).toLocaleDateString() : 'N/A'}</td>
                        <td>${lesson.teacher}</td>
                        <td>${lesson.title || 'Sans titre'}</td>
                        <td>${lesson.type || 'N/A'}</td>
                        <td>${lesson.duration || 'N/A'}</td>
                        <td>${lesson.class || 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Créer les graphiques
            setTimeout(() => {
                // Graphique mensuel
                const monthlyCtx = document.getElementById('lessonsMonthlyChart');
                if (monthlyCtx && sortedMonths.length > 0) {
                    const monthlyChart = new Chart(monthlyCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedMonths.map(([month]) => month),
                            datasets: [{
                                label: 'Nombre de leçons',
                                data: sortedMonths.map(([, count]) => count),
                                backgroundColor: '#2ecc71'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Leçons par mois'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre de leçons'
                                    }
                                }
                            }
                        }
                    });
                    charts.lessonsMonthlyChart = monthlyChart;
                }
                
                // Graphique des types
                const typesCtx = document.getElementById('lessonTypesChart');
                if (typesCtx && Object.keys(lessonTypes).length > 0) {
                    const typesData = Object.entries(lessonTypes)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 8);
                    
                    const typesChart = new Chart(typesCtx, {
                        type: 'doughnut',
                        data: {
                            labels: typesData.map(([type]) => type),
                            datasets: [{
                                data: typesData.map(([, count]) => count),
                                backgroundColor: [
                                    '#3498db', '#2ecc71', '#f39c12', '#e74c3c',
                                    '#9b59b6', '#1abc9c', '#d35400', '#34495e'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Répartition par type'
                                },
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                    charts.lessonTypesChart = typesChart;
                }
            }, 100);
        }

        function updateTPAnalysis() {
            const container = document.getElementById('tpAnalysis');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Analyser les TP
            const teachersWithTPs = teachersData.filter(t => t.tpCount && t.tpCount > 0);
            
            if (teachersWithTPs.length === 0) {
                container.innerHTML = '<p class="text-center">Aucun travail pratique enregistré</p>';
                return;
            }
            
            // Compter les TP par matière
            const tpBySubject = {};
            const tpByMonth = {};
            
            teachersWithTPs.forEach(teacher => {
                if (teacher.data && teacher.data.tps) {
                    teacher.data.tps.forEach(tp => {
                        if (tp.subject) {
                            tpBySubject[tp.subject] = (tpBySubject[tp.subject] || 0) + 1;
                        }
                        
                        if (tp.date) {
                            const date = new Date(tp.date);
                            const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                            tpByMonth[monthKey] = (tpByMonth[monthKey] || 0) + 1;
                        }
                    });
                }
            });
            
            // Trier les matières par nombre de TP
            const sortedSubjects = Object.entries(tpBySubject)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Trier les mois
            const sortedMonths = Object.entries(tpByMonth)
                .sort(([a], [b]) => a.localeCompare(b))
                .slice(-6);
            
            let html = `
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-bar"></i> TP par matière</h4>
                        <div class="chart-container">
                            <canvas id="tpBySubjectChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-line"></i> Évolution mensuelle</h4>
                        <div class="chart-container">
                            <canvas id="tpMonthlyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-chart-pie"></i> Statistiques des TP</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div>Enseignants avec TP</div>
                            <div class="stat-value">${teachersWithTPs.length}</div>
                            <div>${Math.round((teachersWithTPs.length / teachersData.length) * 100)}%</div>
                        </div>
                        <div class="stat-card">
                            <div>TP totaux</div>
                            <div class="stat-value">${teachersWithTPs.reduce((sum, t) => sum + (t.tpCount || 0), 0)}</div>
                        </div>
                        <div class="stat-card">
                            <div>Matières avec TP</div>
                            <div class="stat-value">${Object.keys(tpBySubject).length}</div>
                        </div>
                        <div class="stat-card">
                            <div>TP/enseignant moy.</div>
                            <div class="stat-value">${Math.round(teachersWithTPs.reduce((sum, t) => sum + (t.tpCount || 0), 0) / teachersWithTPs.length * 10) / 10}</div>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-list"></i> Derniers TP enregistrés</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Enseignant</th>
                                <th>Titre</th>
                                <th>Matière</th>
                                <th>Durée</th>
                                <th>Équipement</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Récupérer les 10 derniers TP
            const allTPs = [];
            teachersWithTPs.forEach(teacher => {
                if (teacher.data && teacher.data.tps) {
                    teacher.data.tps.forEach(tp => {
                        allTPs.push({
                            ...tp,
                            teacher: teacher.fullName,
                            dateObj: tp.date ? new Date(tp.date) : new Date(0)
                        });
                    });
                }
            });
            
            allTPs.sort((a, b) => b.dateObj - a.dateObj);
            
            allTPs.slice(0, 10).forEach(tp => {
                html += `
                    <tr>
                        <td>${tp.date ? new Date(tp.date).toLocaleDateString() : 'N/A'}</td>
                        <td>${tp.teacher}</td>
                        <td>${tp.title || 'Sans titre'}</td>
                        <td>${tp.subject || 'N/A'}</td>
                        <td>${tp.duration || 'N/A'}</td>
                        <td>${tp.equipment ? tp.equipment.join(', ') : 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Créer les graphiques
            setTimeout(() => {
                // Graphique par matière
                const subjectCtx = document.getElementById('tpBySubjectChart');
                if (subjectCtx && sortedSubjects.length > 0) {
                    const subjectChart = new Chart(subjectCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedSubjects.map(([subject]) => subject),
                            datasets: [{
                                label: 'Nombre de TP',
                                data: sortedSubjects.map(([, count]) => count),
                                backgroundColor: '#9b59b6'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'TP par matière'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre de TP'
                                    }
                                }
                            }
                        }
                    });
                    charts.tpBySubjectChart = subjectChart;
                }
                
                // Graphique mensuel
                const monthlyCtx = document.getElementById('tpMonthlyChart');
                if (monthlyCtx && sortedMonths.length > 0) {
                    const monthlyChart = new Chart(monthlyCtx, {
                        type: 'line',
                        data: {
                            labels: sortedMonths.map(([month]) => month),
                            datasets: [{
                                label: 'Nombre de TP',
                                data: sortedMonths.map(([, count]) => count),
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Évolution mensuelle des TP'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre de TP'
                                    }
                                }
                            }
                        }
                    });
                    charts.tpMonthlyChart = monthlyChart;
                }
            }, 100);
        }

        function updateResourcesAnalysis() {
            const container = document.getElementById('resourcesAnalysis');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Analyser les ressources pédagogiques
            const teachersWithResources = teachersData.filter(t => 
                t.data && t.data.resources && t.data.resources.length > 0
            );
            
            if (teachersWithResources.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune ressource pédagogique enregistrée</p>';
                return;
            }
            
            // Compter les ressources par type
            const resourcesByType = {};
            const resourcesBySubject = {};
            let totalResources = 0;
            
            teachersWithResources.forEach(teacher => {
                if (teacher.data && teacher.data.resources) {
                    teacher.data.resources.forEach(resource => {
                        totalResources++;
                        
                        if (resource.type) {
                            resourcesByType[resource.type] = (resourcesByType[resource.type] || 0) + 1;
                        }
                        
                        if (resource.subject) {
                            resourcesBySubject[resource.subject] = (resourcesBySubject[resource.subject] || 0) + 1;
                        }
                    });
                }
            });
            
            // Trier les types par fréquence
            const sortedTypes = Object.entries(resourcesByType)
                .sort((a, b) => b[1] - a[1]);
            
            // Trier les matières par fréquence
            const sortedSubjects = Object.entries(resourcesBySubject)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            let html = `
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-pie"></i> Répartition par type</h4>
                        <div class="chart-container">
                            <canvas id="resourcesTypeChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-bar"></i> Ressources par matière</h4>
                        <div class="chart-container">
                            <canvas id="resourcesSubjectChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-chart-line"></i> Statistiques des ressources</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div>Enseignants avec ressources</div>
                            <div class="stat-value">${teachersWithResources.length}</div>
                            <div>${Math.round((teachersWithResources.length / teachersData.length) * 100)}%</div>
                        </div>
                        <div class="stat-card">
                            <div>Ressources totales</div>
                            <div class="stat-value">${totalResources}</div>
                        </div>
                        <div class="stat-card">
                            <div>Types de ressources</div>
                            <div class="stat-value">${Object.keys(resourcesByType).length}</div>
                        </div>
                        <div class="stat-card">
                            <div>Ressources/enseignant moy.</div>
                            <div class="stat-value">${Math.round(totalResources / teachersWithResources.length * 10) / 10}</div>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-list"></i> Types de ressources disponibles</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Nombre</th>
                                <th>Pourcentage</th>
                                <th>Exemples</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedTypes.forEach(([type, count]) => {
                const percentage = Math.round((count / totalResources) * 100);
                let examples = '';
                
                switch(type.toLowerCase()) {
                    case 'document':
                    case 'pdf':
                        examples = 'Cours PDF, exercices, évaluations';
                        break;
                    case 'présentation':
                    case 'powerpoint':
                        examples = 'Présentations PowerPoint, diaporamas';
                        break;
                    case 'vidéo':
                        examples = 'Vidéos éducatives, tutoriels';
                        break;
                    case 'audio':
                        examples = 'Enregistrements audio, podcasts';
                        break;
                    case 'lien':
                    case 'url':
                        examples = 'Liens web, sites éducatifs';
                        break;
                    case 'image':
                        examples = 'Schémas, illustrations, photos';
                        break;
                    case 'logiciel':
                    case 'application':
                        examples = 'Logiciels éducatifs, applications';
                        break;
                    default:
                        examples = 'Divers';
                }
                
                html += `
                    <tr>
                        <td>${type}</td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                        <td>${examples}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Créer les graphiques
            setTimeout(() => {
                // Graphique des types
                const typeCtx = document.getElementById('resourcesTypeChart');
                if (typeCtx && sortedTypes.length > 0) {
                    const typeChart = new Chart(typeCtx, {
                        type: 'doughnut',
                        data: {
                            labels: sortedTypes.map(([type]) => type),
                            datasets: [{
                                data: sortedTypes.map(([, count]) => count),
                                backgroundColor: [
                                    '#3498db', '#2ecc71', '#f39c12', '#e74c3c',
                                    '#9b59b6', '#1abc9c', '#d35400', '#34495e'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Types de ressources'
                                },
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                    charts.resourcesTypeChart = typeChart;
                }
                
                // Graphique par matière
                const subjectCtx = document.getElementById('resourcesSubjectChart');
                if (subjectCtx && sortedSubjects.length > 0) {
                    const subjectChart = new Chart(subjectCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedSubjects.map(([subject]) => subject),
                            datasets: [{
                                label: 'Nombre de ressources',
                                data: sortedSubjects.map(([, count]) => count),
                                backgroundColor: '#1abc9c'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Ressources par matière'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre de ressources'
                                    }
                                }
                            }
                        }
                    });
                    charts.resourcesSubjectChart = subjectChart;
                }
            }, 100);
        }

        // Analyse formation
        function updateTrainingAnalysis() {
            updateTrainingStats();
        }

        function updateTrainingStats() {
            const container = document.getElementById('trainingStats');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Calculer les statistiques de formation
            const totalTrainings = teachersData.reduce((sum, t) => sum + (t.trainingCount || 0), 0);
            
            // Compter les enseignants avec diplômes
            const teachersWithDiplomas = teachersData.filter(t => 
                t.data && t.data.diplomas && t.data.diplomas.length > 0
            ).length;
            
            // Compter les enseignants avec formations continues
            const teachersWithContinuous = teachersData.filter(t => 
                t.data && t.data.trainings && t.data.trainings.length > 0
            ).length;
            
            // Compter les enseignants avec compétences linguistiques
            const teachersWithLanguages = teachersData.filter(t => 
                t.data && t.data.languages && t.data.languages.length > 0
            ).length;
            
            // Compter les enseignants avec compétences IT
            const teachersWithIT = teachersData.filter(t => 
                t.data && t.data.itskills && t.data.itskills.length > 0
            ).length;
            
            const html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div>Formations totales</div>
                        <div class="stat-value">${totalTrainings}</div>
                    </div>
                    <div class="stat-card">
                        <div>Enseignants avec diplômes</div>
                        <div class="stat-value">${teachersWithDiplomas}</div>
                        <div>${teachersData.length > 0 ? Math.round((teachersWithDiplomas / teachersData.length) * 100) : 0}%</div>
                    </div>
                    <div class="stat-card">
                        <div>Formations continues</div>
                        <div class="stat-value">${teachersWithContinuous}</div>
                        <div>${teachersData.length > 0 ? Math.round((teachersWithContinuous / teachersData.length) * 100) : 0}%</div>
                    </div>
                    <div class="stat-card">
                        <div>Compétences linguistiques</div>
                        <div class="stat-value">${teachersWithLanguages}</div>
                        <div>${teachersData.length > 0 ? Math.round((teachersWithLanguages / teachersData.length) * 100) : 0}%</div>
                    </div>
                    <div class="stat-card">
                        <div>Compétences informatiques</div>
                        <div class="stat-value">${teachersWithIT}</div>
                        <div>${teachersData.length > 0 ? Math.round((teachersWithIT / teachersData.length) * 100) : 0}%</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function updateDiplomasAnalysis() {
            const container = document.getElementById('diplomasAnalysis');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Analyser les diplômes
            const teachersWithDiplomas = teachersData.filter(t => 
                t.data && t.data.diplomas && t.data.diplomas.length > 0
            );
            
            if (teachersWithDiplomas.length === 0) {
                container.innerHTML = '<p class="text-center">Aucun diplôme enregistré</p>';
                return;
            }
            
            // Compter les diplômes par type
            const diplomasByType = {};
            const diplomasByYear = {};
            const diplomasByLevel = {};
            
            teachersWithDiplomas.forEach(teacher => {
                if (teacher.data && teacher.data.diplomas) {
                    teacher.data.diplomas.forEach(diploma => {
                        // Par type
                        if (diploma.type) {
                            diplomasByType[diploma.type] = (diplomasByType[diploma.type] || 0) + 1;
                        }
                        
                        // Par année
                        if (diploma.year) {
                            diplomasByYear[diploma.year] = (diplomasByYear[diploma.year] || 0) + 1;
                        }
                        
                        // Par niveau
                        if (diploma.level) {
                            diplomasByLevel[diploma.level] = (diplomasByLevel[diploma.level] || 0) + 1;
                        }
                    });
                }
            });
            
            // Trier les types par fréquence
            const sortedTypes = Object.entries(diplomasByType)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Trier les années
            const sortedYears = Object.entries(diplomasByYear)
                .sort(([a], [b]) => a.localeCompare(b))
                .filter(([year]) => parseInt(year) > 2000)
                .slice(-8);
            
            let html = `
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-bar"></i> Diplômes par type</h4>
                        <div class="chart-container">
                            <canvas id="diplomasTypeChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-line"></i> Évolution par année</h4>
                        <div class="chart-container">
                            <canvas id="diplomasYearChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-chart-pie"></i> Statistiques des diplômes</h4>
                    <div class="stats-grid">
            `;
            
            // Calculer les statistiques
            const totalDiplomas = teachersWithDiplomas.reduce((sum, t) => 
                sum + (t.data.diplomas ? t.data.diplomas.length : 0), 0
            );
            
            const avgDiplomasPerTeacher = Math.round(totalDiplomas / teachersWithDiplomas.length * 10) / 10;
            
            // Niveau de formation le plus commun
            const mostCommonLevel = Object.entries(diplomasByLevel)
                .sort((a, b) => b[1] - a[1])[0];
            
            // Type de diplôme le plus commun
            const mostCommonType = sortedTypes.length > 0 ? sortedTypes[0] : null;
            
            html += `
                        <div class="stat-card">
                            <div>Enseignants avec diplômes</div>
                            <div class="stat-value">${teachersWithDiplomas.length}</div>
                            <div>${Math.round((teachersWithDiplomas.length / teachersData.length) * 100)}%</div>
                        </div>
                        <div class="stat-card">
                            <div>Diplômes totaux</div>
                            <div class="stat-value">${totalDiplomas}</div>
                        </div>
                        <div class="stat-card">
                            <div>Diplômes/enseignant moy.</div>
                            <div class="stat-value">${avgDiplomasPerTeacher}</div>
                        </div>
                        <div class="stat-card">
                            <div>Niveau le plus commun</div>
                            <div class="stat-value">${mostCommonLevel ? mostCommonLevel[0] : 'N/A'}</div>
                            <div>${mostCommonLevel ? mostCommonLevel[1] : 0}</div>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-list"></i> Types de diplômes</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Nombre</th>
                                <th>Pourcentage</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedTypes.forEach(([type, count]) => {
                const percentage = Math.round((count / totalDiplomas) * 100);
                let description = '';
                
                switch(type.toLowerCase()) {
                    case 'licence':
                    case 'bachelor':
                        description = 'Diplôme de niveau Licence (Bac+3)';
                        break;
                    case 'master':
                        description = 'Diplôme de niveau Master (Bac+5)';
                        break;
                    case 'doctorat':
                    case 'phd':
                        description = 'Diplôme de niveau Doctorat (Bac+8)';
                        break;
                    case 'capes':
                        description = 'Certificat d\'Aptitude au Professorat de l\'Enseignement du Second degré';
                        break;
                    case 'agrégation':
                        description = 'Concours d\'agrégation pour l\'enseignement secondaire';
                        break;
                    case 'diplôme d\'état':
                        description = 'Diplôme d\'État dans une spécialité';
                        break;
                    case 'certificat':
                        description = 'Certificat de spécialisation ou de compétence';
                        break;
                    default:
                        description = 'Diplôme académique ou professionnel';
                }
                
                html += `
                    <tr>
                        <td>${type}</td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                        <td>${description}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-award"></i> Enseignants avec les diplômes les plus élevés</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Enseignant</th>
                                <th>Diplôme le plus élevé</th>
                                <th>Année</th>
                                <th>Établissement</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Trouver les enseignants avec les diplômes les plus élevés
            const teachersByHighestDiploma = teachersWithDiplomas
                .map(teacher => {
                    let highestLevel = 0;
                    let highestDiploma = null;
                    
                    if (teacher.data.diplomas) {
                        teacher.data.diplomas.forEach(diploma => {
                            let level = 0;
                            const diplomaName = diploma.name || '';
                            const diplomaType = diploma.type || '';
                            
                            if (diplomaName.includes('Doctorat') || diplomaType.includes('Doctorat')) level = 3;
                            else if (diplomaName.includes('Master') || diplomaType.includes('Master')) level = 2;
                            else if (diplomaName.includes('Licence') || diplomaType.includes('Licence')) level = 1;
                            
                            if (level > highestLevel) {
                                highestLevel = level;
                                highestDiploma = diploma;
                            }
                        });
                    }
                    
                    return {
                        teacher,
                        highestDiploma,
                        highestLevel
                    };
                })
                .filter(t => t.highestDiploma)
                .sort((a, b) => b.highestLevel - a.highestLevel)
                .slice(0, 10);
            
            teachersByHighestDiploma.forEach(item => {
                const diploma = item.highestDiploma;
                html += `
                    <tr>
                        <td>${item.teacher.fullName}</td>
                        <td>${diploma.name || diploma.type || 'Diplôme'}</td>
                        <td>${diploma.year || 'N/A'}</td>
                        <td>${diploma.institution || 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Créer les graphiques
            setTimeout(() => {
                // Graphique des types
                const typeCtx = document.getElementById('diplomasTypeChart');
                if (typeCtx && sortedTypes.length > 0) {
                    const typeChart = new Chart(typeCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedTypes.map(([type]) => type),
                            datasets: [{
                                label: 'Nombre de diplômes',
                                data: sortedTypes.map(([, count]) => count),
                                backgroundColor: '#3498db'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Types de diplômes'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre de diplômes'
                                    }
                                }
                            }
                        }
                    });
                    charts.diplomasTypeChart = typeChart;
                }
                
                // Graphique par année
                const yearCtx = document.getElementById('diplomasYearChart');
                if (yearCtx && sortedYears.length > 0) {
                    const yearChart = new Chart(yearCtx, {
                        type: 'line',
                        data: {
                            labels: sortedYears.map(([year]) => year),
                            datasets: [{
                                label: 'Nombre de diplômes',
                                data: sortedYears.map(([, count]) => count),
                                borderColor: '#2ecc71',
                                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Diplômes par année'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre de diplômes'
                                    }
                                }
                            }
                        }
                    });
                    charts.diplomasYearChart = yearChart;
                }
            }, 100);
        }

        function updateContinuousTrainingAnalysis() {
            const container = document.getElementById('continuousTrainingAnalysis');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Analyser les formations continues
            const teachersWithTraining = teachersData.filter(t => 
                t.data && t.data.trainings && t.data.trainings.length > 0
            );
            
            if (teachersWithTraining.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune formation continue enregistrée</p>';
                return;
            }
            
            // Compter les formations par type
            const trainingsByType = {};
            const trainingsByYear = {};
            const trainingsByDuration = { '≤ 1 jour': 0, '2-3 jours': 0, '4-7 jours': 0, '1-2 semaines': 0, '> 2 semaines': 0 };
            
            let totalDuration = 0;
            let totalTrainings = 0;
            
            teachersWithTraining.forEach(teacher => {
                if (teacher.data && teacher.data.trainings) {
                    teacher.data.trainings.forEach(training => {
                        totalTrainings++;
                        
                        // Par type
                        if (training.type) {
                            trainingsByType[training.type] = (trainingsByType[training.type] || 0) + 1;
                        }
                        
                        // Par année
                        if (training.year) {
                            trainingsByYear[training.year] = (trainingsByYear[training.year] || 0) + 1;
                        }
                        
                        // Par durée
                        if (training.duration) {
                            const duration = parseInt(training.duration) || 0;
                            totalDuration += duration;
                            
                            if (duration <= 1) trainingsByDuration['≤ 1 jour']++;
                            else if (duration <= 3) trainingsByDuration['2-3 jours']++;
                            else if (duration <= 7) trainingsByDuration['4-7 jours']++;
                            else if (duration <= 14) trainingsByDuration['1-2 semaines']++;
                            else trainingsByDuration['> 2 semaines']++;
                        }
                    });
                }
            });
            
            // Trier les types par fréquence
            const sortedTypes = Object.entries(trainingsByType)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Trier les années
            const sortedYears = Object.entries(trainingsByYear)
                .sort(([a], [b]) => a.localeCompare(b))
                .filter(([year]) => parseInt(year) > 2010)
                .slice(-6);
            
            let html = `
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-bar"></i> Formations par type</h4>
                        <div class="chart-container">
                            <canvas id="trainingsTypeChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-line"></i> Évolution par année</h4>
                        <div class="chart-container">
                            <canvas id="trainingsYearChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-grid mt-30">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-pie"></i> Durée des formations</h4>
                        <div class="chart-container">
                            <canvas id="trainingsDurationChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-area"></i> Statistiques</h4>
                        <div class="stats-grid" style="grid-template-columns: 1fr;">
            `;
            
            // Calculer les statistiques
            const avgTrainingsPerTeacher = Math.round(totalTrainings / teachersWithTraining.length * 10) / 10;
            const avgDuration = totalTrainings > 0 ? Math.round(totalDuration / totalTrainings * 10) / 10 : 0;
            
            // Type de formation le plus commun
            const mostCommonType = sortedTypes.length > 0 ? sortedTypes[0] : null;
            
            html += `
                            <div class="stat-card">
                                <div>Enseignants formés</div>
                                <div class="stat-value">${teachersWithTraining.length}</div>
                                <div>${Math.round((teachersWithTraining.length / teachersData.length) * 100)}%</div>
                            </div>
                            <div class="stat-card">
                                <div>Formations totales</div>
                                <div class="stat-value">${totalTrainings}</div>
                            </div>
                            <div class="stat-card">
                                <div>Formations/enseignant moy.</div>
                                <div class="stat-value">${avgTrainingsPerTeacher}</div>
                            </div>
                            <div class="stat-card">
                                <div>Durée moyenne</div>
                                <div class="stat-value">${avgDuration} jours</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-list"></i> Types de formations</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Nombre</th>
                                <th>Pourcentage</th>
                                <th>Thématiques courantes</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedTypes.forEach(([type, count]) => {
                const percentage = Math.round((count / totalTrainings) * 100);
                let themes = '';
                
                switch(type.toLowerCase()) {
                    case 'pédagogique':
                        themes = 'Nouvelles méthodes pédagogiques, différenciation, évaluation';
                        break;
                    case 'numérique':
                        themes = 'Outils numériques, TICE, plateformes éducatives';
                        break;
                    case 'disciplinaire':
                        themes = 'Actualisation des connaissances disciplinaires';
                        break;
                    case 'gestion de classe':
                        themes = 'Gestion des conflits, autorité, climat scolaire';
                        break;
                    case 'éducation inclusive':
                        themes = 'Handicap, besoins éducatifs particuliers, inclusion';
                        break;
                    case 'sécurité':
                        themes = 'Sécurité incendie, gestes de premiers secours, PPMS';
                        break;
                    case 'orientation':
                        themes = 'Orientation scolaire, parcours Avenir';
                        break;
                    default:
                        themes = 'Divers thématiques éducatives';
                }
                
                html += `
                    <tr>
                        <td>${type}</td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                        <td>${themes}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Créer les graphiques
            setTimeout(() => {
                // Graphique des types
                const typeCtx = document.getElementById('trainingsTypeChart');
                if (typeCtx && sortedTypes.length > 0) {
                    const typeChart = new Chart(typeCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedTypes.map(([type]) => type),
                            datasets: [{
                                label: 'Nombre de formations',
                                data: sortedTypes.map(([, count]) => count),
                                backgroundColor: '#f39c12'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Types de formations continues'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre de formations'
                                    }
                                }
                            }
                        }
                    });
                    charts.trainingsTypeChart = typeChart;
                }
                
                // Graphique par année
                const yearCtx = document.getElementById('trainingsYearChart');
                if (yearCtx && sortedYears.length > 0) {
                    const yearChart = new Chart(yearCtx, {
                        type: 'line',
                        data: {
                            labels: sortedYears.map(([year]) => year),
                            datasets: [{
                                label: 'Nombre de formations',
                                data: sortedYears.map(([, count]) => count),
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Évolution des formations par année'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre de formations'
                                    }
                                }
                            }
                        }
                    });
                    charts.trainingsYearChart = yearChart;
                }
                
                // Graphique de durée
                const durationCtx = document.getElementById('trainingsDurationChart');
                if (durationCtx) {
                    const durationChart = new Chart(durationCtx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(trainingsByDuration),
                            datasets: [{
                                data: Object.values(trainingsByDuration),
                                backgroundColor: [
                                    '#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Durée des formations'
                                },
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                    charts.trainingsDurationChart = durationChart;
                }
            }, 100);
        }

        function updateLanguagesAnalysis() {
            const container = document.getElementById('languagesAnalysis');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Analyser les compétences linguistiques
            const teachersWithLanguages = teachersData.filter(t => 
                t.data && t.data.languages && t.data.languages.length > 0
            );
            
            if (teachersWithLanguages.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune compétence linguistique enregistrée</p>';
                return;
            }
            
            // Compter les langues
            const languagesCount = {};
            const languagesByLevel = {};
            const teachersByNumberOfLanguages = { 1: 0, 2: 0, 3: 0, '4+': 0 };
            
            teachersWithLanguages.forEach(teacher => {
                if (teacher.data && teacher.data.languages) {
                    const numLanguages = teacher.data.languages.length;
                    if (numLanguages === 1) teachersByNumberOfLanguages[1]++;
                    else if (numLanguages === 2) teachersByNumberOfLanguages[2]++;
                    else if (numLanguages === 3) teachersByNumberOfLanguages[3]++;
                    else teachersByNumberOfLanguages['4+']++;
                    
                    teacher.data.languages.forEach(lang => {
                        if (lang.name) {
                            // Compter la langue
                            languagesCount[lang.name] = (languagesCount[lang.name] || 0) + 1;
                            
                            // Compter par niveau
                            if (lang.level) {
                                if (!languagesByLevel[lang.name]) {
                                    languagesByLevel[lang.name] = {};
                                }
                                languagesByLevel[lang.name][lang.level] = (languagesByLevel[lang.name][lang.level] || 0) + 1;
                            }
                        }
                    });
                }
            });
            
            // Trier les langues par fréquence
            const sortedLanguages = Object.entries(languagesCount)
                .sort((a, b) => b[1] - a[1]);
            
            // Préparer les données par niveau pour les principales langues
            const topLanguages = sortedLanguages.slice(0, 6);
            
            let html = `
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-globe"></i> Langues les plus maîtrisées</h4>
                        <div class="chart-container">
                            <canvas id="languagesChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-layer-group"></i> Nombre de langues par enseignant</h4>
                        <div class="chart-container">
                            <canvas id="languagesPerTeacherChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-chart-bar"></i> Statistiques linguistiques</h4>
                    <div class="stats-grid">
            `;
            
            // Calculer les statistiques
            const totalLanguages = teachersWithLanguages.reduce((sum, t) => 
                sum + (t.data.languages ? t.data.languages.length : 0), 0
            );
            
            const avgLanguagesPerTeacher = Math.round(totalLanguages / teachersWithLanguages.length * 10) / 10;
            
            // Langue la plus courante
            const mostCommonLanguage = sortedLanguages.length > 0 ? sortedLanguages[0] : null;
            
            // Pourcentage d'enseignants avec au moins 2 langues
            const teachersWithMultipleLanguages = teachersByNumberOfLanguages[2] + teachersByNumberOfLanguages[3] + teachersByNumberOfLanguages['4+'];
            const percentageMultiple = Math.round((teachersWithMultipleLanguages / teachersWithLanguages.length) * 100);
            
            html += `
                        <div class="stat-card">
                            <div>Enseignants avec langues</div>
                            <div class="stat-value">${teachersWithLanguages.length}</div>
                            <div>${Math.round((teachersWithLanguages.length / teachersData.length) * 100)}%</div>
                        </div>
                        <div class="stat-card">
                            <div>Langues totales</div>
                            <div class="stat-value">${totalLanguages}</div>
                        </div>
                        <div class="stat-card">
                            <div>Langues/enseignant moy.</div>
                            <div class="stat-value">${avgLanguagesPerTeacher}</div>
                        </div>
                        <div class="stat-card">
                            <div>Langue la plus courante</div>
                            <div class="stat-value">${mostCommonLanguage ? mostCommonLanguage[0] : 'N/A'}</div>
                            <div>${mostCommonLanguage ? mostCommonLanguage[1] : 0} enseignants</div>
                        </div>
                        <div class="stat-card">
                            <div>≥ 2 langues</div>
                            <div class="stat-value">${teachersWithMultipleLanguages}</div>
                            <div>${percentageMultiple}%</div>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-list"></i> Détail par langue</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Langue</th>
                                <th>Nombre d'enseignants</th>
                                <th>Pourcentage</th>
                                <th>Niveaux (Débutant/Intermédiaire/Avancé)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedLanguages.forEach(([language, count]) => {
                const percentage = Math.round((count / teachersWithLanguages.length) * 100);
                const levelData = languagesByLevel[language] || {};
                
                const beginner = levelData['Débutant'] || levelData['A1'] || levelData['A2'] || 0;
                const intermediate = levelData['Intermédiaire'] || levelData['B1'] || levelData['B2'] || 0;
                const advanced = levelData['Avancé'] || levelData['C1'] || levelData['C2'] || 0;
                
                html += `
                    <tr>
                        <td><strong>${language}</strong></td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                        <td>${beginner}/${intermediate}/${advanced}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Créer les graphiques
            setTimeout(() => {
                // Graphique des langues
                const languagesCtx = document.getElementById('languagesChart');
                if (languagesCtx && sortedLanguages.length > 0) {
                    const languagesChart = new Chart(languagesCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedLanguages.slice(0, 10).map(([lang]) => lang),
                            datasets: [{
                                label: 'Nombre d\'enseignants',
                                data: sortedLanguages.slice(0, 10).map(([, count]) => count),
                                backgroundColor: '#3498db'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Langues les plus maîtrisées'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre d\'enseignants'
                                    }
                                }
                            }
                        }
                    });
                    charts.languagesChart = languagesChart;
                }
                
                // Graphique du nombre de langues par enseignant
                const perTeacherCtx = document.getElementById('languagesPerTeacherChart');
                if (perTeacherCtx) {
                    const perTeacherChart = new Chart(perTeacherCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['1 langue', '2 langues', '3 langues', '4 langues ou plus'],
                            datasets: [{
                                data: [
                                    teachersByNumberOfLanguages[1],
                                    teachersByNumberOfLanguages[2],
                                    teachersByNumberOfLanguages[3],
                                    teachersByNumberOfLanguages['4+']
                                ],
                                backgroundColor: [
                                    '#3498db', '#2ecc71', '#f39c12', '#9b59b6'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Nombre de langues par enseignant'
                                },
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                    charts.languagesPerTeacherChart = perTeacherChart;
                }
            }, 100);
        }

        function updateITSkillsAnalysis() {
            const container = document.getElementById('itSkillsAnalysis');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Analyser les compétences informatiques
            const teachersWithIT = teachersData.filter(t => 
                t.data && t.data.itskills && t.data.itskills.length > 0
            );
            
            if (teachersWithIT.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune compétence informatique enregistrée</p>';
                return;
            }
            
            // Compter les compétences par catégorie
            const skillsByCategory = {};
            const skillsByLevel = {};
            const teachersByNumberOfSkills = { 1: 0, 2: 0, 3: 0, '4+': 0 };
            
            teachersWithIT.forEach(teacher => {
                if (teacher.data && teacher.data.itskills) {
                    const numSkills = teacher.data.itskills.length;
                    if (numSkills === 1) teachersByNumberOfSkills[1]++;
                    else if (numSkills === 2) teachersByNumberOfSkills[2]++;
                    else if (numSkills === 3) teachersByNumberOfSkills[3]++;
                    else teachersByNumberOfSkills['4+']++;
                    
                    teacher.data.itskills.forEach(skill => {
                        if (skill.category) {
                            // Compter par catégorie
                            skillsByCategory[skill.category] = (skillsByCategory[skill.category] || 0) + 1;
                            
                            // Compter par niveau dans chaque catégorie
                            if (skill.level) {
                                if (!skillsByLevel[skill.category]) {
                                    skillsByLevel[skill.category] = {};
                                }
                                skillsByLevel[skill.category][skill.level] = (skillsByLevel[skill.category][skill.level] || 0) + 1;
                            }
                        }
                    });
                }
            });
            
            // Trier les catégories par fréquence
            const sortedCategories = Object.entries(skillsByCategory)
                .sort((a, b) => b[1] - a[1]);
            
            // Catégories principales
            const mainCategories = [
                { name: 'Bureautique', skills: ['Word', 'Excel', 'PowerPoint', 'Outlook'] },
                { name: 'Communication', skills: ['Email', 'Messagerie', 'Visioconférence', 'Réseaux sociaux'] },
                { name: 'Pédagogie numérique', skills: ['ENT', 'LMS', 'Outils interactifs', 'Quiz en ligne'] },
                { name: 'Multimédia', skills: ['Traitement image', 'Montage vidéo', 'Audio', 'Graphisme'] },
                { name: 'Programmation', skills: ['HTML/CSS', 'Python', 'JavaScript', 'Algorithmique'] }
            ];
            
            let html = `
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-laptop-code"></i> Compétences par catégorie</h4>
                        <div class="chart-container">
                            <canvas id="itSkillsChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-pie"></i> Nombre de compétences par enseignant</h4>
                        <div class="chart-container">
                            <canvas id="itSkillsPerTeacherChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-chart-bar"></i> Statistiques des compétences informatiques</h4>
                    <div class="stats-grid">
            `;
            
            // Calculer les statistiques
            const totalSkills = teachersWithIT.reduce((sum, t) => 
                sum + (t.data.itskills ? t.data.itskills.length : 0), 0
            );
            
            const avgSkillsPerTeacher = Math.round(totalSkills / teachersWithIT.length * 10) / 10;
            
            // Catégorie la plus courante
            const mostCommonCategory = sortedCategories.length > 0 ? sortedCategories[0] : null;
            
            html += `
                        <div class="stat-card">
                            <div>Enseignants avec compétences IT</div>
                            <div class="stat-value">${teachersWithIT.length}</div>
                            <div>${Math.round((teachersWithIT.length / teachersData.length) * 100)}%</div>
                        </div>
                        <div class="stat-card">
                            <div>Compétences totales</div>
                            <div class="stat-value">${totalSkills}</div>
                        </div>
                        <div class="stat-card">
                            <div>Compétences/enseignant moy.</div>
                            <div class="stat-value">${avgSkillsPerTeacher}</div>
                        </div>
                        <div class="stat-card">
                            <div>Catégorie la plus courante</div>
                            <div class="stat-value">${mostCommonCategory ? mostCommonCategory[0] : 'N/A'}</div>
                            <div>${mostCommonCategory ? mostCommonCategory[1] : 0}</div>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-list"></i> Catégories de compétences</h4>
                    <div class="dashboard-grid">
            `;
            
            // Afficher chaque catégorie principale
            mainCategories.forEach(category => {
                const categoryData = skillsByLevel[category.name] || {};
                const totalInCategory = skillsByCategory[category.name] || 0;
                const percentage = Math.round((totalInCategory / teachersWithIT.length) * 100);
                
                html += `
                    <div class="dashboard-card">
                        <h5><i class="fas fa-folder"></i> ${category.name}</h5>
                        <p><strong>${totalInCategory}</strong> mentions (${percentage}% des enseignants)</p>
                        <ul style="padding-left: 20px; margin-top: 10px;">
                `;
                
                // Afficher les niveaux
                Object.entries(categoryData).forEach(([level, count]) => {
                    const levelPercentage = Math.round((count / totalInCategory) * 100);
                    html += `<li>${level}: ${count} (${levelPercentage}%)</li>`;
                });
                
                html += `
                        </ul>
                        <p class="mt-10"><small>Compétences typiques: ${category.skills.join(', ')}</small></p>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-lightbulb"></i> Recommandations</h4>
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <h5><i class="fas fa-graduation-cap"></i> Formation recommandée</h5>
                            <ul>
                                <li>Développer les compétences en pédagogie numérique</li>
                                <li>Former aux outils de visioconférence et collaboration</li>
                                <li>Améliorer les compétences bureautiques avancées</li>
                            </ul>
                        </div>
                        <div class="dashboard-card">
                            <h5><i class="fas fa-tools"></i> Outils à promouvoir</h5>
                            <ul>
                                <li>Environnements Numériques de Travail (ENT)</li>
                                <li>Plateformes d'apprentissage en ligne (LMS)</li>
                                <li>Outils de création de contenu interactif</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Créer les graphiques
            setTimeout(() => {
                // Graphique des compétences
                const skillsCtx = document.getElementById('itSkillsChart');
                if (skillsCtx && sortedCategories.length > 0) {
                    const skillsChart = new Chart(skillsCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedCategories.slice(0, 8).map(([category]) => category),
                            datasets: [{
                                label: 'Nombre de mentions',
                                data: sortedCategories.slice(0, 8).map(([, count]) => count),
                                backgroundColor: '#2ecc71'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Compétences informatiques par catégorie'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre de mentions'
                                    }
                                }
                            }
                        }
                    });
                    charts.itSkillsChart = skillsChart;
                }
                
                // Graphique du nombre de compétences par enseignant
                const perTeacherCtx = document.getElementById('itSkillsPerTeacherChart');
                if (perTeacherCtx) {
                    const perTeacherChart = new Chart(perTeacherCtx, {
                        type: 'pie',
                        data: {
                            labels: ['1 compétence', '2 compétences', '3 compétences', '4 compétences ou plus'],
                            datasets: [{
                                data: [
                                    teachersByNumberOfSkills[1],
                                    teachersByNumberOfSkills[2],
                                    teachersByNumberOfSkills[3],
                                    teachersByNumberOfSkills['4+']
                                ],
                                backgroundColor: [
                                    '#3498db', '#2ecc71', '#f39c12', '#9b59b6'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Nombre de compétences par enseignant'
                                },
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                    charts.itSkillsPerTeacherChart = perTeacherChart;
                }
            }, 100);
        }

        // Analyse projets
        function updateProjectsAnalysis() {
            updateProjectsStats();
        }

        function updateProjectsStats() {
            const container = document.getElementById('projectsStats');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Calculer les statistiques des projets
            const totalProjects = teachersData.reduce((sum, t) => sum + (t.projectCount || 0), 0);
            
            // Compter les enseignants avec projets pédagogiques
            const teachersWithProjects = teachersData.filter(t => 
                t.data && t.data.projects && t.data.projects.length > 0
            ).length;
            
            // Compter les enseignants avec activités extrascolaires
            const teachersWithActivities = teachersData.filter(t => 
                t.data && t.data.activities && t.data.activities.length > 0
            ).length;
            
            // Compter les enseignants avec réunions
            const teachersWithMeetings = teachersData.filter(t => 
                t.data && t.data.meetings && t.data.meetings.length > 0
            ).length;
            
            const html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div>Projets totaux</div>
                        <div class="stat-value">${totalProjects}</div>
                    </div>
                    <div class="stat-card">
                        <div>Enseignants avec projets</div>
                        <div class="stat-value">${teachersWithProjects}</div>
                        <div>${teachersData.length > 0 ? Math.round((teachersWithProjects / teachersData.length) * 100) : 0}%</div>
                    </div>
                    <div class="stat-card">
                        <div>Activités extrascolaires</div>
                        <div class="stat-value">${teachersWithActivities}</div>
                        <div>${teachersData.length > 0 ? Math.round((teachersWithActivities / teachersData.length) * 100) : 0}%</div>
                    </div>
                    <div class="stat-card">
                        <div>Réunions enregistrées</div>
                        <div class="stat-value">${teachersWithMeetings}</div>
                        <div>${teachersData.length > 0 ? Math.round((teachersWithMeetings / teachersData.length) * 100) : 0}%</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function updatePedagogicalProjectsAnalysis() {
            const container = document.getElementById('pedagogicalProjectsAnalysis');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Analyser les projets pédagogiques
            const teachersWithProjects = teachersData.filter(t => 
                t.data && t.data.projects && t.data.projects.length > 0
            );
            
            if (teachersWithProjects.length === 0) {
                container.innerHTML = '<p class="text-center">Aucun projet pédagogique enregistré</p>';
                return;
            }
            
            // Compter les projets par type
            const projectsByType = {};
            const projectsByStatus = {};
            const projectsByDuration = { 'Court (≤ 1 mois)': 0, 'Moyen (1-3 mois)': 0, 'Long (> 3 mois)': 0 };
            
            let totalProjects = 0;
            
            teachersWithProjects.forEach(teacher => {
                if (teacher.data && teacher.data.projects) {
                    teacher.data.projects.forEach(project => {
                        totalProjects++;
                        
                        // Par type
                        if (project.type) {
                            projectsByType[project.type] = (projectsByType[project.type] || 0) + 1;
                        }
                        
                        // Par statut
                        if (project.status) {
                            projectsByStatus[project.status] = (projectsByStatus[project.status] || 0) + 1;
                        }
                        
                        // Par durée
                        if (project.duration) {
                            const duration = project.duration.toLowerCase();
                            if (duration.includes('court') || duration.includes('≤') || duration.includes('moins')) {
                                projectsByDuration['Court (≤ 1 mois)']++;
                            } else if (duration.includes('moyen') || duration.includes('1-3') || duration.includes('trimestre')) {
                                projectsByDuration['Moyen (1-3 mois)']++;
                            } else {
                                projectsByDuration['Long (> 3 mois)']++;
                            }
                        }
                    });
                }
            });
            
            // Trier les types par fréquence
            const sortedTypes = Object.entries(projectsByType)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            let html = `
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-bar"></i> Projets par type</h4>
                        <div class="chart-container">
                            <canvas id="projectsTypeChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-pie"></i> Statut des projets</h4>
                        <div class="chart-container">
                            <canvas id="projectsStatusChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-grid mt-30">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-clock"></i> Durée des projets</h4>
                        <div class="chart-container">
                            <canvas id="projectsDurationChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-area"></i> Statistiques</h4>
                        <div class="stats-grid" style="grid-template-columns: 1fr;">
            `;
            
            // Calculer les statistiques
            const avgProjectsPerTeacher = Math.round(totalProjects / teachersWithProjects.length * 10) / 10;
            
            // Type de projet le plus commun
            const mostCommonType = sortedTypes.length > 0 ? sortedTypes[0] : null;
            
            // Pourcentage de projets terminés
            const completedProjects = projectsByStatus['Terminé'] || projectsByStatus['Complété'] || 0;
            const completionRate = Math.round((completedProjects / totalProjects) * 100);
            
            html += `
                            <div class="stat-card">
                                <div>Enseignants avec projets</div>
                                <div class="stat-value">${teachersWithProjects.length}</div>
                                <div>${Math.round((teachersWithProjects.length / teachersData.length) * 100)}%</div>
                            </div>
                            <div class="stat-card">
                                <div>Projets totaux</div>
                                <div class="stat-value">${totalProjects}</div>
                            </div>
                            <div class="stat-card">
                                <div>Projets/enseignant moy.</div>
                                <div class="stat-value">${avgProjectsPerTeacher}</div>
                            </div>
                            <div class="stat-card">
                                <div>Taux de complétion</div>
                                <div class="stat-value">${completionRate}%</div>
                                <div>${completedProjects}/${totalProjects}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-list"></i> Types de projets pédagogiques</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Nombre</th>
                                <th>Pourcentage</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedTypes.forEach(([type, count]) => {
                const percentage = Math.round((count / totalProjects) * 100);
                let description = '';
                
                switch(type.toLowerCase()) {
                    case 'interdisciplinaire':
                        description = 'Projet impliquant plusieurs matières';
                        break;
                    case 'artistique':
                        description = 'Projet à dominante artistique ou culturelle';
                        break;
                    case 'scientifique':
                        description = 'Projet de recherche ou expérimentation scientifique';
                        break;
                    case 'citoyen':
                        description = 'Projet d\'éducation civique ou citoyenne';
                        break;
                    case 'numérique':
                        description = 'Projet utilisant le numérique comme support';
                        break;
                    case 'environnemental':
                        description = 'Projet lié au développement durable ou écologie';
                        break;
                    case 'international':
                        description = 'Projet avec dimension internationale (échanges)';
                        break;
                    default:
                        description = 'Projet pédagogique innovant';
                }
                
                html += `
                    <tr>
                        <td>${type}</td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                        <td>${description}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Créer les graphiques
            setTimeout(() => {
                // Graphique des types
                const typeCtx = document.getElementById('projectsTypeChart');
                if (typeCtx && sortedTypes.length > 0) {
                    const typeChart = new Chart(typeCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedTypes.map(([type]) => type),
                            datasets: [{
                                label: 'Nombre de projets',
                                data: sortedTypes.map(([, count]) => count),
                                backgroundColor: '#9b59b6'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Types de projets pédagogiques'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre de projets'
                                    }
                                }
                            }
                        }
                    });
                    charts.projectsTypeChart = typeChart;
                }
                
                // Graphique des statuts
                const statusCtx = document.getElementById('projectsStatusChart');
                if (statusCtx && Object.keys(projectsByStatus).length > 0) {
                    const statusChart = new Chart(statusCtx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(projectsByStatus),
                            datasets: [{
                                data: Object.values(projectsByStatus),
                                backgroundColor: [
                                    '#2ecc71', '#f39c12', '#e74c3c', '#3498db'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Statut des projets'
                                },
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                    charts.projectsStatusChart = statusChart;
                }
                
                // Graphique de durée
                const durationCtx = document.getElementById('projectsDurationChart');
                if (durationCtx) {
                    const durationChart = new Chart(durationCtx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(projectsByDuration),
                            datasets: [{
                                data: Object.values(projectsByDuration),
                                backgroundColor: [
                                    '#3498db', '#f39c12', '#e74c3c'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Durée des projets'
                                },
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                    charts.projectsDurationChart = durationChart;
                }
            }, 100);
        }

        function updateActivitiesAnalysis() {
            const container = document.getElementById('activitiesAnalysis');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Analyser les activités extrascolaires
            const teachersWithActivities = teachersData.filter(t => 
                t.data && t.data.activities && t.data.activities.length > 0
            );
            
            if (teachersWithActivities.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune activité extrascolaire enregistrée</p>';
                return;
            }
            
            // Compter les activités par type
            const activitiesByType = {};
            const activitiesByFrequency = {};
            const participationByActivity = {};
            
            let totalActivities = 0;
            let totalParticipants = 0;
            
            teachersWithActivities.forEach(teacher => {
                if (teacher.data && teacher.data.activities) {
                    teacher.data.activities.forEach(activity => {
                        totalActivities++;
                        
                        // Par type
                        if (activity.type) {
                            activitiesByType[activity.type] = (activitiesByType[activity.type] || 0) + 1;
                        }
                        
                        // Par fréquence
                        if (activity.frequency) {
                            activitiesByFrequency[activity.frequency] = (activitiesByFrequency[activity.frequency] || 0) + 1;
                        }
                        
                        // Compter les participants
                        if (activity.name) {
                            if (!participationByActivity[activity.name]) {
                                participationByActivity[activity.name] = {
                                    count: 0,
                                    teachers: []
                                };
                            }
                            participationByActivity[activity.name].count++;
                            participationByActivity[activity.name].teachers.push(teacher.fullName);
                        }
                        
                        // Total des participants estimés
                        if (activity.participants) {
                            totalParticipants += parseInt(activity.participants) || 0;
                        }
                    });
                }
            });
            
            // Trier les types par fréquence
            const sortedTypes = Object.entries(activitiesByType)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            // Trier les activités par participation
            const sortedActivities = Object.entries(participationByActivity)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 10);
            
            let html = `
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-bar"></i> Activités par type</h4>
                        <div class="chart-container">
                            <canvas id="activitiesTypeChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-pie"></i> Fréquence des activités</h4>
                        <div class="chart-container">
                            <canvas id="activitiesFrequencyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-chart-line"></i> Statistiques des activités</h4>
                    <div class="stats-grid">
            `;
            
            // Calculer les statistiques
            const avgActivitiesPerTeacher = Math.round(totalActivities / teachersWithActivities.length * 10) / 10;
            
            // Type d'activité le plus commun
            const mostCommonType = sortedTypes.length > 0 ? sortedTypes[0] : null;
            
            // Estimation de participation totale
            const avgParticipantsPerActivity = Math.round(totalParticipants / totalActivities);
            
            html += `
                        <div class="stat-card">
                            <div>Enseignants impliqués</div>
                            <div class="stat-value">${teachersWithActivities.length}</div>
                            <div>${Math.round((teachersWithActivities.length / teachersData.length) * 100)}%</div>
                        </div>
                        <div class="stat-card">
                            <div>Activités totales</div>
                            <div class="stat-value">${totalActivities}</div>
                        </div>
                        <div class="stat-card">
                            <div>Activités/enseignant moy.</div>
                            <div class="stat-value">${avgActivitiesPerTeacher}</div>
                        </div>
                        <div class="stat-card">
                            <div>Participants estimés</div>
                            <div class="stat-value">${totalParticipants}</div>
                            <div>${avgParticipantsPerActivity}/activité</div>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-trophy"></i> Activités les plus populaires</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Activité</th>
                                <th>Nombre d'enseignants</th>
                                <th>Enseignants impliqués</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedActivities.forEach(([activity, data]) => {
                const teachersList = data.teachers.length > 3 ? 
                    `${data.teachers.slice(0, 3).join(', ')}...` : 
                    data.teachers.join(', ');
                
                // Trouver le type de cette activité
                let activityType = 'Divers';
                teachersWithActivities.forEach(teacher => {
                    if (teacher.data && teacher.data.activities) {
                        const found = teacher.data.activities.find(a => a.name === activity);
                        if (found && found.type) {
                            activityType = found.type;
                        }
                    }
                });
                
                html += `
                    <tr>
                        <td><strong>${activity}</strong></td>
                        <td>${data.count}</td>
                        <td title="${data.teachers.join(', ')}">${teachersList}</td>
                        <td>${activityType}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-lightbulb"></i> Recommandations</h4>
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <h5><i class="fas fa-plus-circle"></i> Activités à développer</h5>
                            <ul>
                                <li>Clubs scientifiques et technologiques</li>
                                <li>Activités artistiques et culturelles</li>
                                <li>Sports collectifs et tournois</li>
                                <li>Activités de développement durable</li>
                            </ul>
                        </div>
                        <div class="dashboard-card">
                            <h5><i class="fas fa-chart-line"></i> Mesures d'accompagnement</h5>
                            <ul>
                                <li>Formation à l'animation d'activités</li>
                                <li>Budget dédié aux activités extrascolaires</li>
                                <li>Reconnaissance du temps d'engagement</li>
                                <li>Création d'un calendrier annuel</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Créer les graphiques
            setTimeout(() => {
                // Graphique des types
                const typeCtx = document.getElementById('activitiesTypeChart');
                if (typeCtx && sortedTypes.length > 0) {
                    const typeChart = new Chart(typeCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedTypes.map(([type]) => type),
                            datasets: [{
                                label: 'Nombre d\'activités',
                                data: sortedTypes.map(([, count]) => count),
                                backgroundColor: '#1abc9c'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Types d\'activités extrascolaires'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre d\'activités'
                                    }
                                }
                            }
                        }
                    });
                    charts.activitiesTypeChart = typeChart;
                }
                
                // Graphique de fréquence
                const frequencyCtx = document.getElementById('activitiesFrequencyChart');
                if (frequencyCtx && Object.keys(activitiesByFrequency).length > 0) {
                    const frequencyChart = new Chart(frequencyCtx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(activitiesByFrequency),
                            datasets: [{
                                data: Object.values(activitiesByFrequency),
                                backgroundColor: [
                                    '#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Fréquence des activités'
                                },
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                    charts.activitiesFrequencyChart = frequencyChart;
                }
            }, 100);
        }

        function updateMeetingsAnalysis() {
            const container = document.getElementById('meetingsAnalysis');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Analyser les réunions
            const teachersWithMeetings = teachersData.filter(t => 
                t.data && t.data.meetings && t.data.meetings.length > 0
            );
            
            if (teachersWithMeetings.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune réunion enregistrée</p>';
                return;
            }
            
            // Compter les réunions par type
            const meetingsByType = {};
            const meetingsByMonth = {};
            const meetingsByDuration = { '≤ 1h': 0, '1-2h': 0, '2-3h': 0, '> 3h': 0 };
            
            let totalMeetings = 0;
            let totalDuration = 0;
            
            teachersWithMeetings.forEach(teacher => {
                if (teacher.data && teacher.data.meetings) {
                    teacher.data.meetings.forEach(meeting => {
                        totalMeetings++;
                        
                        // Par type
                        if (meeting.type) {
                            meetingsByType[meeting.type] = (meetingsByType[meeting.type] || 0) + 1;
                        }
                        
                        // Par mois
                        if (meeting.date) {
                            const date = new Date(meeting.date);
                            const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                            meetingsByMonth[monthKey] = (meetingsByMonth[monthKey] || 0) + 1;
                        }
                        
                        // Par durée
                        if (meeting.duration) {
                            const duration = parseInt(meeting.duration) || 0;
                            totalDuration += duration;
                            
                            if (duration <= 60) meetingsByDuration['≤ 1h']++;
                            else if (duration <= 120) meetingsByDuration['1-2h']++;
                            else if (duration <= 180) meetingsByDuration['2-3h']++;
                            else meetingsByDuration['> 3h']++;
                        }
                    });
                }
            });
            
            // Trier les types par fréquence
            const sortedTypes = Object.entries(meetingsByType)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            // Trier les mois
            const sortedMonths = Object.entries(meetingsByMonth)
                .sort(([a], [b]) => a.localeCompare(b))
                .slice(-6);
            
            let html = `
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-bar"></i> Réunions par type</h4>
                        <div class="chart-container">
                            <canvas id="meetingsTypeChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-line"></i> Évolution mensuelle</h4>
                        <div class="chart-container">
                            <canvas id="meetingsMonthlyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-grid mt-30">
                    <div class="dashboard-card">
                        <h4><i class="fas fa-clock"></i> Durée des réunions</h4>
                        <div class="chart-container">
                            <canvas id="meetingsDurationChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h4><i class="fas fa-chart-area"></i> Statistiques</h4>
                        <div class="stats-grid" style="grid-template-columns: 1fr;">
            `;
            
            // Calculer les statistiques
            const avgMeetingsPerTeacher = Math.round(totalMeetings / teachersWithMeetings.length * 10) / 10;
            const avgDuration = Math.round(totalDuration / totalMeetings);
            
            // Type de réunion le plus commun
            const mostCommonType = sortedTypes.length > 0 ? sortedTypes[0] : null;
            
            // Temps total passé en réunions (en heures)
            const totalHours = Math.round(totalDuration / 60);
            
            html += `
                            <div class="stat-card">
                                <div>Enseignants avec réunions</div>
                                <div class="stat-value">${teachersWithMeetings.length}</div>
                                <div>${Math.round((teachersWithMeetings.length / teachersData.length) * 100)}%</div>
                            </div>
                            <div class="stat-card">
                                <div>Réunions totales</div>
                                <div class="stat-value">${totalMeetings}</div>
                            </div>
                            <div class="stat-card">
                                <div>Réunions/enseignant moy.</div>
                                <div class="stat-value">${avgMeetingsPerTeacher}</div>
                            </div>
                            <div class="stat-card">
                                <div>Durée moyenne</div>
                                <div class="stat-value">${avgDuration}min</div>
                            </div>
                            <div class="stat-card">
                                <div>Temps total</div>
                                <div class="stat-value">${totalHours}h</div>
                                <div>${totalDuration} minutes</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="data-section mt-30">
                    <h4><i class="fas fa-list"></i> Types de réunions</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Nombre</th>
                                <th>Pourcentage</th>
                                <th>Objectifs principaux</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedTypes.forEach(([type, count]) => {
                const percentage = Math.round((count / totalMeetings) * 100);
                let objectives = '';
                
                switch(type.toLowerCase()) {
                    case 'conseil de classe':
                        objectives = 'Bilan de classe, orientation, conseils disciplinaires';
                        break;
                    case 'réunion pédagogique':
                        objectives = 'Coordination pédagogique, projets, évaluations';
                        break;
                    case 'conseil d\'enseignement':
                        objectives = 'Coordination par matière, programmations';
                        break;
                    case 'conseil d\'établissement':
                        objectives = 'Gestion de l\'établissement, projets, budget';
                        break;
                    case 'réunion parents':
                        objectives = 'Échanges avec les familles, bilans individuels';
                        break;
                    case 'formation continue':
                        objectives = 'Formation en établissement, partage de pratiques';
                        break;
                    case 'commission':
                        objectives = 'Travail en commission sur des projets spécifiques';
                        break;
                    default:
                        objectives = 'Coordination et travail d\'équipe';
                }
                
                html += `
                    <tr>
                        <td>${type}</td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                        <td>${objectives}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Créer les graphiques
            setTimeout(() => {
                // Graphique des types
                const typeCtx = document.getElementById('meetingsTypeChart');
                if (typeCtx && sortedTypes.length > 0) {
                    const typeChart = new Chart(typeCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedTypes.map(([type]) => type),
                            datasets: [{
                                label: 'Nombre de réunions',
                                data: sortedTypes.map(([, count]) => count),
                                backgroundColor: '#e74c3c'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Types de réunions'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre de réunions'
                                    }
                                }
                            }
                        }
                    });
                    charts.meetingsTypeChart = typeChart;
                }
                
                // Graphique mensuel
                const monthlyCtx = document.getElementById('meetingsMonthlyChart');
                if (monthlyCtx && sortedMonths.length > 0) {
                    const monthlyChart = new Chart(monthlyCtx, {
                        type: 'line',
                        data: {
                            labels: sortedMonths.map(([month]) => month),
                            datasets: [{
                                label: 'Nombre de réunions',
                                data: sortedMonths.map(([, count]) => count),
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Évolution mensuelle des réunions'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre de réunions'
                                    }
                                }
                            }
                        }
                    });
                    charts.meetingsMonthlyChart = monthlyChart;
                }
                
                // Graphique de durée
                const durationCtx = document.getElementById('meetingsDurationChart');
                if (durationCtx) {
                    const durationChart = new Chart(durationCtx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(meetingsByDuration),
                            datasets: [{
                                data: Object.values(meetingsByDuration),
                                backgroundColor: [
                                    '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Durée des réunions'
                                },
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                    charts.meetingsDurationChart = durationChart;
                }
            }, 100);
        }

        // Analyse retraite
        function updateRetirementAnalysis() {
            const container = document.getElementById('retirementAnalysis');
            const tableContainer = document.getElementById('retirementTable');
            const upcomingContainer = document.getElementById('upcomingRetirements');
            
            if (!container || !tableContainer || !upcomingContainer) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                tableContainer.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                upcomingContainer.innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Compter par catégorie
            const categoryStats = {};
            const retirementByYear = {};
            
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.professional) {
                    const category = teacher.data.professional.professionalCategory || 'Non spécifiée';
                    categoryStats[category] = (categoryStats[category] || 0) + 1;
                    
                    if (teacher.data.professional.retirementDate) {
                        const year = new Date(teacher.data.professional.retirementDate).getFullYear();
                        retirementByYear[year] = (retirementByYear[year] || 0) + 1;
                    }
                }
            });
            
            // Statistiques par catégorie
            let statsHtml = '';
            Object.entries(categoryStats).forEach(([category, count]) => {
                statsHtml += `
                    <div class="stat-card">
                        <div>Catégorie ${category}</div>
                        <div class="stat-value">${count}</div>
                    </div>
                `;
            });
            container.innerHTML = statsHtml;
            
            // Tableau des retraites
            const teachersWithRetirement = teachersData
                .filter(t => t.data && t.data.professional && t.data.professional.retirementDate)
                .sort((a, b) => new Date(a.data.professional.retirementDate) - new Date(b.data.professional.retirementDate));
            
            let tableHtml = '<table class="data-table"><thead><tr><th>Enseignant</th><th>Date de retraite</th><th>Années restantes</th><th>Catégorie</th><th>Établissement</th></tr></thead><tbody>';
            
            teachersWithRetirement.forEach(teacher => {
                const retirementDate = new Date(teacher.data.professional.retirementDate);
                const today = new Date();
                const yearsLeft = Math.max(0, retirementDate.getFullYear() - today.getFullYear());
                
                tableHtml += `
                    <tr>
                        <td>${teacher.fullName}</td>
                        <td>${retirementDate.toLocaleDateString()}</td>
                        <td><span class="badge ${yearsLeft <= 2 ? 'badge-danger' : yearsLeft <= 5 ? 'badge-warning' : 'badge-success'}">${yearsLeft} ans</span></td>
                        <td>${teacher.data.professional.professionalCategory || 'N/A'}</td>
                        <td>${teacher.data.establishment ? teacher.data.establishment.name : 'N/A'}</td>
                    </tr>
                `;
            });
            
            tableHtml += '</tbody></table>';
            tableContainer.innerHTML = tableHtml;
            
            // Prochaines retraites (moins de 3 ans)
            const upcoming = teachersWithRetirement
                .filter(teacher => {
                    const retirementDate = new Date(teacher.data.professional.retirementDate);
                    const today = new Date();
                    const yearsLeft = retirementDate.getFullYear() - today.getFullYear();
                    return yearsLeft <= 3;
                })
                .slice(0, 10);
            
            let upcomingHtml = '<table class="data-table"><thead><tr><th>Enseignant</th><th>Date</th><th>Jours restants</th></tr></thead><tbody>';
            
            upcoming.forEach(teacher => {
                const retirementDate = new Date(teacher.data.professional.retirementDate);
                const today = new Date();
                const timeDiff = retirementDate.getTime() - today.getTime();
                const daysLeft = Math.ceil(timeDiff / (1000 * 3600 * 24));
                
                upcomingHtml += `
                    <tr>
                        <td>${teacher.fullName}</td>
                        <td>${retirementDate.toLocaleDateString()}</td>
                        <td><span class="badge badge-danger">${daysLeft} jours</span></td>
                    </tr>
                `;
            });
            
            upcomingHtml += '</tbody></table>';
            upcomingContainer.innerHTML = upcomingHtml;
            
            // Créer le graphique des retraites par année
            setTimeout(() => {
                const retirementYearCtx = document.getElementById('retirementYearChart');
                if (retirementYearCtx && Object.keys(retirementByYear).length > 0) {
                    const sortedYears = Object.keys(retirementByYear).sort();
                    const retirementYearChart = new Chart(retirementYearCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedYears,
                            datasets: [{
                                label: 'Nombre de retraites',
                                data: sortedYears.map(year => retirementByYear[year]),
                                backgroundColor: '#e74c3c'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Répartition des retraites par année'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Nombre de retraites'
                                    }
                                }
                            }
                        }
                    });
                    charts.retirementYearChart = retirementYearChart;
                }
            }, 100);
        }

        // Export Excel
        function exportAllToExcel() {
            if (teachersData.length === 0) {
                showNotification('Aucune donnée à exporter', 'warning');
                return;
            }
            
            showLoader(true);
            
            // Créer un workbook
            const wb = XLSX.utils.book_new();
            
            // Feuille 1: Liste des enseignants
            const teachersSheetData = [
                ['Nom', 'Prénom', 'Matricule', 'Date de naissance', 'Âge', 'Date d\'engagement', 'Années de service', 
                 'Date de retraite', 'Années restantes', 'Catégorie', 'Établissement', 'Matière principale', 'Heures/semaine',
                 'Fiche complète', 'Nombre de fichiers']
            ];
            
            teachersData.forEach(teacher => {
                const personal = teacher.data ? teacher.data.personal : {};
                const professional = teacher.data ? teacher.data.professional : {};
                const establishment = teacher.data ? teacher.data.establishment : {};
                const mainSubject = teacher.data && teacher.data.subjects && teacher.data.subjects.length > 0 ? 
                    teacher.data.subjects[0].name : '';
                
                teachersSheetData.push([
                    teacher.lastName,
                    teacher.firstName,
                    professional.matricule || '',
                    personal.birthDate || '',
                    teacher.age || '',
                    professional.engagementDate || '',
                    teacher.serviceYears || '',
                    professional.retirementDate || '',
                    teacher.yearsToRetirement || '',
                    professional.professionalCategory || '',
                    establishment.name || '',
                    mainSubject,
                    professional.weeklyHours || '',
                    teacher.complete ? 'Oui' : 'Non',
                    teacher.files.length
                ]);
            });
            
            const teachersSheet = XLSX.utils.aoa_to_sheet(teachersSheetData);
            XLSX.utils.book_append_sheet(wb, teachersSheet, 'Enseignants');
            
            // Feuille 2: Matières enseignées
            const subjectsMap = new Map();
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.subjects) {
                    teacher.data.subjects.forEach(subject => {
                        const key = subject.name;
                        if (key) {
                            if (!subjectsMap.has(key)) {
                                subjectsMap.set(key, { count: 0, teachers: [] });
                            }
                            const data = subjectsMap.get(key);
                            data.count++;
                            data.teachers.push(teacher.fullName);
                        }
                    });
                }
            });
            
            const subjectsSheetData = [['Matière', 'Nombre d\'enseignants', 'Enseignants']];
            subjectsMap.forEach((data, subject) => {
                subjectsSheetData.push([subject, data.count, data.teachers.join(', ')]);
            });
            
            const subjectsSheet = XLSX.utils.aoa_to_sheet(subjectsSheetData);
            XLSX.utils.book_append_sheet(wb, subjectsSheet, 'Matières');
            
            // Feuille 3: Planification retraite
            const retirementSheetData = [['Enseignant', 'Date de retraite', 'Années restantes', 'Catégorie', 'Âge actuel', 'Établissement']];
            
            teachersData
                .filter(t => t.data && t.data.professional && t.data.professional.retirementDate)
                .sort((a, b) => new Date(a.data.professional.retirementDate) - new Date(b.data.professional.retirementDate))
                .forEach(teacher => {
                    const retirementDate = new Date(teacher.data.professional.retirementDate);
                    const today = new Date();
                    const yearsLeft = Math.max(0, retirementDate.getFullYear() - today.getFullYear());
                    
                    retirementSheetData.push([
                        teacher.fullName,
                        retirementDate.toISOString().split('T')[0],
                        yearsLeft,
                        teacher.data.professional.professionalCategory || '',
                        teacher.age || '',
                        teacher.data.establishment?.name || ''
                    ]);
                });
            
            const retirementSheet = XLSX.utils.aoa_to_sheet(retirementSheetData);
            XLSX.utils.book_append_sheet(wb, retirementSheet, 'Retraites');
            
            // Feuille 4: Statistiques pédagogiques
            const pedagogySheetData = [
                ['Enseignant', 'Leçons', 'TP', 'Ressources', 'Matières', 'Heures/semaine']
            ];
            
            teachersData.forEach(teacher => {
                pedagogySheetData.push([
                    teacher.fullName,
                    teacher.lessonCount || 0,
                    teacher.tpCount || 0,
                    teacher.data && teacher.data.resources ? teacher.data.resources.length : 0,
                    teacher.subjectCount || 0,
                    teacher.data && teacher.data.professional ? teacher.data.professional.weeklyHours || 0 : 0
                ]);
            });
            
            const pedagogySheet = XLSX.utils.aoa_to_sheet(pedagogySheetData);
            XLSX.utils.book_append_sheet(wb, pedagogySheet, 'Pédagogie');
            
            // Feuille 5: Formation
            const trainingSheetData = [
                ['Enseignant', 'Diplômes', 'Formations continues', 'Langues', 'Compétences IT']
            ];
            
            teachersData.forEach(teacher => {
                trainingSheetData.push([
                    teacher.fullName,
                    teacher.data && teacher.data.diplomas ? teacher.data.diplomas.length : 0,
                    teacher.trainingCount || 0,
                    teacher.data && teacher.data.languages ? teacher.data.languages.length : 0,
                    teacher.data && teacher.data.itskills ? teacher.data.itskills.length : 0
                ]);
            });
            
            const trainingSheet = XLSX.utils.aoa_to_sheet(trainingSheetData);
            XLSX.utils.book_append_sheet(wb, trainingSheet, 'Formation');
            
            // Générer le fichier Excel
            const fileName = `analyse-enseignants-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showLoader(false);
            showNotification('Export Excel complet terminé avec succès', 'success');
        }

        function exportTeachersToExcel() {
            if (teachersData.length === 0) {
                showNotification('Aucune donnée à exporter', 'warning');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const sheetData = [
                ['Nom', 'Prénom', 'Matricule', 'Date de naissance', 'Âge', 'Établissement', 'Fonction', 
                 'Catégorie', 'Date d\'engagement', 'Années de service', 'Date de retraite', 'Années restantes',
                 'Matière principale', 'Heures/semaine', 'Email', 'Téléphone', 'Fiche complète']
            ];
            
            teachersData.forEach(teacher => {
                const personal = teacher.data ? teacher.data.personal : {};
                const professional = teacher.data ? teacher.data.professional : {};
                const establishment = teacher.data ? teacher.data.establishment : {};
                const mainSubject = teacher.data && teacher.data.subjects && teacher.data.subjects.length > 0 ? 
                    teacher.data.subjects[0].name : '';
                
                sheetData.push([
                    teacher.lastName,
                    teacher.firstName,
                    professional.matricule || '',
                    personal.birthDate || '',
                    teacher.age || '',
                    establishment.name || '',
                    professional.position || '',
                    professional.professionalCategory || '',
                    professional.engagementDate || '',
                    teacher.serviceYears || '',
                    professional.retirementDate || '',
                    teacher.yearsToRetirement || '',
                    mainSubject,
                    professional.weeklyHours || '',
                    personal.personalEmail || '',
                    personal.personalPhone || '',
                    teacher.complete ? 'Oui' : 'Non'
                ]);
            });
            
            const sheet = XLSX.utils.aoa_to_sheet(sheetData);
            XLSX.utils.book_append_sheet(wb, sheet, 'Liste Enseignants');
            
            const fileName = `liste-enseignants-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification('Liste des enseignants exportée avec succès', 'success');
        }

        function exportPedagogyToExcel() {
            if (teachersData.length === 0) {
                showNotification('Aucune donnée à exporter', 'warning');
                return;
            }
            
            showLoader(true);
            
            const wb = XLSX.utils.book_new();
            
            // Feuille 1: Synthèse pédagogique
            const summaryData = [
                ['SYNTHÈSE PÉDAGOGIQUE'],
                [''],
                ['Enseignants analysés:', teachersData.length],
                ['Leçons totales:', teachersData.reduce((sum, t) => sum + (t.lessonCount || 0), 0)],
                ['TP totaux:', teachersData.reduce((sum, t) => sum + (t.tpCount || 0), 0)],
                ['Ressources totales:', teachersData.reduce((sum, t) => sum + (t.data && t.data.resources ? t.data.resources.length : 0), 0)],
                [''],
                ['DÉTAIL PAR ENSEIGNANT']
            ];
            
            const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summarySheet, 'Synthèse');
            
            // Feuille 2: Détail pédagogique
            const detailData = [
                ['Enseignant', 'Établissement', 'Matière principale', 'Heures/semaine', 
                 'Leçons', 'TP', 'Ressources', 'Emploi du temps']
            ];
            
            teachersData.forEach(teacher => {
                const hasTimetable = teacher.data && teacher.data.timetable && 
                    Object.keys(teacher.data.timetable).length > 0 ? 'Oui' : 'Non';
                const mainSubject = teacher.data && teacher.data.subjects && teacher.data.subjects.length > 0 ? 
                    teacher.data.subjects[0].name : '';
                const establishment = teacher.data && teacher.data.establishment ? 
                    teacher.data.establishment.name : '';
                
                detailData.push([
                    teacher.fullName,
                    establishment,
                    mainSubject,
                    teacher.data && teacher.data.professional ? teacher.data.professional.weeklyHours || 0 : 0,
                    teacher.lessonCount || 0,
                    teacher.tpCount || 0,
                    teacher.data && teacher.data.resources ? teacher.data.resources.length : 0,
                    hasTimetable
                ]);
            });
            
            const detailSheet = XLSX.utils.aoa_to_sheet(detailData);
            XLSX.utils.book_append_sheet(wb, detailSheet, 'Détail pédagogique');
            
            // Feuille 3: Matières
            const subjectsMap = new Map();
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.subjects) {
                    teacher.data.subjects.forEach(subject => {
                        if (subject && subject.name) {
                            const key = subject.name;
                            if (!subjectsMap.has(key)) {
                                subjectsMap.set(key, { teachers: [], hours: 0 });
                            }
                            const data = subjectsMap.get(key);
                            data.teachers.push(teacher.fullName);
                            data.hours += parseInt(subject.hours) || 0;
                        }
                    });
                }
            });
            
            const subjectsData = [['Matière', 'Nombre d\'enseignants', 'Heures totales', 'Enseignants']];
            subjectsMap.forEach((data, subject) => {
                subjectsData.push([subject, data.teachers.length, data.hours, data.teachers.join(', ')]);
            });
            
            const subjectsSheet = XLSX.utils.aoa_to_sheet(subjectsData);
            XLSX.utils.book_append_sheet(wb, subjectsSheet, 'Matières');
            
            const fileName = `pedagogie-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showLoader(false);
            showNotification('Données pédagogiques exportées avec succès', 'success');
        }

        function exportTrainingToExcel() {
            if (teachersData.length === 0) {
                showNotification('Aucune donnée à exporter', 'warning');
                return;
            }
            
            showLoader(true);
            
            const wb = XLSX.utils.book_new();
            
            // Feuille 1: Synthèse formation
            const summaryData = [
                ['SYNTHÈSE FORMATION'],
                [''],
                ['Enseignants analysés:', teachersData.length],
                ['Diplômes totaux:', teachersData.reduce((sum, t) => sum + (t.data && t.data.diplomas ? t.data.diplomas.length : 0), 0)],
                ['Formations continues:', teachersData.reduce((sum, t) => sum + (t.trainingCount || 0), 0)],
                ['Langues déclarées:', teachersData.reduce((sum, t) => sum + (t.data && t.data.languages ? t.data.languages.length : 0), 0)],
                ['Compétences IT:', teachersData.reduce((sum, t) => sum + (t.data && t.data.itskills ? t.data.itskills.length : 0), 0)],
                [''],
                ['DÉTAIL PAR ENSEIGNANT']
            ];
            
            const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summarySheet, 'Synthèse');
            
            // Feuille 2: Détail formation
            const detailData = [
                ['Enseignant', 'Diplômes', 'Niveau max', 'Formations continues', 
                 'Langues', 'Niveau langue max', 'Compétences IT', 'Catégories IT']
            ];
            
            teachersData.forEach(teacher => {
                // Trouver le niveau de diplôme le plus élevé
                let maxDiplomaLevel = '';
                if (teacher.data && teacher.data.diplomas) {
                    teacher.data.diplomas.forEach(diploma => {
                        const level = diploma.level || '';
                        if (level.includes('Doctorat') || level.includes('PhD')) maxDiplomaLevel = 'Doctorat';
                        else if (level.includes('Master') && maxDiplomaLevel !== 'Doctorat') maxDiplomaLevel = 'Master';
                        else if (level.includes('Licence') && !maxDiplomaLevel) maxDiplomaLevel = 'Licence';
                    });
                }
                
                // Trouver le niveau de langue le plus élevé
                let maxLanguageLevel = '';
                if (teacher.data && teacher.data.languages) {
                    teacher.data.languages.forEach(lang => {
                        const level = lang.level || '';
                        if (level.includes('C2') || level.includes('Avancé')) maxLanguageLevel = 'C2/Avancé';
                        else if (level.includes('C1') && maxLanguageLevel !== 'C2/Avancé') maxLanguageLevel = 'C1';
                        else if (level.includes('B2') && !maxLanguageLevel) maxLanguageLevel = 'B2';
                    });
                }
                
                // Catégories IT uniques
                const itCategories = new Set();
                if (teacher.data && teacher.data.itskills) {
                    teacher.data.itskills.forEach(skill => {
                        if (skill.category) itCategories.add(skill.category);
                    });
                }
                
                detailData.push([
                    teacher.fullName,
                    teacher.data && teacher.data.diplomas ? teacher.data.diplomas.length : 0,
                    maxDiplomaLevel,
                    teacher.trainingCount || 0,
                    teacher.data && teacher.data.languages ? teacher.data.languages.length : 0,
                    maxLanguageLevel,
                    teacher.data && teacher.data.itskills ? teacher.data.itskills.length : 0,
                    Array.from(itCategories).join(', ')
                ]);
            });
            
            const detailSheet = XLSX.utils.aoa_to_sheet(detailData);
            XLSX.utils.book_append_sheet(wb, detailSheet, 'Détail formation');
            
            // Feuille 3: Diplômes détaillés
            const diplomasData = [['Enseignant', 'Diplôme', 'Type', 'Niveau', 'Année', 'Établissement']];
            
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.diplomas) {
                    teacher.data.diplomas.forEach(diploma => {
                        diplomasData.push([
                            teacher.fullName,
                            diploma.name || '',
                            diploma.type || '',
                            diploma.level || '',
                            diploma.year || '',
                            diploma.institution || ''
                        ]);
                    });
                }
            });
            
            if (diplomasData.length > 1) {
                const diplomasSheet = XLSX.utils.aoa_to_sheet(diplomasData);
                XLSX.utils.book_append_sheet(wb, diplomasSheet, 'Diplômes');
            }
            
            const fileName = `formation-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showLoader(false);
            showNotification('Données de formation exportées avec succès', 'success');
        }

        function exportRetirementToExcel() {
            if (teachersData.length === 0) {
                showNotification('Aucune donnée à exporter', 'warning');
                return;
            }
            
            showLoader(true);
            
            const wb = XLSX.utils.book_new();
            
            // Feuille 1: Planification retraite
            const retirementData = [
                ['PLANIFICATION DES RETRAITES'],
                [''],
                ['Enseignants analysés:', teachersData.length],
                ['Avec date de retraite:', teachersData.filter(t => t.data && t.data.professional && t.data.professional.retirementDate).length],
                ['Retraites ≤ 1 an:', teachersData.filter(t => t.yearsToRetirement !== null && t.yearsToRetirement <= 1).length],
                ['Retraites 2-5 ans:', teachersData.filter(t => t.yearsToRetirement !== null && t.yearsToRetirement > 1 && t.yearsToRetirement <= 5).length],
                ['Retraites > 5 ans:', teachersData.filter(t => t.yearsToRetirement !== null && t.yearsToRetirement > 5).length],
                [''],
                ['DÉTAIL PAR ENSEIGNANT']
            ];
            
            const retirementSheet = XLSX.utils.aoa_to_sheet(retirementData);
            XLSX.utils.book_append_sheet(wb, retirementSheet, 'Synthèse retraites');
            
            // Feuille 2: Détail retraite
            const detailData = [
                ['Enseignant', 'Date de retraite', 'Années restantes', 'Âge actuel', 
                 'Années de service', 'Catégorie', 'Établissement', 'Matière principale']
            ];
            
            teachersData
                .filter(t => t.data && t.data.professional && t.data.professional.retirementDate)
                .sort((a, b) => new Date(a.data.professional.retirementDate) - new Date(b.data.professional.retirementDate))
                .forEach(teacher => {
                    const retirementDate = new Date(teacher.data.professional.retirementDate);
                    const today = new Date();
                    const yearsLeft = Math.max(0, retirementDate.getFullYear() - today.getFullYear());
                    const mainSubject = teacher.data && teacher.data.subjects && teacher.data.subjects.length > 0 ? 
                        teacher.data.subjects[0].name : '';
                    const establishment = teacher.data && teacher.data.establishment ? 
                        teacher.data.establishment.name : '';
                    
                    detailData.push([
                        teacher.fullName,
                        retirementDate.toISOString().split('T')[0],
                        yearsLeft,
                        teacher.age || '',
                        teacher.serviceYears || '',
                        teacher.data.professional.professionalCategory || '',
                        establishment,
                        mainSubject
                    ]);
                });
            
            const detailSheet = XLSX.utils.aoa_to_sheet(detailData);
            XLSX.utils.book_append_sheet(wb, detailSheet, 'Détail retraites');
            
            // Feuille 3: Analyse par année
            const retirementByYear = {};
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.professional && teacher.data.professional.retirementDate) {
                    const year = new Date(teacher.data.professional.retirementDate).getFullYear();
                    retirementByYear[year] = (retirementByYear[year] || 0) + 1;
                }
            });
            
            const yearData = [['Année', 'Nombre de retraites', 'Pourcentage']];
            const sortedYears = Object.keys(retirementByYear).sort();
            const totalWithRetirement = teachersData.filter(t => 
                t.data && t.data.professional && t.data.professional.retirementDate
            ).length;
            
            sortedYears.forEach(year => {
                const count = retirementByYear[year];
                const percentage = Math.round((count / totalWithRetirement) * 100);
                yearData.push([year, count, `${percentage}%`]);
            });
            
            const yearSheet = XLSX.utils.aoa_to_sheet(yearData);
            XLSX.utils.book_append_sheet(wb, yearSheet, 'Analyse par année');
            
            const fileName = `retraites-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showLoader(false);
            showNotification('Planification retraite exportée avec succès', 'success');
        }

        function exportProjectsToExcel() {
            if (teachersData.length === 0) {
                showNotification('Aucune donnée à exporter', 'warning');
                return;
            }
            
            showLoader(true);
            
            const wb = XLSX.utils.book_new();
            
            // Feuille 1: Synthèse projets
            const summaryData = [
                ['SYNTHÈSE PROJETS ET ACTIVITÉS'],
                [''],
                ['Enseignants analysés:', teachersData.length],
                ['Projets pédagogiques:', teachersData.reduce((sum, t) => sum + (t.projectCount || 0), 0)],
                ['Activités extrascolaires:', teachersData.reduce((sum, t) => sum + (t.data && t.data.activities ? t.data.activities.length : 0), 0)],
                ['Réunions:', teachersData.reduce((sum, t) => sum + (t.data && t.data.meetings ? t.data.meetings.length : 0), 0)],
                [''],
                ['DÉTAIL PAR ENSEIGNANT']
            ];
            
            const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summarySheet, 'Synthèse projets');
            
            // Feuille 2: Projets pédagogiques
            const projectsData = [
                ['Enseignant', 'Projet', 'Type', 'Statut', 'Durée', 
                 'Date début', 'Date fin', 'Participants', 'Description']
            ];
            
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.projects) {
                    teacher.data.projects.forEach(project => {
                        projectsData.push([
                            teacher.fullName,
                            project.name || '',
                            project.type || '',
                            project.status || '',
                            project.duration || '',
                            project.startDate || '',
                            project.endDate || '',
                            project.participants || '',
                            project.description || ''
                        ]);
                    });
                }
            });
            
            if (projectsData.length > 1) {
                const projectsSheet = XLSX.utils.aoa_to_sheet(projectsData);
                XLSX.utils.book_append_sheet(wb, projectsSheet, 'Projets pédagogiques');
            }
            
            // Feuille 3: Activités extrascolaires
            const activitiesData = [
                ['Enseignant', 'Activité', 'Type', 'Fréquence', 
                 'Participants', 'Lieu', 'Responsable', 'Objectifs']
            ];
            
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.activities) {
                    teacher.data.activities.forEach(activity => {
                        activitiesData.push([
                            teacher.fullName,
                            activity.name || '',
                            activity.type || '',
                            activity.frequency || '',
                            activity.participants || '',
                            activity.location || '',
                            activity.responsible || '',
                            activity.objectives || ''
                        ]);
                    });
                }
            });
            
            if (activitiesData.length > 1) {
                const activitiesSheet = XLSX.utils.aoa_to_sheet(activitiesData);
                XLSX.utils.book_append_sheet(wb, activitiesSheet, 'Activités extrascolaires');
            }
            
            const fileName = `projets-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showLoader(false);
            showNotification('Projets et activités exportés avec succès', 'success');
        }

        function exportTeacherToExcel(index) {
            const teacher = teachersData[index];
            if (!teacher) return;
            
            const wb = XLSX.utils.book_new();
            
            // Feuille 1: Informations générales
            const generalData = [
                ['FICHE SYNTHÉTIQUE DE L\'ENSEIGNANT'],
                [''],
                ['Nom:', teacher.lastName],
                ['Prénom:', teacher.firstName],
                ['Matricule:', teacher.data && teacher.data.professional ? teacher.data.professional.matricule : ''],
                [''],
                ['INFORMATIONS PERSONNELLES'],
                ['Date de naissance:', teacher.data && teacher.data.personal ? teacher.data.personal.birthDate : ''],
                ['Lieu de naissance:', teacher.data && teacher.data.personal ? teacher.data.personal.birthPlace : ''],
                ['Nationalité:', teacher.data && teacher.data.personal ? teacher.data.personal.nationality : ''],
                [''],
                ['INFORMATIONS PROFESSIONNELLES'],
                ['Établissement:', teacher.data && teacher.data.establishment ? teacher.data.establishment.name : ''],
                ['Fonction:', teacher.data && teacher.data.professional ? teacher.data.professional.position : ''],
                ['Catégorie:', teacher.data && teacher.data.professional ? teacher.data.professional.professionalCategory : ''],
                ['Date d\'engagement:', teacher.data && teacher.data.professional ? teacher.data.professional.engagementDate : ''],
                ['Date de retraite:', teacher.data && teacher.data.professional ? teacher.data.professional.retirementDate : ''],
                [''],
                ['STATISTIQUES'],
                ['Âge:', teacher.age || ''],
                ['Années de service:', teacher.serviceYears || ''],
                ['Années avant retraite:', teacher.yearsToRetirement || '']
            ];
            
            const generalSheet = XLSX.utils.aoa_to_sheet(generalData);
            XLSX.utils.book_append_sheet(wb, generalSheet, 'Synthèse');
            
            // Feuille 2: Matières enseignées
            if (teacher.data && teacher.data.subjects) {
                const subjectsData = [['Matière', 'Type', 'Heures/semaine']];
                teacher.data.subjects.forEach(subject => {
                    subjectsData.push([subject.name || '', subject.type || '', subject.hours || '']);
                });
                
                const subjectsSheet = XLSX.utils.aoa_to_sheet(subjectsData);
                XLSX.utils.book_append_sheet(wb, subjectsSheet, 'Matières');
            }
            
            const fileName = `enseignant-${teacher.lastName}-${teacher.firstName}-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification('Fiche enseignant exportée avec succès', 'success');
        }

        function updateExportPreview() {
            const container = document.getElementById('exportPreview');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée à exporter</p>';
                return;
            }
            
            const totalTeachers = teachersData.length;
            const completeTeachers = teachersData.filter(t => t.complete).length;
            const subjectsCount = new Set();
            const establishmentsCount = new Set();
            
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.subjects) {
                    teacher.data.subjects.forEach(subject => {
                        if (subject.name) subjectsCount.add(subject.name);
                    });
                }
                if (teacher.data && teacher.data.establishment && teacher.data.establishment.name) {
                    establishmentsCount.add(teacher.data.establishment.name);
                }
            });
            
            const html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div>Enseignants à exporter</div>
                        <div class="stat-value">${totalTeachers}</div>
                    </div>
                    <div class="stat-card">
                        <div>Fiches complètes</div>
                        <div class="stat-value">${completeTeachers}</div>
                        <div>${totalTeachers > 0 ? Math.round((completeTeachers / totalTeachers) * 100) : 0}%</div>
                    </div>
                    <div class="stat-card">
                        <div>Matières uniques</div>
                        <div class="stat-value">${subjectsCount.size}</div>
                    </div>
                    <div class="stat-card">
                        <div>Établissements</div>
                        <div class="stat-value">${establishmentsCount.size}</div>
                    </div>
                </div>
                
                <p class="mt-20"><i class="fas fa-info-circle"></i> L'export Excel contiendra ${totalTeachers} enseignants répartis en plusieurs feuilles.</p>
                <p><i class="fas fa-lightbulb"></i> Astuce: Utilisez les filtres pour affiner votre export.</p>
            `;
            
            container.innerHTML = html;
        }

        // Fonctions utilitaires
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');
            const icon = document.getElementById('notificationIcon');
            
            if (!notification || !messageEl || !icon) return;
            
            messageEl.textContent = message;
            notification.className = 'notification';
            icon.className = 'fas';
            
            switch(type) {
                case 'success':
                    notification.classList.add('show');
                    icon.classList.add('fa-check-circle');
                    break;
                case 'error':
                    notification.classList.add('show', 'error');
                    icon.classList.add('fa-exclamation-circle');
                    break;
                case 'warning':
                    notification.classList.add('show', 'warning');
                    icon.classList.add('fa-exclamation-triangle');
                    break;
                case 'info':
                    notification.classList.add('show', 'info');
                    icon.classList.add('fa-info-circle');
                    break;
            }
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showLoader(show) {
            const loader = document.getElementById('loader');
            if (loader) {
                if (show) {
                    loader.classList.add('active');
                } else {
                    loader.classList.remove('active');
                }
            }
        }

        function clearAllData() {
            if (confirm('Voulez-vous vraiment effacer toutes les données importées ? Cette action est irréversible.')) {
                teachersData = [];
                filteredTeachers = [];
                updateUIAfterImport();
                showNotification('Toutes les données ont été effacées', 'success');
            }
        }

        function saveSession() {
            try {
                const sessionData = {
                    teachers: teachersData,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('inspecteurSession', JSON.stringify(sessionData));
                showNotification('Session sauvegardée avec succès', 'success');
            } catch (error) {
                showNotification('Erreur lors de la sauvegarde', 'error');
                console.error(error);
            }
        }

        function backupData() {
            try {
                const sessionData = {
                    teachers: teachersData,
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                
                const blob = new Blob([JSON.stringify(sessionData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `session-inspecteur-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('Session exportée avec succès', 'success');
            } catch (error) {
                showNotification('Erreur lors de l\'export', 'error');
                console.error(error);
            }
        }

        function loadSessionData() {
            try {
                const saved = localStorage.getItem('inspecteurSession');
                if (saved) {
                    const sessionData = JSON.parse(saved);
                    teachersData = sessionData.teachers || [];
                    
                    // Recalculer les statistiques
                    teachersData.forEach(teacher => {
                        calculateTeacherStatistics(teacher);
                    });
                    
                    updateUIAfterImport();
                    showNotification('Session restaurée avec succès', 'success');
                }
            } catch (error) {
                console.error('Erreur lors du chargement de la session:', error);
            }
        }

        function generateReport() {
            showNotification('Génération de rapport PDF à implémenter', 'info');
        }

        // Initialisation finale
        window.addEventListener('beforeunload', function() {
            // Sauvegarder automatiquement avant de quitter
            saveSession();
        });
    </script>
</body>
</html>
