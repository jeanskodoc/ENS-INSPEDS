<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plateforme d'Analyse - Inspecteurs √âducation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #9b59b6;
            --dark-color: #2c3e50;
            --light-color: #f5f5f5;
            --gray-color: #7f8c8d;
            --border-radius: 10px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-color);
            padding: 20px;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        /* Header */
        header {
            text-align: center;
            padding: 25px 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            position: relative;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .platform-name {
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        header h1 {
            color: white;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        /* Navigation */
        .tabs-container {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }

        .tabs {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            min-width: 800px;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-color);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .tab:hover {
            background-color: #e9ecef;
            color: var(--dark-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background-color: white;
        }

        /* Contenu des onglets */
        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        /* Section d'importation */
        .import-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            border: 2px dashed var(--primary-color);
            text-align: center;
        }

        .import-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .import-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .import-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
        }

        .import-card i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .import-card h3 {
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        .import-card p {
            color: var(--gray-color);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Boutons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--success-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #d68910;
            transform: translateY(-2px);
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
        }

        .btn-light {
            background-color: #f8f9fa;
            color: var(--dark-color);
            border: 1px solid #dee2e6;
        }

        .btn-light:hover {
            background-color: #e9ecef;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .btn-xs {
            padding: 5px 8px;
            font-size: 0.8rem;
        }

        /* Bouton Retour */
        .btn-return {
            background-color: white;
            color: var(--primary-color);
            border: 2px solid white;
        }

        .btn-return:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Sections de donn√©es */
        .data-section {
            margin-bottom: 30px;
            padding: 25px;
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .data-section h2 {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            margin: -25px -25px 25px -25px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        /* Tableaux */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .data-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .dashboard-card h3 {
            margin-bottom: 15px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
            position: relative;
        }

        /* Statistiques */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        /* Filtres */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
            padding: 15px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .search-box input {
            padding-left: 40px;
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        /* Onglets secondaires */
        .sub-tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 25px;
            overflow-x: auto;
        }

        .sub-tab {
            padding: 12px 25px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-color);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
        }

        .sub-tab:hover {
            color: var(--dark-color);
        }

        .sub-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 5px;
        }

        .badge-primary {
            background-color: #e3f2fd;
            color: var(--primary-color);
        }

        .badge-success {
            background-color: #e8f5e9;
            color: var(--success-color);
        }

        .badge-warning {
            background-color: #fff3e0;
            color: var(--warning-color);
        }

        .badge-danger {
            background-color: #ffebee;
            color: var(--danger-color);
        }

        .badge-info {
            background-color: #f3e5f5;
            color: var(--info-color);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success-color);
            color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        /* Loader */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }

        .loader.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-color);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 0;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .data-section {
                padding: 20px;
            }
            
            .import-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-bar {
                flex-direction: column;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .sub-tabs {
                flex-wrap: wrap;
            }
            
            .sub-tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .file-type-tabs {
                flex-direction: column;
            }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .header-actions {
                display: flex;
                gap: 10px;
                width: 100%;
                justify-content: space-between;
            }
        }

        /* Utilitaires */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-30 {
            margin-bottom: 30px;
        }

        .mt-30 {
            margin-top: 30px;
        }

        .d-flex {
            display: flex;
        }

        .align-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-10 {
            gap: 10px;
        }

        .gap-15 {
            gap: 15px;
        }

        .gap-20 {
            gap: 20px;
        }

        .w-100 {
            width: 100%;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Cartes enseignants */
        .teacher-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .teacher-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
            cursor: pointer;
        }

        .teacher-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .teacher-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .teacher-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .teacher-matricule {
            background: var(--primary-color);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .teacher-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .teacher-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray-color);
        }

        .teacher-info-item i {
            color: var(--primary-color);
        }

        /* Fichiers par type */
        .files-by-type {
            margin: 20px 0;
        }

        .file-type-group {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .file-list {
            margin-top: 10px;
            padding-left: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        /* Visualisation donn√©es */
        .data-preview {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }

        /* Header actions */
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* Section Python Analysis */
        .python-editor {
            width: 100%;
            height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
            resize: vertical;
            margin-bottom: 15px;
        }

        .python-output {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }

        .python-script-item {
            padding: 10px 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .python-script-item:hover {
            background-color: #f8f9fa;
            border-color: var(--primary-color);
        }

        .python-analysis-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .python-analysis-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .python-analysis-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Am√©liorations sp√©cifiques pour l'analyse Python */
        .python-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .python-stat-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .python-stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 5px 0;
        }

        .python-template-section {
            margin-top: 20px;
        }

        .python-template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        /* Compatibilit√© avec les fichiers export√©s */
        .compatibility-check {
            padding: 15px;
            background: #e8f5e9;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--success-color);
        }

        .compatibility-check.warning {
            background: #fff3e0;
            border-left-color: var(--warning-color);
        }

        .data-structure-view {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .structure-item {
            margin: 5px 0;
            padding: 5px 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle" id="notificationIcon"></i>
        <span id="notificationMessage"></span>
    </div>

    <!-- Container principal -->
    <div class="container">
        <header>
            <div class="header-content">
                <div class="platform-name">
                    <i class="fas fa-chart-line"></i>
                    <span>Plateforme d'Analyse - Inspecteurs √âducation</span>
                </div>
                <div class="header-actions">
                    <div class="user-info">
                        <i class="fas fa-user-shield"></i>
                        <span>Inspecteur - <span id="currentYear"></span></span>
                    </div>
                    <a href="index.html" class="btn btn-return">
                        <i class="fas fa-home"></i> Retour √† l'accueil
                    </a>
                </div>
            </div>
            <h1><i class="fas fa-analytics"></i> ANALYSE DES FICHES ENSEIGNANTS</h1>
            <p>Importation, visualisation et analyse des donn√©es p√©dagogiques compl√®tes</p>
        </header>

        <!-- Navigation principale -->
        <div class="tabs-container">
            <ul class="tabs">
                <li class="tab active" data-tab="tab-import">
                    <i class="fas fa-upload"></i> Importation
                </li>
                <li class="tab" data-tab="tab-python">
                    <i class="fab fa-python"></i> Analyse Python
                </li>
                <li class="tab" data-tab="tab-dashboard">
                    <i class="fas fa-tachometer-alt"></i> Tableau de bord
                </li>
                <li class="tab" data-tab="tab-teachers">
                    <i class="fas fa-users"></i> Enseignants
                </li>
                <li class="tab" data-tab="tab-pedagogy">
                    <i class="fas fa-chalkboard-teacher"></i> P√©dagogie
                </li>
                <li class="tab" data-tab="tab-evaluations">
                    <i class="fas fa-chart-line"></i> √âvaluations
                </li>
                <li class="tab" data-tab="tab-projects">
                    <i class="fas fa-project-diagram"></i> Projets
                </li>
                <li class="tab" data-tab="tab-retirement">
                    <i class="fas fa-umbrella-beach"></i> Retraite
                </li>
                <li class="tab" data-tab="tab-export">
                    <i class="fas fa-download"></i> Export Excel
                </li>
            </ul>
        </div>

        <!-- Onglet Importation -->
        <div id="tab-import" class="tab-content active">
            <div class="import-section">
                <h2><i class="fas fa-file-import"></i> IMPORTATION DES DONN√âES</h2>
                <p>S√©lectionnez le type d'importation ou choisissez un type de fichier sp√©cifique</p>
                
                <!-- Compatibilit√© avec les fichiers export√©s -->
                <div class="compatibility-check">
                    <h4><i class="fas fa-check-circle"></i> Compatibilit√© avec les fichiers de la Fiche Administrative Enseignant</h4>
                    <p>Cette plateforme supporte tous les fichiers JSON export√©s depuis l'application "Fiche Administrative Enseignant" :</p>
                    <ul>
                        <li>Fichiers individuels par onglet (tab1, tab2, tab3, tab4, tab5)</li>
                        <li>Fichier JSON complet (export total)</li>
                        <li>Fichiers multiples d'un m√™me enseignant</li>
                    </ul>
                </div>
                
                <div class="import-grid">
                    <!-- Import fichier unique -->
                    <div class="import-card">
                        <i class="fas fa-file-import"></i>
                        <h3>Import fichier unique</h3>
                        <p>Importez un fichier JSON sp√©cifique (tab1, tab2, etc.)</p>
                        <div class="file-input-wrapper">
                            <button class="btn btn-primary" id="singleFileBtn">
                                <i class="fas fa-upload"></i> Choisir un fichier
                            </button>
                            <input type="file" id="singleFileInput" accept=".json" style="display: none;">
                        </div>
                    </div>

                    <!-- Import multiple -->
                    <div class="import-card">
                        <i class="fas fa-folder-open"></i>
                        <h3>Import multiple</h3>
                        <p>Importez tous les fichiers JSON d'un enseignant</p>
                        <div class="file-input-wrapper">
                            <button class="btn btn-secondary" id="multiFileBtn">
                                <i class="fas fa-folder-open"></i> Choisir des fichiers
                            </button>
                            <input type="file" id="multiFileInput" accept=".json" multiple style="display: none;">
                        </div>
                    </div>

                    <!-- Import dossier -->
                    <div class="import-card">
                        <i class="fas fa-database"></i>
                        <h3>Import complet</h3>
                        <p>Importez un fichier JSON complet (export total)</p>
                        <div class="file-input-wrapper">
                            <button class="btn btn-info" id="completeFileBtn">
                                <i class="fas fa-database"></i> Choisir un fichier
                            </button>
                            <input type="file" id="completeFileInput" accept=".json" style="display: none;">
                        </div>
                    </div>
                </div>

                <!-- Liste des fichiers import√©s -->
                <div class="data-section mt-30" id="importedFilesSection" style="display: none;">
                    <h2><i class="fas fa-list-check"></i> FICHIERS IMPORT√âS</h2>
                    <div id="importedFilesList"></div>
                </div>

                <!-- Vue d'ensemble -->
                <div class="data-section mt-30" id="overviewSection" style="display: none;">
                    <h2><i class="fas fa-eye"></i> VUE D'ENSEMBLE</h2>
                    <div class="stats-grid" id="overviewStats"></div>
                </div>

                <!-- Visualisation des donn√©es -->
                <div class="data-section mt-30" id="dataPreviewSection" style="display: none;">
                    <h2><i class="fas fa-eye"></i> VISUALISATION DES DONN√âES</h2>
                    <select id="dataPreviewSelect" class="w-100 mb-20" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">S√©lectionner un enseignant pour pr√©visualiser...</option>
                    </select>
                    <div id="dataPreviewContent"></div>
                </div>
            </div>
        </div>

        <!-- Onglet Analyse Python -->
        <div id="tab-python" class="tab-content">
            <div class="import-section">
                <h2><i class="fab fa-python"></i> ANALYSE AVEC PYTHON</h2>
                <p>Ex√©cutez des scripts Python pour analyser les donn√©es import√©es</p>
                
                <!-- Indicateur Pyodide -->
                <div id="pyodideStatus" class="compatibility-check" style="display: none;">
                    <h4><i class="fas fa-spinner fa-spin"></i> Chargement de Pyodide...</h4>
                    <p>Initialisation de l'environnement Python dans le navigateur</p>
                </div>
                
                <div class="python-analysis-grid">
                    <div>
                        <div class="python-analysis-controls">
                            <button class="btn btn-primary" onclick="runPythonAnalysis()">
                                <i class="fas fa-play"></i> Ex√©cuter l'analyse
                            </button>
                            <button class="btn btn-secondary" onclick="loadPythonTemplate('basic_analysis')">
                                <i class="fas fa-file-code"></i> Charger un mod√®le
                            </button>
                            <button class="btn btn-info" onclick="savePythonScript()">
                                <i class="fas fa-save"></i> Sauvegarder le script
                            </button>
                            <button class="btn btn-warning" onclick="clearPythonOutput()">
                                <i class="fas fa-broom"></i> Effacer la sortie
                            </button>
                        </div>

                        <textarea class="python-editor" id="pythonEditor" placeholder="√âcrivez votre code Python ici...">
# === ANALYSE DES DONN√âES ENSEIGNANTS ===
# Les donn√©es charg√©es sont disponibles dans la variable 'teachers_data'
# Cette variable contient la liste compl√®te des enseignants import√©s

def analyse_basique(teachers_data):
    """Analyse basique des donn√©es enseignants"""
    if not teachers_data:
        return "‚ö†Ô∏è Aucune donn√©e disponible. Veuillez d'abord importer des donn√©es."
    
    total_enseignants = len(teachers_data)
    fiches_completes = sum(1 for t in teachers_data if t.get('complete', False))
    
    # Calcul des statistiques g√©n√©rales
    stats = {
        'total_enseignants': total_enseignants,
        'fiches_completes': fiches_completes,
        'pourcentage_complet': (fiches_completes / total_enseignants * 100) if total_enseignants > 0 else 0,
        'age_moyen': 0,
        'service_moyen': 0
    }
    
    # Calcul de l'√¢ge moyen
    ages = [t.get('age') for t in teachers_data if t.get('age')]
    if ages:
        stats['age_moyen'] = sum(ages) / len(ages)
    
    # Calcul des ann√©es de service moyennes
    services = [t.get('serviceYears') for t in teachers_data if t.get('serviceYears')]
    if services:
        stats['service_moyen'] = sum(services) / len(services)
    
    return stats

# Ex√©cution de l'analyse
print("üîç ANALYSE DES DONN√âES ENSEIGNANTS")
print("=" * 50)

if 'teachers_data' in globals() and teachers_data:
    resultats = analyse_basique(teachers_data)
    
    print(f"üë• Nombre total d'enseignants: {resultats['total_enseignants']}")
    print(f"‚úÖ Fiches compl√®tes: {resultats['fiches_completes']}")
    print(f"üìä Taux de compl√©tion: {resultats['pourcentage_complet']:.1f}%")
    print(f"üéÇ √Çge moyen: {resultats['age_moyen']:.1f} ans")
    print(f"‚è≥ Service moyen: {resultats['service_moyen']:.1f} ans")
    
    # Analyse par √©tablissement
    print("\nüìå R√âPARTITION PAR √âTABLISSEMENT")
    print("-" * 40)
    
    etablissements = {}
    for teacher in teachers_data:
        etab = teacher.get('establishment', 'Non sp√©cifi√©')
        etablissements[etab] = etablissements.get(etab, 0) + 1
    
    for etab, count in sorted(etablissements.items(), key=lambda x: x[1], reverse=True):
        pourcentage = (count / len(teachers_data) * 100) if teachers_data else 0
        print(f"üè´ {etab}: {count} enseignants ({pourcentage:.1f}%)")
    
    # Analyse des mati√®res
    print("\nüìö MATI√àRES ENSEIGN√âES")
    print("-" * 40)
    
    matieres = {}
    for teacher in teachers_data:
        if teacher.get('data') and teacher['data'].get('subjects'):
            for subject in teacher['data']['subjects']:
                if subject and subject.get('name'):
                    matiere = subject['name']
                    matieres[matiere] = matieres.get(matiere, 0) + 1
    
    if matieres:
        print(f"üìñ Nombre de mati√®res diff√©rentes: {len(matieres)}")
        print("Top 10 des mati√®res les plus enseign√©es:")
        for matiere, count in sorted(matieres.items(), key=lambda x: x[1], reverse=True)[:10]:
            print(f"  ‚Ä¢ {matiere}: {count} enseignants")
    else:
        print("Aucune mati√®re enregistr√©e")
        
else:
    print("‚ùå Aucune donn√©e disponible. Veuillez d'abord importer des donn√©es dans l'onglet 'Importation'.")
                        </textarea>

                        <div class="python-output" id="pythonOutput">
                            <span style="color: #4CAF50;">Sortie Python s'affichera ici...</span>
                            <br><br>
                            <span style="color: #888; font-size: 0.9em;">
                                Ex√©cutez le script pour voir les r√©sultats d'analyse.
                            </span>
                        </div>
                    </div>

                    <div>
                        <div class="data-section">
                            <h3><i class="fas fa-code"></i> Scripts d'analyse pr√©d√©finis</h3>
                            <div class="python-template-grid">
                                <div class="python-script-item" onclick="loadPythonTemplate('basic_analysis')">
                                    <strong><i class="fas fa-chart-bar"></i> Analyse basique</strong>
                                    <p>Statistiques g√©n√©rales des enseignants</p>
                                </div>
                                <div class="python-script-item" onclick="loadPythonTemplate('pedagogy_analysis')">
                                    <strong><i class="fas fa-chalkboard-teacher"></i> Analyse p√©dagogique</strong>
                                    <p>Analyse des donn√©es d'enseignement</p>
                                </div>
                                <div class="python-script-item" onclick="loadPythonTemplate('retirement_analysis')">
                                    <strong><i class="fas fa-umbrella-beach"></i> Planification retraite</strong>
                                    <p>Analyse des d√©parts √† la retraite</p>
                                </div>
                                <div class="python-script-item" onclick="loadPythonTemplate('evaluation_analysis')">
                                    <strong><i class="fas fa-chart-line"></i> Analyse √©valuations</strong>
                                    <p>Statistiques des √©valuations</p>
                                </div>
                                <div class="python-script-item" onclick="loadPythonTemplate('export_analysis')">
                                    <strong><i class="fas fa-file-export"></i> Rapport complet</strong>
                                    <p>G√©n√©ration de rapport d√©taill√©</p>
                                </div>
                                <div class="python-script-item" onclick="loadPythonTemplate('data_validation')">
                                    <strong><i class="fas fa-check-circle"></i> Validation donn√©es</strong>
                                    <p>V√©rification de la qualit√© des donn√©es</p>
                                </div>
                            </div>
                        </div>

                        <div class="data-section mt-20">
                            <h3><i class="fas fa-chart-bar"></i> Statistiques disponibles</h3>
                            <div class="python-stats">
                                <div class="python-stat-item">
                                    <div>Enseignants</div>
                                    <div class="python-stat-value" id="pythonTeacherCount">0</div>
                                </div>
                                <div class="python-stat-item">
                                    <div>Fiches compl√®tes</div>
                                    <div class="python-stat-value" id="pythonCompleteCount">0</div>
                                </div>
                                <div class="python-stat-item">
                                    <div>Mati√®res</div>
                                    <div class="python-stat-value" id="pythonSubjectsCount">0</div>
                                </div>
                                <div class="python-stat-item">
                                    <div>√âtablissements</div>
                                    <div class="python-stat-value" id="pythonEstablishmentsCount">0</div>
                                </div>
                            </div>
                        </div>

                        <div class="data-section mt-20">
                            <h3><i class="fas fa-info-circle"></i> Variables disponibles</h3>
                            <div class="data-preview" style="font-size: 0.85rem;">
# Variables disponibles dans le contexte Python:
# - teachers_data: Liste compl√®te des donn√©es enseignants
#   Chaque enseignant a les propri√©t√©s suivantes:
#   ‚Ä¢ fullName: Nom complet
#   ‚Ä¢ lastName, firstName: Nom et pr√©nom
#   ‚Ä¢ matricule: Num√©ro matricule
#   ‚Ä¢ establishment: √âtablissement
#   ‚Ä¢ age: √Çge (calcul√©)
#   ‚Ä¢ serviceYears: Ann√©es de service
#   ‚Ä¢ complete: Fiche compl√®te (bool√©en)
#   ‚Ä¢ data: Donn√©es structur√©es (√©tablissement, personal, professional, subjects, etc.)

# Exemples d'acc√®s aux donn√©es:
# for teacher in teachers_data:
#     print(f"Enseignant: {teacher['fullName']}")
#     print(f"Matricule: {teacher.get('matricule', 'Non sp√©cifi√©')}")
#     print(f"√âtablissement: {teacher.get('establishment', 'Non sp√©cifi√©')}")
#     
#     if teacher.get('data'):
#         print(f"Mati√®res: {[s['name'] for s in teacher['data'].get('subjects', [])]}")
#         print(f"Date retraite: {teacher['data'].get('professional', {}).get('retirement_date')}")

# Modules Python disponibles:
# - datetime, math, statistics, json, collections, itertools
                            </div>
                        </div>
                    </div>
                </div>

                <div class="data-section mt-30">
                    <h3><i class="fas fa-database"></i> Structure des donn√©es</h3>
                    <div class="data-preview" style="font-size: 0.85rem;">
# Structure compl√®te des donn√©es d'un enseignant:
teacher_example = {
    "id": 1234567890,
    "lastName": "Dupont",
    "firstName": "Jean",
    "fullName": "Jean Dupont",
    "matricule": "12345ABC",
    "establishment": "Lyc√©e Victor Hugo",
    "age": 45,
    "serviceYears": 20,
    "yearsToRetirement": 15,
    "complete": True,
    "files": [
        {
            "name": "tab1_infos.json",
            "type": "tab1",
            "importDate": "2024-01-15T10:30:00Z"
        }
    ],
    "data": {
        "establishment": {
            "name": "Lyc√©e Victor Hugo",
            "type": "lycee",
            "address": "123 Rue de l'√âcole",
            "phone": "01 23 45 67 89",
            "email": "contact@lycee-victor-hugo.fr"
        },
        "personal": {
            "last_name": "Dupont",
            "first_name": "Jean",
            "birth_date": "1979-05-15",
            "birth_place": "Paris",
            "nationality": "Fran√ßaise",
            "address": "456 Rue de la Maison",
            "personal_phone": "06 12 34 56 78"
        },
        "professional": {
            "matricule": "12345ABC",
            "position": "Professeur",
            "grade": "Professeur certifi√©",
            "professional_category": "A2",
            "engagement_date": "2004-09-01",
            "retirement_date": "2039-05-15",
            "weekly_hours": 18
        },
        "subjects": [
            {"name": "Math√©matiques", "type": "main", "hours": 12},
            {"name": "Physique", "type": "secondary", "hours": 6}
        ],
        "lessons": [...],      # Liste des le√ßons (onglet 2)
        "evaluations": [...],  # Liste des √©valuations (onglet 3)
        "projects": [...]      # Liste des projets (onglet 4)
    }
}
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet Tableau de bord -->
        <div id="tab-dashboard" class="tab-content">
            <div class="filter-bar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Rechercher un enseignant..." id="dashboardSearch">
                </div>
                <select id="dashboardFilterSubject">
                    <option value="">Toutes les mati√®res</option>
                </select>
                <select id="dashboardFilterCategory">
                    <option value="">Toutes les cat√©gories</option>
                </select>
                <select id="dashboardFilterEstablishment">
                    <option value="">Tous les √©tablissements</option>
                </select>
            </div>

            <!-- Statistiques globales -->
            <div class="data-section">
                <h2><i class="fas fa-chart-bar"></i> STATISTIQUES GLOBALES</h2>
                <div class="stats-grid" id="globalStats"></div>
            </div>

            <!-- Graphiques -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-pie"></i> R√©partition par mati√®re</h3>
                    <div class="chart-container">
                        <canvas id="subjectChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-line"></i> √âvolution des retraites</h3>
                    <div class="chart-container">
                        <canvas id="retirementChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-bar"></i> Heures d'enseignement</h3>
                    <div class="chart-container">
                        <canvas id="hoursChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-graduation-cap"></i> R√©partition par √¢ge</h3>
                    <div class="chart-container">
                        <canvas id="ageChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Derni√®res activit√©s -->
            <div class="data-section">
                <h2><i class="fas fa-history"></i> ACTIVIT√âS P√âDAGOGIQUES R√âCENTES</h2>
                <div id="recentActivities"></div>
            </div>
        </div>

        <!-- Onglet Enseignants -->
        <div id="tab-teachers" class="tab-content">
            <div class="filter-bar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Rechercher par nom, matricule..." id="teacherSearch">
                </div>
                <button class="btn btn-light" onclick="sortTeachers('name')">
                    <i class="fas fa-sort-alpha-down"></i> Trier par nom
                </button>
                <button class="btn btn-light" onclick="sortTeachers('retirement')">
                    <i class="fas fa-calendar"></i> Trier par retraite
                </button>
                <button class="btn btn-light" onclick="filterCompleteOnly()">
                    <i class="fas fa-check-circle"></i> Fiches compl√®tes
                </button>
            </div>

            <!-- Liste des enseignants -->
            <div id="teachersListContainer">
                <div class="teacher-cards" id="teachersCards"></div>
            </div>

            <!-- D√©tails enseignant (modal) -->
            <div class="modal" id="teacherDetailModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="teacherModalTitle"></h3>
                        <button class="modal-close" onclick="closeTeacherDetail()">&times;</button>
                    </div>
                    <div id="teacherModalContent"></div>
                </div>
            </div>
        </div>

        <!-- Onglet P√©dagogie -->
        <div id="tab-pedagogy" class="tab-content">
            <!-- Sous-onglets p√©dagogie -->
            <div class="sub-tabs">
                <div class="sub-tab active" data-subtab="pedagogy-overview">Vue d'ensemble</div>
                <div class="sub-tab" data-subtab="pedagogy-subjects">Mati√®res enseign√©es</div>
                <div class="sub-tab" data-subtab="pedagogy-lessons">Le√ßons</div>
                <div class="sub-tab" data-subtab="pedagogy-tp">Travaux pratiques</div>
            </div>

            <!-- Sous-contenus -->
            <div class="sub-tab-content active" data-subtab="pedagogy-overview">
                <div class="data-section">
                    <h2><i class="fas fa-chart-bar"></i> STATISTIQUES P√âDAGOGIQUES</h2>
                    <div id="pedagogyStats"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="pedagogy-subjects">
                <div class="data-section">
                    <h2><i class="fas fa-book"></i> MATI√àRES ENSEIGN√âES</h2>
                    <div id="subjectsAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="pedagogy-lessons">
                <div class="data-section">
                    <h2><i class="fas fa-chalkboard"></i> LE√áONS ENREGISTR√âES</h2>
                    <div id="lessonsAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="pedagogy-tp">
                <div class="data-section">
                    <h2><i class="fas fa-flask"></i> TRAVAUX PRATIQUES</h2>
                    <div id="tpAnalysis"></div>
                </div>
            </div>
        </div>

        <!-- Onglet √âvaluations -->
        <div id="tab-evaluations" class="tab-content">
            <div class="data-section">
                <h2><i class="fas fa-chart-line"></i> STATISTIQUES D'√âVALUATION</h2>
                <div class="stats-grid" id="evaluationStats"></div>
            </div>

            <div class="data-section">
                <h2><i class="fas fa-table"></i> ANALYSE DES √âVALUATIONS</h2>
                <div id="evaluationsAnalysis"></div>
            </div>
        </div>

        <!-- Onglet Projets -->
        <div id="tab-projects" class="tab-content">
            <div class="data-section">
                <h2><i class="fas fa-project-diagram"></i> STATISTIQUES DES PROJETS</h2>
                <div class="stats-grid" id="projectsStats"></div>
            </div>

            <div class="data-section">
                <h2><i class="fas fa-table"></i> PROJETS ET ACTIVIT√âS</h2>
                <div id="projectsAnalysis"></div>
            </div>
        </div>

        <!-- Onglet Retraite -->
        <div id="tab-retirement" class="tab-content">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3><i class="fas fa-calendar-times"></i> Prochaines retraites</h3>
                    <div id="upcomingRetirements"></div>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-bar"></i> R√©partition par ann√©e</h3>
                    <div class="chart-container">
                        <canvas id="retirementYearChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="data-section">
                <h2><i class="fas fa-table"></i> TABLEAU DES RETRAITES</h2>
                <div id="retirementTable"></div>
            </div>

            <!-- Analyse de la retraite -->
            <div class="data-section">
                <h2><i class="fas fa-chart-pie"></i> ANALYSE PAR CAT√âGORIE</h2>
                <div class="stats-grid" id="retirementAnalysis"></div>
            </div>
        </div>

        <!-- Onglet Export Excel -->
        <div id="tab-export" class="tab-content">
            <div class="import-section">
                <h2><i class="fas fa-file-excel"></i> EXPORT EXCEL</h2>
                <p>Exportez toutes les donn√©es analys√©es au format Excel</p>

                <div class="export-options">
                    <button class="btn btn-success" onclick="exportAllToExcel()">
                        <i class="fas fa-file-excel"></i> Export complet
                    </button>
                    <button class="btn btn-primary" onclick="exportTeachersToExcel()">
                        <i class="fas fa-users"></i> Liste enseignants
                    </button>
                    <button class="btn btn-info" onclick="exportPedagogyToExcel()">
                        <i class="fas fa-chalkboard-teacher"></i> Donn√©es p√©dagogiques
                    </button>
                    <button class="btn btn-warning" onclick="exportEvaluationsToExcel()">
                        <i class="fas fa-chart-line"></i> Donn√©es √©valuations
                    </button>
                    <button class="btn btn-secondary" onclick="exportRetirementToExcel()">
                        <i class="fas fa-umbrella-beach"></i> Planification retraite
                    </button>
                    <button class="btn btn-secondary" onclick="exportProjectsToExcel()">
                        <i class="fas fa-project-diagram"></i> Projets et activit√©s
                    </button>
                </div>

                <!-- Aper√ßu des donn√©es √† exporter -->
                <div class="data-section mt-30">
                    <h2><i class="fas fa-eye"></i> APER√áU DES DONN√âES √Ä EXPORTER</h2>
                    <div id="exportPreview"></div>
                </div>
            </div>
        </div>

        <!-- Actions globales -->
        <div class="filter-bar" style="margin-top: 30px;">
            <a href="index.html" class="btn btn-light">
                <i class="fas fa-home"></i> Retour √† l'accueil
            </a>
            <button class="btn btn-light" onclick="clearAllData()">
                <i class="fas fa-trash"></i> Effacer toutes les donn√©es
            </button>
            <button class="btn btn-info" onclick="generateReport()">
                <i class="fas fa-file-pdf"></i> G√©n√©rer rapport
            </button>
            <button class="btn btn-primary" onclick="saveSession()">
                <i class="fas fa-save"></i> Sauvegarder la session
            </button>
            <button class="btn btn-secondary" onclick="backupData()">
                <i class="fas fa-download"></i> Exporter session
            </button>
        </div>
    </div>

    <script>
        // Variables globales
        let teachersData = [];
        let currentTeacherIndex = -1;
        let charts = {};
        let filteredTeachers = [];
        let currentFileType = 'all';
        let pyodide = null;
        let currentSort = { field: 'lastName', direction: 'asc' };
        let showCompleteOnly = false;
        let pyodideLoaded = false;

        // Types de fichiers support√©s
        const FILE_TYPES = {
            'tab1': {
                name: 'Informations G√©n√©rales',
                icon: 'fa-user-tie',
                description: 'Donn√©es personnelles, professionnelles et √©tablissement'
            },
            'tab2': {
                name: 'Enseignement & P√©dagogie',
                icon: 'fa-chalkboard-teacher',
                description: 'Planning, le√ßons, TP, ressources'
            },
            'tab3': {
                name: '√âvaluations & Statistiques',
                icon: 'fa-chart-line',
                description: '√âvaluations, performances, statistiques'
            },
            'tab4': {
                name: 'Projets & Activit√©s',
                icon: 'fa-project-diagram',
                description: 'Projets p√©dagogiques, activit√©s, r√©unions'
            },
            'tab5': {
                name: 'Donn√©es & Archives',
                icon: 'fa-database',
                description: 'Sauvegardes, logs, donn√©es techniques'
            },
            'complete': {
                name: 'Fichier complet',
                icon: 'fa-database',
                description: 'Toutes les donn√©es en un seul fichier'
            }
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        async function initApp() {
            // Initialiser l'ann√©e
            const currentYear = new Date().getFullYear();
            document.getElementById('currentYear').textContent = currentYear;
            
            // Gestion des onglets
            initTabs();
            
            // Gestion des sous-onglets
            initSubTabs();
            
            // Initialiser les √©v√©nements des boutons
            initButtons();
            
            // Charger les donn√©es de session
            loadSessionData();
            
            // Initialiser les √©v√©nements
            initEvents();
            
            // Initialiser Pyodide
            await initPyodide();
            
            showNotification('Plateforme d\'analyse pr√™te', 'success');
        }

        // Initialisation de Pyodide
        async function initPyodide() {
            const statusElement = document.getElementById('pyodideStatus');
            if (statusElement) {
                statusElement.style.display = 'block';
            }
            
            showLoader(true);
            
            try {
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                
                // Charger les packages n√©cessaires
                await pyodide.loadPackage(['micropip', 'numpy', 'pandas']);
                
                pyodideLoaded = true;
                
                if (statusElement) {
                    statusElement.innerHTML = `
                        <h4><i class="fas fa-check-circle" style="color: #2ecc71;"></i> Pyodide charg√© avec succ√®s</h4>
                        <p>Environnement Python pr√™t pour l'analyse des donn√©es</p>
                    `;
                }
                
                console.log('Pyodide charg√© avec succ√®s');
                showNotification('Environnement Python pr√™t pour l\'analyse', 'success');
                
                // Cacher le statut apr√®s 3 secondes
                setTimeout(() => {
                    if (statusElement) {
                        statusElement.style.display = 'none';
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Erreur lors du chargement de Pyodide:', error);
                if (statusElement) {
                    statusElement.innerHTML = `
                        <h4><i class="fas fa-exclamation-triangle" style="color: #f39c12;"></i> Pyodide non disponible</h4>
                        <p>L'analyse Python est limit√©e. Certaines fonctionnalit√©s peuvent ne pas √™tre disponibles.</p>
                    `;
                }
                showNotification('Pyodide non disponible - analyse Python limit√©e', 'warning');
            } finally {
                showLoader(false);
            }
        }

        // Ex√©cution de l'analyse Python
        async function runPythonAnalysis() {
            if (!pyodideLoaded) {
                showNotification('Chargement de Pyodide en cours...', 'warning');
                await initPyodide();
                if (!pyodideLoaded) {
                    showNotification('Impossible de charger Pyodide. Veuillez r√©essayer.', 'error');
                    return;
                }
            }
            
            const pythonCode = document.getElementById('pythonEditor').value;
            const outputElement = document.getElementById('pythonOutput');
            
            if (!pythonCode.trim()) {
                showNotification('Veuillez entrer du code Python', 'warning');
                return;
            }
            
            showLoader(true);
            outputElement.innerHTML = '<span style="color: #4CAF50;">Ex√©cution en cours...</span>';
            
            try {
                // Pr√©parer les donn√©es pour Python
                const pythonReadyData = prepareDataForPython(teachersData);
                
                // Injecter les donn√©es dans l'environnement Python
                pyodide.globals.set('teachers_data', pythonReadyData);
                pyodide.globals.set('FILE_TYPES', FILE_TYPES);
                
                // Ajouter des modules essentiels
                await pyodide.runPythonAsync(`
                    import json
                    import datetime
                    from datetime import datetime as dt
                    import statistics
                    import math
                    from collections import Counter, defaultdict
                `);
                
                // Ex√©cuter le code Python
                try {
                    await pyodide.runPythonAsync(pythonCode);
                    showNotification('Analyse Python ex√©cut√©e avec succ√®s', 'success');
                } catch (pyError) {
                    outputElement.innerHTML = `
                        <div style="color: #ff6b6b; font-family: monospace;">
                            <strong>Erreur Python:</strong><br>
                            ${pyError.toString().replace(/\n/g, '<br>')}
                        </div>
                    `;
                    showNotification('Erreur dans l\'ex√©cution Python', 'error');
                }
                
                // Mettre √† jour les statistiques Python
                updatePythonStats();
                
            } catch (error) {
                outputElement.innerHTML = `
                    <div style="color: #ff6b6b; font-family: monospace;">
                        <strong>Erreur d'ex√©cution:</strong><br>
                        ${error.toString().replace(/\n/g, '<br>')}
                    </div>
                `;
                showNotification('Erreur dans l\'analyse Python', 'error');
            } finally {
                showLoader(false);
            }
        }

        // Pr√©parer les donn√©es pour Python
        function prepareDataForPython(data) {
            // Convertir les donn√©es en format compatible avec Python
            return JSON.parse(JSON.stringify(data));
        }

        // Charger un mod√®le d'analyse Python
        function loadPythonTemplate(templateName) {
            const templates = {
                'basic_analysis': `# === ANALYSE BASIQUE DES DONN√âES ENSEIGNANTS ===
def analyse_basique(teachers_data):
    """Analyse statistique basique des enseignants"""
    if not teachers_data:
        return "‚ö†Ô∏è Aucune donn√©e disponible"
    
    total = len(teachers_data)
    complet = sum(1 for t in teachers_data if t.get('complete', False))
    
    # Calcul des √¢ges
    ages = [t.get('age') for t in teachers_data if t.get('age')]
    age_moyenne = statistics.mean(ages) if ages else 0
    age_min = min(ages) if ages else 0
    age_max = max(ages) if ages else 0
    
    # Analyse par √©tablissement
    etablissements = Counter()
    for teacher in teachers_data:
        etab = teacher.get('establishment', 'Non sp√©cifi√©')
        etablissements[etab] += 1
    
    # Analyse par cat√©gorie professionnelle
    categories = Counter()
    for teacher in teachers_data:
        if teacher.get('data') and teacher['data'].get('professional'):
            cat = teacher['data']['professional'].get('professional_category', 'Non sp√©cifi√©')
            categories[cat] += 1
    
    # G√©n√©ration du rapport
    rapport = []
    rapport.append("=== RAPPORT D'ANALYSE BASIQUE ===")
    rapport.append(f"üìÖ Date: {dt.now().strftime('%Y-%m-%d %H:%M:%S')}")
    rapport.append(f"üë• Total enseignants: {total}")
    rapport.append(f"‚úÖ Fiches compl√®tes: {complet} ({complet/total*100:.1f}%)")
    rapport.append(f"üéÇ √Çge moyen: {age_moyenne:.1f} ans (min: {age_min}, max: {age_max})")
    rapport.append("")
    rapport.append("=== üìä R√âPARTITION PAR √âTABLISSEMENT ===")
    for etab, count in etablissements.most_common(15):
        rapport.append(f"üè´ {etab}: {count} ({count/total*100:.1f}%)")
    
    rapport.append("")
    rapport.append("=== üè∑Ô∏è R√âPARTITION PAR CAT√âGORIE ===")
    for cat, count in categories.most_common():
        if cat != 'Non sp√©cifi√©':
            rapport.append(f"üìã {cat}: {count} ({count/total*100:.1f}%)")
    
    return "\\n".join(rapport)

# Ex√©cution
print(analyse_basique(teachers_data))`,

                'pedagogy_analysis': `# === ANALYSE P√âDAGOGIQUE APPROFONDIE ===
def analyse_pedagogique(teachers_data):
    """Analyse d√©taill√©e des donn√©es p√©dagogiques"""
    if not teachers_data:
        return "‚ö†Ô∏è Aucune donn√©e p√©dagogique disponible"
    
    rapport = []
    rapport.append("=== üìö ANALYSE P√âDAGOGIQUE ===")
    
    # Statistiques g√©n√©rales
    total_lecons = sum(len(t.get('data', {}).get('lessons', [])) for t in teachers_data)
    total_tp = sum(len(t.get('data', {}).get('tps', [])) for t in teachers_data)
    
    enseignants_avec_lecons = sum(1 for t in teachers_data if t.get('data', {}).get('lessons'))
    enseignants_avec_tp = sum(1 for t in teachers_data if t.get('data', {}).get('tps'))
    
    rapport.append(f"üìñ Le√ßons totales: {total_lecons}")
    rapport.append(f"üî¨ TP total: {total_tp}")
    rapport.append(f"üë®‚Äçüè´ Enseignants avec le√ßons: {enseignants_avec_lecons}/{len(teachers_data)} ({enseignants_avec_lecons/len(teachers_data)*100:.1f}%)")
    rapport.append(f"üë©‚Äçüî¨ Enseignants avec TP: {enseignants_avec_tp}/{len(teachers_data)} ({enseignants_avec_tp/len(teachers_data)*100:.1f}%)")
    
    # Analyse par mati√®re
    matieres = Counter()
    heures_par_matiere = defaultdict(float)
    
    for teacher in teachers_data:
        if teacher.get('data') and teacher['data'].get('subjects'):
            for subject in teacher['data']['subjects']:
                if subject and subject.get('name'):
                    matiere = subject['name']
                    matieres[matiere] += 1
                    heures = float(subject.get('hours', 0) or 0)
                    heures_par_matiere[matiere] += heures
    
    rapport.append("")
    rapport.append("=== üìö MATI√àRES LES PLUS ENSEIGN√âES ===")
    for matiere, count in matieres.most_common(15):
        heures = heures_par_matiere[matiere]
        rapport.append(f"üìñ {matiere}: {count} enseignants, {heures:.0f} heures totales")
    
    # Analyse des emplois du temps
    teachers_avec_edt = sum(1 for t in teachers_data if t.get('data', {}).get('timetable'))
    rapport.append("")
    rapport.append(f"üìÖ Enseignants avec emploi du temps: {teachers_avec_edt} ({teachers_avec_edt/len(teachers_data)*100:.1f}%)")
    
    # Analyse des ressources
    total_ressources = sum(len(t.get('data', {}).get('resources', [])) for t in teachers_data)
    rapport.append(f"üìé Ressources p√©dagogiques totales: {total_ressources}")
    
    return "\\n".join(rapport)

print(analyse_pedagogique(teachers_data))`,

                'retirement_analysis': `# === ANALYSE DE LA PLANIFICATION DES RETRAITES ===
def analyse_retraites(teachers_data):
    """Analyse des d√©parts √† la retraite"""
    rapport = []
    rapport.append("=== üèñÔ∏è ANALYSE DES RETRAITES ===")
    
    # Enseignants avec date de retraite
    teachers_avec_date = []
    for teacher in teachers_data:
        if teacher.get('data') and teacher['data'].get('professional'):
            if teacher['data']['professional'].get('retirement_date'):
                teachers_avec_date.append(teacher)
    
    total = len(teachers_data)
    avec_date = len(teachers_avec_date)
    sans_date = total - avec_date
    
    rapport.append(f"üë• Total enseignants: {total}")
    rapport.append(f"üìÖ Avec date de retraite: {avec_date} ({avec_date/total*100:.1f}%)")
    rapport.append(f"‚ùì Sans date de retraite: {sans_date} ({sans_date/total*100:.1f}%)")
    
    if not teachers_avec_date:
        return "\\n".join(rapport)
    
    # Calcul des ann√©es restantes
    aujourdhui = datetime.datetime.now()
    
    retraites_par_annee = Counter()
    urgence = {'< 1 an': 0, '1-3 ans': 0, '3-5 ans': 0, '> 5 ans': 0}
    annees_restantes_liste = []
    
    for teacher in teachers_avec_date:
        date_retraite_str = teacher['data']['professional']['retirement_date']
        try:
            if 'T' in date_retraite_str:
                date_retraite = datetime.datetime.fromisoformat(date_retraite_str.replace('Z', '+00:00'))
            else:
                date_retraite = datetime.datetime.strptime(date_retraite_str, '%Y-%m-%d')
            
            annees_restantes = (date_retraite - aujourdhui).days / 365.25
            annees_restantes_liste.append(annees_restantes)
            
            annee = date_retraite.year
            retraites_par_annee[annee] += 1
            
            if annees_restantes < 1:
                urgence['< 1 an'] += 1
            elif annees_restantes < 3:
                urgence['1-3 ans'] += 1
            elif annees_restantes < 5:
                urgence['3-5 ans'] += 1
            else:
                urgence['> 5 ans'] += 1
                
        except Exception as e:
            continue
    
    rapport.append("")
    rapport.append("=== ‚ö†Ô∏è R√âPARTITION PAR URGENCE ===")
    for categorie, count in urgence.items():
        pourcentage = count / avec_date * 100
        rapport.append(f"üïí {categorie}: {count} ({pourcentage:.1f}%)")
    
    if annees_restantes_liste:
        rapport.append("")
        rapport.append("=== üìä STATISTIQUES TEMPS RESTANT ===")
        rapport.append(f"‚è±Ô∏è  Moyenne: {statistics.mean(annees_restantes_liste):.1f} ans")
        rapport.append(f"üìà Maximum: {max(annees_restantes_liste):.1f} ans")
        rapport.append(f"üìâ Minimum: {min(annees_restantes_liste):.1f} ans")
        rapport.append(f"üìä M√©diane: {statistics.median(annees_restantes_liste):.1f} ans")
    
    rapport.append("")
    rapport.append("=== üìÖ RETRAITES PAR ANN√âE ===")
    for annee, count in sorted(retraites_par_annee.items()):
        rapport.append(f"üóìÔ∏è  {annee}: {count} retraites")
    
    # Analyse par cat√©gorie
    retraites_par_categorie = Counter()
    for teacher in teachers_avec_date:
        if teacher.get('data') and teacher['data'].get('professional'):
            cat = teacher['data']['professional'].get('professional_category', 'Non sp√©cifi√©')
            retraites_par_categorie[cat] += 1
    
    rapport.append("")
    rapport.append("=== üè∑Ô∏è RETRAITES PAR CAT√âGORIE ===")
    for cat, count in retraites_par_categorie.most_common():
        if cat != 'Non sp√©cifi√©':
            rapport.append(f"üìã {cat}: {count}")
    
    return "\\n".join(rapport)

print(analyse_retraites(teachers_data))`,

                'evaluation_analysis': `# === ANALYSE DES √âVALUATIONS ===
def analyse_evaluations(teachers_data):
    """Analyse des donn√©es d'√©valuation"""
    if not teachers_data:
        return "‚ö†Ô∏è Aucune donn√©e d'√©valuation disponible"
    
    rapport = []
    rapport.append("=== üìä ANALYSE DES √âVALUATIONS ===")
    
    # Compilation des donn√©es
    total_evaluations = 0
    evaluations_par_type = Counter()
    evaluations_par_matiere = Counter()
    evaluations_par_mois = Counter()
    
    notes_totales = []
    meilleures_notes = []
    
    for teacher in teachers_data:
        if teacher.get('data') and teacher['data'].get('evaluations'):
            evaluations = teacher['data']['evaluations']
            total_evaluations += len(evaluations)
            
            for eval_item in evaluations:
                # Type d'√©valuation
                eval_type = eval_item.get('type', 'Non sp√©cifi√©')
                evaluations_par_type[eval_type] += 1
                
                # Mati√®re
                sujet = eval_item.get('subject', 'Non sp√©cifi√©')
                if sujet != 'Non sp√©cifi√©':
                    evaluations_par_matiere[sujet] += 1
                
                # Date
                date_str = eval_item.get('date', '')
                if date_str:
                    try:
                        mois = date_str[:7]  # YYYY-MM
                        evaluations_par_mois[mois] += 1
                    except:
                        pass
                
                # Notes
                moyenne = eval_item.get('average')
                meilleure = eval_item.get('best')
                
                if moyenne is not None:
                    try:
                        notes_totales.append(float(moyenne))
                    except:
                        pass
                
                if meilleure is not None:
                    try:
                        meilleures_notes.append(float(meilleure))
                    except:
                        pass
    
    rapport.append(f"üìà √âvaluations totales: {total_evaluations}")
    
    if notes_totales:
        rapport.append(f"üìä Moyenne g√©n√©rale: {statistics.mean(notes_totales):.2f}/20")
        rapport.append(f"üèÜ Meilleure note moyenne: {max(notes_totales):.2f}/20")
        rapport.append(f"üìâ √âcart-type: {statistics.stdev(notes_totales):.2f}")
    
    rapport.append("")
    rapport.append("=== üè∑Ô∏è R√âPARTITION PAR TYPE ===")
    for type_eval, count in evaluations_par_type.most_common():
        pourcentage = count / total_evaluations * 100 if total_evaluations > 0 else 0
        rapport.append(f"üìã {type_eval}: {count} ({pourcentage:.1f}%)")
    
    rapport.append("")
    rapport.append("=== üìö √âVALUATIONS PAR MATI√àRE (TOP 10) ===")
    for matiere, count in evaluations_par_matiere.most_common(10):
        pourcentage = count / total_evaluations * 100 if total_evaluations > 0 else 0
        rapport.append(f"üìñ {matiere}: {count} ({pourcentage:.1f}%)")
    
    rapport.append("")
    rapport.append("=== üìÖ √âVOLUTION MENSUELLE ===")
    for mois, count in sorted(evaluations_par_mois.items()):
        rapport.append(f"üóìÔ∏è  {mois}: {count} √©valuations")
    
    # Enseignants avec/sans √©valuations
    enseignants_avec_eval = sum(1 for t in teachers_data if t.get('data', {}).get('evaluations'))
    rapport.append("")
    rapport.append(f"üë®‚Äçüè´ Enseignants avec √©valuations: {enseignants_avec_eval}/{len(teachers_data)} ({enseignants_avec_eval/len(teachers_data)*100:.1f}%)")
    
    return "\\n".join(rapport)

print(analyse_evaluations(teachers_data))`,

                'export_analysis': `# === G√âN√âRATION DE RAPPORT COMPLET ===
def generer_rapport_complet(teachers_data):
    """G√©n√®re un rapport complet pour export"""
    import datetime
    
    rapport = []
    rapport.append("=" * 70)
    rapport.append("üìä RAPPORT COMPLET D'ANALYSE DES ENSEIGNANTS")
    rapport.append(f"üìÖ Date de g√©n√©ration: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    rapport.append("=" * 70)
    rapport.append("")
    
    # 1. Statistiques g√©n√©rales
    rapport.append("1. üìà STATISTIQUES G√âN√âRALES")
    rapport.append("-" * 50)
    rapport.append(f"üë• Nombre total d'enseignants: {len(teachers_data)}")
    
    fiches_completes = sum(1 for t in teachers_data if t.get('complete', False))
    rapport.append(f"‚úÖ Fiches compl√®tes: {fiches_completes} ({fiches_completes/len(teachers_data)*100:.1f}%)")
    
    # Calcul de l'√¢ge
    ages = [t.get('age') for t in teachers_data if t.get('age')]
    if ages:
        rapport.append(f"üéÇ √Çge moyen: {statistics.mean(ages):.1f} ans")
        rapport.append(f"üìâ √Çge minimum: {min(ages)} ans")
        rapport.append(f"üìà √Çge maximum: {max(ages)} ans")
        rapport.append(f"üìä √âcart-type: {statistics.stdev(ages):.1f} ans")
    
    # 2. Analyse par √©tablissement
    rapport.append("")
    rapport.append("2. üè´ R√âPARTITION PAR √âTABLISSEMENT")
    rapport.append("-" * 50)
    
    etablissements = Counter()
    for teacher in teachers_data:
        etab = teacher.get('establishment', 'Non sp√©cifi√©')
        etablissements[etab] += 1
    
    for etab, count in etablissements.most_common():
        pourcentage = count / len(teachers_data) * 100
        rapport.append(f"üè´ {etab}: {count} enseignants ({pourcentage:.1f}%)")
    
    # 3. Analyse p√©dagogique
    rapport.append("")
    rapport.append("3. üìö ANALYSE P√âDAGOGIQUE")
    rapport.append("-" * 50)
    
    total_lecons = sum(len(t.get('data', {}).get('lessons', [])) for t in teachers_data)
    total_tp = sum(len(t.get('data', {}).get('tps', [])) for t in teachers_data)
    
    rapport.append(f"üìñ Le√ßons totales enregistr√©es: {total_lecons}")
    rapport.append(f"üî¨ Travaux pratiques total: {total_tp}")
    rapport.append(f"üìä Moyenne le√ßons/enseignant: {total_lecons/len(teachers_data):.1f}")
    
    # 4. Analyse des √©valuations
    rapport.append("")
    rapport.append("4. üìä ANALYSE DES √âVALUATIONS")
    rapport.append("-" * 50)
    
    total_evaluations = sum(len(t.get('data', {}).get('evaluations', [])) for t in teachers_data)
    rapport.append(f"üìà √âvaluations totales: {total_evaluations}")
    rapport.append(f"üìä Moyenne √©valuations/enseignant: {total_evaluations/len(teachers_data):.1f}")
    
    # 5. Planification retraite
    rapport.append("")
    rapport.append("5. üèñÔ∏è PLANIFICATION DES RETRAITES")
    rapport.append("-" * 50)
    
    teachers_avec_retraite = sum(1 for t in teachers_data 
                                if t.get('data') and t['data'].get('professional') 
                                and t['data']['professional'].get('retirement_date'))
    
    rapport.append(f"üìÖ Enseignants avec date de retraite: {teachers_avec_retraite}/{len(teachers_data)}")
    
    # 6. Recommandations
    rapport.append("")
    rapport.append("6. üí° RECOMMANDATIONS ET OBSERVATIONS")
    rapport.append("-" * 50)
    
    # Taux de compl√©tion
    taux_completion = fiches_completes / len(teachers_data) if teachers_data else 0
    if taux_completion < 0.7:
        rapport.append("‚ö†Ô∏è  Priorit√©: Am√©liorer le taux de compl√©tion des fiches")
        rapport.append(f"   ‚Ä¢ Objectif: Atteindre 70% (actuellement {taux_completion*100:.1f}%)")
    
    # Retraites
    taux_retraite = teachers_avec_retraite / len(teachers_data) if teachers_data else 0
    if taux_retraite < 0.5:
        rapport.append("‚ö†Ô∏è  Priorit√©: Compl√©ter les dates de retraite")
        rapport.append(f"   ‚Ä¢ Objectif: Atteindre 50% (actuellement {taux_retraite*100:.1f}%)")
    
    # Le√ßons
    taux_lecons = total_lecons / len(teachers_data) if teachers_data else 0
    if taux_lecons < 10:
        rapport.append("üìù Observation: Faible nombre de le√ßons enregistr√©es")
        rapport.append(f"   ‚Ä¢ Moyenne actuelle: {taux_lecons:.1f} le√ßons/enseignant")
    
    # √âvaluations
    taux_evaluations = total_evaluations / len(teachers_data) if teachers_data else 0
    if taux_evaluations < 5:
        rapport.append("üìä Observation: Faible nombre d'√©valuations")
        rapport.append(f"   ‚Ä¢ Moyenne actuelle: {taux_evaluations:.1f} √©valuations/enseignant")
    
    rapport.append("")
    rapport.append("=" * 70)
    rapport.append("‚úÖ FIN DU RAPPORT")
    rapport.append("=" * 70)
    
    return "\\n".join(rapport)

# G√©n√©ration et affichage du rapport
print(generer_rapport_complet(teachers_data))`,

                'data_validation': `# === VALIDATION DE LA QUALIT√â DES DONN√âES ===
def valider_donnees(teachers_data):
    """Valide la qualit√© et la compl√©tude des donn√©es"""
    if not teachers_data:
        return "‚ö†Ô∏è Aucune donn√©e √† valider"
    
    rapport = []
    rapport.append("=== üîç VALIDATION DE LA QUALIT√â DES DONN√âES ===")
    
    total = len(teachers_data)
    erreurs_par_type = Counter()
    enseignants_problemes = []
    
    for idx, teacher in enumerate(teachers_data):
        problemes = []
        
        # V√©rification des champs obligatoires
        if not teacher.get('lastName') or not teacher.get('firstName'):
            problemes.append("Nom/pr√©nom manquant")
            erreurs_par_type['identite'] += 1
        
        if not teacher.get('matricule'):
            problemes.append("Matricule manquant")
            erreurs_par_type['matricule'] += 1
        
        if not teacher.get('establishment'):
            problemes.append("√âtablissement manquant")
            erreurs_par_type['etablissement'] += 1
        
        # V√©rification des donn√©es structurelles
        if teacher.get('data'):
            data = teacher['data']
            
            # Informations personnelles
            if data.get('personal'):
                personal = data['personal']
                if not personal.get('birth_date'):
                    problemes.append("Date de naissance manquante")
                    erreurs_par_type['naissance'] += 1
            
            # Informations professionnelles
            if data.get('professional'):
                professional = data['professional']
                if not professional.get('engagement_date'):
                    problemes.append("Date d'engagement manquante")
                    erreurs_par_type['engagement'] += 1
            
            # Mati√®res enseign√©es
            if not data.get('subjects') or len(data.get('subjects', [])) == 0:
                problemes.append("Aucune mati√®re enseign√©e")
                erreurs_par_type['matieres'] += 1
        
        if problemes:
            enseignants_problemes.append({
                'nom': teacher.get('fullName', f'Enseignant {idx+1}'),
                'problemes': problemes,
                'matricule': teacher.get('matricule', 'Non sp√©cifi√©')
            })
    
    # R√©sum√©
    rapport.append(f"üë• Total enseignants analys√©s: {total}")
    rapport.append(f"‚úÖ Enseignants sans probl√®mes: {total - len(enseignants_problemes)} ({((total - len(enseignants_problemes))/total*100):.1f}%)")
    rapport.append(f"‚ùå Enseignants avec probl√®mes: {len(enseignants_problemes)} ({len(enseignants_problemes)/total*100:.1f}%)")
    
    rapport.append("")
    rapport.append("=== üìä R√âPARTITION DES PROBL√àMES ===")
    for type_erreur, count in erreurs_par_type.most_common():
        pourcentage = count / total * 100
        rapport.append(f"üî¥ {type_erreur}: {count} occurrences ({pourcentage:.1f}%)")
    
    rapport.append("")
    rapport.append("=== üë®‚Äçüè´ ENSEIGNANTS AVEC PROBL√àMES (TOP 10) ===")
    for enseignant in enseignants_problemes[:10]:
        rapport.append(f"üìå {enseignant['nom']} ({enseignant['matricule']})")
        for probleme in enseignant['problemes']:
            rapport.append(f"   ‚Ä¢ {probleme}")
    
    # Recommandations
    rapport.append("")
    rapport.append("=== üí° RECOMMANDATIONS ===")
    
    if erreurs_par_type['identite'] > 0:
        rapport.append("1. üî∏ Compl√©ter les noms et pr√©noms manquants")
    
    if erreurs_par_type['matricule'] > 0:
        rapport.append("2. üî∏ Ajouter les num√©ros de matricule")
    
    if erreurs_par_type['etablissement'] > 0:
        rapport.append("3. üî∏ Sp√©cifier les √©tablissements")
    
    if erreurs_par_type['matieres'] > 0:
        rapport.append("4. üî∏ Ajouter les mati√®res enseign√©es")
    
    return "\\n".join(rapport)

print(valider_donnees(teachers_data))`
            };
            
            const editor = document.getElementById('pythonEditor');
            if (templates[templateName]) {
                editor.value = templates[templateName];
                showNotification(`Mod√®le "${templateName}" charg√©`, 'success');
                
                // Mettre √† jour les statistiques
                updatePythonStats();
            } else {
                showNotification('Mod√®le non trouv√©', 'warning');
            }
        }

        // Sauvegarder le script Python
        function savePythonScript() {
            const pythonCode = document.getElementById('pythonEditor').value;
            if (!pythonCode.trim()) {
                showNotification('Aucun code √† sauvegarder', 'warning');
                return;
            }
            
            const blob = new Blob([pythonCode], { type: 'text/x-python' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analyse_enseignants_${new Date().toISOString().split('T')[0]}.py`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Script Python sauvegard√©', 'success');
        }

        // Effacer la sortie Python
        function clearPythonOutput() {
            document.getElementById('pythonOutput').innerHTML = 
                '<span style="color: #4CAF50;">Sortie Python s\'affichera ici...</span><br><br>' +
                '<span style="color: #888; font-size: 0.9em;">Ex√©cutez le script pour voir les r√©sultats d\'analyse.</span>';
        }

        // Mettre √† jour les statistiques Python
        function updatePythonStats() {
            if (!teachersData || teachersData.length === 0) {
                document.getElementById('pythonTeacherCount').textContent = '0';
                document.getElementById('pythonCompleteCount').textContent = '0';
                document.getElementById('pythonSubjectsCount').textContent = '0';
                document.getElementById('pythonEstablishmentsCount').textContent = '0';
                return;
            }
            
            const totalTeachers = teachersData.length;
            const completeTeachers = teachersData.filter(t => t.complete).length;
            
            // Compter les mati√®res uniques
            const subjectSet = new Set();
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.subjects) {
                    teacher.data.subjects.forEach(subject => {
                        if (subject && subject.name) subjectSet.add(subject.name);
                    });
                }
            });
            
            // Compter les √©tablissements uniques
            const establishmentSet = new Set();
            teachersData.forEach(teacher => {
                if (teacher.establishment) {
                    establishmentSet.add(teacher.establishment);
                }
            });
            
            document.getElementById('pythonTeacherCount').textContent = totalTeachers;
            document.getElementById('pythonCompleteCount').textContent = completeTeachers;
            document.getElementById('pythonSubjectsCount').textContent = subjectSet.size;
            document.getElementById('pythonEstablishmentsCount').textContent = establishmentSet.size;
        }

        // Initialiser les onglets
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
        }

        function initSubTabs() {
            const subTabs = document.querySelectorAll('.sub-tab');
            subTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const subtabId = this.getAttribute('data-subtab');
                    switchSubTab(subtabId);
                });
            });
        }

        function initButtons() {
            // Boutons d'importation
            document.getElementById('singleFileBtn').addEventListener('click', function() {
                document.getElementById('singleFileInput').click();
            });
            
            document.getElementById('multiFileBtn').addEventListener('click', function() {
                document.getElementById('multiFileInput').click();
            });
            
            document.getElementById('completeFileBtn').addEventListener('click', function() {
                document.getElementById('completeFileInput').click();
            });
            
            // Gestion des inputs de fichiers
            document.getElementById('singleFileInput').addEventListener('change', handleSingleFileImport);
            document.getElementById('multiFileInput').addEventListener('change', handleMultiFileImport);
            document.getElementById('completeFileInput').addEventListener('change', handleCompleteFileImport);
        }

        function initEvents() {
            // Recherche
            const dashboardSearch = document.getElementById('dashboardSearch');
            if (dashboardSearch) {
                dashboardSearch.addEventListener('input', filterDashboard);
            }
            
            const teacherSearch = document.getElementById('teacherSearch');
            if (teacherSearch) {
                teacherSearch.addEventListener('input', filterTeachers);
            }
            
            // Pr√©visualisation des donn√©es
            const dataPreviewSelect = document.getElementById('dataPreviewSelect');
            if (dataPreviewSelect) {
                dataPreviewSelect.addEventListener('change', function() {
                    previewTeacherData(this.value);
                });
            }
        }

        function switchTab(tabId) {
            // D√©sactiver tous les onglets
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Activer l'onglet s√©lectionn√©
            const tabElement = document.querySelector(`[data-tab="${tabId}"]`);
            const tabContent = document.getElementById(tabId);
            
            if (tabElement) tabElement.classList.add('active');
            if (tabContent) tabContent.classList.add('active');
            
            // Mettre √† jour l'interface sp√©cifique
            updateTabUI(tabId);
        }

        function switchSubTab(subtabId) {
            // D√©sactiver tous les sous-onglets
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
            
            // Activer le sous-onglet s√©lectionn√©
            const subTabElement = document.querySelector(`.sub-tab[data-subtab="${subtabId}"]`);
            const subTabContent = document.querySelector(`.sub-tab-content[data-subtab="${subtabId}"]`);
            
            if (subTabElement) subTabElement.classList.add('active');
            if (subTabContent) subTabContent.classList.add('active');
            
            // Mettre √† jour le contenu sp√©cifique
            updateSubTabUI(subtabId);
        }

        function updateTabUI(tabId) {
            switch(tabId) {
                case 'tab-dashboard':
                    updateDashboard();
                    break;
                case 'tab-teachers':
                    updateTeachersList();
                    break;
                case 'tab-python':
                    updatePythonStats();
                    break;
                case 'tab-export':
                    updateExportPreview();
                    break;
            }
        }

        function updateSubTabUI(subtabId) {
            // Mettre √† jour le contenu sp√©cifique du sous-onglet
            switch(subtabId) {
                case 'pedagogy-overview':
                    updatePedagogyOverview();
                    break;
                case 'pedagogy-subjects':
                    updateSubjectsAnalysis();
                    break;
                case 'pedagogy-lessons':
                    updateLessonsAnalysis();
                    break;
                case 'pedagogy-tp':
                    updateTPAnalysis();
                    break;
            }
        }

        // Gestion des imports de fichiers
        async function handleSingleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoader(true);
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                // Traiter le fichier unique
                processImportedFile(file.name, data, 'single');
                
                showNotification(`Fichier ${file.name} import√© avec succ√®s`, 'success');
                
            } catch (error) {
                console.error('Erreur lors de l\'importation:', error);
                showNotification(`Erreur lors de l'importation: ${error.message}`, 'error');
            } finally {
                showLoader(false);
                event.target.value = ''; // R√©initialiser l'input
            }
        }

        async function handleMultiFileImport(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            showLoader(true);
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    // Traiter chaque fichier
                    processImportedFile(file.name, data, 'multi');
                }
                
                showNotification(`${files.length} fichiers import√©s avec succ√®s`, 'success');
                
            } catch (error) {
                console.error('Erreur lors de l\'importation multiple:', error);
                showNotification(`Erreur lors de l'importation multiple: ${error.message}`, 'error');
            } finally {
                showLoader(false);
                event.target.value = ''; // R√©initialiser l'input
            }
        }

        async function handleCompleteFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoader(true);
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                // Traiter le fichier complet
                processCompleteFile(file.name, data);
                
                showNotification(`Fichier complet ${file.name} import√© avec succ√®s`, 'success');
                
            } catch (error) {
                console.error('Erreur lors de l\'importation compl√®te:', error);
                showNotification(`Erreur lors de l'importation compl√®te: ${error.message}`, 'error');
            } finally {
                showLoader(false);
                event.target.value = ''; // R√©initialiser l'input
            }
        }

        // Traiter un fichier import√©
        function processImportedFile(filename, data, importType) {
            // D√©terminer le type de fichier bas√© sur le nom
            let fileType = 'unknown';
            if (filename.includes('tab1')) fileType = 'tab1';
            else if (filename.includes('tab2')) fileType = 'tab2';
            else if (filename.includes('tab3')) fileType = 'tab3';
            else if (filename.includes('tab4')) fileType = 'tab4';
            else if (filename.includes('tab5')) fileType = 'tab5';
            else if (filename.includes('complete')) fileType = 'complete';
            
            // Cr√©er ou mettre √† jour un enseignant
            const teacherId = generateTeacherId(data);
            let teacherIndex = teachersData.findIndex(t => t.id === teacherId);
            
            if (teacherIndex === -1) {
                // Cr√©er un nouvel enseignant
                const newTeacher = createTeacherFromData(data, fileType);
                newTeacher.id = teacherId;
                teachersData.push(newTeacher);
                teacherIndex = teachersData.length - 1;
            } else {
                // Mettre √† jour l'enseignant existant
                updateTeacherData(teachersData[teacherIndex], data, fileType);
            }
            
            // Ajouter le fichier √† la liste des fichiers de l'enseignant
            if (!teachersData[teacherIndex].files) {
                teachersData[teacherIndex].files = [];
            }
            
            teachersData[teacherIndex].files.push({
                name: filename,
                type: fileType,
                importDate: new Date().toISOString(),
                importType: importType
            });
            
            // Marquer comme complet si toutes les donn√©es sont pr√©sentes
            checkTeacherCompleteness(teachersData[teacherIndex]);
            
            // Mettre √† jour l'interface
            updateUIAfterImport();
        }

        // Traiter un fichier complet
        function processCompleteFile(filename, data) {
            if (Array.isArray(data)) {
                // Si c'est un tableau d'enseignants
                data.forEach(teacherData => {
                    processImportedFile(filename, teacherData, 'complete');
                });
            } else if (typeof data === 'object') {
                // Si c'est un objet unique
                processImportedFile(filename, data, 'complete');
            }
        }

        // Cr√©er un ID d'enseignant unique
        function generateTeacherId(data) {
            // Utiliser le matricule si disponible
            if (data.matricule) {
                return `teacher_${data.matricule}`;
            }
            
            // Sinon, utiliser le nom et pr√©nom
            if (data.lastName && data.firstName) {
                return `teacher_${data.lastName}_${data.firstName}`;
            }
            
            // Sinon, g√©n√©rer un ID bas√© sur le timestamp
            return `teacher_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        // Cr√©er un enseignant √† partir des donn√©es
        function createTeacherFromData(data, fileType) {
            const teacher = {
                id: generateTeacherId(data),
                lastName: data.lastName || data.last_name || '',
                firstName: data.firstName || data.first_name || '',
                fullName: data.fullName || `${data.firstName || data.first_name || ''} ${data.lastName || data.last_name || ''}`.trim(),
                matricule: data.matricule || '',
                establishment: data.establishment || data.establishment_name || '',
                age: calculateAge(data.birthDate || data.birth_date),
                serviceYears: calculateServiceYears(data.engagementDate || data.engagement_date),
                yearsToRetirement: calculateYearsToRetirement(data.retirementDate || data.retirement_date),
                complete: false,
                files: [],
                data: {}
            };
            
            // Organiser les donn√©es par type
            organizeTeacherData(teacher, data, fileType);
            
            return teacher;
        }

        // Mettre √† jour les donn√©es d'un enseignant existant
        function updateTeacherData(teacher, data, fileType) {
            // Mettre √† jour les informations de base
            teacher.lastName = teacher.lastName || data.lastName || data.last_name || '';
            teacher.firstName = teacher.firstName || data.firstName || data.first_name || '';
            teacher.fullName = teacher.fullName || data.fullName || `${teacher.firstName} ${teacher.lastName}`.trim();
            teacher.matricule = teacher.matricule || data.matricule || '';
            teacher.establishment = teacher.establishment || data.establishment || data.establishment_name || '';
            
            // Calculer les √¢ges et ann√©es
            if (data.birthDate || data.birth_date) {
                teacher.age = calculateAge(data.birthDate || data.birth_date);
            }
            
            if (data.engagementDate || data.engagement_date) {
                teacher.serviceYears = calculateServiceYears(data.engagementDate || data.engagement_date);
            }
            
            if (data.retirementDate || data.retirement_date) {
                teacher.yearsToRetirement = calculateYearsToRetirement(data.retirementDate || data.retirement_date);
            }
            
            // Organiser les donn√©es
            organizeTeacherData(teacher, data, fileType);
        }

        // Organiser les donn√©es de l'enseignant par cat√©gorie
        function organizeTeacherData(teacher, data, fileType) {
            if (!teacher.data) teacher.data = {};
            
            switch(fileType) {
                case 'tab1':
                    teacher.data.establishment = data.establishment || {};
                    teacher.data.personal = data.personal || {};
                    teacher.data.professional = data.professional || {};
                    break;
                case 'tab2':
                    teacher.data.subjects = data.subjects || [];
                    teacher.data.lessons = data.lessons || [];
                    teacher.data.timetable = data.timetable || {};
                    break;
                case 'tab3':
                    teacher.data.evaluations = data.evaluations || [];
                    teacher.data.statistics = data.statistics || {};
                    break;
                case 'tab4':
                    teacher.data.projects = data.projects || [];
                    teacher.data.activities = data.activities || [];
                    break;
                case 'tab5':
                    teacher.data.archives = data.archives || [];
                    teacher.data.logs = data.logs || [];
                    break;
                case 'complete':
                    // Si c'est un fichier complet, copier toutes les donn√©es
                    teacher.data = { ...teacher.data, ...data };
                    break;
                default:
                    // Pour les fichiers inconnus, essayer de d√©terminer le type
                    if (data.subjects) teacher.data.subjects = data.subjects;
                    if (data.evaluations) teacher.data.evaluations = data.evaluations;
                    if (data.projects) teacher.data.projects = data.projects;
                    break;
            }
        }

        // V√©rifier si un enseignant est complet
        function checkTeacherCompleteness(teacher) {
            const requiredData = [
                teacher.lastName && teacher.firstName,
                teacher.matricule,
                teacher.establishment,
                teacher.data.personal,
                teacher.data.professional,
                teacher.data.subjects && teacher.data.subjects.length > 0
            ];
            
            teacher.complete = requiredData.every(Boolean);
            return teacher.complete;
        }

        // Calculer l'√¢ge √† partir de la date de naissance
        function calculateAge(birthDate) {
            if (!birthDate) return null;
            
            try {
                const birth = new Date(birthDate);
                const today = new Date();
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                
                return age;
            } catch (error) {
                console.error('Erreur lors du calcul de l\'√¢ge:', error);
                return null;
            }
        }

        // Calculer les ann√©es de service
        function calculateServiceYears(engagementDate) {
            if (!engagementDate) return null;
            
            try {
                const engagement = new Date(engagementDate);
                const today = new Date();
                let years = today.getFullYear() - engagement.getFullYear();
                const monthDiff = today.getMonth() - engagement.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < engagement.getDate())) {
                    years--;
                }
                
                return years;
            } catch (error) {
                console.error('Erreur lors du calcul des ann√©es de service:', error);
                return null;
            }
        }

        // Calculer les ann√©es avant la retraite
        function calculateYearsToRetirement(retirementDate) {
            if (!retirementDate) return null;
            
            try {
                const retirement = new Date(retirementDate);
                const today = new Date();
                let years = retirement.getFullYear() - today.getFullYear();
                const monthDiff = retirement.getMonth() - today.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && retirement.getDate() < today.getDate())) {
                    years--;
                }
                
                return Math.max(0, years);
            } catch (error) {
                console.error('Erreur lors du calcul des ann√©es avant retraite:', error);
                return null;
            }
        }

        // Mettre √† jour l'interface apr√®s importation
        function updateUIAfterImport() {
            // Mettre √† jour la liste des fichiers import√©s
            updateImportedFilesList();
            
            // Mettre √† jour les statistiques d'aper√ßu
            updateOverviewStats();
            
            // Mettre √† jour la liste des enseignants pour pr√©visualisation
            updateDataPreviewSelect();
            
            // Mettre √† jour les statistiques Python
            updatePythonStats();
            
            // Afficher les sections si des donn√©es sont pr√©sentes
            if (teachersData.length > 0) {
                document.getElementById('importedFilesSection').style.display = 'block';
                document.getElementById('overviewSection').style.display = 'block';
                document.getElementById('dataPreviewSection').style.display = 'block';
            }
            
            // Sauvegarder les donn√©es dans le localStorage
            saveSessionData();
        }

        // Mettre √† jour la liste des fichiers import√©s
        function updateImportedFilesList() {
            const container = document.getElementById('importedFilesList');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucun fichier import√©</p>';
                return;
            }
            
            let html = '<div class="files-by-type">';
            
            // Grouper les fichiers par type
            const filesByType = {};
            teachersData.forEach(teacher => {
                if (teacher.files) {
                    teacher.files.forEach(file => {
                        if (!filesByType[file.type]) {
                            filesByType[file.type] = [];
                        }
                        filesByType[file.type].push({
                            name: file.name,
                            teacher: teacher.fullName,
                            date: file.importDate
                        });
                    });
                }
            });
            
            // Afficher les fichiers par type
            Object.keys(filesByType).forEach(type => {
                const fileTypeInfo = FILE_TYPES[type] || { name: type, icon: 'fa-file', description: '' };
                html += `
                    <div class="file-type-group">
                        <h4><i class="fas ${fileTypeInfo.icon}"></i> ${fileTypeInfo.name} (${filesByType[type].length})</h4>
                        <p>${fileTypeInfo.description}</p>
                        <div class="file-list">
                `;
                
                filesByType[type].forEach(file => {
                    const date = new Date(file.date).toLocaleString();
                    html += `
                        <div class="file-item">
                            <span><i class="fas fa-file"></i> ${file.name}</span>
                            <span class="badge badge-primary">${file.teacher}</span>
                            <span style="color: var(--gray-color); font-size: 0.9em;">${date}</span>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Mettre √† jour les statistiques d'aper√ßu
        function updateOverviewStats() {
            const container = document.getElementById('overviewStats');
            if (!container) return;
            
            const totalTeachers = teachersData.length;
            const completeTeachers = teachersData.filter(t => t.complete).length;
            const totalFiles = teachersData.reduce((sum, teacher) => sum + (teacher.files ? teacher.files.length : 0), 0);
            
            // Compter les √©tablissements uniques
            const establishments = [...new Set(teachersData.map(t => t.establishment).filter(Boolean))];
            
            // Calculer l'√¢ge moyen
            const ages = teachersData.map(t => t.age).filter(age => age !== null);
            const averageAge = ages.length > 0 ? (ages.reduce((a, b) => a + b, 0) / ages.length).toFixed(1) : 0;
            
            container.innerHTML = `
                <div class="stat-card">
                    <div><i class="fas fa-users"></i> Enseignants</div>
                    <div class="stat-value">${totalTeachers}</div>
                    <div>Total import√©s</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-check-circle"></i> Fiches compl√®tes</div>
                    <div class="stat-value">${completeTeachers}</div>
                    <div>${totalTeachers > 0 ? ((completeTeachers / totalTeachers) * 100).toFixed(1) : 0}%</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-file"></i> Fichiers</div>
                    <div class="stat-value">${totalFiles}</div>
                    <div>Import√©s</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-school"></i> √âtablissements</div>
                    <div class="stat-value">${establishments.length}</div>
                    <div>Diff√©rents</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-birthday-cake"></i> √Çge moyen</div>
                    <div class="stat-value">${averageAge}</div>
                    <div>Ans</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-chart-bar"></i> Mati√®res</div>
                    <div class="stat-value">${countUniqueSubjects()}</div>
                    <div>Diff√©rentes</div>
                </div>
            `;
        }

        // Compter les mati√®res uniques
        function countUniqueSubjects() {
            const subjects = new Set();
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.subjects) {
                    teacher.data.subjects.forEach(subject => {
                        if (subject && subject.name) {
                            subjects.add(subject.name);
                        }
                    });
                }
            });
            return subjects.size;
        }

        // Mettre √† jour la liste de pr√©visualisation
        function updateDataPreviewSelect() {
            const select = document.getElementById('dataPreviewSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">S√©lectionner un enseignant pour pr√©visualiser...</option>';
            
            teachersData.forEach((teacher, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${teacher.fullName} (${teacher.matricule || 'Pas de matricule'}) - ${teacher.establishment || '√âtablissement inconnu'}`;
                select.appendChild(option);
            });
        }

        // Pr√©visualiser les donn√©es d'un enseignant
        function previewTeacherData(teacherIndex) {
            const container = document.getElementById('dataPreviewContent');
            if (!container) return;
            
            if (teacherIndex === '' || teacherIndex === null || teacherIndex === undefined) {
                container.innerHTML = '<p class="text-center">S√©lectionnez un enseignant pour voir ses donn√©es.</p>';
                return;
            }
            
            const index = parseInt(teacherIndex);
            if (isNaN(index) || index < 0 || index >= teachersData.length) {
                container.innerHTML = '<p class="text-center">Enseignant non trouv√©.</p>';
                return;
            }
            
            const teacher = teachersData[index];
            let html = `
                <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                    <h3 style="margin-bottom: 20px; color: var(--primary-color);">
                        <i class="fas fa-user-tie"></i> ${teacher.fullName}
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div>
                            <strong><i class="fas fa-id-card"></i> Informations personnelles</strong>
                            <div style="margin-top: 10px;">
                                <div>Matricule: <strong>${teacher.matricule || 'Non sp√©cifi√©'}</strong></div>
                                <div>√âtablissement: <strong>${teacher.establishment || 'Non sp√©cifi√©'}</strong></div>
                                <div>√Çge: <strong>${teacher.age || 'Non calcul√©'} ans</strong></div>
                                <div>Service: <strong>${teacher.serviceYears || 'Non calcul√©'} ans</strong></div>
                                <div>Retraite dans: <strong>${teacher.yearsToRetirement || 'Non calcul√©'} ans</strong></div>
                                <div>Fiche: <span class="badge ${teacher.complete ? 'badge-success' : 'badge-warning'}">${teacher.complete ? 'Compl√®te' : 'Incompl√®te'}</span></div>
                            </div>
                        </div>
                        
                        <div>
                            <strong><i class="fas fa-file"></i> Fichiers import√©s</strong>
                            <div style="margin-top: 10px;">
            `;
            
            if (teacher.files && teacher.files.length > 0) {
                teacher.files.forEach(file => {
                    const date = new Date(file.importDate).toLocaleString();
                    html += `<div><i class="fas fa-file"></i> ${file.name} <small>(${date})</small></div>`;
                });
            } else {
                html += '<div>Aucun fichier</div>';
            }
            
            html += `
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <strong><i class="fas fa-database"></i> Donn√©es structur√©es</strong>
                        <div style="margin-top: 10px;">
            `;
            
            // Afficher les donn√©es structur√©es
            if (teacher.data) {
                Object.keys(teacher.data).forEach(key => {
                    const dataSection = teacher.data[key];
                    if (dataSection && Object.keys(dataSection).length > 0) {
                        html += `<div style="margin-bottom: 10px;"><strong>${key}:</strong> ${JSON.stringify(dataSection, null, 2)}</div>`;
                    }
                });
            } else {
                html += '<div>Aucune donn√©e structur√©e</div>';
            }
            
            html += `
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary btn-sm" onclick="viewTeacherDetail(${index})">
                            <i class="fas fa-eye"></i> Voir les d√©tails complets
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="editTeacherData(${index})">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Mettre √† jour le tableau de bord
        function updateDashboard() {
            if (teachersData.length === 0) {
                document.getElementById('globalStats').innerHTML = '<p class="text-center">Aucune donn√©e disponible. Importez des donn√©es d\'abord.</p>';
                return;
            }
            
            updateGlobalStats();
            updateDashboardCharts();
            updateRecentActivities();
        }

        // Mettre √† jour les statistiques globales
        function updateGlobalStats() {
            const container = document.getElementById('globalStats');
            if (!container) return;
            
            const totalTeachers = teachersData.length;
            const completeTeachers = teachersData.filter(t => t.complete).length;
            const averageAge = calculateAverage(teachersData.map(t => t.age).filter(age => age !== null));
            const averageService = calculateAverage(teachersData.map(t => t.serviceYears).filter(years => years !== null));
            
            // Compter par mati√®re
            const subjectCount = countUniqueSubjects();
            
            // Compter par √©tablissement
            const establishmentCount = [...new Set(teachersData.map(t => t.establishment).filter(Boolean))].length;
            
            // Compter les retraites √† venir (moins de 5 ans)
            const upcomingRetirements = teachersData.filter(t => {
                return t.yearsToRetirement !== null && t.yearsToRetirement <= 5;
            }).length;
            
            container.innerHTML = `
                <div class="stat-card">
                    <div><i class="fas fa-users"></i> Total enseignants</div>
                    <div class="stat-value">${totalTeachers}</div>
                    <div>Import√©s</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-check-circle"></i> Fiches compl√®tes</div>
                    <div class="stat-value">${completeTeachers}</div>
                    <div>${totalTeachers > 0 ? ((completeTeachers / totalTeachers) * 100).toFixed(1) : 0}%</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-birthday-cake"></i> √Çge moyen</div>
                    <div class="stat-value">${averageAge.toFixed(1)}</div>
                    <div>Ans</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-clock"></i> Service moyen</div>
                    <div class="stat-value">${averageService.toFixed(1)}</div>
                    <div>Ans</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-book"></i> Mati√®res</div>
                    <div class="stat-value">${subjectCount}</div>
                    <div>Diff√©rentes</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-school"></i> √âtablissements</div>
                    <div class="stat-value">${establishmentCount}</div>
                    <div>Diff√©rents</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-umbrella-beach"></i> Retraites proches</div>
                    <div class="stat-value">${upcomingRetirements}</div>
                    <div>Dans ‚â§ 5 ans</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-chart-line"></i> Taux compl√©tion</div>
                    <div class="stat-value">${totalTeachers > 0 ? ((completeTeachers / totalTeachers) * 100).toFixed(1) : 0}%</div>
                    <div>Moyenne</div>
                </div>
            `;
        }

        // Calculer la moyenne
        function calculateAverage(values) {
            const validValues = values.filter(v => v !== null && v !== undefined);
            if (validValues.length === 0) return 0;
            return validValues.reduce((a, b) => a + b, 0) / validValues.length;
        }

        // Mettre √† jour les graphiques du tableau de bord
        function updateDashboardCharts() {
            // Graphique des mati√®res
            updateSubjectChart();
            
            // Graphique des retraites
            updateRetirementChart();
            
            // Graphique des heures
            updateHoursChart();
            
            // Graphique des √¢ges
            updateAgeChart();
        }

        // Graphique des mati√®res
        function updateSubjectChart() {
            const ctx = document.getElementById('subjectChart');
            if (!ctx) return;
            
            // Compter les mati√®res
            const subjectCounts = {};
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.subjects) {
                    teacher.data.subjects.forEach(subject => {
                        if (subject && subject.name) {
                            subjectCounts[subject.name] = (subjectCounts[subject.name] || 0) + 1;
                        }
                    });
                }
            });
            
            // Trier et prendre les 10 premi√®res
            const sortedSubjects = Object.entries(subjectCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const labels = sortedSubjects.map(s => s[0]);
            const data = sortedSubjects.map(s => s[1]);
            
            // D√©truire le graphique existant
            if (charts.subjectChart) {
                charts.subjectChart.destroy();
            }
            
            // Cr√©er un nouveau graphique
            charts.subjectChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                            '#1abc9c', '#d35400', '#c0392b', '#16a085', '#8e44ad'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Graphique des retraites
        function updateRetirementChart() {
            const ctx = document.getElementById('retirementChart');
            if (!ctx) return;
            
            // Compter les retraites par ann√©e
            const retirementCounts = {};
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.professional && teacher.data.professional.retirement_date) {
                    try {
                        const date = new Date(teacher.data.professional.retirement_date);
                        const year = date.getFullYear();
                        retirementCounts[year] = (retirementCounts[year] || 0) + 1;
                    } catch (error) {
                        console.error('Erreur lors du traitement de la date de retraite:', error);
                    }
                }
            });
            
            // Trier par ann√©e
            const sortedYears = Object.keys(retirementCounts).sort();
            const labels = sortedYears;
            const data = sortedYears.map(year => retirementCounts[year]);
            
            // D√©truire le graphique existant
            if (charts.retirementChart) {
                charts.retirementChart.destroy();
            }
            
            // Cr√©er un nouveau graphique
            charts.retirementChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nombre de retraites',
                        data: data,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nombre de retraites'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Ann√©e'
                            }
                        }
                    }
                }
            });
        }

        // Graphique des heures
        function updateHoursChart() {
            const ctx = document.getElementById('hoursChart');
            if (!ctx) return;
            
            // Calculer les heures totales par enseignant
            const teacherHours = teachersData.map(teacher => {
                let totalHours = 0;
                if (teacher.data && teacher.data.subjects) {
                    teacher.data.subjects.forEach(subject => {
                        if (subject && subject.hours) {
                            totalHours += parseFloat(subject.hours) || 0;
                        }
                    });
                }
                return totalHours;
            }).filter(hours => hours > 0);
            
            // Cr√©er des tranches d'heures
            const bins = [0, 10, 15, 20, 25, 30];
            const labels = bins.slice(1).map((bin, i) => `${bins[i]}-${bin}h`);
            const data = new Array(bins.length - 1).fill(0);
            
            teacherHours.forEach(hours => {
                for (let i = 0; i < bins.length - 1; i++) {
                    if (hours >= bins[i] && hours < bins[i + 1]) {
                        data[i]++;
                        break;
                    }
                }
            });
            
            // D√©truire le graphique existant
            if (charts.hoursChart) {
                charts.hoursChart.destroy();
            }
            
            // Cr√©er un nouveau graphique
            charts.hoursChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nombre d\'enseignants',
                        data: data,
                        backgroundColor: '#2ecc71'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nombre d\'enseignants'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Heures d\'enseignement par semaine'
                            }
                        }
                    }
                }
            });
        }

        // Graphique des √¢ges
        function updateAgeChart() {
            const ctx = document.getElementById('ageChart');
            if (!ctx) return;
            
            // Cr√©er des tranches d'√¢ge
            const ageBins = [20, 30, 40, 50, 60, 70];
            const labels = ageBins.slice(1).map((bin, i) => `${ageBins[i]}-${bin} ans`);
            const data = new Array(ageBins.length - 1).fill(0);
            
            teachersData.forEach(teacher => {
                if (teacher.age !== null) {
                    for (let i = 0; i < ageBins.length - 1; i++) {
                        if (teacher.age >= ageBins[i] && teacher.age < ageBins[i + 1]) {
                            data[i]++;
                            break;
                        }
                    }
                }
            });
            
            // D√©truire le graphique existant
            if (charts.ageChart) {
                charts.ageChart.destroy();
            }
            
            // Cr√©er un nouveau graphique
            charts.ageChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nombre d\'enseignants',
                        data: data,
                        backgroundColor: '#9b59b6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nombre d\'enseignants'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Tranche d\'√¢ge'
                            }
                        }
                    }
                }
            });
        }

        // Mettre √† jour les activit√©s r√©centes
        function updateRecentActivities() {
            const container = document.getElementById('recentActivities');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune activit√© r√©cente</p>';
                return;
            }
            
            // R√©cup√©rer les fichiers r√©cemment import√©s
            const allFiles = [];
            teachersData.forEach(teacher => {
                if (teacher.files) {
                    teacher.files.forEach(file => {
                        allFiles.push({
                            teacher: teacher.fullName,
                            filename: file.name,
                            date: new Date(file.importDate),
                            type: file.type
                        });
                    });
                }
            });
            
            // Trier par date (plus r√©cent d'abord)
            allFiles.sort((a, b) => b.date - a.date);
            
            // Prendre les 10 plus r√©cents
            const recentFiles = allFiles.slice(0, 10);
            
            let html = '<div style="background: white; padding: 20px; border-radius: 8px;">';
            
            if (recentFiles.length === 0) {
                html += '<p class="text-center">Aucune activit√© r√©cente</p>';
            } else {
                html += '<table class="data-table">';
                html += '<thead><tr><th>Date</th><th>Enseignant</th><th>Fichier</th><th>Type</th></tr></thead><tbody>';
                
                recentFiles.forEach(file => {
                    const fileTypeInfo = FILE_TYPES[file.type] || { name: file.type, icon: 'fa-file' };
                    html += `
                        <tr>
                            <td>${file.date.toLocaleString()}</td>
                            <td>${file.teacher}</td>
                            <td><i class="fas ${fileTypeInfo.icon}"></i> ${file.filename}</td>
                            <td><span class="badge badge-primary">${fileTypeInfo.name}</span></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Filtrer le tableau de bord
        function filterDashboard() {
            const searchTerm = document.getElementById('dashboardSearch').value.toLowerCase();
            const subjectFilter = document.getElementById('dashboardFilterSubject').value;
            const categoryFilter = document.getElementById('dashboardFilterCategory').value;
            const establishmentFilter = document.getElementById('dashboardFilterEstablishment').value;
            
            // Mettre √† jour les graphiques avec les donn√©es filtr√©es
            updateDashboardCharts();
        }

        // Mettre √† jour la liste des enseignants
        function updateTeachersList() {
            const container = document.getElementById('teachersCards');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center" style="grid-column: 1 / -1; padding: 40px; color: var(--gray-color);">Aucun enseignant import√©. Utilisez l\'onglet "Importation" pour importer des donn√©es.</p>';
                return;
            }
            
            // Filtrer les enseignants
            filteredTeachers = [...teachersData];
            
            if (showCompleteOnly) {
                filteredTeachers = filteredTeachers.filter(teacher => teacher.complete);
            }
            
            // Trier les enseignants
            filteredTeachers.sort((a, b) => {
                let aValue, bValue;
                
                switch(currentSort.field) {
                    case 'name':
                        aValue = a.lastName + a.firstName;
                        bValue = b.lastName + b.firstName;
                        break;
                    case 'retirement':
                        aValue = a.yearsToRetirement !== null ? a.yearsToRetirement : Infinity;
                        bValue = b.yearsToRetirement !== null ? b.yearsToRetirement : Infinity;
                        break;
                    default:
                        aValue = a[currentSort.field] || '';
                        bValue = b[currentSort.field] || '';
                }
                
                if (currentSort.direction === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });
            
            // Afficher les enseignants
            let html = '';
            filteredTeachers.forEach((teacher, index) => {
                html += `
                    <div class="teacher-card" onclick="viewTeacherDetail(${teachersData.indexOf(teacher)})">
                        <div class="teacher-header">
                            <div class="teacher-name">${teacher.fullName}</div>
                            <div class="teacher-matricule">${teacher.matricule || 'Pas de matricule'}</div>
                        </div>
                        
                        <div class="teacher-info">
                            <div class="teacher-info-item">
                                <i class="fas fa-school"></i>
                                <span>${teacher.establishment || 'Non sp√©cifi√©'}</span>
                            </div>
                            <div class="teacher-info-item">
                                <i class="fas fa-birthday-cake"></i>
                                <span>${teacher.age || '?'} ans</span>
                            </div>
                            <div class="teacher-info-item">
                                <i class="fas fa-clock"></i>
                                <span>${teacher.serviceYears || '?'} ans de service</span>
                            </div>
                            <div class="teacher-info-item">
                                <i class="fas fa-umbrella-beach"></i>
                                <span>Retraite: ${teacher.yearsToRetirement !== null ? `dans ${teacher.yearsToRetirement} ans` : 'Non d√©finie'}</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                ${teacher.data && teacher.data.subjects && teacher.data.subjects.length > 0 ? 
                                    `<span class="badge badge-info">${teacher.data.subjects.length} mati√®re(s)</span>` : 
                                    '<span class="badge badge-warning">Aucune mati√®re</span>'
                                }
                                <span class="badge ${teacher.complete ? 'badge-success' : 'badge-warning'}">
                                    ${teacher.complete ? 'Complet' : 'Incomplet'}
                                </span>
                            </div>
                            <div>
                                <button class="btn btn-xs btn-primary" onclick="event.stopPropagation(); editTeacherData(${teachersData.indexOf(teacher)})">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Trier les enseignants
        function sortTeachers(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            updateTeachersList();
            
            // Mettre √† jour le texte du bouton
            const button = document.querySelector(`button[onclick="sortTeachers('${field}')"]`);
            if (button) {
                const icon = currentSort.direction === 'asc' ? 'fa-sort-alpha-down' : 'fa-sort-alpha-up';
                button.innerHTML = `<i class="fas ${icon}"></i> Trier par ${field === 'name' ? 'nom' : 'retraite'}`;
            }
        }

        // Filtrer seulement les fiches compl√®tes
        function filterCompleteOnly() {
            showCompleteOnly = !showCompleteOnly;
            updateTeachersList();
            
            // Mettre √† jour le bouton
            const button = document.querySelector('button[onclick="filterCompleteOnly()"]');
            if (button) {
                if (showCompleteOnly) {
                    button.innerHTML = '<i class="fas fa-check-circle"></i> Toutes les fiches';
                    button.classList.remove('btn-light');
                    button.classList.add('btn-success');
                } else {
                    button.innerHTML = '<i class="fas fa-check-circle"></i> Fiches compl√®tes';
                    button.classList.remove('btn-success');
                    button.classList.add('btn-light');
                }
            }
        }

        // Filtrer les enseignants par recherche
        function filterTeachers() {
            const searchTerm = document.getElementById('teacherSearch').value.toLowerCase();
            
            // Filtrer les enseignants
            filteredTeachers = teachersData.filter(teacher => {
                return (
                    teacher.fullName.toLowerCase().includes(searchTerm) ||
                    teacher.matricule.toLowerCase().includes(searchTerm) ||
                    teacher.establishment.toLowerCase().includes(searchTerm) ||
                    (teacher.data && teacher.data.subjects && 
                     teacher.data.subjects.some(s => s.name.toLowerCase().includes(searchTerm)))
                );
            });
            
            // Mettre √† jour l'affichage
            updateTeachersList();
        }

        // Voir les d√©tails d'un enseignant
        function viewTeacherDetail(index) {
            const teacher = teachersData[index];
            if (!teacher) return;
            
            document.getElementById('teacherModalTitle').textContent = `D√©tails: ${teacher.fullName}`;
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4><i class="fas fa-user-tie"></i> Informations personnelles</h4>
                        <table class="data-table">
                            <tr><td>Nom complet</td><td><strong>${teacher.fullName}</strong></td></tr>
                            <tr><td>Matricule</td><td>${teacher.matricule || 'Non sp√©cifi√©'}</td></tr>
                            <tr><td>√âtablissement</td><td>${teacher.establishment || 'Non sp√©cifi√©'}</td></tr>
                            <tr><td>√Çge</td><td>${teacher.age || 'Non calcul√©'} ans</td></tr>
                            <tr><td>Ann√©es de service</td><td>${teacher.serviceYears || 'Non calcul√©'} ans</td></tr>
                            <tr><td>Ann√©es avant retraite</td><td>${teacher.yearsToRetirement !== null ? `${teacher.yearsToRetirement} ans` : 'Non d√©finie'}</td></tr>
                            <tr><td>Statut fiche</td><td><span class="badge ${teacher.complete ? 'badge-success' : 'badge-warning'}">${teacher.complete ? 'Compl√®te' : 'Incompl√®te'}</span></td></tr>
                        </table>
                    </div>
                    
                    <div>
                        <h4><i class="fas fa-file"></i> Fichiers import√©s</h4>
            `;
            
            if (teacher.files && teacher.files.length > 0) {
                html += '<table class="data-table"><thead><tr><th>Fichier</th><th>Type</th><th>Date</th></tr></thead><tbody>';
                teacher.files.forEach(file => {
                    const fileTypeInfo = FILE_TYPES[file.type] || { name: file.type, icon: 'fa-file' };
                    const date = new Date(file.importDate).toLocaleString();
                    html += `
                        <tr>
                            <td><i class="fas ${fileTypeInfo.icon}"></i> ${file.name}</td>
                            <td><span class="badge badge-primary">${fileTypeInfo.name}</span></td>
                            <td>${date}</td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
            } else {
                html += '<p>Aucun fichier import√©</p>';
            }
            
            html += `
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4><i class="fas fa-database"></i> Donn√©es structur√©es</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            `;
            
            // Afficher les donn√©es structur√©es
            if (teacher.data) {
                Object.keys(teacher.data).forEach(key => {
                    const dataSection = teacher.data[key];
                    if (dataSection && Object.keys(dataSection).length > 0) {
                        html += `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #ddd;">
                                <h5 style="margin-bottom: 10px;">${key}</h5>
                                <pre style="white-space: pre-wrap; font-size: 0.85rem; max-height: 200px; overflow-y: auto;">${JSON.stringify(dataSection, null, 2)}</pre>
                            </div>
                        `;
                    }
                });
            } else {
                html += '<p>Aucune donn√©e structur√©e disponible</p>';
            }
            
            html += `
                    </div>
                </div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-primary" onclick="editTeacherData(${index})">
                        <i class="fas fa-edit"></i> Modifier les donn√©es
                    </button>
                    <button class="btn btn-danger" onclick="deleteTeacher(${index})">
                        <i class="fas fa-trash"></i> Supprimer cet enseignant
                    </button>
                </div>
            `;
            
            document.getElementById('teacherModalContent').innerHTML = html;
            document.getElementById('teacherDetailModal').classList.add('active');
        }

        // Fermer les d√©tails de l'enseignant
        function closeTeacherDetail() {
            document.getElementById('teacherDetailModal').classList.remove('active');
        }

        // Modifier les donn√©es d'un enseignant
        function editTeacherData(index) {
            const teacher = teachersData[index];
            if (!teacher) return;
            
            // Pour l'instant, on va simplement permettre de supprimer et re-importer
            // Dans une version future, on pourrait impl√©menter un formulaire d'√©dition
            if (confirm(`Voulez-vous supprimer les donn√©es de ${teacher.fullName} et r√©-importer de nouvelles donn√©es ?`)) {
                deleteTeacher(index);
                showNotification('Enseignant supprim√©. Vous pouvez maintenant importer de nouvelles donn√©es.', 'info');
            }
        }

        // Supprimer un enseignant
        function deleteTeacher(index) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet enseignant ? Cette action est irr√©versible.')) {
                teachersData.splice(index, 1);
                updateUIAfterImport();
                updateTeachersList();
                closeTeacherDetail();
                showNotification('Enseignant supprim√© avec succ√®s', 'success');
            }
        }

        // Mettre √† jour l'aper√ßu de l'export
        function updateExportPreview() {
            const container = document.getElementById('exportPreview');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donn√©e √† exporter. Importez des donn√©es d\'abord.</p>';
                return;
            }
            
            const totalTeachers = teachersData.length;
            const completeTeachers = teachersData.filter(t => t.complete).length;
            const totalFiles = teachersData.reduce((sum, teacher) => sum + (teacher.files ? teacher.files.length : 0), 0);
            
            container.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px;">
                    <h4 style="margin-bottom: 15px;"><i class="fas fa-info-circle"></i> R√©sum√© des donn√©es disponibles</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="stat-card">
                            <div>Enseignants</div>
                            <div class="stat-value">${totalTeachers}</div>
                            <div>Total</div>
                        </div>
                        <div class="stat-card">
                            <div>Fiches compl√®tes</div>
                            <div class="stat-value">${completeTeachers}</div>
                            <div>${totalTeachers > 0 ? ((completeTeachers / totalTeachers) * 100).toFixed(1) : 0}%</div>
                        </div>
                        <div class="stat-card">
                            <div>Fichiers</div>
                            <div class="stat-value">${totalFiles}</div>
                            <div>Import√©s</div>
                        </div>
                        <div class="stat-card">
                            <div>Mati√®res</div>
                            <div class="stat-value">${countUniqueSubjects()}</div>
                            <div>Diff√©rentes</div>
                        </div>
                    </div>
                    
                    <h5 style="margin-bottom: 10px;">D√©tails par cat√©gorie:</h5>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Cat√©gorie</th>
                                <th>Enregistrements</th>
                                <th>Disponible pour export</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Enseignants (liste)</td>
                                <td>${totalTeachers}</td>
                                <td><span class="badge badge-success">Oui</span></td>
                            </tr>
                            <tr>
                                <td>Donn√©es p√©dagogiques</td>
                                <td>${countDataRecords('subjects') + countDataRecords('lessons')}</td>
                                <td><span class="badge ${countDataRecords('subjects') > 0 ? 'badge-success' : 'badge-warning'}">${countDataRecords('subjects') > 0 ? 'Oui' : 'Non'}</span></td>
                            </tr>
                            <tr>
                                <td>√âvaluations</td>
                                <td>${countDataRecords('evaluations')}</td>
                                <td><span class="badge ${countDataRecords('evaluations') > 0 ? 'badge-success' : 'badge-warning'}">${countDataRecords('evaluations') > 0 ? 'Oui' : 'Non'}</span></td>
                            </tr>
                            <tr>
                                <td>Projets et activit√©s</td>
                                <td>${countDataRecords('projects') + countDataRecords('activities')}</td>
                                <td><span class="badge ${countDataRecords('projects') > 0 ? 'badge-success' : 'badge-warning'}">${countDataRecords('projects') > 0 ? 'Oui' : 'Non'}</span></td>
                            </tr>
                            <tr>
                                <td>Planification retraite</td>
                                <td>${countTeachersWithRetirementDate()}</td>
                                <td><span class="badge ${countTeachersWithRetirementDate() > 0 ? 'badge-success' : 'badge-warning'}">${countTeachersWithRetirementDate() > 0 ? 'Oui' : 'Non'}</span></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 5px; border-left: 4px solid var(--success-color);">
                        <h5><i class="fas fa-lightbulb"></i> Recommandation</h5>
                        <p>Utilisez "Export complet" pour obtenir toutes les donn√©es dans un seul fichier Excel avec plusieurs onglets.</p>
                    </div>
                </div>
            `;
        }

        // Compter les enregistrements d'une cat√©gorie de donn√©es
        function countDataRecords(dataType) {
            return teachersData.reduce((sum, teacher) => {
                if (teacher.data && teacher.data[dataType]) {
                    return sum + (Array.isArray(teacher.data[dataType]) ? teacher.data[dataType].length : 1);
                }
                return sum;
            }, 0);
        }

        // Compter les enseignants avec date de retraite
        function countTeachersWithRetirementDate() {
            return teachersData.filter(teacher => {
                return teacher.data && teacher.data.professional && teacher.data.professional.retirement_date;
            }).length;
        }

        // Exporter toutes les donn√©es vers Excel
        function exportAllToExcel() {
            if (teachersData.length === 0) {
                showNotification('Aucune donn√©e √† exporter', 'warning');
                return;
            }
            
            showLoader(true);
            
            try {
                // Cr√©er un classeur avec plusieurs onglets
                const wb = XLSX.utils.book_new();
                
                // 1. Onglet "Enseignants"
                const teachersSheet = prepareTeachersSheet();
                XLSX.utils.book_append_sheet(wb, teachersSheet, "Enseignants");
                
                // 2. Onglet "P√©dagogie"
                const pedagogySheet = preparePedagogySheet();
                XLSX.utils.book_append_sheet(wb, pedagogySheet, "P√©dagogie");
                
                // 3. Onglet "√âvaluations"
                const evaluationsSheet = prepareEvaluationsSheet();
                XLSX.utils.book_append_sheet(wb, evaluationsSheet, "√âvaluations");
                
                // 4. Onglet "Projets"
                const projectsSheet = prepareProjectsSheet();
                XLSX.utils.book_append_sheet(wb, projectsSheet, "Projets");
                
                // 5. Onglet "Retraite"
                const retirementSheet = prepareRetirementSheet();
                XLSX.utils.book_append_sheet(wb, retirementSheet, "Retraite");
                
                // 6. Onglet "Statistiques"
                const statsSheet = prepareStatsSheet();
                XLSX.utils.book_append_sheet(wb, statsSheet, "Statistiques");
                
                // G√©n√©rer le fichier Excel
                const fileName = `export_enseignants_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification('Export complet r√©alis√© avec succ√®s', 'success');
                
            } catch (error) {
                console.error('Erreur lors de l\'export:', error);
                showNotification('Erreur lors de l\'export: ' + error.message, 'error');
            } finally {
                showLoader(false);
            }
        }

        // Pr√©parer l'onglet "Enseignants"
        function prepareTeachersSheet() {
            const headers = [
                "Nom", "Pr√©nom", "Nom complet", "Matricule", "√âtablissement",
                "√Çge", "Ann√©es de service", "Ann√©es avant retraite", "Fiche compl√®te",
                "Date de naissance", "Date d'engagement", "Date de retraite",
                "Cat√©gorie", "Grade", "Heures hebdomadaires"
            ];
            
            const data = teachersData.map(teacher => [
                teacher.lastName || '',
                teacher.firstName || '',
                teacher.fullName || '',
                teacher.matricule || '',
                teacher.establishment || '',
                teacher.age || '',
                teacher.serviceYears || '',
                teacher.yearsToRetirement || '',
                teacher.complete ? "Oui" : "Non",
                teacher.data && teacher.data.personal ? teacher.data.personal.birth_date || '' : '',
                teacher.data && teacher.data.professional ? teacher.data.professional.engagement_date || '' : '',
                teacher.data && teacher.data.professional ? teacher.data.professional.retirement_date || '' : '',
                teacher.data && teacher.data.professional ? teacher.data.professional.professional_category || '' : '',
                teacher.data && teacher.data.professional ? teacher.data.professional.grade || '' : '',
                teacher.data && teacher.data.professional ? teacher.data.professional.weekly_hours || '' : ''
            ]);
            
            return XLSX.utils.aoa_to_sheet([headers, ...data]);
        }

        // Pr√©parer l'onglet "P√©dagogie"
        function preparePedagogySheet() {
            const headers = [
                "Enseignant", "Matricule", "√âtablissement",
                "Mati√®re", "Type", "Heures", "Niveau"
            ];
            
            const data = [];
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.subjects) {
                    teacher.data.subjects.forEach(subject => {
                        data.push([
                            teacher.fullName || '',
                            teacher.matricule || '',
                            teacher.establishment || '',
                            subject.name || '',
                            subject.type || '',
                            subject.hours || '',
                            subject.level || ''
                        ]);
                    });
                }
            });
            
            return XLSX.utils.aoa_to_sheet([headers, ...data]);
        }

        // Pr√©parer l'onglet "√âvaluations"
        function prepareEvaluationsSheet() {
            const headers = [
                "Enseignant", "Matricule", "√âtablissement",
                "Date", "Type", "Mati√®re", "Moyenne", "Meilleure note",
                "Nombre d'√©l√®ves", "Commentaire"
            ];
            
            const data = [];
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.evaluations) {
                    teacher.data.evaluations.forEach(evaluation => {
                        data.push([
                            teacher.fullName || '',
                            teacher.matricule || '',
                            teacher.establishment || '',
                            evaluation.date || '',
                            evaluation.type || '',
                            evaluation.subject || '',
                            evaluation.average || '',
                            evaluation.best || '',
                            evaluation.student_count || '',
                            evaluation.comment || ''
                        ]);
                    });
                }
            });
            
            return XLSX.utils.aoa_to_sheet([headers, ...data]);
        }

        // Pr√©parer l'onglet "Projets"
        function prepareProjectsSheet() {
            const headers = [
                "Enseignant", "Matricule", "√âtablissement",
                "Projet", "Type", "Date d√©but", "Date fin",
                "Description", "Statut", "Participants"
            ];
            
            const data = [];
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.projects) {
                    teacher.data.projects.forEach(project => {
                        data.push([
                            teacher.fullName || '',
                            teacher.matricule || '',
                            teacher.establishment || '',
                            project.name || '',
                            project.type || '',
                            project.start_date || '',
                            project.end_date || '',
                            project.description || '',
                            project.status || '',
                            project.participants ? project.participants.join(', ') : ''
                        ]);
                    });
                }
            });
            
            return XLSX.utils.aoa_to_sheet([headers, ...data]);
        }

        // Pr√©parer l'onglet "Retraite"
        function prepareRetirementSheet() {
            const headers = [
                "Enseignant", "Matricule", "√âtablissement",
                "√Çge", "Ann√©es de service", "Date de retraite",
                "Ann√©es restantes", "Cat√©gorie", "Remarques"
            ];
            
            const data = teachersData
                .filter(teacher => teacher.data && teacher.data.professional && teacher.data.professional.retirement_date)
                .map(teacher => [
                    teacher.fullName || '',
                    teacher.matricule || '',
                    teacher.establishment || '',
                    teacher.age || '',
                    teacher.serviceYears || '',
                    teacher.data.professional.retirement_date || '',
                    teacher.yearsToRetirement || '',
                    teacher.data.professional.professional_category || '',
                    teacher.data.professional.retirement_notes || ''
                ]);
            
            return XLSX.utils.aoa_to_sheet([headers, ...data]);
        }

        // Pr√©parer l'onglet "Statistiques"
        function prepareStatsSheet() {
            const headers = ["Statistique", "Valeur", "D√©tail"];
            
            const totalTeachers = teachersData.length;
            const completeTeachers = teachersData.filter(t => t.complete).length;
            const averageAge = calculateAverage(teachersData.map(t => t.age).filter(age => age !== null));
            const averageService = calculateAverage(teachersData.map(t => t.serviceYears).filter(years => years !== null));
            const subjectCount = countUniqueSubjects();
            const establishmentCount = [...new Set(teachersData.map(t => t.establishment).filter(Boolean))].length;
            const upcomingRetirements = teachersData.filter(t => t.yearsToRetirement !== null && t.yearsToRetirement <= 5).length;
            
            const data = [
                ["Enseignants total", totalTeachers, "Nombre total d'enseignants import√©s"],
                ["Fiches compl√®tes", completeTeachers, `${totalTeachers > 0 ? ((completeTeachers / totalTeachers) * 100).toFixed(1) : 0}% du total`],
                ["√Çge moyen", averageAge.toFixed(1), "√Çge moyen des enseignants"],
                ["Service moyen", averageService.toFixed(1), "Ann√©es de service moyennes"],
                ["Mati√®res diff√©rentes", subjectCount, "Nombre de mati√®res enseign√©es"],
                ["√âtablissements", establishmentCount, "Nombre d'√©tablissements diff√©rents"],
                ["Retraites proches", upcomingRetirements, "Retraites dans moins de 5 ans"],
                ["Taux de compl√©tion", `${totalTeachers > 0 ? ((completeTeachers / totalTeachers) * 100).toFixed(1) : 0}%`, "Pourcentage de fiches compl√®tes"],
                ["Date d'export", new Date().toLocaleDateString(), "Date de g√©n√©ration du rapport"],
                ["Nombre de fichiers", teachersData.reduce((sum, t) => sum + (t.files ? t.files.length : 0), 0), "Total des fichiers import√©s"]
            ];
            
            return XLSX.utils.aoa_to_sheet([headers, ...data]);
        }

        // Exporter seulement la liste des enseignants
        function exportTeachersToExcel() {
            if (teachersData.length === 0) {
                showNotification('Aucun enseignant √† exporter', 'warning');
                return;
            }
            
            const sheet = prepareTeachersSheet();
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, sheet, "Enseignants");
            
            const fileName = `liste_enseignants_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification('Liste des enseignants export√©e avec succ√®s', 'success');
        }

        // Exporter les donn√©es p√©dagogiques
        function exportPedagogyToExcel() {
            if (countDataRecords('subjects') === 0) {
                showNotification('Aucune donn√©e p√©dagogique √† exporter', 'warning');
                return;
            }
            
            const sheet = preparePedagogySheet();
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, sheet, "P√©dagogie");
            
            const fileName = `donnees_pedagogiques_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification('Donn√©es p√©dagogiques export√©es avec succ√®s', 'success');
        }

        // Exporter les donn√©es d'√©valuation
        function exportEvaluationsToExcel() {
            if (countDataRecords('evaluations') === 0) {
                showNotification('Aucune donn√©e d\'√©valuation √† exporter', 'warning');
                return;
            }
            
            const sheet = prepareEvaluationsSheet();
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, sheet, "√âvaluations");
            
            const fileName = `evaluations_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification('Donn√©es d\'√©valuation export√©es avec succ√®s', 'success');
        }

        // Exporter la planification des retraites
        function exportRetirementToExcel() {
            if (countTeachersWithRetirementDate() === 0) {
                showNotification('Aucune donn√©e de retraite √† exporter', 'warning');
                return;
            }
            
            const sheet = prepareRetirementSheet();
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, sheet, "Retraite");
            
            const fileName = `planification_retraite_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification('Planification retraite export√©e avec succ√®s', 'success');
        }

        // Exporter les projets et activit√©s
        function exportProjectsToExcel() {
            if (countDataRecords('projects') === 0) {
                showNotification('Aucun projet ou activit√© √† exporter', 'warning');
                return;
            }
            
            const sheet = prepareProjectsSheet();
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, sheet, "Projets");
            
            const fileName = `projets_activites_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification('Projets et activit√©s export√©s avec succ√®s', 'success');
        }

        // Effacer toutes les donn√©es
        function clearAllData() {
            if (teachersData.length === 0) {
                showNotification('Aucune donn√©e √† effacer', 'info');
                return;
            }
            
            if (confirm('√ätes-vous s√ªr de vouloir effacer toutes les donn√©es ? Cette action est irr√©versible.')) {
                teachersData = [];
                filteredTeachers = [];
                
                // R√©initialiser l'interface
                document.getElementById('importedFilesSection').style.display = 'none';
                document.getElementById('overviewSection').style.display = 'none';
                document.getElementById('dataPreviewSection').style.display = 'none';
                
                updateTeachersList();
                updateDashboard();
                updateExportPreview();
                updatePythonStats();
                
                // Effacer le localStorage
                localStorage.removeItem('teachersAnalyticsData');
                
                showNotification('Toutes les donn√©es ont √©t√© effac√©es', 'success');
            }
        }

        // G√©n√©rer un rapport
        function generateReport() {
            if (teachersData.length === 0) {
                showNotification('Aucune donn√©e pour g√©n√©rer un rapport', 'warning');
                return;
            }
            
            showLoader(true);
            
            try {
                // Cr√©er un rapport simple en HTML
                const reportWindow = window.open('', '_blank');
                const reportDate = new Date().toLocaleString();
                
                let reportHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Rapport d'analyse enseignants - ${reportDate}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            h1 { color: #2c3e50; }
                            h2 { color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
                            .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
                            .stat-card { background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center; border: 1px solid #dee2e6; }
                            .stat-value { font-size: 2rem; font-weight: bold; color: #3498db; margin: 10px 0; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th { background: #3498db; color: white; padding: 10px; text-align: left; }
                            td { padding: 8px 10px; border-bottom: 1px solid #ddd; }
                            tr:hover { background: #f5f5f5; }
                            .badge { padding: 3px 8px; border-radius: 10px; font-size: 0.8rem; }
                            .badge-success { background: #d4edda; color: #155724; }
                            .badge-warning { background: #fff3cd; color: #856404; }
                            .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 0.9em; }
                        </style>
                    </head>
                    <body>
                        <h1>üìä Rapport d'analyse des enseignants</h1>
                        <p>Date de g√©n√©ration: ${reportDate}</p>
                        
                        <h2>üìà Statistiques globales</h2>
                        <div class="stat-grid">
                `;
                
                const totalTeachers = teachersData.length;
                const completeTeachers = teachersData.filter(t => t.complete).length;
                const averageAge = calculateAverage(teachersData.map(t => t.age).filter(age => age !== null));
                const averageService = calculateAverage(teachersData.map(t => t.serviceYears).filter(years => years !== null));
                const subjectCount = countUniqueSubjects();
                const establishmentCount = [...new Set(teachersData.map(t => t.establishment).filter(Boolean))].length;
                const upcomingRetirements = teachersData.filter(t => t.yearsToRetirement !== null && t.yearsToRetirement <= 5).length;
                
                reportHTML += `
                            <div class="stat-card">
                                <div>Enseignants total</div>
                                <div class="stat-value">${totalTeachers}</div>
                            </div>
                            <div class="stat-card">
                                <div>Fiches compl√®tes</div>
                                <div class="stat-value">${completeTeachers}</div>
                                <div>${totalTeachers > 0 ? ((completeTeachers / totalTeachers) * 100).toFixed(1) : 0}%</div>
                            </div>
                            <div class="stat-card">
                                <div>√Çge moyen</div>
                                <div class="stat-value">${averageAge.toFixed(1)}</div>
                                <div>ans</div>
                            </div>
                            <div class="stat-card">
                                <div>Service moyen</div>
                                <div class="stat-value">${averageService.toFixed(1)}</div>
                                <div>ans</div>
                            </div>
                            <div class="stat-card">
                                <div>Mati√®res</div>
                                <div class="stat-value">${subjectCount}</div>
                                <div>diff√©rentes</div>
                            </div>
                            <div class="stat-card">
                                <div>√âtablissements</div>
                                <div class="stat-value">${establishmentCount}</div>
                                <div>diff√©rents</div>
                            </div>
                        </div>
                        
                        <h2>üë• Liste des enseignants</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Matricule</th>
                                    <th>√âtablissement</th>
                                    <th>√Çge</th>
                                    <th>Service</th>
                                    <th>Retraite</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                teachersData.forEach(teacher => {
                    reportHTML += `
                        <tr>
                            <td>${teacher.fullName}</td>
                            <td>${teacher.matricule || ''}</td>
                            <td>${teacher.establishment || ''}</td>
                            <td>${teacher.age || ''}</td>
                            <td>${teacher.serviceYears || ''}</td>
                            <td>${teacher.yearsToRetirement !== null ? `${teacher.yearsToRetirement} ans` : ''}</td>
                            <td><span class="badge ${teacher.complete ? 'badge-success' : 'badge-warning'}">${teacher.complete ? 'Complet' : 'Incomplet'}</span></td>
                        </tr>
                    `;
                });
                
                reportHTML += `
                            </tbody>
                        </table>
                        
                        <h2>üìä Analyse par √©tablissement</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>√âtablissement</th>
                                    <th>Nombre d'enseignants</th>
                                    <th>Pourcentage</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Compter par √©tablissement
                const establishmentCounts = {};
                teachersData.forEach(teacher => {
                    const etab = teacher.establishment || 'Non sp√©cifi√©';
                    establishmentCounts[etab] = (establishmentCounts[etab] || 0) + 1;
                });
                
                Object.entries(establishmentCounts).forEach(([etab, count]) => {
                    const percentage = totalTeachers > 0 ? ((count / totalTeachers) * 100).toFixed(1) : 0;
                    reportHTML += `
                        <tr>
                            <td>${etab}</td>
                            <td>${count}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
                
                reportHTML += `
                            </tbody>
                        </table>
                        
                        <div class="footer">
                            <p>Rapport g√©n√©r√© automatiquement par la Plateforme d'Analyse - Inspecteurs √âducation</p>
                            <p>Nombre total de fichiers import√©s: ${teachersData.reduce((sum, t) => sum + (t.files ? t.files.length : 0), 0)}</p>
                        </div>
                    </body>
                    </html>
                `;
                
                reportWindow.document.write(reportHTML);
                reportWindow.document.close();
                
                showNotification('Rapport g√©n√©r√© avec succ√®s', 'success');
                
            } catch (error) {
                console.error('Erreur lors de la g√©n√©ration du rapport:', error);
                showNotification('Erreur lors de la g√©n√©ration du rapport: ' + error.message, 'error');
            } finally {
                showLoader(false);
            }
        }

        // Sauvegarder la session
        function saveSession() {
            if (teachersData.length === 0) {
                showNotification('Aucune donn√©e √† sauvegarder', 'warning');
                return;
            }
            
            const sessionData = {
                teachers: teachersData,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            try {
                localStorage.setItem('teachersAnalyticsData', JSON.stringify(sessionData));
                showNotification('Session sauvegard√©e avec succ√®s', 'success');
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                showNotification('Erreur lors de la sauvegarde: ' + error.message, 'error');
            }
        }

        // Charger les donn√©es de session
        function loadSessionData() {
            try {
                const savedData = localStorage.getItem('teachersAnalyticsData');
                if (savedData) {
                    const sessionData = JSON.parse(savedData);
                    if (sessionData.teachers && Array.isArray(sessionData.teachers)) {
                        teachersData = sessionData.teachers;
                        updateUIAfterImport();
                        showNotification('Session pr√©c√©dente charg√©e avec succ√®s', 'success');
                    }
                }
            } catch (error) {
                console.error('Erreur lors du chargement de la session:', error);
                // Ne pas afficher d'erreur pour ne pas perturber l'utilisateur
            }
        }

        // Exporter les donn√©es de session
        function backupData() {
            if (teachersData.length === 0) {
                showNotification('Aucune donn√©e √† sauvegarder', 'warning');
                return;
            }
            
            const backupData = {
                teachers: teachersData,
                timestamp: new Date().toISOString(),
                version: '1.0',
                exportType: 'backup'
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_enseignants_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Sauvegarde des donn√©es export√©e avec succ√®s', 'success');
        }

        // Gestionnaire de notifications
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const messageElement = document.getElementById('notificationMessage');
            
            // Mettre √† jour le message et le type
            messageElement.textContent = message;
            notification.className = 'notification';
            
            // D√©finir l'ic√¥ne et la couleur selon le type
            switch(type) {
                case 'error':
                    notification.classList.add('error');
                    icon.className = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    notification.classList.add('warning');
                    icon.className = 'fas fa-exclamation-triangle';
                    break;
                case 'info':
                    notification.classList.add('info');
                    icon.className = 'fas fa-info-circle';
                    break;
                default:
                    notification.classList.add('success');
                    icon.className = 'fas fa-check-circle';
            }
            
            // Afficher la notification
            notification.classList.add('show');
            
            // Masquer automatiquement apr√®s 5 secondes
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Gestionnaire de loader
        function showLoader(show) {
            const loader = document.getElementById('loader');
            if (show) {
                loader.classList.add('active');
            } else {
                loader.classList.remove('active');
            }
        }

        // Note: Les fonctions pour les sous-onglets p√©dagogie, √©valuations, projets, etc.
        // sont simplifi√©es pour cet exemple. Dans une version compl√®te, elles seraient
        // impl√©ment√©es de mani√®re similaire aux autres sections.

        function updatePedagogyOverview() {
            const container = document.getElementById('pedagogyStats');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donn√©e p√©dagogique disponible</p>';
                return;
            }
            
            const totalSubjects = countDataRecords('subjects');
            const totalLessons = countDataRecords('lessons');
            const teachersWithSubjects = teachersData.filter(t => t.data && t.data.subjects && t.data.subjects.length > 0).length;
            
            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div>Mati√®res enseign√©es</div>
                        <div class="stat-value">${totalSubjects}</div>
                        <div>Total</div>
                    </div>
                    <div class="stat-card">
                        <div>Le√ßons enregistr√©es</div>
                        <div class="stat-value">${totalLessons}</div>
                        <div>Total</div>
                    </div>
                    <div class="stat-card">
                        <div>Enseignants avec mati√®res</div>
                        <div class="stat-value">${teachersWithSubjects}</div>
                        <div>${teachersData.length > 0 ? ((teachersWithSubjects / teachersData.length) * 100).toFixed(1) : 0}%</div>
                    </div>
                </div>
            `;
        }

        function updateSubjectsAnalysis() {
            const container = document.getElementById('subjectsAnalysis');
            if (!container) return;
            
            // Similaire aux autres fonctions d'analyse
            container.innerHTML = '<p class="text-center">Fonctionnalit√© d\'analyse des mati√®res en d√©veloppement...</p>';
        }

        function updateLessonsAnalysis() {
            const container = document.getElementById('lessonsAnalysis');
            if (!container) return;
            
            container.innerHTML = '<p class="text-center">Fonctionnalit√© d\'analyse des le√ßons en d√©veloppement...</p>';
        }

        function updateTPAnalysis() {
            const container = document.getElementById('tpAnalysis');
            if (!container) return;
            
            container.innerHTML = '<p class="text-center">Fonctionnalit√© d\'analyse des TP en d√©veloppement...</p>';
        }

    </script>
</body>
</html>
