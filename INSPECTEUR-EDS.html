<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plateforme d'Analyse - Inspecteurs Éducation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #9b59b6;
            --dark-color: #2c3e50;
            --light-color: #f5f5f5;
            --gray-color: #7f8c8d;
            --border-radius: 10px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-color);
            padding: 20px;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        /* Header */
        header {
            text-align: center;
            padding: 25px 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            position: relative;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .platform-name {
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        header h1 {
            color: white;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        /* Navigation */
        .tabs-container {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }

        .tabs {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            min-width: 800px;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-color);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .tab:hover {
            background-color: #e9ecef;
            color: var(--dark-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background-color: white;
        }

        /* Contenu des onglets */
        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        /* Section d'importation */
        .import-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            border: 2px dashed var(--primary-color);
            text-align: center;
        }

        .import-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .import-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .import-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
        }

        .import-card i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .import-card h3 {
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        .import-card p {
            color: var(--gray-color);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Onglets de type de fichier */
        .file-type-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .file-type-tab {
            padding: 10px 20px;
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-type-tab:hover {
            background: var(--primary-color);
            color: white;
        }

        .file-type-tab.active {
            background: var(--primary-color);
            color: white;
        }

        /* Boutons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--success-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #d68910;
            transform: translateY(-2px);
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
        }

        .btn-light {
            background-color: #f8f9fa;
            color: var(--dark-color);
            border: 1px solid #dee2e6;
        }

        .btn-light:hover {
            background-color: #e9ecef;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .btn-xs {
            padding: 5px 8px;
            font-size: 0.8rem;
        }

        /* Bouton Retour */
        .btn-return {
            background-color: white;
            color: var(--primary-color);
            border: 2px solid white;
        }

        .btn-return:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Sections de données */
        .data-section {
            margin-bottom: 30px;
            padding: 25px;
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .data-section h2 {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            margin: -25px -25px 25px -25px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        /* Tableaux */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .data-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .dashboard-card h3 {
            margin-bottom: 15px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
            position: relative;
        }

        /* Statistiques */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        /* Filtres */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
            padding: 15px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .search-box input {
            padding-left: 40px;
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        /* Onglets secondaires */
        .sub-tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 25px;
            overflow-x: auto;
        }

        .sub-tab {
            padding: 12px 25px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-color);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
        }

        .sub-tab:hover {
            color: var(--dark-color);
        }

        .sub-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 5px;
        }

        .badge-primary {
            background-color: #e3f2fd;
            color: var(--primary-color);
        }

        .badge-success {
            background-color: #e8f5e9;
            color: var(--success-color);
        }

        .badge-warning {
            background-color: #fff3e0;
            color: var(--warning-color);
        }

        .badge-danger {
            background-color: #ffebee;
            color: var(--danger-color);
        }

        .badge-info {
            background-color: #f3e5f5;
            color: var(--info-color);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success-color);
            color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        /* Loader */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }

        .loader.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-color);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 0;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .data-section {
                padding: 20px;
            }
            
            .import-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-bar {
                flex-direction: column;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .sub-tabs {
                flex-wrap: wrap;
            }
            
            .sub-tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .file-type-tabs {
                flex-direction: column;
            }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .header-actions {
                display: flex;
                gap: 10px;
                width: 100%;
                justify-content: space-between;
            }
        }

        /* Utilitaires */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-30 {
            margin-bottom: 30px;
        }

        .mt-30 {
            margin-top: 30px;
        }

        .d-flex {
            display: flex;
        }

        .align-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-10 {
            gap: 10px;
        }

        .gap-15 {
            gap: 15px;
        }

        .gap-20 {
            gap: 20px;
        }

        .w-100 {
            width: 100%;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Cartes enseignants */
        .teacher-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .teacher-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
            cursor: pointer;
        }

        .teacher-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .teacher-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .teacher-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .teacher-matricule {
            background: var(--primary-color);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .teacher-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .teacher-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray-color);
        }

        .teacher-info-item i {
            color: var(--primary-color);
        }

        /* Fichiers par type */
        .files-by-type {
            margin: 20px 0;
        }

        .file-type-group {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .file-list {
            margin-top: 10px;
            padding-left: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        /* Visualisation données */
        .data-preview {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }

        /* Header actions */
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* Section Python Analysis */
        .python-editor {
            width: 100%;
            height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
            resize: vertical;
            margin-bottom: 15px;
        }

        .python-output {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }

        .python-script-item {
            padding: 10px 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .python-script-item:hover {
            background-color: #f8f9fa;
            border-color: var(--primary-color);
        }

        .python-analysis-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .python-analysis-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .python-analysis-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle" id="notificationIcon"></i>
        <span id="notificationMessage"></span>
    </div>

    <!-- Container principal -->
    <div class="container">
        <header>
            <div class="header-content">
                <div class="platform-name">
                    <i class="fas fa-chart-line"></i>
                    <span>Plateforme d'Analyse - Inspecteurs Éducation</span>
                </div>
                <div class="header-actions">
                    <div class="user-info">
                        <i class="fas fa-user-shield"></i>
                        <span>Inspecteur - <span id="currentYear"></span></span>
                    </div>
                    <a href="index.html" class="btn btn-return">
                        <i class="fas fa-home"></i> Retour à l'accueil
                    </a>
                </div>
            </div>
            <h1><i class="fas fa-analytics"></i> ANALYSE DES FICHES ENSEIGNANTS</h1>
            <p>Importation, visualisation et analyse des données pédagogiques complètes</p>
        </header>

        <!-- Navigation principale -->
        <div class="tabs-container">
            <ul class="tabs">
                <li class="tab active" data-tab="tab-import">
                    <i class="fas fa-upload"></i> Importation
                </li>
                <li class="tab" data-tab="tab-python">
                    <i class="fab fa-python"></i> Analyse Python
                </li>
                <li class="tab" data-tab="tab-dashboard">
                    <i class="fas fa-tachometer-alt"></i> Tableau de bord
                </li>
                <li class="tab" data-tab="tab-teachers">
                    <i class="fas fa-users"></i> Enseignants
                </li>
                <li class="tab" data-tab="tab-pedagogy">
                    <i class="fas fa-chalkboard-teacher"></i> Pédagogie
                </li>
                <li class="tab" data-tab="tab-training">
                    <i class="fas fa-graduation-cap"></i> Formation
                </li>
                <li class="tab" data-tab="tab-projects">
                    <i class="fas fa-project-diagram"></i> Projets
                </li>
                <li class="tab" data-tab="tab-retirement">
                    <i class="fas fa-umbrella-beach"></i> Retraite
                </li>
                <li class="tab" data-tab="tab-export">
                    <i class="fas fa-download"></i> Export Excel
                </li>
            </ul>
        </div>

        <!-- Onglet Importation -->
        <div id="tab-import" class="tab-content active">
            <div class="import-section">
                <h2><i class="fas fa-file-import"></i> IMPORTATION DES DONNÉES</h2>
                <p>Sélectionnez le type d'importation ou choisissez un type de fichier spécifique</p>
                
                <!-- Sélecteur de type de fichier -->
                <div class="file-type-tabs" id="fileTypeTabs">
                    <div class="file-type-tab active" data-file-type="all">
                        <i class="fas fa-file"></i> Tous les fichiers
                    </div>
                    <div class="file-type-tab" data-file-type="tab1">
                        <i class="fas fa-user-tie"></i> Informations Générales
                    </div>
                    <div class="file-type-tab" data-file-type="tab2">
                        <i class="fas fa-chalkboard-teacher"></i> Enseignement
                    </div>
                    <div class="file-type-tab" data-file-type="tab3">
                        <i class="fas fa-graduation-cap"></i> Formation
                    </div>
                    <div class="file-type-tab" data-file-type="tab4">
                        <i class="fas fa-chart-line"></i> Évaluations
                    </div>
                    <div class="file-type-tab" data-file-type="tab5">
                        <i class="fas fa-project-diagram"></i> Projets
                    </div>
                    <div class="file-type-tab" data-file-type="tab7">
                        <i class="fas fa-dashboard"></i> Dashboard
                    </div>
                </div>
                
                <div class="import-grid">
                    <!-- Import fichier unique -->
                    <div class="import-card">
                        <i class="fas fa-file-import"></i>
                        <h3>Import fichier unique</h3>
                        <p>Importez un fichier JSON spécifique (tab1, tab2, etc.)</p>
                        <div class="file-input-wrapper">
                            <button class="btn btn-primary" id="singleFileBtn">
                                <i class="fas fa-upload"></i> Choisir un fichier
                            </button>
                            <input type="file" id="singleFileInput" accept=".json" style="display: none;">
                        </div>
                    </div>

                    <!-- Import multiple -->
                    <div class="import-card">
                        <i class="fas fa-folder-open"></i>
                        <h3>Import multiple</h3>
                        <p>Importez tous les fichiers JSON d'un enseignant</p>
                        <div class="file-input-wrapper">
                            <button class="btn btn-secondary" id="multiFileBtn">
                                <i class="fas fa-folder-open"></i> Choisir des fichiers
                            </button>
                            <input type="file" id="multiFileInput" accept=".json" multiple style="display: none;">
                        </div>
                    </div>

                    <!-- Import dossier -->
                    <div class="import-card">
                        <i class="fas fa-database"></i>
                        <h3>Import complet</h3>
                        <p>Importez un fichier JSON complet (export total)</p>
                        <div class="file-input-wrapper">
                            <button class="btn btn-info" id="completeFileBtn">
                                <i class="fas fa-database"></i> Choisir un fichier
                            </button>
                            <input type="file" id="completeFileInput" accept=".json" style="display: none;">
                        </div>
                    </div>
                </div>

                <!-- Liste des fichiers importés par type -->
                <div class="data-section mt-30" id="importedFilesSection" style="display: none;">
                    <h2><i class="fas fa-list-check"></i> FICHIERS IMPORTÉS PAR TYPE</h2>
                    <div id="importedFilesList"></div>
                </div>

                <!-- Vue d'ensemble -->
                <div class="data-section mt-30" id="overviewSection" style="display: none;">
                    <h2><i class="fas fa-eye"></i> VUE D'ENSEMBLE</h2>
                    <div class="stats-grid" id="overviewStats"></div>
                </div>

                <!-- Visualisation des données -->
                <div class="data-section mt-30" id="dataPreviewSection" style="display: none;">
                    <h2><i class="fas fa-eye"></i> VISUALISATION DES DONNÉES</h2>
                    <select id="dataPreviewSelect" class="w-100 mb-20" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Sélectionner un enseignant pour prévisualiser...</option>
                    </select>
                    <div id="dataPreviewContent"></div>
                </div>
            </div>
        </div>

        <!-- Onglet Analyse Python -->
        <div id="tab-python" class="tab-content">
            <div class="import-section">
                <h2><i class="fab fa-python"></i> ANALYSE AVEC PYTHON</h2>
                <p>Exécutez des scripts Python pour analyser les données importées</p>
                
                <div class="python-analysis-grid">
                    <div>
                        <div class="python-analysis-controls">
                            <button class="btn btn-primary" onclick="runPythonAnalysis()">
                                <i class="fas fa-play"></i> Exécuter l'analyse
                            </button>
                            <button class="btn btn-secondary" onclick="loadPythonTemplate('basic')">
                                <i class="fas fa-file-code"></i> Charger un modèle
                            </button>
                            <button class="btn btn-info" onclick="savePythonScript()">
                                <i class="fas fa-save"></i> Sauvegarder le script
                            </button>
                            <button class="btn btn-warning" onclick="clearPythonOutput()">
                                <i class="fas fa-broom"></i> Effacer la sortie
                            </button>
                        </div>

                        <textarea class="python-editor" id="pythonEditor" placeholder="Écrivez votre code Python ici...">
# Importation des données chargées dans l'application
# Les données sont disponibles dans la variable 'teachers_data'

def analyse_enseignants(teachers_data):
    """Analyse basique des données enseignants"""
    if not teachers_data:
        return "Aucune donnée disponible"
    
    total_enseignants = len(teachers_data)
    fiches_completes = sum(1 for t in teachers_data if t.get('complete', False))
    
    # Calcul des statistiques
    stats = {
        'total_enseignants': total_enseignants,
        'fiches_completes': fiches_completes,
        'pourcentage_complet': (fiches_completes / total_enseignants * 100) if total_enseignants > 0 else 0
    }
    
    return stats

# Exécution de l'analyse
if 'teachers_data' in globals():
    resultats = analyse_enseignants(teachers_data)
    print("=== ANALYSE DES ENSEIGNANTS ===")
    print(f"Nombre total d'enseignants: {resultats['total_enseignants']}")
    print(f"Fiches complètes: {resultats['fiches_completes']}")
    print(f"Taux de complétion: {resultats['pourcentage_complet']:.1f}%")
    
    # Analyse par établissement
    print("\n=== RÉPARTITION PAR ÉTABLISSEMENT ===")
    etablissements = {}
    for teacher in teachers_data:
        if teacher.get('data') and teacher['data'].get('establishment'):
            etab = teacher['data']['establishment'].get('name', 'Non spécifié')
            etablissements[etab] = etablissements.get(etab, 0) + 1
    
    for etab, count in etablissements.items():
        pourcentage = (count / len(teachers_data) * 100) if teachers_data else 0
        print(f"{etab}: {count} enseignants ({pourcentage:.1f}%)")
    
    # Analyse par matière
    print("\n=== MATIÈRES ENSEIGNÉES ===")
    matieres = {}
    for teacher in teachers_data:
        if teacher.get('data') and teacher['data'].get('subjects'):
            for subject in teacher['data']['subjects']:
                if subject.get('name'):
                    matieres[subject['name']] = matieres.get(subject['name'], 0) + 1
    
    for matiere, count in sorted(matieres.items(), key=lambda x: x[1], reverse=True)[:10]:
        print(f"{matiere}: {count} enseignants")
else:
    print("Veuillez d'abord importer des données dans l'onglet Importation")
                        </textarea>

                        <div class="python-output" id="pythonOutput">
                            Sortie Python s'affichera ici...
                        </div>
                    </div>

                    <div>
                        <div class="data-section">
                            <h3><i class="fas fa-code"></i> Scripts prédéfinis</h3>
                            <div id="pythonScriptsList">
                                <div class="python-script-item" onclick="loadPythonTemplate('basic')">
                                    <strong>Analyse basique</strong>
                                    <p>Statistiques générales des enseignants</p>
                                </div>
                                <div class="python-script-item" onclick="loadPythonTemplate('pedagogy')">
                                    <strong>Analyse pédagogique</strong>
                                    <p>Analyse des données d'enseignement</p>
                                </div>
                                <div class="python-script-item" onclick="loadPythonTemplate('retirement')">
                                    <strong>Planification retraite</strong>
                                    <p>Analyse des départs à la retraite</p>
                                </div>
                                <div class="python-script-item" onclick="loadPythonTemplate('training')">
                                    <strong>Analyse formation</strong>
                                    <p>Compétences et formations des enseignants</p>
                                </div>
                                <div class="python-script-item" onclick="loadPythonTemplate('export')">
                                    <strong>Export avancé</strong>
                                    <p>Génération de rapports détaillés</p>
                                </div>
                            </div>
                        </div>

                        <div class="data-section mt-20">
                            <h3><i class="fas fa-chart-bar"></i> Données disponibles</h3>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div>Enseignants chargés</div>
                                    <div class="stat-value" id="pythonTeacherCount">0</div>
                                </div>
                                <div class="stat-card">
                                    <div>Fiches complètes</div>
                                    <div class="stat-value" id="pythonCompleteCount">0</div>
                                </div>
                                <div class="stat-card">
                                    <div>Matières uniques</div>
                                    <div class="stat-value" id="pythonSubjectsCount">0</div>
                                </div>
                                <div class="stat-card">
                                    <div>Établissements</div>
                                    <div class="stat-value" id="pythonEstablishmentsCount">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="data-section mt-30">
                    <h3><i class="fas fa-lightbulb"></i> Variables disponibles pour l'analyse</h3>
                    <div class="data-preview">
# Variables disponibles dans le contexte Python:
# - teachers_data: Liste complète des données enseignants
# - current_file_type: Type de fichier actuellement sélectionné
# - FILE_TYPES: Dictionnaire des types de fichiers supportés

# Accès aux données d'un enseignant:
# for teacher in teachers_data:
#     print(f"Nom: {teacher.get('fullName')}")
#     print(f"Matricule: {teacher.get('data', {}).get('professional', {}).get('matricule')}")
#     print(f"Établissement: {teacher.get('data', {}).get('establishment', {}).get('name')}")

# Exemple de fonction d'analyse:
def generer_rapport(teachers_data):
    """Génère un rapport détaillé"""
    rapport = []
    rapport.append("=== RAPPORT D'ANALYSE ===")
    rapport.append(f"Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    rapport.append(f"Nombre d'enseignants: {len(teachers_data)}")
    return "\n".join(rapport)

# Pour exécuter cette fonction:
# print(generer_rapport(teachers_data))
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet Tableau de bord -->
        <div id="tab-dashboard" class="tab-content">
            <div class="filter-bar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Rechercher un enseignant..." id="dashboardSearch">
                </div>
                <select id="dashboardFilterSubject">
                    <option value="">Toutes les matières</option>
                </select>
                <select id="dashboardFilterCategory">
                    <option value="">Toutes les catégories</option>
                </select>
                <select id="dashboardFilterEstablishment">
                    <option value="">Tous les établissements</option>
                </select>
            </div>

            <!-- Statistiques globales -->
            <div class="data-section">
                <h2><i class="fas fa-chart-bar"></i> STATISTIQUES GLOBALES</h2>
                <div class="stats-grid" id="globalStats"></div>
            </div>

            <!-- Graphiques -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-pie"></i> Répartition par matière</h3>
                    <div class="chart-container">
                        <canvas id="subjectChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-line"></i> Évolution des retraites</h3>
                    <div class="chart-container">
                        <canvas id="retirementChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-bar"></i> Heures d'enseignement</h3>
                    <div class="chart-container">
                        <canvas id="hoursChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-graduation-cap"></i> Niveau de formation</h3>
                    <div class="chart-container">
                        <canvas id="trainingChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Dernières activités -->
            <div class="data-section">
                <h2><i class="fas fa-history"></i> DERNIÈRES ACTIVITÉS PÉDAGOGIQUES</h2>
                <div id="recentActivities"></div>
            </div>
        </div>

        <!-- Onglet Enseignants -->
        <div id="tab-teachers" class="tab-content">
            <div class="filter-bar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Rechercher par nom, matricule..." id="teacherSearch">
                </div>
                <button class="btn btn-light" onclick="sortTeachers('name')">
                    <i class="fas fa-sort-alpha-down"></i> Trier par nom
                </button>
                <button class="btn btn-light" onclick="sortTeachers('retirement')">
                    <i class="fas fa-calendar"></i> Trier par retraite
                </button>
                <button class="btn btn-light" onclick="filterCompleteOnly()">
                    <i class="fas fa-check-circle"></i> Fiches complètes
                </button>
            </div>

            <!-- Liste des enseignants -->
            <div id="teachersListContainer">
                <div class="teacher-cards" id="teachersCards"></div>
            </div>

            <!-- Détails enseignant (modal) -->
            <div class="modal" id="teacherDetailModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="teacherModalTitle"></h3>
                        <button class="modal-close" onclick="closeTeacherDetail()">&times;</button>
                    </div>
                    <div id="teacherModalContent"></div>
                </div>
            </div>
        </div>

        <!-- Onglet Pédagogie -->
        <div id="tab-pedagogy" class="tab-content">
            <!-- Sous-onglets pédagogie -->
            <div class="sub-tabs">
                <div class="sub-tab active" data-subtab="pedagogy-overview">Vue d'ensemble</div>
                <div class="sub-tab" data-subtab="pedagogy-subjects">Matières enseignées</div>
                <div class="sub-tab" data-subtab="pedagogy-timetable">Emplois du temps</div>
                <div class="sub-tab" data-subtab="pedagogy-lessons">Leçons</div>
                <div class="sub-tab" data-subtab="pedagogy-tp">Travaux pratiques</div>
                <div class="sub-tab" data-subtab="pedagogy-resources">Ressources</div>
            </div>

            <!-- Sous-contenus -->
            <div class="sub-tab-content active" data-subtab="pedagogy-overview">
                <div class="data-section">
                    <h2><i class="fas fa-chart-bar"></i> STATISTIQUES PÉDAGOGIQUES</h2>
                    <div id="pedagogyStats"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="pedagogy-subjects">
                <div class="data-section">
                    <h2><i class="fas fa-book"></i> MATIÈRES ENSEIGNÉES</h2>
                    <div id="subjectsAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="pedagogy-timetable">
                <div class="data-section">
                    <h2><i class="fas fa-calendar-alt"></i> EMPLOIS DU TEMPS</h2>
                    <div id="timetableAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="pedagogy-lessons">
                <div class="data-section">
                    <h2><i class="fas fa-chalkboard"></i> LEÇONS ENREGISTRÉES</h2>
                    <div id="lessonsAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="pedagogy-tp">
                <div class="data-section">
                    <h2><i class="fas fa-flask"></i> TRAVAUX PRATIQUES</h2>
                    <div id="tpAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="pedagogy-resources">
                <div class="data-section">
                    <h2><i class="fas fa-folder-open"></i> RESSOURCES PÉDAGOGIQUES</h2>
                    <div id="resourcesAnalysis"></div>
                </div>
            </div>
        </div>

        <!-- Onglet Formation -->
        <div id="tab-training" class="tab-content">
            <!-- Sous-onglets formation -->
            <div class="sub-tabs">
                <div class="sub-tab active" data-subtab="training-overview">Vue d'ensemble</div>
                <div class="sub-tab" data-subtab="training-diplomas">Diplômes</div>
                <div class="sub-tab" data-subtab="training-continuous">Formations continues</div>
                <div class="sub-tab" data-subtab="training-languages">Compétences linguistiques</div>
                <div class="sub-tab" data-subtab="training-it">Compétences informatiques</div>
            </div>

            <!-- Sous-contenus -->
            <div class="sub-tab-content active" data-subtab="training-overview">
                <div class="data-section">
                    <h2><i class="fas fa-graduation-cap"></i> STATISTIQUES DE FORMATION</h2>
                    <div id="trainingStats"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="training-diplomas">
                <div class="data-section">
                    <h2><i class="fas fa-award"></i> DIPLÔMES ACADÉMIQUES ET PROFESSIONNELS</h2>
                    <div id="diplomasAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="training-continuous">
                <div class="data-section">
                    <h2><i class="fas fa-chalkboard-teacher"></i> FORMATIONS CONTINUES</h2>
                    <div id="continuousTrainingAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="training-languages">
                <div class="data-section">
                    <h2><i class="fas fa-language"></i> COMPÉTENCES LINGUISTIQUES</h2>
                    <div id="languagesAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="training-it">
                <div class="data-section">
                    <h2><i class="fas fa-laptop-code"></i> COMPÉTENCES INFORMATIQUES</h2>
                    <div id="itSkillsAnalysis"></div>
                </div>
            </div>
        </div>

        <!-- Onglet Projets -->
        <div id="tab-projects" class="tab-content">
            <!-- Sous-onglets projets -->
            <div class="sub-tabs">
                <div class="sub-tab active" data-subtab="projects-overview">Vue d'ensemble</div>
                <div class="sub-tab" data-subtab="projects-pedagogical">Projets pédagogiques</div>
                <div class="sub-tab" data-subtab="projects-activities">Activités extrascolaires</div>
                <div class="sub-tab" data-subtab="projects-meetings">Réunions</div>
            </div>

            <!-- Sous-contenus -->
            <div class="sub-tab-content active" data-subtab="projects-overview">
                <div class="data-section">
                    <h2><i class="fas fa-project-diagram"></i> STATISTIQUES DES PROJETS</h2>
                    <div id="projectsStats"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="projects-pedagogical">
                <div class="data-section">
                    <h2><i class="fas fa-project-diagram"></i> PROJETS PÉDAGOGIQUES</h2>
                    <div id="pedagogicalProjectsAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="projects-activities">
                <div class="data-section">
                    <h2><i class="fas fa-futbol"></i> ACTIVITÉS EXTRASCOLAIRES</h2>
                    <div id="activitiesAnalysis"></div>
                </div>
            </div>

            <div class="sub-tab-content" data-subtab="projects-meetings">
                <div class="data-section">
                    <h2><i class="fas fa-users"></i> RÉUNIONS ET CONSEILS</h2>
                    <div id="meetingsAnalysis"></div>
                </div>
            </div>
        </div>

        <!-- Onglet Retraite -->
        <div id="tab-retirement" class="tab-content">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3><i class="fas fa-calendar-times"></i> Prochaines retraites</h3>
                    <div id="upcomingRetirements"></div>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-bar"></i> Répartition par année</h3>
                    <div class="chart-container">
                        <canvas id="retirementYearChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="data-section">
                <h2><i class="fas fa-table"></i> TABLEAU DES RETRAITES</h2>
                <div id="retirementTable"></div>
            </div>

            <!-- Analyse de la retraite -->
            <div class="data-section">
                <h2><i class="fas fa-chart-pie"></i> ANALYSE PAR CATÉGORIE</h2>
                <div class="stats-grid" id="retirementAnalysis"></div>
            </div>
        </div>

        <!-- Onglet Export Excel -->
        <div id="tab-export" class="tab-content">
            <div class="import-section">
                <h2><i class="fas fa-file-excel"></i> EXPORT EXCEL</h2>
                <p>Exportez toutes les données analysées au format Excel</p>

                <div class="export-options">
                    <button class="btn btn-success" onclick="exportAllToExcel()">
                        <i class="fas fa-file-excel"></i> Export complet
                    </button>
                    <button class="btn btn-primary" onclick="exportTeachersToExcel()">
                        <i class="fas fa-users"></i> Liste enseignants
                    </button>
                    <button class="btn btn-info" onclick="exportPedagogyToExcel()">
                        <i class="fas fa-chalkboard-teacher"></i> Données pédagogiques
                    </button>
                    <button class="btn btn-warning" onclick="exportTrainingToExcel()">
                        <i class="fas fa-graduation-cap"></i> Données formation
                    </button>
                    <button class="btn btn-secondary" onclick="exportRetirementToExcel()">
                        <i class="fas fa-umbrella-beach"></i> Planification retraite
                    </button>
                    <button class="btn btn-secondary" onclick="exportProjectsToExcel()">
                        <i class="fas fa-project-diagram"></i> Projets et activités
                    </button>
                </div>

                <!-- Aperçu des données à exporter -->
                <div class="data-section mt-30">
                    <h2><i class="fas fa-eye"></i> APERÇU DES DONNÉES À EXPORTER</h2>
                    <div id="exportPreview"></div>
                </div>

                <!-- Options d'export -->
                <div class="data-section mt-20">
                    <h2><i class="fas fa-cog"></i> OPTIONS D'EXPORT</h2>
                    <div class="filter-bar">
                        <select id="exportFilterEstablishment" class="w-100">
                            <option value="">Tous les établissements</option>
                        </select>
                        <select id="exportFilterSubject" class="w-100">
                            <option value="">Toutes les matières</option>
                        </select>
                        <select id="exportFilterCategory" class="w-100">
                            <option value="">Toutes les catégories</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions globales -->
        <div class="filter-bar" style="margin-top: 30px;">
            <a href="index.html" class="btn btn-light">
                <i class="fas fa-home"></i> Retour à l'accueil
            </a>
            <button class="btn btn-light" onclick="clearAllData()">
                <i class="fas fa-trash"></i> Effacer toutes les données
            </button>
            <button class="btn btn-info" onclick="generateReport()">
                <i class="fas fa-file-pdf"></i> Générer rapport
            </button>
            <button class="btn btn-primary" onclick="saveSession()">
                <i class="fas fa-save"></i> Sauvegarder la session
            </button>
            <button class="btn btn-secondary" onclick="backupData()">
                <i class="fas fa-download"></i> Exporter session
            </button>
        </div>
    </div>

    <script>
        // Variables globales
        let teachersData = [];
        let currentTeacherIndex = -1;
        let charts = {};
        let filteredTeachers = [];
        let currentFileType = 'all';
        let pyodide = null;
        let currentSort = { field: 'lastName', direction: 'asc' };
        let showCompleteOnly = false;

        // Types de fichiers supportés
        const FILE_TYPES = {
            'tab1': {
                name: 'Informations Générales',
                icon: 'fa-user-tie',
                description: 'Données personnelles, professionnelles et établissement'
            },
            'tab2': {
                name: 'Enseignement & Pédagogie',
                icon: 'fa-chalkboard-teacher',
                description: 'Planning, thèmes, leçons, TP, ressources'
            },
            'tab3': {
                name: 'Formation & Compétences',
                icon: 'fa-graduation-cap',
                description: 'Diplômes, formations, langues, compétences IT'
            },
            'tab4': {
                name: 'Évaluations & Statistiques',
                icon: 'fa-chart-line',
                description: 'Évaluations, performances, statistiques'
            },
            'tab5': {
                name: 'Projets & Activités',
                icon: 'fa-project-diagram',
                description: 'Projets pédagogiques, activités, réunions'
            },
            'tab6': {
                name: 'Données & Archives',
                icon: 'fa-database',
                description: 'Sauvegardes, logs, données techniques'
            },
            'tab7': {
                name: 'Tableau de bord',
                icon: 'fa-tachometer-alt',
                description: 'Statistiques, synthèses, rapports'
            },
            'complete': {
                name: 'Fichier complet',
                icon: 'fa-database',
                description: 'Toutes les données en un seul fichier'
            }
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            // Initialiser l'année
            const currentYear = new Date().getFullYear();
            document.getElementById('currentYear').textContent = currentYear;
            
            // Gestion des onglets
            initTabs();
            
            // Gestion des sous-onglets
            initSubTabs();
            
            // Gestion des types de fichiers
            initFileTypeTabs();
            
            // Initialiser les événements des boutons
            initButtons();
            
            // Charger les données de session
            loadSessionData();
            
            // Initialiser les événements
            initEvents();
            
            // Initialiser les listes de filtres
            initFilterLists();
            
            showNotification('Plateforme d\'analyse prête', 'success');
        }

        // Initialisation de Pyodide
        async function initPyodide() {
            showLoader(true);
            try {
                pyodide = await loadPyodide();
                await pyodide.loadPackage(['micropip']);
                
                console.log('Pyodide chargé avec succès');
                showNotification('Environnement Python prêt pour l\'analyse', 'success');
            } catch (error) {
                console.error('Erreur lors du chargement de Pyodide:', error);
                showNotification('Pyodide non disponible - analyse Python limitée', 'warning');
            } finally {
                showLoader(false);
            }
        }

        // Exécution de l'analyse Python
        async function runPythonAnalysis() {
            if (!pyodide) {
                await initPyodide();
            }
            
            const pythonCode = document.getElementById('pythonEditor').value;
            const outputElement = document.getElementById('pythonOutput');
            
            if (!pythonCode.trim()) {
                showNotification('Veuillez entrer du code Python', 'warning');
                return;
            }
            
            showLoader(true);
            outputElement.innerHTML = '<span style="color: #4CAF50;">Exécution en cours...</span>';
            
            try {
                // Préparer les données pour Python
                const pythonData = {
                    teachers_data: teachersData,
                    current_file_type: currentFileType,
                    FILE_TYPES: FILE_TYPES
                };
                
                // Injecter les données dans l'environnement Python
                pyodide.globals.set('teachers_data', teachersData);
                pyodide.globals.set('current_file_type', currentFileType);
                pyodide.globals.set('FILE_TYPES', FILE_TYPES);
                
                // Ajouter des modules essentiels
                await pyodide.runPythonAsync(`
                    import datetime
                    from datetime import datetime as dt
                `);
                
                // Exécuter le code Python
                try {
                    await pyodide.runPythonAsync(pythonCode);
                    showNotification('Analyse Python exécutée avec succès', 'success');
                } catch (pyError) {
                    outputElement.innerHTML = `<pre style="color: #ff6b6b;">Erreur Python: ${pyError.message}</pre>`;
                    showNotification('Erreur dans l\'exécution Python', 'error');
                }
                
                // Mettre à jour les statistiques Python
                updatePythonStats();
                
            } catch (error) {
                outputElement.innerHTML = `<pre style="color: #ff6b6b;">Erreur lors de l'exécution: ${error.message}</pre>`;
                showNotification('Erreur dans l\'analyse Python', 'error');
            } finally {
                showLoader(false);
            }
        }

        // Charger un modèle d'analyse Python
        function loadPythonTemplate(templateName) {
            const templates = {
                'basic': `# Analyse basique des données enseignants
def analyse_basique(teachers_data):
    """Analyse statistique basique des enseignants"""
    if not teachers_data:
        return "Aucune donnée disponible"
    
    total = len(teachers_data)
    complet = sum(1 for t in teachers_data if t.get('complete', False))
    
    # Calcul des âges
    ages = [t.get('age') for t in teachers_data if t.get('age')]
    age_moyenne = sum(ages) / len(ages) if ages else 0
    
    # Analyse par établissement
    etablissements = {}
    for teacher in teachers_data:
        if teacher.get('data') and teacher['data'].get('establishment'):
            etab = teacher['data']['establishment'].get('name', 'Non spécifié')
            etablissements[etab] = etablissements.get(etab, 0) + 1
    
    # Génération du rapport
    rapport = []
    rapport.append("=== RAPPORT D'ANALYSE BASIQUE ===")
    rapport.append(f"Total enseignants: {total}")
    rapport.append(f"Fiches complètes: {complet} ({complet/total*100:.1f}%)")
    rapport.append(f"Âge moyen: {age_moyenne:.1f} ans")
    rapport.append("")
    rapport.append("=== RÉPARTITION PAR ÉTABLISSEMENT ===")
    for etab, count in sorted(etablissements.items(), key=lambda x: x[1], reverse=True):
        rapport.append(f"{etab}: {count} ({count/total*100:.1f}%)")
    
    return "\\n".join(rapport)

# Exécution
print(analyse_basique(teachers_data))`,

                'pedagogy': `# Analyse pédagogique approfondie
def analyse_pedagogique(teachers_data):
    """Analyse détaillée des données pédagogiques"""
    if not teachers_data:
        return "Aucune donnée pédagogique disponible"
    
    rapport = []
    rapport.append("=== ANALYSE PÉDAGOGIQUE ===")
    
    # Statistiques générales
    total_lecons = sum(t.get('lessonCount', 0) for t in teachers_data)
    total_tp = sum(t.get('tpCount', 0) for t in teachers_data)
    total_ressources = sum(len(t.get('data', {}).get('resources', [])) for t in teachers_data)
    
    rapport.append(f"Leçons totales: {total_lecons}")
    rapport.append(f"TP total: {total_tp}")
    rapport.append(f"Ressources pédagogiques: {total_ressources}")
    
    # Analyse par matière
    matieres = {}
    for teacher in teachers_data:
        if teacher.get('data') and teacher['data'].get('subjects'):
            for subject in teacher['data']['subjects']:
                if subject.get('name'):
                    matiere = subject['name']
                    matieres[matiere] = matieres.get(matiere, 0) + 1
    
    rapport.append("")
    rapport.append("=== MATIÈRES LES PLUS ENSEIGNÉES ===")
    for matiere, count in sorted(matieres.items(), key=lambda x: x[1], reverse=True)[:10]:
        rapport.append(f"{matiere}: {count} enseignants")
    
    # Analyse des emplois du temps
    teachers_avec_edt = sum(1 for t in teachers_data if t.get('data', {}).get('timetable'))
    rapport.append("")
    rapport.append(f"Enseignants avec emploi du temps: {teachers_avec_edt} ({teachers_avec_edt/len(teachers_data)*100:.1f}%)")
    
    return "\\n".join(rapport)

print(analyse_pedagogique(teachers_data))`,

                'retirement': `# Analyse de la planification des retraites
def analyse_retraites(teachers_data):
    """Analyse des départs à la retraite"""
    rapport = []
    rapport.append("=== ANALYSE DES RETRAITES ===")
    
    # Enseignants avec date de retraite
    teachers_avec_date = []
    for teacher in teachers_data:
        if teacher.get('data') and teacher['data'].get('professional'):
            if teacher['data']['professional'].get('retirementDate'):
                teachers_avec_date.append(teacher)
    
    rapport.append(f"Enseignants avec date de retraite: {len(teachers_avec_date)}/{len(teachers_data)}")
    
    if not teachers_avec_date:
        return "\\n".join(rapport)
    
    # Calcul des années restantes
    import datetime
    aujourdhui = datetime.datetime.now()
    
    retraites_par_annee = {}
    urgence = {'< 1 an': 0, '1-3 ans': 0, '3-5 ans': 0, '> 5 ans': 0}
    
    for teacher in teachers_avec_date:
        date_retraite_str = teacher['data']['professional']['retirementDate']
        try:
            if 'T' in date_retraite_str:
                date_retraite = datetime.datetime.fromisoformat(date_retraite_str.replace('Z', '+00:00'))
            else:
                date_retraite = datetime.datetime.strptime(date_retraite_str, '%Y-%m-%d')
            
            annees_restantes = (date_retraite - aujourdhui).days / 365.25
            
            annee = date_retraite.year
            retraites_par_annee[annee] = retraites_par_annee.get(annee, 0) + 1
            
            if annees_restantes < 1:
                urgence['< 1 an'] += 1
            elif annees_restantes < 3:
                urgence['1-3 ans'] += 1
            elif annees_restantes < 5:
                urgence['3-5 ans'] += 1
            else:
                urgence['> 5 ans'] += 1
        except:
            continue
    
    rapport.append("")
    rapport.append("=== RÉPARTITION PAR URGENCE ===")
    for categorie, count in urgence.items():
        pourcentage = count / len(teachers_avec_date) * 100
        rapport.append(f"{categorie}: {count} ({pourcentage:.1f}%)")
    
    rapport.append("")
    rapport.append("=== RETRAITES PAR ANNÉE ===")
    for annee, count in sorted(retraites_par_annee.items()):
        rapport.append(f"{annee}: {count} retraites")
    
    return "\\n".join(rapport)

print(analyse_retraites(teachers_data))`,

                'training': `# Analyse des compétences et formations
def analyse_formations(teachers_data):
    """Analyse des données de formation"""
    rapport = []
    rapport.append("=== ANALYSE DES FORMATIONS ===")
    
    # Compilation des données
    total_diplomes = 0
    total_formations = 0
    total_langues = 0
    total_competences_it = 0
    
    niveaux_diplomes = {}
    types_formations = {}
    langues = {}
    competences_it = {}
    
    for teacher in teachers_data:
        if teacher.get('data'):
            # Diplômes
            if teacher['data'].get('diplomas'):
                total_diplomes += len(teacher['data']['diplomas'])
                for diplome in teacher['data']['diplomas']:
                    niveau = diplome.get('level', 'Non spécifié')
                    niveaux_diplomes[niveau] = niveaux_diplomes.get(niveau, 0) + 1
            
            # Formations continues
            if teacher['data'].get('trainings'):
                total_formations += len(teacher['data']['trainings'])
                for formation in teacher['data']['trainings']:
                    type_formation = formation.get('type', 'Non spécifié')
                    types_formations[type_formation] = types_formations.get(type_formation, 0) + 1
            
            # Langues
            if teacher['data'].get('languages'):
                total_langues += len(teacher['data']['languages'])
                for langue in teacher['data']['languages']:
                    nom_langue = langue.get('name', 'Non spécifié')
                    langues[nom_langue] = langues.get(nom_langue, 0) + 1
            
            # Compétences IT
            if teacher['data'].get('itskills'):
                total_competences_it += len(teacher['data']['itskills'])
                for competence in teacher['data']['itskills']:
                    categorie = competence.get('category', 'Non spécifié')
                    competences_it[categorie] = competences_it.get(categorie, 0) + 1
    
    rapport.append(f"Diplômes totaux: {total_diplomes}")
    rapport.append(f"Formations continues: {total_formations}")
    rapport.append(f"Langues déclarées: {total_langues}")
    rapport.append(f"Compétences IT: {total_competences_it}")
    
    rapport.append("")
    rapport.append("=== NIVEAUX DE DIPLÔMES ===")
    for niveau, count in sorted(niveaux_diplomes.items(), key=lambda x: x[1], reverse=True):
        rapport.append(f"{niveau}: {count}")
    
    rapport.append("")
    rapport.append("=== LANGUES LES PLUS COURANTES ===")
    for langue, count in sorted(langues.items(), key=lambda x: x[1], reverse=True)[:10]:
        rapport.append(f"{langue}: {count}")
    
    return "\\n".join(rapport)

print(analyse_formations(teachers_data))`,

                'export': `# Génération de rapport détaillé pour export
def generer_rapport_complet(teachers_data):
    """Génère un rapport complet pour export"""
    import datetime
    
    rapport = []
    rapport.append("=" * 60)
    rapport.append("RAPPORT COMPLET D'ANALYSE DES ENSEIGNANTS")
    rapport.append(f"Date de génération: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    rapport.append("=" * 60)
    rapport.append("")
    
    # 1. Statistiques générales
    rapport.append("1. STATISTIQUES GÉNÉRALES")
    rapport.append("-" * 40)
    rapport.append(f"Nombre total d'enseignants: {len(teachers_data)}")
    
    fiches_completes = sum(1 for t in teachers_data if t.get('complete', False))
    rapport.append(f"Fiches complètes: {fiches_completes} ({fiches_completes/len(teachers_data)*100:.1f}%)")
    
    # Calcul de l'âge moyen
    ages = [t.get('age') for t in teachers_data if t.get('age')]
    if ages:
        rapport.append(f"Âge moyen: {sum(ages)/len(ages):.1f} ans")
        rapport.append(f"Âge minimum: {min(ages)} ans")
        rapport.append(f"Âge maximum: {max(ages)} ans")
    
    # 2. Analyse par établissement
    rapport.append("")
    rapport.append("2. RÉPARTITION PAR ÉTABLISSEMENT")
    rapport.append("-" * 40)
    
    etablissements = {}
    for teacher in teachers_data:
        if teacher.get('data') and teacher['data'].get('establishment'):
            etab = teacher['data']['establishment'].get('name', 'Non spécifié')
            etablissements[etab] = etablissements.get(etab, 0) + 1
    
    for etab, count in sorted(etablissements.items(), key=lambda x: x[1], reverse=True):
        pourcentage = count / len(teachers_data) * 100
        rapport.append(f"{etab}: {count} enseignants ({pourcentage:.1f}%)")
    
    # 3. Analyse pédagogique
    rapport.append("")
    rapport.append("3. ANALYSE PÉDAGOGIQUE")
    rapport.append("-" * 40)
    
    total_lecons = sum(t.get('lessonCount', 0) for t in teachers_data)
    total_tp = sum(t.get('tpCount', 0) for t in teachers_data)
    
    rapport.append(f"Leçons totales enregistrées: {total_lecons}")
    rapport.append(f"Travaux pratiques total: {total_tp}")
    rapport.append(f"Moyenne leçons/enseignant: {total_lecons/len(teachers_data):.1f}")
    
    # 4. Planification retraite
    rapport.append("")
    rapport.append("4. PLANIFICATION DES RETRAITES")
    rapport.append("-" * 40)
    
    teachers_avec_retraite = sum(1 for t in teachers_data 
                                if t.get('data') and t['data'].get('professional') 
                                and t['data']['professional'].get('retirementDate'))
    
    rapport.append(f"Enseignants avec date de retraite: {teachers_avec_retraite}/{len(teachers_data)}")
    
    # 5. Recommandations
    rapport.append("")
    rapport.append("5. RECOMMANDATIONS")
    rapport.append("-" * 40)
    
    if fiches_completes / len(teachers_data) < 0.7:
        rapport.append("⚠️  Priorité: Améliorer le taux de complétion des fiches")
    
    if teachers_avec_retraite / len(teachers_data) < 0.5:
        rapport.append("⚠️  Priorité: Compléter les dates de retraite")
    
    taux_lecons = total_lecons / len(teachers_data)
    if taux_lecons < 10:
        rapport.append("⚠️  Observation: Faible nombre de leçons enregistrées")
    
    rapport.append("")
    rapport.append("=" * 60)
    rapport.append("FIN DU RAPPORT")
    rapport.append("=" * 60)
    
    return "\\n".join(rapport)

# Génération et affichage du rapport
print(generer_rapport_complet(teachers_data))`
            };
            
            const editor = document.getElementById('pythonEditor');
            if (templates[templateName]) {
                editor.value = templates[templateName];
                showNotification(`Modèle "${templateName}" chargé`, 'success');
            } else {
                showNotification('Modèle non trouvé', 'warning');
            }
        }

        // Sauvegarder le script Python
        function savePythonScript() {
            const pythonCode = document.getElementById('pythonEditor').value;
            if (!pythonCode.trim()) {
                showNotification('Aucun code à sauvegarder', 'warning');
                return;
            }
            
            const blob = new Blob([pythonCode], { type: 'text/x-python' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analyse_enseignants_${new Date().toISOString().split('T')[0]}.py`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Script Python sauvegardé', 'success');
        }

        // Effacer la sortie Python
        function clearPythonOutput() {
            document.getElementById('pythonOutput').innerHTML = 'Sortie Python s\'affichera ici...';
        }

        // Mettre à jour les statistiques Python
        function updatePythonStats() {
            if (!teachersData || teachersData.length === 0) {
                document.getElementById('pythonTeacherCount').textContent = '0';
                document.getElementById('pythonCompleteCount').textContent = '0';
                document.getElementById('pythonSubjectsCount').textContent = '0';
                document.getElementById('pythonEstablishmentsCount').textContent = '0';
                return;
            }
            
            const totalTeachers = teachersData.length;
            const completeTeachers = teachersData.filter(t => t.complete).length;
            
            // Compter les matières uniques
            const subjectSet = new Set();
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.subjects) {
                    teacher.data.subjects.forEach(subject => {
                        if (subject && subject.name) subjectSet.add(subject.name);
                    });
                }
            });
            
            // Compter les établissements uniques
            const establishmentSet = new Set();
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.establishment && teacher.data.establishment.name) {
                    establishmentSet.add(teacher.data.establishment.name);
                }
            });
            
            document.getElementById('pythonTeacherCount').textContent = totalTeachers;
            document.getElementById('pythonCompleteCount').textContent = completeTeachers;
            document.getElementById('pythonSubjectsCount').textContent = subjectSet.size;
            document.getElementById('pythonEstablishmentsCount').textContent = establishmentSet.size;
        }

        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
        }

        function initSubTabs() {
            const subTabs = document.querySelectorAll('.sub-tab');
            subTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const subtabId = this.getAttribute('data-subtab');
                    switchSubTab(subtabId);
                });
            });
        }

        function initFileTypeTabs() {
            const fileTypeTabs = document.querySelectorAll('.file-type-tab');
            fileTypeTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const fileType = this.getAttribute('data-file-type');
                    switchFileTypeTab(fileType);
                });
            });
        }

        function initButtons() {
            // Boutons d'importation
            document.getElementById('singleFileBtn').addEventListener('click', function() {
                document.getElementById('singleFileInput').click();
            });
            
            document.getElementById('multiFileBtn').addEventListener('click', function() {
                document.getElementById('multiFileInput').click();
            });
            
            document.getElementById('completeFileBtn').addEventListener('click', function() {
                document.getElementById('completeFileInput').click();
            });
            
            // Gestion des inputs de fichiers
            document.getElementById('singleFileInput').addEventListener('change', handleSingleFileImport);
            document.getElementById('multiFileInput').addEventListener('change', handleMultiFileImport);
            document.getElementById('completeFileInput').addEventListener('change', handleCompleteFileImport);
        }

        function switchTab(tabId) {
            // Désactiver tous les onglets
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Activer l'onglet sélectionné
            const tabElement = document.querySelector(`[data-tab="${tabId}"]`);
            const tabContent = document.getElementById(tabId);
            
            if (tabElement) tabElement.classList.add('active');
            if (tabContent) tabContent.classList.add('active');
            
            // Mettre à jour l'interface spécifique
            updateTabUI(tabId);
        }

        function switchSubTab(subtabId) {
            // Désactiver tous les sous-onglets
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
            
            // Activer le sous-onglet sélectionné
            const subTabElement = document.querySelector(`.sub-tab[data-subtab="${subtabId}"]`);
            const subTabContent = document.querySelector(`.sub-tab-content[data-subtab="${subtabId}"]`);
            
            if (subTabElement) subTabElement.classList.add('active');
            if (subTabContent) subTabContent.classList.add('active');
            
            // Mettre à jour le contenu spécifique
            updateSubTabUI(subtabId);
        }

        function switchFileTypeTab(fileType) {
            // Désactiver tous les onglets de type de fichier
            document.querySelectorAll('.file-type-tab').forEach(t => t.classList.remove('active'));
            
            // Activer l'onglet sélectionné
            const tabElement = document.querySelector(`[data-file-type="${fileType}"]`);
            if (tabElement) tabElement.classList.add('active');
            
            currentFileType = fileType;
        }

        function initEvents() {
            // Recherche
            const dashboardSearch = document.getElementById('dashboardSearch');
            if (dashboardSearch) {
                dashboardSearch.addEventListener('input', filterDashboard);
            }
            
            const teacherSearch = document.getElementById('teacherSearch');
            if (teacherSearch) {
                teacherSearch.addEventListener('input', filterTeachers);
            }
            
            // Prévisualisation des données
            const dataPreviewSelect = document.getElementById('dataPreviewSelect');
            if (dataPreviewSelect) {
                dataPreviewSelect.addEventListener('change', function() {
                    previewTeacherData(this.value);
                });
            }
            
            // Filtres dashboard
            const subjectFilter = document.getElementById('dashboardFilterSubject');
            const categoryFilter = document.getElementById('dashboardFilterCategory');
            const establishmentFilter = document.getElementById('dashboardFilterEstablishment');
            
            if (subjectFilter) subjectFilter.addEventListener('change', filterDashboard);
            if (categoryFilter) categoryFilter.addEventListener('change', filterDashboard);
            if (establishmentFilter) establishmentFilter.addEventListener('change', filterDashboard);
        }

        function initFilterLists() {
            updateFilterOptions();
        }

        function updateFilterOptions() {
            // Sujets uniques
            const subjectSet = new Set();
            // Catégories uniques
            const categorySet = new Set();
            // Établissements uniques
            const establishmentSet = new Set();

            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.subjects) {
                    teacher.data.subjects.forEach(subject => {
                        if (subject && subject.name) subjectSet.add(subject.name);
                    });
                }
                if (teacher.data && teacher.data.professional && teacher.data.professional.professionalCategory) {
                    categorySet.add(teacher.data.professional.professionalCategory);
                }
                if (teacher.data && teacher.data.establishment && teacher.data.establishment.name) {
                    establishmentSet.add(teacher.data.establishment.name);
                }
            });

            // Mettre à jour les filtres du dashboard
            updateSelectOptions('dashboardFilterSubject', Array.from(subjectSet));
            updateSelectOptions('dashboardFilterCategory', Array.from(categorySet));
            updateSelectOptions('dashboardFilterEstablishment', Array.from(establishmentSet));

            // Mettre à jour les filtres d'export
            updateSelectOptions('exportFilterSubject', Array.from(subjectSet));
            updateSelectOptions('exportFilterCategory', Array.from(categorySet));
            updateSelectOptions('exportFilterEstablishment', Array.from(establishmentSet));
        }

        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;

            // Sauvegarder la valeur sélectionnée
            const currentValue = select.value;
            
            // Conserver le premier option (Tous/Toutes)
            const firstOption = select.options[0];
            select.innerHTML = '';
            select.appendChild(firstOption);

            // Ajouter les nouvelles options
            options.sort().forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });

            // Restaurer la valeur sélectionnée si elle existe toujours
            if (options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Gestion de l'importation
        function handleSingleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoader(true);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const fileType = detectFileTypeFromContent(data, file.name);
                    const teacherInfo = extractTeacherInfo(data);
                    
                    // Vérifier si l'enseignant existe déjà
                    let teacherIndex = findTeacherIndex(teacherInfo);
                    
                    if (teacherIndex === -1) {
                        // Créer un nouvel enseignant
                        const newTeacher = createNewTeacher(teacherInfo, file, data, fileType);
                        teachersData.push(newTeacher);
                        teacherIndex = teachersData.length - 1;
                    } else {
                        // Ajouter le fichier à l'enseignant existant
                        addFileToTeacher(teacherIndex, file, data, fileType);
                    }
                    
                    // Mettre à jour l'interface
                    updateUIAfterImport();
                    showNotification(`Fichier ${file.name} importé avec succès (${FILE_TYPES[fileType]?.name || fileType})`, 'success');
                    
                } catch (error) {
                    showNotification('Erreur lors de l\'importation du fichier', 'error');
                    console.error('Erreur d\'importation:', error);
                } finally {
                    showLoader(false);
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function handleMultiFileImport(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            showLoader(true);
            let importedCount = 0;
            const totalFiles = files.length;
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        const fileType = detectFileTypeFromContent(data, file.name);
                        const teacherInfo = extractTeacherInfo(data);
                        
                        let teacherIndex = findTeacherIndex(teacherInfo);
                        
                        if (teacherIndex === -1) {
                            const newTeacher = createNewTeacher(teacherInfo, file, data, fileType);
                            teachersData.push(newTeacher);
                        } else {
                            addFileToTeacher(teacherIndex, file, data, fileType);
                        }
                        
                        importedCount++;
                        
                        if (importedCount === totalFiles) {
                            updateUIAfterImport();
                            showNotification(`${files.length} fichiers importés avec succès`, 'success');
                            showLoader(false);
                        }
                        
                    } catch (error) {
                        console.error(`Erreur avec le fichier ${file.name}:`, error);
                        importedCount++;
                        
                        if (importedCount === totalFiles) {
                            updateUIAfterImport();
                            showNotification('Importation terminée avec quelques erreurs', 'warning');
                            showLoader(false);
                        }
                    }
                };
                reader.readAsText(file);
            });
            
            // Réinitialiser l'input
            event.target.value = '';
        }

        function handleCompleteFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoader(true);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const teacherInfo = extractTeacherInfo(data);
                    
                    // Créer un enseignant avec toutes les données
                    const newTeacher = {
                        id: Date.now(),
                        ...teacherInfo,
                        files: [{
                            name: file.name,
                            type: 'complete',
                            data: data,
                            importDate: new Date().toISOString()
                        }],
                        complete: true,
                        data: data
                    };
                    
                    // Calculer les statistiques
                    calculateTeacherStatistics(newTeacher);
                    
                    teachersData.push(newTeacher);
                    
                    // Mettre à jour l'interface
                    updateUIAfterImport();
                    showNotification(`Fichier complet importé avec succès`, 'success');
                    
                } catch (error) {
                    showNotification('Erreur lors de l\'importation du fichier complet', 'error');
                    console.error(error);
                } finally {
                    showLoader(false);
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function detectFileTypeFromContent(data, fileName) {
            // Essayer de détecter le type à partir du contenu
            if (fileName.includes('tab1') || fileName.includes('informations')) return 'tab1';
            if (fileName.includes('tab2') || fileName.includes('enseignement') || fileName.includes('pédagogie')) return 'tab2';
            if (fileName.includes('tab3') || fileName.includes('formation')) return 'tab3';
            if (fileName.includes('tab4') || fileName.includes('évaluation')) return 'tab4';
            if (fileName.includes('tab5') || fileName.includes('projet')) return 'tab5';
            if (fileName.includes('tab6') || fileName.includes('données')) return 'tab6';
            if (fileName.includes('tab7') || fileName.includes('dashboard')) return 'tab7';
            if (fileName.includes('complete')) return 'complete';
            
            // Détection basée sur la structure des données
            if (data.establishment && data.personal && data.professional) return 'tab1';
            if (data.themes || data.lessons || data.tps || data.timetable) return 'tab2';
            if (data.diplomas || data.trainings || data.languages || data.itskills) return 'tab3';
            if (data.evaluations || data.statistics) return 'tab4';
            if (data.projects || data.activities || data.meetings) return 'tab5';
            if (data.backups || data.logs) return 'tab6';
            if (data.dashboard || data.summary) return 'tab7';
            
            return 'unknown';
        }

        function extractTeacherInfo(data) {
            let lastName = '';
            let firstName = '';
            let matricule = '';
            let establishment = '';
            
            // Essayer différentes structures de données
            if (data.personal) {
                lastName = data.personal.lastName || '';
                firstName = data.personal.firstName || '';
                matricule = data.professional?.matricule || '';
                establishment = data.establishment?.name || '';
            } else if (data.lastName) {
                lastName = data.lastName;
                firstName = data.firstName || '';
            } else if (data.teacher) {
                lastName = data.teacher.lastName || '';
                firstName = data.teacher.firstName || '';
            }
            
            // Si pas de nom, utiliser des valeurs par défaut
            if (!lastName) {
                lastName = 'Enseignant';
                firstName = 'Non spécifié';
            }
            
            return {
                lastName,
                firstName,
                matricule,
                establishment,
                fullName: `${lastName} ${firstName}`.trim()
            };
        }

        function findTeacherIndex(teacherInfo) {
            return teachersData.findIndex(t => 
                t.lastName === teacherInfo.lastName && 
                t.firstName === teacherInfo.firstName
            );
        }

        function createNewTeacher(teacherInfo, file, data, fileType) {
            const newTeacher = {
                id: Date.now(),
                ...teacherInfo,
                files: [{
                    name: file.name,
                    type: fileType,
                    data: data,
                    importDate: new Date().toISOString()
                }],
                complete: false
            };
            
            // Traiter les données selon le type
            processTeacherData(newTeacher, data, fileType);
            
            return newTeacher;
        }

        function addFileToTeacher(teacherIndex, file, data, fileType) {
            const teacher = teachersData[teacherIndex];
            
            // Vérifier si ce type de fichier existe déjà
            const existingFileIndex = teacher.files.findIndex(f => f.type === fileType);
            
            if (existingFileIndex === -1) {
                // Ajouter le nouveau fichier
                teacher.files.push({
                    name: file.name,
                    type: fileType,
                    data: data,
                    importDate: new Date().toISOString()
                });
            } else {
                // Mettre à jour le fichier existant
                teacher.files[existingFileIndex] = {
                    name: file.name,
                    type: fileType,
                    data: data,
                    importDate: new Date().toISOString()
                };
            }
            
            // Traiter les données
            processTeacherData(teacher, data, fileType);
            
            // Vérifier la complétude
            checkTeacherCompleteness(teacherIndex);
        }

        function processTeacherData(teacher, data, fileType) {
            // Initialiser l'objet data si nécessaire
            if (!teacher.data) {
                teacher.data = {};
            }
            
            // Fusionner les données selon le type
            switch(fileType) {
                case 'tab1':
                    teacher.data.establishment = data.establishment || {};
                    teacher.data.personal = data.personal || {};
                    teacher.data.professional = data.professional || {};
                    teacher.data.subjects = data.subjects || [];
                    break;
                    
                case 'tab2':
                    // Gestion des sous-onglets de tab2
                    if (data.timetable) teacher.data.timetable = data.timetable;
                    if (data.themes) teacher.data.themes = data.themes;
                    if (data.lessons) teacher.data.lessons = data.lessons;
                    if (data.tps) teacher.data.tps = data.tps;
                    if (data.resources) teacher.data.resources = data.resources;
                    break;
                    
                case 'tab3':
                    teacher.data.diplomas = data.diplomas || [];
                    teacher.data.trainings = data.trainings || [];
                    teacher.data.languages = data.languages || [];
                    teacher.data.itskills = data.itskills || [];
                    break;
                    
                case 'tab4':
                    teacher.data.evaluations = data.evaluations || [];
                    teacher.data.statistics = data.statistics || {};
                    break;
                    
                case 'tab5':
                    teacher.data.projects = data.projects || [];
                    teacher.data.activities = data.activities || [];
                    teacher.data.meetings = data.meetings || [];
                    break;
                    
                case 'complete':
                    // Fusionner toutes les données
                    Object.assign(teacher.data, data);
                    break;
            }
            
            // Recalculer les statistiques
            calculateTeacherStatistics(teacher);
        }

        function checkTeacherCompleteness(teacherIndex) {
            const teacher = teachersData[teacherIndex];
            if (!teacher) return;
            
            const fileTypes = teacher.files.map(f => f.type);
            const requiredTypes = ['tab1', 'tab2', 'tab3'];
            const hasAllRequired = requiredTypes.every(type => fileTypes.includes(type));
            
            teacher.complete = hasAllRequired;
            
            if (teacher.complete) {
                showNotification(`${teacher.fullName} - Fiche maintenant complète`, 'success');
            }
        }

        function calculateTeacherStatistics(teacher) {
            if (!teacher.data) return;
            
            // Âge
            if (teacher.data.personal && teacher.data.personal.birthDate) {
                teacher.age = calculateAge(teacher.data.personal.birthDate);
            }
            
            // Années de service
            if (teacher.data.professional && teacher.data.professional.engagementDate) {
                teacher.serviceYears = calculateServiceYears(teacher.data.professional.engagementDate);
            }
            
            // Années avant retraite
            if (teacher.data.professional && teacher.data.professional.retirementDate) {
                teacher.yearsToRetirement = calculateYearsToDate(teacher.data.professional.retirementDate);
            }
            
            // Nombre de matières
            if (teacher.data.subjects) {
                teacher.subjectCount = teacher.data.subjects.length;
            }
            
            // Nombre de leçons
            if (teacher.data.lessons) {
                teacher.lessonCount = teacher.data.lessons.length;
            }
            
            // Nombre de TP
            if (teacher.data.tps) {
                teacher.tpCount = teacher.data.tps.length;
            }
            
            // Nombre d'évaluations
            if (teacher.data.evaluations) {
                teacher.evaluationCount = teacher.data.evaluations.length;
            }
            
            // Nombre de projets
            if (teacher.data.projects) {
                teacher.projectCount = teacher.data.projects.length;
            }
            
            // Nombre de formations
            if (teacher.data.trainings) {
                teacher.trainingCount = teacher.data.trainings.length;
            }
        }

        function calculateAge(birthDate) {
            if (!birthDate) return null;
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        function calculateServiceYears(startDate) {
            if (!startDate) return null;
            const start = new Date(startDate);
            const today = new Date();
            let years = today.getFullYear() - start.getFullYear();
            const monthDiff = today.getMonth() - start.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < start.getDate())) {
                years--;
            }
            
            return Math.max(years, 0);
        }

        function calculateYearsToDate(futureDate) {
            if (!futureDate) return null;
            const future = new Date(futureDate);
            const today = new Date();
            let years = future.getFullYear() - today.getFullYear();
            const monthDiff = future.getMonth() - today.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && future.getDate() < today.getDate())) {
                years--;
            }
            
            return Math.max(years, 0);
        }

        function updateUIAfterImport() {
            updateImportedFilesList();
            updateOverview();
            updateDataPreviewSelect();
            updateDashboard();
            updateTeachersList();
            updatePythonStats();
            updateFilterOptions();
            updateExportPreview();
        }

        function updateImportedFilesList() {
            const container = document.getElementById('importedFilesList');
            const section = document.getElementById('importedFilesSection');
            
            if (!container || !section) return;
            
            if (teachersData.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            // Grouper les fichiers par type
            const filesByType = {};
            Object.keys(FILE_TYPES).forEach(type => {
                filesByType[type] = [];
            });
            
            teachersData.forEach(teacher => {
                teacher.files.forEach(file => {
                    if (filesByType[file.type]) {
                        filesByType[file.type].push({
                            teacher: teacher.fullName,
                            fileName: file.name,
                            date: file.importDate
                        });
                    }
                });
            });
            
            let html = '';
            
            Object.keys(FILE_TYPES).forEach(type => {
                const files = filesByType[type];
                if (files.length > 0) {
                    html += `
                        <div class="file-type-group">
                            <h4><i class="fas ${FILE_TYPES[type].icon}"></i> ${FILE_TYPES[type].name} (${files.length})</h4>
                            <div class="file-list">
                    `;
                    
                    files.forEach(file => {
                        const date = new Date(file.date).toLocaleDateString();
                        html += `
                            <div class="file-item">
                                <span><strong>${file.teacher}</strong> - ${file.fileName}</span>
                                <span class="badge badge-primary">${date}</span>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }

        function updateOverview() {
            const container = document.getElementById('overviewStats');
            const section = document.getElementById('overviewSection');
            
            if (!container || !section) return;
            
            if (teachersData.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            const totalTeachers = teachersData.length;
            const completeTeachers = teachersData.filter(t => t.complete).length;
            const totalFiles = teachersData.reduce((sum, t) => sum + t.files.length, 0);
            
            const subjectSet = new Set();
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.subjects) {
                    teacher.data.subjects.forEach(subject => {
                        if (subject && subject.name) subjectSet.add(subject.name);
                    });
                }
            });
            
            const uniqueSubjects = subjectSet.size;
            
            const html = `
                <div class="stat-card">
                    <div><i class="fas fa-users"></i> Enseignants</div>
                    <div class="stat-value">${totalTeachers}</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-check-circle"></i> Fiches complètes</div>
                    <div class="stat-value">${completeTeachers}</div>
                    <div>${Math.round((completeTeachers / totalTeachers) * 100)}%</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-file"></i> Fichiers</div>
                    <div class="stat-value">${totalFiles}</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-book"></i> Matières</div>
                    <div class="stat-value">${uniqueSubjects}</div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function updateDataPreviewSelect() {
            const container = document.getElementById('dataPreviewSelect');
            const section = document.getElementById('dataPreviewSection');
            
            if (!container || !section) return;
            
            if (teachersData.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            let html = '<option value="">Sélectionner un enseignant...</option>';
            
            teachersData.forEach((teacher, index) => {
                const fileTypes = teacher.files.map(f => FILE_TYPES[f.type]?.name || f.type).join(', ');
                html += `<option value="${index}">${teacher.fullName} - ${teacher.files.length} fichiers (${fileTypes})</option>`;
            });
            
            container.innerHTML = html;
        }

        function previewTeacherData(teacherIndex) {
            const container = document.getElementById('dataPreviewContent');
            if (!container) return;
            
            if (!teacherIndex) {
                container.innerHTML = '<p class="text-center">Sélectionnez un enseignant</p>';
                return;
            }
            
            const teacher = teachersData[teacherIndex];
            if (!teacher) return;
            
            let html = `
                <h4>${teacher.fullName}</h4>
                <div class="files-by-type">
            `;
            
            // Afficher les données par type de fichier
            teacher.files.forEach(file => {
                const fileTypeInfo = FILE_TYPES[file.type] || { name: file.type, icon: 'fa-file' };
                
                html += `
                    <div class="file-type-group">
                        <h5><i class="fas ${fileTypeInfo.icon}"></i> ${fileTypeInfo.name}</h5>
                        <div class="data-preview">
                `;
                
                // Afficher un aperçu des données
                const previewData = getDataPreview(file.data, file.type);
                html += JSON.stringify(previewData, null, 2);
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function getDataPreview(data, type) {
            // Créer un aperçu limité des données
            const preview = {};
            
            switch(type) {
                case 'tab1':
                    preview.establishment = data.establishment?.name || 'Non spécifié';
                    preview.personal = {
                        nom: data.personal?.lastName,
                        prenom: data.personal?.firstName,
                        age: calculateAge(data.personal?.birthDate)
                    };
                    preview.professional = {
                        matricule: data.professional?.matricule,
                        fonction: data.professional?.position,
                        categorie: data.professional?.professionalCategory
                    };
                    preview.subjects = data.subjects?.length || 0;
                    break;
                    
                case 'tab2':
                    preview.timetable = data.timetable ? 'Disponible' : 'Non disponible';
                    preview.themes = data.themes ? Object.keys(data.themes).length + ' thèmes' : 'Non disponible';
                    preview.lessons = data.lessons?.length || 0;
                    preview.tps = data.tps?.length || 0;
                    preview.resources = data.resources?.length || 0;
                    break;
                    
                case 'tab3':
                    preview.diplomas = data.diplomas?.length || 0;
                    preview.trainings = data.trainings?.length || 0;
                    preview.languages = data.languages?.length || 0;
                    preview.itskills = data.itskills?.length || 0;
                    break;
                    
                case 'tab4':
                    preview.evaluations = data.evaluations?.length || 0;
                    preview.statistics = data.statistics || 'Non disponible';
                    break;
                    
                case 'tab5':
                    preview.projects = data.projects?.length || 0;
                    preview.activities = data.activities?.length || 0;
                    preview.meetings = data.meetings?.length || 0;
                    break;
                    
                default:
                    preview.type = type;
                    preview.keys = Object.keys(data).slice(0, 5);
            }
            
            return preview;
        }

        function updateTabUI(tabId) {
            switch(tabId) {
                case 'tab-python':
                    updatePythonStats();
                    break;
                case 'tab-dashboard':
                    updateDashboard();
                    break;
                case 'tab-teachers':
                    updateTeachersList();
                    break;
                case 'tab-pedagogy':
                    updatePedagogyAnalysis();
                    break;
                case 'tab-training':
                    updateTrainingAnalysis();
                    break;
                case 'tab-projects':
                    updateProjectsAnalysis();
                    break;
                case 'tab-retirement':
                    updateRetirementAnalysis();
                    break;
                case 'tab-export':
                    updateExportPreview();
                    break;
            }
        }

        function updateDashboard() {
            if (teachersData.length === 0) {
                document.getElementById('globalStats').innerHTML = '<p class="text-center">Aucune donnée disponible</p>';
                return;
            }
            
            // Calculer les statistiques globales
            const totalTeachers = teachersData.length;
            const completeTeachers = teachersData.filter(t => t.complete).length;
            const totalSubjects = teachersData.reduce((sum, t) => sum + (t.subjectCount || 0), 0);
            const totalLessons = teachersData.reduce((sum, t) => sum + (t.lessonCount || 0), 0);
            const totalProjects = teachersData.reduce((sum, t) => sum + (t.projectCount || 0), 0);
            const totalTrainings = teachersData.reduce((sum, t) => sum + (t.trainingCount || 0), 0);
            
            // Mettre à jour les statistiques globales
            const globalStatsHTML = `
                <div class="stat-card">
                    <div>Enseignants</div>
                    <div class="stat-value">${totalTeachers}</div>
                </div>
                <div class="stat-card">
                    <div>Fiches complètes</div>
                    <div class="stat-value">${completeTeachers}</div>
                    <div>${Math.round((completeTeachers / totalTeachers) * 100)}%</div>
                </div>
                <div class="stat-card">
                    <div>Matières enseignées</div>
                    <div class="stat-value">${totalSubjects}</div>
                </div>
                <div class="stat-card">
                    <div>Leçons</div>
                    <div class="stat-value">${totalLessons}</div>
                </div>
                <div class="stat-card">
                    <div>Projets</div>
                    <div class="stat-value">${totalProjects}</div>
                </div>
                <div class="stat-card">
                    <div>Formations</div>
                    <div class="stat-value">${totalTrainings}</div>
                </div>
            `;
            
            document.getElementById('globalStats').innerHTML = globalStatsHTML;
            
            // Mettre à jour les graphiques
            updateCharts();
            
            // Mettre à jour les activités récentes
            updateRecentActivities();
        }

        function updateCharts() {
            // Graphique des matières
            updateSubjectChart();
            
            // Graphique des retraites
            updateRetirementChart();
            
            // Graphique des heures d'enseignement
            updateHoursChart();
            
            // Graphique de formation
            updateTrainingChart();
            
            // Graphique des retraites par année
            updateRetirementYearChart();
        }

        function updateSubjectChart() {
            const ctx = document.getElementById('subjectChart');
            if (!ctx) return;
            
            // Compter les matières
            const subjectCount = {};
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.subjects) {
                    teacher.data.subjects.forEach(subject => {
                        if (subject && subject.name) {
                            subjectCount[subject.name] = (subjectCount[subject.name] || 0) + 1;
                        }
                    });
                }
            });
            
            const labels = Object.keys(subjectCount).slice(0, 10);
            const data = labels.map(label => subjectCount[label]);
            
            if (charts.subjectChart) {
                charts.subjectChart.destroy();
            }
            
            charts.subjectChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6',
                            '#1abc9c', '#34495e', '#f1c40f', '#e67e22', '#95a5a6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        title: {
                            display: true,
                            text: 'Top 10 des matières enseignées'
                        }
                    }
                }
            });
        }

        function updateRetirementChart() {
            const ctx = document.getElementById('retirementChart');
            if (!ctx) return;
            
            // Compter les retraites par année
            const retirementByYear = {};
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.professional && teacher.data.professional.retirementDate) {
                    const year = new Date(teacher.data.professional.retirementDate).getFullYear();
                    retirementByYear[year] = (retirementByYear[year] || 0) + 1;
                }
            });
            
            const years = Object.keys(retirementByYear).sort();
            const counts = years.map(year => retirementByYear[year]);
            
            if (charts.retirementChart) {
                charts.retirementChart.destroy();
            }
            
            charts.retirementChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Nombre de retraites',
                        data: counts,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Évolution des départs à la retraite'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nombre de retraites'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Année'
                            }
                        }
                    }
                }
            });
        }

        function updateHoursChart() {
            const ctx = document.getElementById('hoursChart');
            if (!ctx) return;
            
            // Exemple de données d'heures d'enseignement
            // Dans une vraie application, vous récupéreriez ces données depuis vos fichiers
            const hoursData = teachersData.map(teacher => {
                // Simuler des heures d'enseignement basées sur le nombre de matières
                return (teacher.subjectCount || 1) * 15; // 15 heures par matière
            }).slice(0, 15);
            
            const teacherNames = teachersData.slice(0, 15).map(t => t.fullName);
            
            if (charts.hoursChart) {
                charts.hoursChart.destroy();
            }
            
            charts.hoursChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: teacherNames,
                    datasets: [{
                        label: 'Heures d\'enseignement (estimées)',
                        data: hoursData,
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Heures d\'enseignement par enseignant'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Heures par semaine'
                            }
                        }
                    }
                }
            });
        }

        function updateTrainingChart() {
            const ctx = document.getElementById('trainingChart');
            if (!ctx) return;
            
            // Compter les niveaux de formation
            const trainingLevels = {};
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.diplomas) {
                    teacher.data.diplomas.forEach(diploma => {
                        if (diploma.level) {
                            trainingLevels[diploma.level] = (trainingLevels[diploma.level] || 0) + 1;
                        }
                    });
                }
            });
            
            const labels = Object.keys(trainingLevels);
            const data = labels.map(label => trainingLevels[label]);
            
            if (charts.trainingChart) {
                charts.trainingChart.destroy();
            }
            
            charts.trainingChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6',
                            '#1abc9c', '#34495e'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Répartition par niveau de formation'
                        }
                    }
                }
            });
        }

        function updateRetirementYearChart() {
            const ctx = document.getElementById('retirementYearChart');
            if (!ctx) return;
            
            // Compter les retraites par année
            const retirementByYear = {};
            teachersData.forEach(teacher => {
                if (teacher.data && teacher.data.professional && teacher.data.professional.retirementDate) {
                    const year = new Date(teacher.data.professional.retirementDate).getFullYear();
                    retirementByYear[year] = (retirementByYear[year] || 0) + 1;
                }
            });
            
            const years = Object.keys(retirementByYear).sort();
            const counts = years.map(year => retirementByYear[year]);
            
            if (charts.retirementYearChart) {
                charts.retirementYearChart.destroy();
            }
            
            charts.retirementYearChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Nombre de retraites',
                        data: counts,
                        backgroundColor: '#e74c3c',
                        borderColor: '#c0392b',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Répartition des retraites par année'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nombre de retraites'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Année'
                            }
                        }
                    }
                }
            });
        }

        function updateRecentActivities() {
            const container = document.getElementById('recentActivities');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune activité récente</p>';
                return;
            }
            
            // Récupérer les activités récentes (dernières importations)
            const recentActivities = [];
            teachersData.forEach(teacher => {
                teacher.files.forEach(file => {
                    recentActivities.push({
                        teacher: teacher.fullName,
                        file: file.name,
                        type: FILE_TYPES[file.type]?.name || file.type,
                        date: new Date(file.importDate)
                    });
                });
            });
            
            // Trier par date (plus récent en premier)
            recentActivities.sort((a, b) => b.date - a.date);
            
            let html = '<div class="data-table">';
            html += `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Enseignant</th>
                            <th>Fichier</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            recentActivities.slice(0, 10).forEach(activity => {
                const dateStr = activity.date.toLocaleDateString() + ' ' + activity.date.toLocaleTimeString();
                html += `
                    <tr>
                        <td>${dateStr}</td>
                        <td>${activity.teacher}</td>
                        <td>${activity.file}</td>
                        <td><span class="badge badge-primary">${activity.type}</span></td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            </div>
            `;
            
            container.innerHTML = html;
        }

        function updateTeachersList() {
            const container = document.getElementById('teachersCards');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucun enseignant importé</p>';
                return;
            }
            
            // Filtrer et trier les enseignants
            let teachersToDisplay = [...teachersData];
            
            // Appliquer le filtre "fiches complètes"
            if (showCompleteOnly) {
                teachersToDisplay = teachersToDisplay.filter(t => t.complete);
            }
            
            // Appliquer le tri
            teachersToDisplay.sort((a, b) => {
                let aValue, bValue;
                
                switch(currentSort.field) {
                    case 'name':
                        aValue = a.lastName + a.firstName;
                        bValue = b.lastName + b.firstName;
                        break;
                    case 'retirement':
                        aValue = a.yearsToRetirement || 999;
                        bValue = b.yearsToRetirement || 999;
                        break;
                    default:
                        aValue = a.lastName;
                        bValue = b.lastName;
                }
                
                if (currentSort.direction === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });
            
            let html = '';
            
            teachersToDisplay.forEach((teacher, index) => {
                const establishment = teacher.data?.establishment?.name || 'Non spécifié';
                const matricule = teacher.data?.professional?.matricule || 'Non spécifié';
                const subjectCount = teacher.subjectCount || 0;
                const retirementYears = teacher.yearsToRetirement !== undefined ? teacher.yearsToRetirement : 'Non spécifié';
                
                html += `
                    <div class="teacher-card" onclick="showTeacherDetail(${index})">
                        <div class="teacher-header">
                            <div class="teacher-name">${teacher.fullName}</div>
                            <div class="teacher-matricule">${matricule}</div>
                        </div>
                        <div class="teacher-info">
                            <div class="teacher-info-item">
                                <i class="fas fa-school"></i>
                                <span>${establishment}</span>
                            </div>
                            <div class="teacher-info-item">
                                <i class="fas fa-book"></i>
                                <span>${subjectCount} matière(s)</span>
                            </div>
                            <div class="teacher-info-item">
                                <i class="fas ${teacher.complete ? 'fa-check-circle text-success' : 'fa-times-circle text-danger'}"></i>
                                <span>${teacher.complete ? 'Fiche complète' : 'Fiche incomplète'}</span>
                            </div>
                            <div class="teacher-info-item">
                                <i class="fas fa-umbrella-beach"></i>
                                <span>${retirementYears !== 'Non spécifié' ? retirementYears + ' an(s)' : 'Non spécifié'}</span>
                            </div>
                        </div>
                        <div class="mt-20">
                            <span class="badge ${teacher.complete ? 'badge-success' : 'badge-warning'}">
                                ${teacher.files.length} fichier(s)
                            </span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function sortTeachers(field) {
            if (currentSort.field === field) {
                // Inverser la direction
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // Nouveau champ, direction ascendante par défaut
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            updateTeachersList();
            
            // Mettre à jour le texte des boutons si nécessaire
            const buttons = document.querySelectorAll('#tab-teachers .btn-light');
            buttons.forEach(button => {
                if (button.textContent.includes('Trier par')) {
                    button.innerHTML = `<i class="fas fa-sort-${currentSort.direction === 'asc' ? 'alpha-down' : 'alpha-up'}"></i> Trier par ${field === 'name' ? 'nom' : 'retraite'}`;
                }
            });
        }

        function filterCompleteOnly() {
            showCompleteOnly = !showCompleteOnly;
            updateTeachersList();
            
            const button = document.querySelector('#tab-teachers .btn-light:nth-child(4)');
            if (button) {
                button.innerHTML = `<i class="fas fa-${showCompleteOnly ? 'check-square' : 'check-circle'}"></i> ${showCompleteOnly ? 'Toutes les fiches' : 'Fiches complètes'}`;
            }
        }

        function filterTeachers() {
            const searchTerm = document.getElementById('teacherSearch').value.toLowerCase();
            
            // Cette fonction est appelée à chaque frappe, mais updateTeachersList gère déjà le filtrage
            // via showCompleteOnly et currentSort. Pour une recherche textuelle plus avancée,
            // vous devriez ajouter une logique de filtrage supplémentaire ici.
            updateTeachersList();
        }

        function showTeacherDetail(teacherIndex) {
            const teacher = teachersData[teacherIndex];
            if (!teacher) return;
            
            document.getElementById('teacherModalTitle').textContent = `Détails - ${teacher.fullName}`;
            
            let html = `
                <div class="data-section">
                    <h3><i class="fas fa-info-circle"></i> Informations générales</h3>
                    <div class="teacher-info">
                        <div class="teacher-info-item">
                            <i class="fas fa-id-card"></i>
                            <span><strong>Matricule:</strong> ${teacher.data?.professional?.matricule || 'Non spécifié'}</span>
                        </div>
                        <div class="teacher-info-item">
                            <i class="fas fa-school"></i>
                            <span><strong>Établissement:</strong> ${teacher.data?.establishment?.name || 'Non spécifié'}</span>
                        </div>
                        <div class="teacher-info-item">
                            <i class="fas fa-user-tag"></i>
                            <span><strong>Catégorie:</strong> ${teacher.data?.professional?.professionalCategory || 'Non spécifié'}</span>
                        </div>
                        <div class="teacher-info-item">
                            <i class="fas fa-birthday-cake"></i>
                            <span><strong>Âge:</strong> ${teacher.age || 'Non spécifié'} ans</span>
                        </div>
                    </div>
                </div>
                
                <div class="data-section">
                    <h3><i class="fas fa-book"></i> Matières enseignées</h3>
                    <div>
            `;
            
            if (teacher.data?.subjects && teacher.data.subjects.length > 0) {
                teacher.data.subjects.forEach(subject => {
                    html += `<span class="badge badge-primary">${subject.name}</span> `;
                });
            } else {
                html += '<p>Aucune matière spécifiée</p>';
            }
            
            html += `
                    </div>
                </div>
                
                <div class="data-section">
                    <h3><i class="fas fa-file"></i> Fichiers importés</h3>
                    <div class="file-list">
            `;
            
            teacher.files.forEach(file => {
                const fileTypeInfo = FILE_TYPES[file.type] || { name: file.type, icon: 'fa-file' };
                const date = new Date(file.importDate).toLocaleDateString();
                
                html += `
                    <div class="file-item">
                        <span><i class="fas ${fileTypeInfo.icon}"></i> ${fileTypeInfo.name}</span>
                        <span>${file.name} <span class="badge badge-info">${date}</span></span>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <div class="data-section">
                    <h3><i class="fas fa-chart-bar"></i> Statistiques</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div>Années de service</div>
                            <div class="stat-value">${teacher.serviceYears || '0'}</div>
                        </div>
                        <div class="stat-card">
                            <div>Leçons</div>
                            <div class="stat-value">${teacher.lessonCount || '0'}</div>
                        </div>
                        <div class="stat-card">
                            <div>Projets</div>
                            <div class="stat-value">${teacher.projectCount || '0'}</div>
                        </div>
                        <div class="stat-card">
                            <div>Formations</div>
                            <div class="stat-value">${teacher.trainingCount || '0'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('teacherModalContent').innerHTML = html;
            document.getElementById('teacherDetailModal').classList.add('active');
        }

        function closeTeacherDetail() {
            document.getElementById('teacherDetailModal').classList.remove('active');
        }

        function filterDashboard() {
            // Cette fonction est appelée lorsque les filtres du dashboard changent
            // Pour l'instant, nous mettons simplement à jour le dashboard
            updateDashboard();
        }

        function updatePedagogyAnalysis() {
            // Cette fonction met à jour l'analyse pédagogique
            // Pour l'instant, nous affichons simplement un message
            const subtab = document.querySelector('.sub-tab.active[data-subtab]');
            const subtabId = subtab ? subtab.getAttribute('data-subtab') : 'pedagogy-overview';
            
            switch(subtabId) {
                case 'pedagogy-overview':
                    document.getElementById('pedagogyStats').innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div>Leçons totales</div>
                                <div class="stat-value">${teachersData.reduce((sum, t) => sum + (t.lessonCount || 0), 0)}</div>
                            </div>
                            <div class="stat-card">
                                <div>TP total</div>
                                <div class="stat-value">${teachersData.reduce((sum, t) => sum + (t.tpCount || 0), 0)}</div>
                            </div>
                            <div class="stat-card">
                                <div>Matières uniques</div>
                                <div class="stat-value">${new Set(teachersData.flatMap(t => t.data?.subjects?.map(s => s.name) || [])).size}</div>
                            </div>
                            <div class="stat-card">
                                <div>Ressources</div>
                                <div class="stat-value">${teachersData.reduce((sum, t) => sum + (t.data?.resources?.length || 0), 0)}</div>
                            </div>
                        </div>
                    `;
                    break;
                default:
                    document.getElementById(subtabId.replace('pedagogy-', '') + 'Analysis').innerHTML = 
                        `<p class="text-center">Analyse ${subtabId.replace('pedagogy-', '')} - Données disponibles: ${teachersData.length} enseignants</p>`;
            }
        }

        function updateTrainingAnalysis() {
            // Similaire à updatePedagogyAnalysis mais pour la formation
            const subtab = document.querySelector('.sub-tab.active[data-subtab]');
            const subtabId = subtab ? subtab.getAttribute('data-subtab') : 'training-overview';
            
            switch(subtabId) {
                case 'training-overview':
                    document.getElementById('trainingStats').innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div>Diplômes</div>
                                <div class="stat-value">${teachersData.reduce((sum, t) => sum + (t.data?.diplomas?.length || 0), 0)}</div>
                            </div>
                            <div class="stat-card">
                                <div>Formations continues</div>
                                <div class="stat-value">${teachersData.reduce((sum, t) => sum + (t.trainingCount || 0), 0)}</div>
                            </div>
                            <div class="stat-card">
                                <div>Langues</div>
                                <div class="stat-value">${teachersData.reduce((sum, t) => sum + (t.data?.languages?.length || 0), 0)}</div>
                            </div>
                            <div class="stat-card">
                                <div>Compétences IT</div>
                                <div class="stat-value">${teachersData.reduce((sum, t) => sum + (t.data?.itskills?.length || 0), 0)}</div>
                            </div>
                        </div>
                    `;
                    break;
                default:
                    document.getElementById(subtabId.replace('training-', '') + 'Analysis').innerHTML = 
                        `<p class="text-center">Analyse ${subtabId.replace('training-', '')} - Données disponibles: ${teachersData.length} enseignants</p>`;
            }
        }

        function updateProjectsAnalysis() {
            // Similaire aux autres analyses mais pour les projets
            const subtab = document.querySelector('.sub-tab.active[data-subtab]');
            const subtabId = subtab ? subtab.getAttribute('data-subtab') : 'projects-overview';
            
            switch(subtabId) {
                case 'projects-overview':
                    document.getElementById('projectsStats').innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div>Projets pédagogiques</div>
                                <div class="stat-value">${teachersData.reduce((sum, t) => sum + (t.projectCount || 0), 0)}</div>
                            </div>
                            <div class="stat-card">
                                <div>Activités extrascolaires</div>
                                <div class="stat-value">${teachersData.reduce((sum, t) => sum + (t.data?.activities?.length || 0), 0)}</div>
                            </div>
                            <div class="stat-card">
                                <div>Réunions</div>
                                <div class="stat-value">${teachersData.reduce((sum, t) => sum + (t.data?.meetings?.length || 0), 0)}</div>
                            </div>
                        </div>
                    `;
                    break;
                default:
                    document.getElementById(subtabId.replace('projects-', '') + 'Analysis').innerHTML = 
                        `<p class="text-center">Analyse ${subtabId.replace('projects-', '')} - Données disponibles: ${teachersData.length} enseignants</p>`;
            }
        }

        function updateRetirementAnalysis() {
            // Calculer les statistiques de retraite
            const teachersWithRetirement = teachersData.filter(t => t.data?.professional?.retirementDate);
            const totalTeachers = teachersData.length;
            
            // Mettre à jour le tableau des prochaines retraites
            updateUpcomingRetirements();
            
            // Mettre à jour l'analyse par catégorie
            const analysisHTML = `
                <div class="stat-card">
                    <div>Avec date de retraite</div>
                    <div class="stat-value">${teachersWithRetirement.length}</div>
                    <div>${Math.round((teachersWithRetirement.length / totalTeachers) * 100)}%</div>
                </div>
                <div class="stat-card">
                    <div>Sans date de retraite</div>
                    <div class="stat-value">${totalTeachers - teachersWithRetirement.length}</div>
                    <div>${Math.round(((totalTeachers - teachersWithRetirement.length) / totalTeachers) * 100)}%</div>
                </div>
                <div class="stat-card">
                    <div>Moyenne d'âge</div>
                    <div class="stat-value">${Math.round(teachersData.reduce((sum, t) => sum + (t.age || 0), 0) / teachersData.filter(t => t.age).length) || 0}</div>
                </div>
                <div class="stat-card">
                    <div>Service moyen (ans)</div>
                    <div class="stat-value">${Math.round(teachersData.reduce((sum, t) => sum + (t.serviceYears || 0), 0) / teachersData.filter(t => t.serviceYears).length) || 0}</div>
                </div>
            `;
            
            document.getElementById('retirementAnalysis').innerHTML = analysisHTML;
            
            // Mettre à jour le tableau des retraites
            updateRetirementTable();
        }

        function updateUpcomingRetirements() {
            const container = document.getElementById('upcomingRetirements');
            if (!container) return;
            
            // Filtrer les enseignants avec date de retraite
            const teachersWithRetirement = teachersData.filter(t => t.data?.professional?.retirementDate);
            
            // Trier par date de retraite (plus proche en premier)
            teachersWithRetirement.sort((a, b) => {
                const dateA = new Date(a.data.professional.retirementDate);
                const dateB = new Date(b.data.professional.retirementDate);
                return dateA - dateB;
            });
            
            let html = '<div class="data-table">';
            html += `
                <table>
                    <thead>
                        <tr>
                            <th>Enseignant</th>
                            <th>Date de retraite</th>
                            <th>Années restantes</th>
                            <th>Établissement</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            teachersWithRetirement.slice(0, 10).forEach(teacher => {
                const retirementDate = new Date(teacher.data.professional.retirementDate);
                const yearsRemaining = teacher.yearsToRetirement;
                const dateStr = retirementDate.toLocaleDateString();
                
                html += `
                    <tr>
                        <td>${teacher.fullName}</td>
                        <td>${dateStr}</td>
                        <td><span class="badge ${yearsRemaining < 1 ? 'badge-danger' : yearsRemaining < 3 ? 'badge-warning' : 'badge-success'}">${yearsRemaining} an(s)</span></td>
                        <td>${teacher.data.establishment?.name || 'Non spécifié'}</td>
                    </tr>
                `;
            });
            
            if (teachersWithRetirement.length === 0) {
                html += `
                    <tr>
                        <td colspan="4" class="text-center">Aucune date de retraite spécifiée</td>
                    </tr>
                `;
            }
            
            html += `
                    </tbody>
                </table>
            </div>
            `;
            
            container.innerHTML = html;
        }

        function updateRetirementTable() {
            const container = document.getElementById('retirementTable');
            if (!container) return;
            
            // Créer un tableau complet des retraites
            let html = '<div class="data-table">';
            html += `
                <table>
                    <thead>
                        <tr>
                            <th>Enseignant</th>
                            <th>Matricule</th>
                            <th>Âge</th>
                            <th>Service (ans)</th>
                            <th>Date retraite</th>
                            <th>Années rest.</th>
                            <th>Établissement</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            teachersData.forEach(teacher => {
                const hasRetirementDate = teacher.data?.professional?.retirementDate;
                const retirementDate = hasRetirementDate ? new Date(teacher.data.professional.retirementDate) : null;
                const dateStr = hasRetirementDate ? retirementDate.toLocaleDateString() : 'Non spécifié';
                const yearsRemaining = teacher.yearsToRetirement;
                
                let statusBadge = '';
                if (!hasRetirementDate) {
                    statusBadge = '<span class="badge badge-warning">Non spécifié</span>';
                } else if (yearsRemaining < 1) {
                    statusBadge = '<span class="badge badge-danger">Urgent</span>';
                } else if (yearsRemaining < 3) {
                    statusBadge = '<span class="badge badge-warning">Proche</span>';
                } else if (yearsRemaining < 5) {
                    statusBadge = '<span class="badge badge-info">Moyen terme</span>';
                } else {
                    statusBadge = '<span class="badge badge-success">Long terme</span>';
                }
                
                html += `
                    <tr>
                        <td>${teacher.fullName}</td>
                        <td>${teacher.data?.professional?.matricule || 'Non spécifié'}</td>
                        <td>${teacher.age || 'Non spécifié'}</td>
                        <td>${teacher.serviceYears || 'Non spécifié'}</td>
                        <td>${dateStr}</td>
                        <td>${yearsRemaining !== undefined ? yearsRemaining : 'Non spécifié'}</td>
                        <td>${teacher.data?.establishment?.name || 'Non spécifié'}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            </div>
            `;
            
            container.innerHTML = html;
        }

        function updateSubTabUI(subtabId) {
            // Mettre à jour le contenu en fonction du sous-onglet
            switch(subtabId) {
                case 'pedagogy-overview':
                case 'pedagogy-subjects':
                case 'pedagogy-timetable':
                case 'pedagogy-lessons':
                case 'pedagogy-tp':
                case 'pedagogy-resources':
                    updatePedagogyAnalysis();
                    break;
                    
                case 'training-overview':
                case 'training-diplomas':
                case 'training-continuous':
                case 'training-languages':
                case 'training-it':
                    updateTrainingAnalysis();
                    break;
                    
                case 'projects-overview':
                case 'projects-pedagogical':
                case 'projects-activities':
                case 'projects-meetings':
                    updateProjectsAnalysis();
                    break;
            }
        }

        function updateExportPreview() {
            const container = document.getElementById('exportPreview');
            if (!container) return;
            
            if (teachersData.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée à exporter</p>';
                return;
            }
            
            const totalTeachers = teachersData.length;
            const completeTeachers = teachersData.filter(t => t.complete).length;
            const totalFiles = teachersData.reduce((sum, t) => sum + t.files.length, 0);
            
            const html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div>Enseignants</div>
                        <div class="stat-value">${totalTeachers}</div>
                    </div>
                    <div class="stat-card">
                        <div>Fiches complètes</div>
                        <div class="stat-value">${completeTeachers}</div>
                        <div>${Math.round((completeTeachers / totalTeachers) * 100)}%</div>
                    </div>
                    <div class="stat-card">
                        <div>Fichiers</div>
                        <div class="stat-value">${totalFiles}</div>
                    </div>
                    <div class="stat-card">
                        <div>Données pédagogiques</div>
                        <div class="stat-value">${teachersData.reduce((sum, t) => sum + (t.lessonCount || 0), 0)}</div>
                    </div>
                </div>
                <p class="mt-20"><strong>Note:</strong> Cliquez sur un bouton d'export pour télécharger les données au format Excel.</p>
            `;
            
            container.innerHTML = html;
        }

        // Fonctions d'export Excel
        function exportAllToExcel() {
            if (teachersData.length === 0) {
                showNotification('Aucune donnée à exporter', 'warning');
                return;
            }
            
            showLoader(true);
            
            try {
                // Créer un classeur avec plusieurs feuilles
                const wb = XLSX.utils.book_new();
                
                // Feuille 1: Liste des enseignants
                const teachersSheetData = teachersData.map(teacher => ({
                    'Nom': teacher.lastName,
                    'Prénom': teacher.firstName,
                    'Nom complet': teacher.fullName,
                    'Matricule': teacher.data?.professional?.matricule || '',
                    'Établissement': teacher.data?.establishment?.name || '',
                    'Catégorie': teacher.data?.professional?.professionalCategory || '',
                    'Âge': teacher.age || '',
                    'Années de service': teacher.serviceYears || '',
                    'Date retraite': teacher.data?.professional?.retirementDate || '',
                    'Années avant retraite': teacher.yearsToRetirement || '',
                    'Fiche complète': teacher.complete ? 'Oui' : 'Non',
                    'Nombre de fichiers': teacher.files.length,
                    'Matières': teacher.data?.subjects?.map(s => s.name).join(', ') || '',
                    'Leçons': teacher.lessonCount || 0,
                    'Projets': teacher.projectCount || 0,
                    'Formations': teacher.trainingCount || 0
                }));
                
                const teachersSheet = XLSX.utils.json_to_sheet(teachersSheetData);
                XLSX.utils.book_append_sheet(wb, teachersSheet, 'Enseignants');
                
                // Feuille 2: Statistiques
                const statsData = [{
                    'Total enseignants': teachersData.length,
                    'Fiches complètes': teachersData.filter(t => t.complete).length,
                    'Pourcentage complet': `${Math.round((teachersData.filter(t => t.complete).length / teachersData.length) * 100)}%`,
                    'Total fichiers': teachersData.reduce((sum, t) => sum + t.files.length, 0),
                    'Total leçons': teachersData.reduce((sum, t) => sum + (t.lessonCount || 0), 0),
                    'Total projets': teachersData.reduce((sum, t) => sum + (t.projectCount || 0), 0),
                    'Total formations': teachersData.reduce((sum, t) => sum + (t.trainingCount || 0), 0),
                    'Date d\'export': new Date().toLocaleString()
                }];
                
                const statsSheet = XLSX.utils.json_to_sheet(statsData);
                XLSX.utils.book_append_sheet(wb, statsSheet, 'Statistiques');
                
                // Générer le fichier Excel
                const fileName = `export_complet_enseignants_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification('Export complet réalisé avec succès', 'success');
            } catch (error) {
                showNotification('Erreur lors de l\'export', 'error');
                console.error(error);
            } finally {
                showLoader(false);
            }
        }

        function exportTeachersToExcel() {
            if (teachersData.length === 0) {
                showNotification('Aucune donnée à exporter', 'warning');
                return;
            }
            
            showLoader(true);
            
            try {
                const teachersSheetData = teachersData.map(teacher => ({
                    'Nom': teacher.lastName,
                    'Prénom': teacher.firstName,
                    'Matricule': teacher.data?.professional?.matricule || '',
                    'Établissement': teacher.data?.establishment?.name || '',
                    'Catégorie': teacher.data?.professional?.professionalCategory || '',
                    'Âge': teacher.age || '',
                    'Années de service': teacher.serviceYears || '',
                    'Date retraite': teacher.data?.professional?.retirementDate || '',
                    'Fiche complète': teacher.complete ? 'Oui' : 'Non',
                    'Nombre de fichiers': teacher.files.length
                }));
                
                const ws = XLSX.utils.json_to_sheet(teachersSheetData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Liste enseignants');
                
                const fileName = `liste_enseignants_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification('Liste des enseignants exportée avec succès', 'success');
            } catch (error) {
                showNotification('Erreur lors de l\'export', 'error');
                console.error(error);
            } finally {
                showLoader(false);
            }
        }

        function exportPedagogyToExcel() {
            // Similaire à exportTeachersToExcel mais pour les données pédagogiques
            showNotification('Export des données pédagogiques - Fonctionnalité à implémenter', 'info');
        }

        function exportTrainingToExcel() {
            // Similaire mais pour les formations
            showNotification('Export des données de formation - Fonctionnalité à implémenter', 'info');
        }

        function exportRetirementToExcel() {
            // Similaire mais pour les retraites
            showNotification('Export de la planification retraite - Fonctionnalité à implémenter', 'info');
        }

        function exportProjectsToExcel() {
            // Similaire mais pour les projets
            showNotification('Export des projets et activités - Fonctionnalité à implémenter', 'info');
        }

        // Fonctions utilitaires
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationMessage = document.getElementById('notificationMessage');
            
            // Changer l'icône et la couleur selon le type
            switch(type) {
                case 'error':
                    notificationIcon.className = 'fas fa-exclamation-circle';
                    notification.className = 'notification error';
                    break;
                case 'warning':
                    notificationIcon.className = 'fas fa-exclamation-triangle';
                    notification.className = 'notification warning';
                    break;
                case 'info':
                    notificationIcon.className = 'fas fa-info-circle';
                    notification.className = 'notification info';
                    break;
                default:
                    notificationIcon.className = 'fas fa-check-circle';
                    notification.className = 'notification';
            }
            
            notificationMessage.textContent = message;
            notification.classList.add('show');
            
            // Masquer après 5 secondes
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        function showLoader(show) {
            const loader = document.getElementById('loader');
            if (show) {
                loader.classList.add('active');
            } else {
                loader.classList.remove('active');
            }
        }

        function clearAllData() {
            if (confirm('Voulez-vous vraiment effacer toutes les données ? Cette action est irréversible.')) {
                teachersData = [];
                filteredTeachers = [];
                
                // Réinitialiser les graphiques
                Object.values(charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                charts = {};
                
                // Mettre à jour l'interface
                updateUIAfterImport();
                
                // Effacer le stockage local
                localStorage.removeItem('teachersData');
                
                showNotification('Toutes les données ont été effacées', 'success');
            }
        }

        function generateReport() {
            showNotification('Génération de rapport PDF - Fonctionnalité à implémenter', 'info');
        }

        function saveSession() {
            try {
                const sessionData = {
                    teachersData: teachersData,
                    saveDate: new Date().toISOString()
                };
                
                localStorage.setItem('teachersData', JSON.stringify(sessionData));
                showNotification('Session sauvegardée avec succès', 'success');
            } catch (error) {
                showNotification('Erreur lors de la sauvegarde', 'error');
            }
        }

        function loadSessionData() {
            try {
                const savedData = localStorage.getItem('teachersData');
                if (savedData) {
                    const sessionData = JSON.parse(savedData);
                    teachersData = sessionData.teachersData || [];
                    
                    // Recalculer les statistiques pour chaque enseignant
                    teachersData.forEach(teacher => {
                        calculateTeacherStatistics(teacher);
                    });
                    
                    updateUIAfterImport();
                    showNotification('Session précédente chargée', 'success');
                }
            } catch (error) {
                console.error('Erreur lors du chargement de la session:', error);
            }
        }

        function backupData() {
            if (teachersData.length === 0) {
                showNotification('Aucune donnée à sauvegarder', 'warning');
                return;
            }
            
            const backup = {
                teachersData: teachersData,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_enseignants_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Sauvegarde créée avec succès', 'success');
        }
    </script>
</body>
</html>
