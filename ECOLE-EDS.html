<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche Administrative Enseignant - Gestion Pédagogique Complète</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Variables CSS */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #9b59b6;
            --dark-color: #2c3e50;
            --light-color: #f5f5f5;
            --gray-color: #7f8c8d;
            --border-radius: 10px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        /* Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-color);
            padding: 20px;
            color: var(--dark-color);
            line-height: 1.6;
        }

        /* Container principal */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        /* Header */
        header {
            text-align: center;
            padding: 25px 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            position: relative;
        }

        .school-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .school-name {
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .academic-year {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        header h1 {
            color: white;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        /* Navigation */
        .tabs-container {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }

        .tabs {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            min-width: 600px;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-color);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .tab:hover {
            background-color: #e9ecef;
            color: var(--dark-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background-color: white;
        }

        /* Contenu des onglets */
        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        /* Sections */
        .form-section {
            margin-bottom: 30px;
            padding: 25px;
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .form-section h2 {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            margin: -25px -25px 25px -25px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        /* Formulaires */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-col {
            flex: 1;
            min-width: 250px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="file"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Éléments dynamiques */
        .dynamic-item {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            position: relative;
            transition: var(--transition);
        }

        .dynamic-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        /* Matières et pédagogie */
        .subject-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #dee2e6;
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }

        .theme-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .lesson-container, .tp-container, .evaluation-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 18px;
            margin-bottom: 15px;
            border-left: 4px solid var(--info-color);
        }

        .tp-container {
            border-left-color: var(--warning-color);
        }

        .evaluation-container {
            border-left-color: var(--success-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        /* Boutons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--success-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #d68910;
            transform: translateY(-2px);
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
        }

        .btn-light {
            background-color: #f8f9fa;
            color: var(--dark-color);
            border: 1px solid #dee2e6;
        }

        .btn-light:hover {
            background-color: #e9ecef;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .btn-xs {
            padding: 5px 8px;
            font-size: 0.8rem;
        }

        /* Actions */
        .form-actions {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .tab-actions {
            display: flex;
            justify-content: flex-start;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding: 15px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .section-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Navigation */
        .btn-retour {
            padding: 10px 20px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 0 20px 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .btn-retour:hover {
            background-color: #e0e0e0;
        }

        /* Tableaux */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .data-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        /* Onglets secondaires */
        .sub-tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 25px;
        }

        .sub-tab {
            padding: 12px 25px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-color);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }

        .sub-tab:hover {
            color: var(--dark-color);
        }

        .sub-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        /* Sous-contenus des onglets */
        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        /* Indicateurs */
        .counter {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            font-size: 0.8rem;
            margin-right: 8px;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 5px;
        }

        .badge-primary {
            background-color: #e3f2fd;
            color: var(--primary-color);
        }

        .badge-success {
            background-color: #e8f5e9;
            color: var(--success-color);
        }

        .badge-warning {
            background-color: #fff3e0;
            color: var(--warning-color);
        }

        .badge-danger {
            background-color: #ffebee;
            color: var(--danger-color);
        }

        .badge-info {
            background-color: #f3e5f5;
            color: var(--info-color);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-color);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success-color);
            color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        /* Loader */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }

        .loader.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 0;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .form-section {
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions, .tab-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .subject-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .sub-tabs {
                flex-wrap: wrap;
            }
            
            .sub-tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .tab-content {
                padding: 15px;
            }
            
            .form-section {
                padding: 15px;
            }
            
            header {
                padding: 20px;
            }
            
            header h1 {
                font-size: 1.4rem;
            }
            
            .school-info {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Print */
        @media print {
            .btn-retour, .form-actions, button, .tabs-container, .tab-actions,
            .section-actions, .modal, .notification {
                display: none !important;
            }
            
            body {
                background-color: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
            }
            
            .tab-content {
                display: block !important;
                padding: 0;
            }
            
            .form-section {
                break-inside: avoid;
            }
        }

        /* Utilitaires */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-30 {
            margin-bottom: 30px;
        }

        .mt-30 {
            margin-top: 30px;
        }

        .d-flex {
            display: flex;
        }

        .align-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-10 {
            gap: 10px;
        }

        .gap-15 {
            gap: 15px;
        }

        .gap-20 {
            gap: 20px;
        }

        .w-100 {
            width: 100%;
        }

        /* Améliorations spécifiques */
        .rating-stars {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .rating-stars i {
            color: #ffd700;
            cursor: pointer;
        }

        .progress-bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress {
            height: 100%;
            background: var(--success-color);
            transition: width 0.3s;
        }

        .calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin: 20px 0;
        }

        .calendar-day {
            padding: 10px;
            border: 1px solid #e9ecef;
            text-align: center;
            cursor: pointer;
        }

        .calendar-day.active {
            background: var(--primary-color);
            color: white;
        }

        .attachment-list {
            margin: 15px 0;
        }

        .attachment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .dashboard-card h3 {
            margin-bottom: 15px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            height: 200px;
            margin: 20px 0;
            position: relative;
        }

        /* Bouton Accueil */
        .btn-accueil {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-accueil:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4);
            color: white;
            text-decoration: none;
        }
        
        /* Correction: Ajout du style manquant */
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            position: relative;
            min-width: 200px;
        }
        
        .search-box i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }
        
        .search-box input {
            padding-left: 35px;
        }
        
        /* Correction: Ajout du style pour .timeline */
        .timeline {
            border-left: 2px solid var(--primary-color);
            padding-left: 20px;
            margin-left: 10px;
        }
        
        .timeline-item {
            margin-bottom: 20px;
            position: relative;
        }
        
        .timeline-item:before {
            content: '';
            position: absolute;
            left: -26px;
            top: 5px;
            width: 10px;
            height: 10px;
            background-color: var(--primary-color);
            border-radius: 50%;
        }
        
        /* Style pour la classe courante */
        .current-class-display {
            background: #e8f5e9;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success-color);
        }
        
        .current-class-display h4 {
            color: var(--success-color);
            margin-bottom: 5px;
        }
        
        /* Style spécifique pour l'emploi du temps */
        .timetable-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .timetable-cell {
            min-width: 120px;
            height: 40px;
            border: 1px solid #dee2e6;
            text-align: center;
            background: white;
            transition: all 0.2s;
        }
        
        .timetable-cell:hover {
            background: #f8f9fa;
            transform: scale(1.02);
        }
        
        .timetable-cell.main {
            background: #e3f2fd;
            border-color: var(--primary-color);
        }
        
        .timetable-cell.secondary {
            background: #e8f5e9;
            border-color: var(--success-color);
        }
        
        .timetable-cell.tp {
            background: #fff3e0;
            border-color: var(--warning-color);
        }
        
        .timetable-cell.meeting {
            background: #f3e5f5;
            border-color: var(--info-color);
        }
        
        .timetable-cell.free {
            background: #f5f5f5;
        }
        
        .timetable-cell.break {
            background: repeating-linear-gradient(45deg, #f8f9fa, #f8f9fa 10px, #e9ecef 10px, #e9ecef 20px);
            text-align: center;
            font-style: italic;
            color: var(--gray-color);
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
    </div>

    <!-- Modal générique -->
    <div class="modal" id="genericModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle"></h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle" id="notificationIcon"></i>
        <span id="notificationMessage"></span>
    </div>

    <!-- Bouton retour -->
    <button class="btn-retour" onclick="history.back()">
        <i class="fas fa-arrow-left"></i> Retour
    </button>

    <!-- Bouton Accueil -->
    <a href="index.html" class="btn btn-accueil">
        <i class="fas fa-home"></i> Accueil
    </a>
    
    <!-- Container principal -->
    <div class="container">
        <header>
            <div class="school-info">
                <div class="school-name">
                    <i class="fas fa-school"></i>
                    <span id="schoolName">Établissement Scolaire</span>
                </div>
                <div class="academic-year">
                    <i class="fas fa-calendar-alt"></i>
                    Année scolaire: <span id="currentYear"></span>
                </div>
            </div>
            <h1><i class="fas fa-id-card"></i> FICHE ADMINISTRATIVE DE L'ENSEIGNANT</h1>
            <p>Système complet de gestion pédagogique et administrative</p>
        </header>

        <!-- Navigation principale -->
        <div class="tabs-container">
            <ul class="tabs">
                <li class="tab active" data-tab="tab1">
                    <i class="fas fa-user-tie"></i> Informations Générales
                </li>
                <li class="tab" data-tab="tab2">
                    <i class="fas fa-chalkboard-teacher"></i> Enseignement & Pédagogie
                </li>
                <li class="tab" data-tab="tab3">
                    <i class="fas fa-graduation-cap"></i> Formation & Compétences
                </li>
                <li class="tab" data-tab="tab4">
                    <i class="fas fa-chart-line"></i> Évaluations & Statistiques
                </li>
                <li class="tab" data-tab="tab5">
                    <i class="fas fa-project-diagram"></i> Projets & Activités
                </li>
                <li class="tab" data-tab="tab6">
                    <i class="fas fa-database"></i> Données & Archives
                </li>
                <li class="tab" data-tab="tab7">
                    <i class="fas fa-tachometer-alt"></i> Tableau de bord
                </li>
            </ul>
        </div>

        <form id="teacherForm">
            <!-- Onglet 1: Informations Générales -->
            <div id="tab1" class="tab-content active">
                <div class="tab-actions">
                    <button type="button" class="btn btn-info" onclick="exportJSON('tab1')">
                        <i class="fas fa-file-export"></i> Exporter
                    </button>
                    <button type="button" class="btn btn-warning" onclick="importJSON('tab1')">
                        <i class="fas fa-file-import"></i> Importer
                    </button>
                    <button type="button" class="btn btn-light" onclick="generateQRCode()">
                        <i class="fas fa-qrcode"></i> QR Code
                    </button>
                </div>

                <!-- Établissement -->
                <div class="form-section">
                    <h2><i class="fas fa-university"></i> I. INFORMATION DE L'ÉTABLISSEMENT</h2>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="establishmentName"><i class="fas fa-school"></i> Nom de l'établissement *</label>
                                <input type="text" id="establishmentName" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="establishmentType"><i class="fas fa-building"></i> Type d'établissement</label>
                                <select id="establishmentType">
                                    <option value="">Sélectionner</option>
                                    <option value="college">Collège</option>
                                    <option value="lycee">Lycée</option>
                                    <option value="lycee_pro">Lycée Professionnel</option>
                                    <option value="lycee_tech">Lycée Technique</option>
                                    <option value="ecole">École Primaire</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="establishmentAddress"><i class="fas fa-map-marker-alt"></i> Adresse</label>
                                <input type="text" id="establishmentAddress">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="establishmentPhone"><i class="fas fa-phone"></i> Téléphone</label>
                                <input type="tel" id="establishmentPhone">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="establishmentEmail"><i class="fas fa-envelope"></i> Email</label>
                                <input type="email" id="establishmentEmail">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="establishmentWebsite"><i class="fas fa-globe"></i> Site web</label>
                                <input type="text" id="establishmentWebsite">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informations personnelles -->
                <div class="form-section">
                    <h2><i class="fas fa-user"></i> II. INFORMATIONS PERSONNELLES</h2>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="lastName"><i class="fas fa-signature"></i> Nom *</label>
                                <input type="text" id="lastName" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="firstName"><i class="fas fa-user"></i> Prénoms *</label>
                                <input type="text" id="firstName" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="gender"><i class="fas fa-venus-mars"></i> Sexe</label>
                                <select id="gender">
                                    <option value="">Sélectionner</option>
                                    <option value="M">Masculin</option>
                                    <option value="F">Féminin</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="birthDate"><i class="fas fa-birthday-cake"></i> Date de naissance *</label>
                                <input type="date" id="birthDate" required onchange="calculateRetirementDate()">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="birthMonth"><i class="fas fa-calendar"></i> Mois de naissance</label>
                                <select id="birthMonth" onchange="calculateRetirementDate()">
                                    <option value="">Sélectionner</option>
                                    <option value="1">Janvier</option>
                                    <option value="2">Février</option>
                                    <option value="3">Mars</option>
                                    <option value="4">Avril</option>
                                    <option value="5">Mai</option>
                                    <option value="6">Juin</option>
                                    <option value="7">Juillet</option>
                                    <option value="8">Août</option>
                                    <option value="9">Septembre</option>
                                    <option value="10">Octobre</option>
                                    <option value="11">Novembre</option>
                                    <option value="12">Décembre</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="birthPlace"><i class="fas fa-map-marker-alt"></i> Lieu de naissance *</label>
                                <input type="text" id="birthPlace" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="nationality"><i class="fas fa-flag"></i> Nationalité</label>
                                <input type="text" id="nationality">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="address"><i class="fas fa-home"></i> Adresse personnelle</label>
                                <input type="text" id="address">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="personalPhone"><i class="fas fa-mobile-alt"></i> Téléphone personnel</label>
                                <input type="tel" id="personalPhone">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="personalEmail"><i class="fas fa-envelope"></i> Email personnel</label>
                                <input type="email" id="personalEmail">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="cin"><i class="fas fa-id-card"></i> CIN/Passport</label>
                                <input type="text" id="cin">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="maritalStatus"><i class="fas fa-heart"></i> Situation familiale</label>
                                <select id="maritalStatus">
                                    <option value="">Sélectionner</option>
                                    <option value="celibataire">Célibataire</option>
                                    <option value="marie">Marié(e)</option>
                                    <option value="divorce">Divorcé(e)</option>
                                    <option value="veuf">Veuf/Veuve</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="childrenNumber"><i class="fas fa-child"></i> Nombre d'enfants</label>
                                <input type="number" id="childrenNumber" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informations professionnelles -->
                <div class="form-section">
                    <h2><i class="fas fa-briefcase"></i> III. INFORMATIONS PROFESSIONNELLES</h2>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="matricule"><i class="fas fa-id-badge"></i> Numéro matricule *</label>
                                <input type="text" id="matricule" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="position"><i class="fas fa-user-tag"></i> Fonction *</label>
                                <select id="position" required>
                                    <option value="">Sélectionner</option>
                                    <option value="professeur">Professeur</option>
                                    <option value="prof_agrege">Professeur Agrégé</option>
                                    <option value="prof_certifie">Professeur Certifié</option>
                                    <option value="charge_cours">Chargé de Cours</option>
                                    <option value="vacataire">Vacataire</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="grade"><i class="fas fa-award"></i> Grade</label>
                                <input type="text" id="grade">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="professionalCategory"><i class="fas fa-layer-group"></i> Catégorie professionnelle</label>
                                <select id="professionalCategory" onchange="calculateRetirementDate()">
                                    <option value="">Sélectionner</option>
                                    <option value="A1">A1 (Cadres supérieurs)</option>
                                    <option value="A2">A2 (Cadres)</option>
                                    <option value="B">B (Techniciens supérieurs)</option>
                                    <option value="C">C (Techniciens)</option>
                                    <option value="D">D (Adjoints techniques)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="engagementDate"><i class="fas fa-handshake"></i> Date d'engagement *</label>
                                <input type="date" id="engagementDate" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="regionServiceDate"><i class="fas fa-calendar-alt"></i> Date de prise de service dans la région *</label>
                                <input type="date" id="regionServiceDate" required onchange="calculateServiceYears('regionServiceDate', 'yearsInRegion')">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="inspectionServiceDate"><i class="fas fa-calendar-check"></i> Date de prise de service dans l'inspection *</label>
                                <input type="date" id="inspectionServiceDate" required onchange="calculateServiceYears('inspectionServiceDate', 'yearsInInspection')">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="yearsInRegion"><i class="fas fa-history"></i> Années dans la région</label>
                                <input type="number" id="yearsInRegion" readonly>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="yearsInInspection"><i class="fas fa-clock"></i> Années dans l'inspection</label>
                                <input type="number" id="yearsInInspection" readonly>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="retirementDate"><i class="fas fa-umbrella-beach"></i> Date de retraite</label>
                                <input type="date" id="retirementDate" readonly>
                            </div>
                        </div>
                    </div>
                    <!-- Détails du calcul de la retraite -->
                    <div class="form-row">
                        <div class="form-col">
                            <div id="retirementDetails">
                                <!-- Les détails du calcul s'afficheront ici -->
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="currentClass"><i class="fas fa-chalkboard"></i> Classe(s) actuelle(s) *</label>
                                <input type="text" id="currentClass" placeholder="Ex: 3ème A, Terminale C..." required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="weeklyHours"><i class="fas fa-clock"></i> Heures/semaine</label>
                                <input type="number" id="weeklyHours" min="0" max="40">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Matières enseignées -->
                <div class="form-section">
                    <h2><i class="fas fa-book"></i> IV. MATIÈRES ENSEIGNÉES</h2>
                    <div id="subjectsContainer">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="mainSubject"><i class="fas fa-star"></i> Matière principale *</label>
                                    <input type="text" id="mainSubject" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="secondarySubject"><i class="fas fa-star-half-alt"></i> Matière secondaire</label>
                                    <input type="text" id="secondarySubject">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addSubjectField()">
                        <i class="fas fa-plus"></i> Ajouter une matière supplémentaire
                    </button>
                </div>
            </div>

            <!-- Onglet 2: Enseignement & Pédagogie -->
            <div id="tab2" class="tab-content">
                <!-- Navigation secondaire -->
                <div class="sub-tabs mb-30">
                    <div class="sub-tab active" data-subtab="planning">Planning & Emploi du temps</div>
                    <div class="sub-tab" data-subtab="themes">Thèmes & Programmes</div>
                    <div class="sub-tab" data-subtab="lessons">Leçons & Séances</div>
                    <div class="sub-tab" data-subtab="tp">TP & Expériences</div>
                    <div class="sub-tab" data-subtab="resources">Ressources & Supports</div>
                </div>

                <div class="tab-actions">
                    <button type="button" class="btn btn-info" onclick="exportJSON('tab2')">
                        <i class="fas fa-file-export"></i> Exporter données pédagogiques
                    </button>
                    <button type="button" class="btn btn-warning" onclick="importJSON('tab2')">
                        <i class="fas fa-file-import"></i> Importer données
                    </button>
                    <button type="button" class="btn btn-light" onclick="generatePlanningPDF()">
                        <i class="fas fa-file-pdf"></i> Générer PDF
                    </button>
                </div>

                <!-- Affichage des informations synchronisées -->
                <div class="form-section">
                    <h2><i class="fas fa-sync-alt"></i> INFORMATIONS SYNCHRONISÉES</h2>
                    <div id="syncedInfoDisplay" class="current-class-display">
                        <!-- Les informations synchronisées s'afficheront ici -->
                    </div>
                </div>

                <!-- Contenu des sous-onglets -->
                <div class="sub-tab-content active" data-subtab="planning">
                    <div class="form-section">
                        <h2><i class="fas fa-calendar-alt"></i> EMPLOI DU TEMPS HEBDOMADAIRE</h2>
                        <div class="form-group">
                            <div class="current-class-display mb-20">
                                <h4><i class="fas fa-info-circle"></i> Paramètres généraux</h4>
                                <div class="form-row">
                                    <div class="form-col">
                                        <label><i class="fas fa-chalkboard"></i> Classe(s) à planifier</label>
                                        <input type="text" id="planningClasses" placeholder="Ex: 3ème A, Terminale C">
                                    </div>
                                    <div class="form-col">
                                        <label><i class="fas fa-clock"></i> Heures par séance</label>
                                        <input type="number" id="sessionDuration" value="55" min="30" max="120" step="5">
                                        <small>Durée en minutes</small>
                                    </div>
                                </div>
                            </div>
                            <div id="timetableContainer">
                                <!-- L'emploi du temps sera généré dynamiquement -->
                            </div>
                            <div class="mt-20">
                                <button type="button" class="btn btn-secondary" onclick="generateTimetable()">
                                    <i class="fas fa-table"></i> Générer l'emploi du temps
                                </button>
                                <button type="button" class="btn btn-primary" onclick="saveTimetable()">
                                    <i class="fas fa-save"></i> Sauvegarder l'emploi du temps
                                </button>
                                <button type="button" class="btn btn-light" onclick="printTimetable()">
                                    <i class="fas fa-print"></i> Imprimer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sub-tab-content" data-subtab="themes">
                    <div class="form-section">
                        <h2><i class="fas fa-sitemap"></i> THÈMES ET PROGRAMMES PAR MATIÈRE</h2>
                        <div class="form-group">
                            <label><i class="fas fa-book-open"></i> Sélectionnez la matière</label>
                            <select id="subjectSelector" onchange="loadSubjectThemes(this.value)">
                                <option value="">-- Sélectionner une matière --</option>
                            </select>
                        </div>
                        <div id="themesContainer">
                            <!-- Les thèmes seront chargés dynamiquement -->
                        </div>
                    </div>
                </div>

                <div class="sub-tab-content" data-subtab="lessons">
                    <div class="form-section">
                        <h2><i class="fas fa-chalkboard"></i> GESTION DES LEÇONS</h2>
                        <div class="filter-bar">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" placeholder="Rechercher une leçon..." id="lessonSearch">
                            </div>
                            <select id="lessonFilterSubject">
                                <option value="">Toutes les matières</option>
                            </select>
                            <select id="lessonFilterClass">
                                <option value="">Toutes les classes</option>
                            </select>
                        </div>
                        <div id="lessonsContainer">
                            <!-- Liste des leçons -->
                        </div>
                        <button type="button" class="btn btn-primary" onclick="addNewLesson()">
                            <i class="fas fa-plus-circle"></i> Nouvelle leçon
                        </button>
                    </div>
                </div>

                <div class="sub-tab-content" data-subtab="tp">
                    <div class="form-section">
                        <h2><i class="fas fa-flask"></i> TRAVAUX PRATIQUES & EXPÉRIENCES</h2>
                        <div id="tpContainer">
                            <!-- TP seront ajoutés ici -->
                        </div>
                        <button type="button" class="btn btn-primary" onclick="addNewTP()">
                            <i class="fas fa-plus-circle"></i> Nouveau TP/Expérience
                        </button>
                    </div>
                </div>

                <div class="sub-tab-content" data-subtab="resources">
                    <div class="form-section">
                        <h2><i class="fas fa-folder-open"></i> RESSOURCES PÉDAGOGIQUES</h2>
                        <div class="form-group">
                            <label><i class="fas fa-upload"></i> Ajouter des ressources</label>
                            <input type="file" id="resourceUpload" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.jpg,.png,.mp4,.mp3">
                            <div class="attachment-list" id="resourcesList">
                                <!-- Liste des ressources -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet 3: Formation & Compétences -->
            <div id="tab3" class="tab-content">
                <div class="tab-actions">
                    <button type="button" class="btn btn-info" onclick="exportJSON('tab3')">
                        <i class="fas fa-file-export"></i> Exporter
                    </button>
                    <button type="button" class="btn btn-warning" onclick="importJSON('tab3')">
                        <i class="fas fa-file-import"></i> Importer
                    </button>
                </div>

                <!-- Diplômes académiques -->
                <div class="form-section">
                    <h2><i class="fas fa-graduation-cap"></i> DIPLÔMES ACADÉMIQUES</h2>
                    <div id="academicDiplomas">
                        <!-- Diplômes seront ajoutés dynamiquement -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addAcademicDiploma()">
                        <i class="fas fa-plus"></i> Ajouter un diplôme
                    </button>
                </div>

                <!-- Diplômes professionnels -->
                <div class="form-section">
                    <h2><i class="fas fa-award"></i> DIPLÔMES PROFESSIONNELS</h2>
                    <div id="professionalDiplomas">
                        <!-- Diplômes professionnels -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addProfessionalDiploma()">
                        <i class="fas fa-plus"></i> Ajouter un diplôme
                    </button>
                </div>

                <!-- Formations continues -->
                <div class="form-section">
                    <h2><i class="fas fa-chalkboard-teacher"></i> FORMATIONS CONTINUES</h2>
                    <div id="trainingContainer">
                        <!-- Formations -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addTraining()">
                        <i class="fas fa-plus"></i> Ajouter une formation
                    </button>
                </div>

                <!-- Compétences linguistiques -->
                <div class="form-section">
                    <h2><i class="fas fa-language"></i> COMPÉTENCES LINGUISTIQUES</h2>
                    <div id="languagesContainer">
                        <!-- Langues -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addLanguage()">
                        <i class="fas fa-plus"></i> Ajouter une langue
                    </button>
                </div>

                <!-- Compétences informatiques -->
                <div class="form-section">
                    <h2><i class="fas fa-laptop-code"></i> COMPÉTENCES INFORMATIQUES</h2>
                    <div id="itSkillsContainer">
                        <!-- Compétences IT -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addITSkill()">
                        <i class="fas fa-plus"></i> Ajouter une compétence
                    </button>
                </div>
            </div>

            <!-- Onglet 4: Évaluations & Statistiques -->
            <div id="tab4" class="tab-content">
                <div class="tab-actions">
                    <button type="button" class="btn btn-info" onclick="exportJSON('tab4')">
                        <i class="fas fa-file-export"></i> Exporter
                    </button>
                    <button type="button" class="btn btn-warning" onclick="importJSON('tab4')">
                        <i class="fas fa-file-import"></i> Importer
                    </button>
                    <button type="button" class="btn btn-light" onclick="showStatistics()">
                        <i class="fas fa-chart-bar"></i> Statistiques
                    </button>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3><i class="fas fa-chart-line"></i> Performances des élèves</h3>
                        <div class="chart-container" id="performanceChart"></div>
                    </div>
                    <div class="dashboard-card">
                        <h3><i class="fas fa-tasks"></i> Progression du programme</h3>
                        <div class="chart-container" id="progressChart"></div>
                    </div>
                </div>

                <!-- Évaluations -->
                <div class="form-section">
                    <h2><i class="fas fa-clipboard-check"></i> ÉVALUATIONS</h2>
                    <div id="evaluationsContainer">
                        <!-- Évaluations -->
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addEvaluation()">
                        <i class="fas fa-plus"></i> Nouvelle évaluation
                    </button>
                </div>
            </div>

            <!-- Onglet 5: Projets & Activités -->
            <div id="tab5" class="tab-content">
                <div class="tab-actions">
                    <button type="button" class="btn btn-info" onclick="exportJSON('tab5')">
                        <i class="fas fa-file-export"></i> Exporter
                    </button>
                    <button type="button" class="btn btn-warning" onclick="importJSON('tab5')">
                        <i class="fas fa-file-import"></i> Importer
                    </button>
                </div>

                <!-- Projets pédagogiques -->
                <div class="form-section">
                    <h2><i class="fas fa-project-diagram"></i> PROJETS PÉDAGOGIQUES</h2>
                    <div id="projectsContainer">
                        <!-- Projets -->
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addProject()">
                        <i class="fas fa-plus"></i> Nouveau projet
                    </button>
                </div>

                <!-- Activités extrascolaires -->
                <div class="form-section">
                    <h2><i class="fas fa-futbol"></i> ACTIVITÉS EXTRASCOLAIRES</h2>
                    <div id="activitiesContainer">
                        <!-- Activités -->
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addActivity()">
                        <i class="fas fa-plus"></i> Nouvelle activité
                    </button>
                </div>

                <!-- Réunions et conseils -->
                <div class="form-section">
                    <h2><i class="fas fa-users"></i> RÉUNIONS & CONSEILS</h2>
                    <div id="meetingsContainer">
                        <!-- Réunions -->
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addMeeting()">
                        <i class="fas fa-plus"></i> Nouvelle réunion
                    </button>
                </div>
            </div>

            <!-- Onglet 6: Données & Archives -->
            <div id="tab6" class="tab-content">
                <div class="tab-actions">
                    <button type="button" class="btn btn-info" onclick="backupData()">
                        <i class="fas fa-save"></i> Sauvegarder
                    </button>
                    <button type="button" class="btn btn-warning" onclick="restoreData()">
                        <i class="fas fa-undo"></i> Restaurer
                    </button>
                    <button type="button" class="btn btn-danger" onclick="clearAllData()">
                        <i class="fas fa-trash"></i> Effacer tout
                    </button>
                </div>

                <!-- Import/Export -->
                <div class="form-section">
                    <h2><i class="fas fa-exchange-alt"></i> IMPORT/EXPORT DE DONNÉES</h2>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-file-export"></i> Exporter toutes les données</label>
                                <button type="button" class="btn btn-warning w-100" onclick="exportAllJSON()">
                                    <i class="fas fa-download"></i> Exporter JSON complet
                                </button>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-file-import"></i> Importer des données</label>
                                <input type="file" id="importFile" accept=".json" class="mb-10">
                                <button type="button" class="btn btn-info w-100" onclick="importAllJSON()">
                                    <i class="fas fa-upload"></i> Importer JSON
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sauvegardes -->
                <div class="form-section">
                    <h2><i class="fas fa-history"></i> HISTORIQUE DES SAUVEGARDES</h2>
                    <div id="backupHistory">
                        <!-- Historique -->
                    </div>
                </div>

                <!-- Logs -->
                <div class="form-section">
                    <h2><i class="fas fa-clipboard-list"></i> JOURNAL DES ACTIVITÉS</h2>
                    <div id="activityLogs">
                        <!-- Logs -->
                    </div>
                </div>
            </div>

            <!-- Onglet 7: Tableau de bord -->
            <div id="tab7" class="tab-content">
                <div class="dashboard-grid">
                    <!-- Cartes de synthèse -->
                    <div class="dashboard-card">
                        <h3><i class="fas fa-user-circle"></i> Profil complet</h3>
                        <div id="profileSummary"></div>
                    </div>
                    <div class="dashboard-card">
                        <h3><i class="fas fa-chart-pie"></i> Répartition par matière</h3>
                        <div class="chart-container" id="subjectDistribution"></div>
                    </div>
                    <div class="dashboard-card">
                        <h3><i class="fas fa-calendar-check"></i> Activité récente</h3>
                        <div id="recentActivity"></div>
                    </div>
                    <div class="dashboard-card">
                        <h3><i class="fas fa-bell"></i> Notifications</h3>
                        <div id="notificationsList"></div>
                    </div>
                </div>

                <!-- Statistiques détaillées -->
                <div class="form-section">
                    <h2><i class="fas fa-chart-bar"></i> STATISTIQUES DÉTAILLÉES</h2>
                    <div class="stats-grid" id="detailedStats">
                        <!-- Statistiques -->
                    </div>
                </div>

                <!-- Rapports rapides -->
                <div class="form-section">
                    <h2><i class="fas fa-file-alt"></i> RAPPORTS RAPIDES</h2>
                    <div class="form-row">
                        <div class="form-col">
                            <button type="button" class="btn btn-primary w-100" onclick="generateTeachingReport()">
                                <i class="fas fa-chalkboard-teacher"></i> Rapport d'enseignement
                            </button>
                        </div>
                        <div class="form-col">
                            <button type="button" class="btn btn-success w-100" onclick="generateEvaluationReport()">
                                <i class="fas fa-clipboard-check"></i> Rapport d'évaluation
                            </button>
                        </div>
                        <div class="form-col">
                            <button type="button" class="btn btn-info w-100" onclick="generateActivityReport()">
                                <i class="fas fa-project-diagram"></i> Rapport d'activités
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Règles de départ à la retraite -->
                <div class="form-section" id="retirementRulesSection">
                    <h2><i class="fas fa-umbrella-beach"></i> RÈGLES DE DÉPART À LA RETRAITE</h2>
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                            <i class="fas fa-info-circle"></i> Tableau des catégories
                        </h4>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Catégorie</th>
                                    <th>Âge de départ</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>A1 & A2</strong></td>
                                    <td><span class="badge badge-info">60 ans</span></td>
                                    <td>Cadres supérieurs et Cadres</td>
                                </tr>
                                <tr>
                                    <td><strong>B & C</strong></td>
                                    <td><span class="badge badge-warning">58 ans</span></td>
                                    <td>Techniciens supérieurs et Techniciens</td>
                                </tr>
                                <tr>
                                    <td><strong>D</strong></td>
                                    <td><span class="badge badge-success">55 ans</span></td>
                                    <td>Adjoints techniques</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                            <h5 style="color: var(--warning-color); margin-bottom: 10px;">
                                <i class="fas fa-calendar-alt"></i> Règles spécifiques pour 58 ans
                            </h5>
                            <ul style="margin-bottom: 0;">
                                <li><strong>Né(e) entre Janvier et Mars:</strong> Départ le 1er Avril</li>
                                <li><strong>Né(e) entre Avril et Septembre:</strong> Départ le 1er Octobre</li>
                                <li><strong>Né(e) entre Octobre et Décembre:</strong> Départ le 1er Janvier suivant</li>
                            </ul>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 5px; border-left: 4px solid var(--success-color);">
                            <h5 style="color: var(--success-color); margin-bottom: 10px;">
                                <i class="fas fa-calculator"></i> Formule de calcul
                            </h5>
                            <p><strong>Date de départ = Année de naissance + Âge selon catégorie</strong></p>
                            <p>Exemple: Né en 1970, catégorie B → 1970 + 58 = 2028</p>
                            <p>Le mois de départ dépend du mois de naissance selon les règles spécifiques ci-dessus.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions globales -->
            <div class="form-actions">
                <button type="button" class="btn btn-light" onclick="printForm()">
                    <i class="fas fa-print"></i> Imprimer
                </button>
                <button type="reset" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Annuler
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Sauvegarder tout
                </button>
            </div>
        </form>
    </div>

    <script>
        // Structure de données complète
        let teacherData = {
            establishment: {},
            personal: {},
            professional: {},
            subjects: [],
            teaching: {
                themes: {},
                lessons: [],
                tps: [],
                resources: [],
                timetable: {},
                planningClasses: ""
            },
            diplomas: [],
            trainings: [],
            languages: [],
            itSkills: [],
            evaluations: [],
            projects: [],
            activities: [],
            meetings: [],
            statistics: {},
            backups: [],
            logs: []
        };

        let currentTab = 'tab1';
        let currentSubTab = 'planning';
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            // Initialiser l'année scolaire
            const currentYear = new Date().getFullYear();
            document.getElementById('currentYear').textContent = `${currentYear}-${currentYear + 1}`;
            
            // Gestion des onglets principaux
            initTabs();
            
            // Gestion des sous-onglets
            initSubTabs();
            
            // Charger les données sauvegardées
            loadSavedData();
            
            // Initialiser les événements
            initEvents();
            
            // Mettre à jour l'interface
            updateUI();
            
            showNotification('Application chargée avec succès', 'success');
        }

        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
        }

        function initSubTabs() {
            const subTabs = document.querySelectorAll('.sub-tab');
            subTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const subtabId = this.getAttribute('data-subtab');
                    switchSubTab(subtabId);
                });
            });
        }

        function switchTab(tabId) {
            // Désactiver tous les onglets
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Activer l'onglet sélectionné
            const tabElement = document.querySelector(`[data-tab="${tabId}"]`);
            const tabContent = document.getElementById(tabId);
            
            if (tabElement) tabElement.classList.add('active');
            if (tabContent) tabContent.classList.add('active');
            
            currentTab = tabId;
            
            // Mettre à jour l'interface spécifique à l'onglet
            updateTabUI(tabId);
        }

        function switchSubTab(subtabId) {
            // Désactiver tous les sous-onglets
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
            
            // Activer le sous-onglet sélectionné
            const subTabElement = document.querySelector(`.sub-tab[data-subtab="${subtabId}"]`);
            const subTabContent = document.querySelector(`.sub-tab-content[data-subtab="${subtabId}"]`);
            
            if (subTabElement) subTabElement.classList.add('active');
            if (subTabContent) subTabContent.classList.add('active');
            
            currentSubTab = subtabId;
            
            // Mettre à jour les informations synchronisées
            updateSyncedInfoDisplay();
            
            // Charger les données spécifiques au sous-onglet
            loadSubTabData(subtabId);
        }

        function loadSubTabData(subtabId) {
            switch(subtabId) {
                case 'planning':
                    // Pré-remplir les classes pour l'emploi du temps
                    const planningClassesInput = document.getElementById('planningClasses');
                    if (planningClassesInput && !planningClassesInput.value && teacherData.professional.current_class) {
                        planningClassesInput.value = teacherData.professional.current_class;
                    }
                    // Charger l'emploi du temps sauvegardé
                    loadTimetableData();
                    break;
                case 'themes':
                    updateSubjectsSelector();
                    break;
                case 'lessons':
                    loadLessons();
                    break;
                case 'tp':
                    loadTPs();
                    break;
                case 'resources':
                    loadResources();
                    break;
            }
        }

        function initEvents() {
            // Synchronisation automatique des champs
            const form = document.getElementById('teacherForm');
            if (form) {
                form.addEventListener('change', syncAllData);
                form.addEventListener('input', syncAllData);
                form.addEventListener('submit', handleSubmit);
            }
            
            // Événements spécifiques
            document.getElementById('establishmentName')?.addEventListener('change', updateSchoolName);
            
            document.getElementById('birthDate')?.addEventListener('change', function() {
                syncBirthDateWithMonth();
                calculateRetirementDate();
            });
            
            document.getElementById('birthMonth')?.addEventListener('change', calculateRetirementDate);
            document.getElementById('professionalCategory')?.addEventListener('change', calculateRetirementDate);
            
            document.getElementById('regionServiceDate')?.addEventListener('change', () => {
                calculateServiceYears('regionServiceDate', 'yearsInRegion');
            });
            
            document.getElementById('inspectionServiceDate')?.addEventListener('change', () => {
                calculateServiceYears('inspectionServiceDate', 'yearsInInspection');
            });
            
            // Recherche
            document.getElementById('lessonSearch')?.addEventListener('input', filterLessons);
            
            // Upload de fichiers
            document.getElementById('resourceUpload')?.addEventListener('change', handleResourceUpload);
            document.getElementById('importFile')?.addEventListener('change', handleFileSelect);
            
            // Synchronisation des classes pour l'emploi du temps
            document.getElementById('currentClass')?.addEventListener('change', function() {
                const planningClassesInput = document.getElementById('planningClasses');
                if (planningClassesInput && !planningClassesInput.value) {
                    planningClassesInput.value = this.value;
                }
            });
        }

        // Fonction principale de synchronisation
        function syncAllData() {
            collectTab1Data();
            collectPlanningData();
            saveToLocalStorage();
            
            // Mettre à jour les interfaces dépendantes
            updateSchoolName();
            updateSubjectsSelector();
            updateSyncedInfoDisplay();
            updateDashboard();
            
            // Mettre à jour les filtres de classe
            updateClassFilters();
        }

        function collectTab1Data() {
            // Données de l'établissement
            teacherData.establishment = {
                name: document.getElementById('establishmentName')?.value || '',
                type: document.getElementById('establishmentType')?.value || '',
                address: document.getElementById('establishmentAddress')?.value || '',
                phone: document.getElementById('establishmentPhone')?.value || '',
                email: document.getElementById('establishmentEmail')?.value || '',
                website: document.getElementById('establishmentWebsite')?.value || ''
            };
            
            // Données personnelles
            teacherData.personal = {
                last_name: document.getElementById('lastName')?.value || '',
                first_name: document.getElementById('firstName')?.value || '',
                gender: document.getElementById('gender')?.value || '',
                birth_date: document.getElementById('birthDate')?.value || '',
                birth_month: document.getElementById('birthMonth')?.value || '',
                birth_place: document.getElementById('birthPlace')?.value || '',
                nationality: document.getElementById('nationality')?.value || '',
                address: document.getElementById('address')?.value || '',
                personal_phone: document.getElementById('personalPhone')?.value || '',
                personal_email: document.getElementById('personalEmail')?.value || '',
                cin: document.getElementById('cin')?.value || '',
                marital_status: document.getElementById('maritalStatus')?.value || '',
                children_number: document.getElementById('childrenNumber')?.value || ''
            };
            
            // Données professionnelles
            teacherData.professional = {
                matricule: document.getElementById('matricule')?.value || '',
                position: document.getElementById('position')?.value || '',
                grade: document.getElementById('grade')?.value || '',
                professional_category: document.getElementById('professionalCategory')?.value || '',
                engagement_date: document.getElementById('engagementDate')?.value || '',
                region_service_date: document.getElementById('regionServiceDate')?.value || '',
                inspection_service_date: document.getElementById('inspectionServiceDate')?.value || '',
                years_in_region: document.getElementById('yearsInRegion')?.value || '',
                years_in_inspection: document.getElementById('yearsInInspection')?.value || '',
                retirement_date: document.getElementById('retirementDate')?.value || '',
                current_class: document.getElementById('currentClass')?.value || '',
                weekly_hours: document.getElementById('weeklyHours')?.value || ''
            };
            
            // Collecter les matières
            teacherData.subjects = [];
            const mainSubject = document.getElementById('mainSubject')?.value;
            const secondarySubject = document.getElementById('secondarySubject')?.value;
            
            if (mainSubject) {
                teacherData.subjects.push({
                    id: 'main',
                    name: mainSubject,
                    type: 'main',
                    hours: ''
                });
            }
            
            if (secondarySubject) {
                teacherData.subjects.push({
                    id: 'secondary',
                    name: secondarySubject,
                    type: 'secondary',
                    hours: ''
                });
            }
            
            // Collecter les matières supplémentaires
            const subjectRows = document.querySelectorAll('#subjectsContainer .form-row');
            subjectRows.forEach((row, index) => {
                if (index > 0) {
                    const subjectInput = row.querySelector('.subject-field');
                    const hoursInput = row.querySelector('.subject-hours-field');
                    
                    if (subjectInput && subjectInput.value) {
                        teacherData.subjects.push({
                            id: `additional_${index}`,
                            name: subjectInput.value,
                            hours: hoursInput?.value || '',
                            type: 'additional'
                        });
                    }
                }
            });
        }

        function collectPlanningData() {
            const planningClasses = document.getElementById('planningClasses')?.value || '';
            teacherData.teaching.planningClasses = planningClasses;
        }

        function updateSchoolName() {
            const name = document.getElementById('establishmentName')?.value || 'Établissement Scolaire';
            document.getElementById('schoolName').textContent = name;
        }

        function syncBirthDateWithMonth() {
            const birthDate = document.getElementById('birthDate')?.value;
            if (birthDate) {
                const date = new Date(birthDate);
                const month = date.getMonth() + 1;
                const monthSelect = document.getElementById('birthMonth');
                if (monthSelect) {
                    monthSelect.value = month;
                }
            }
        }

        function calculateRetirementDate() {
            const birthDateInput = document.getElementById('birthDate');
            const birthMonthInput = document.getElementById('birthMonth');
            const professionalCategoryInput = document.getElementById('professionalCategory');
            const retirementDateInput = document.getElementById('retirementDate');
            
            if (!birthDateInput || !birthDateInput.value) return;
            
            const birthDate = new Date(birthDateInput.value);
            let birthMonth = birthDate.getMonth() + 1;
            
            if (birthMonthInput && birthMonthInput.value) {
                birthMonth = parseInt(birthMonthInput.value);
            }
            
            const birthYear = birthDate.getFullYear();
            const professionalCategory = professionalCategoryInput?.value || '';
            
            let retirementAge = 60;
            
            if (professionalCategory === 'A1' || professionalCategory === 'A2') {
                retirementAge = 60;
            } else if (professionalCategory === 'B' || professionalCategory === 'C') {
                retirementAge = 58;
            } else if (professionalCategory === 'D') {
                retirementAge = 55;
            }
            
            let retirementYear = birthYear + retirementAge;
            let retirementMonth = 1;
            
            if (retirementAge === 58) {
                if (birthMonth >= 1 && birthMonth <= 3) {
                    retirementMonth = 4;
                } else if (birthMonth >= 4 && birthMonth <= 9) {
                    retirementMonth = 10;
                } else {
                    retirementMonth = 1;
                    retirementYear += 1;
                }
            } else {
                retirementMonth = birthMonth;
            }
            
            const retirementDate = new Date(retirementYear, retirementMonth - 1, 1);
            retirementDateInput.value = retirementDate.toISOString().split('T')[0];
            
            updateRetirementDetails(birthYear, birthMonth, retirementAge, retirementYear, retirementMonth, professionalCategory);
            syncAllData();
        }

        function updateRetirementDetails(birthYear, birthMonth, retirementAge, retirementYear, retirementMonth, professionalCategory) {
            const container = document.getElementById('retirementDetails');
            if (!container) return;
            
            const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
            
            let html = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 10px;">
                        <i class="fas fa-info-circle"></i> Détails du calcul
                    </h4>
                    <p><strong>Année de naissance:</strong> ${birthYear}</p>
                    <p><strong>Mois de naissance:</strong> ${monthNames[birthMonth - 1] || 'Non défini'}</p>
                    <p><strong>Catégorie:</strong> ${professionalCategory || 'Non définie'}</p>
                    <p><strong>Âge de départ:</strong> ${retirementAge} ans</p>
                    <p><strong>Date calculée:</strong> 1er ${monthNames[retirementMonth - 1]} ${retirementYear}</p>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function calculateServiceYears(dateFieldId, yearsFieldId) {
            const dateField = document.getElementById(dateFieldId);
            const yearsField = document.getElementById(yearsFieldId);
            
            if (dateField && dateField.value && yearsField) {
                const startDate = new Date(dateField.value);
                const today = new Date();
                
                let years = today.getFullYear() - startDate.getFullYear();
                const monthDiff = today.getMonth() - startDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < startDate.getDate())) {
                    years--;
                }
                
                yearsField.value = Math.max(years, 0);
                syncAllData();
            }
        }

        function updateSubjectsSelector() {
            const selector = document.getElementById('subjectSelector');
            const lessonFilter = document.getElementById('lessonFilterSubject');
            
            if (selector) {
                selector.innerHTML = '<option value="">-- Sélectionner une matière --</option>';
                teacherData.subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.name;
                    option.textContent = `${subject.name} ${subject.type === 'main' ? '(Principale)' : subject.type === 'secondary' ? '(Secondaire)' : ''}`;
                    selector.appendChild(option);
                });
            }
            
            if (lessonFilter) {
                lessonFilter.innerHTML = '<option value="">Toutes les matières</option>';
                teacherData.subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.name;
                    option.textContent = subject.name;
                    lessonFilter.appendChild(option);
                });
            }
        }

        function updateClassFilters() {
            const filter = document.getElementById('lessonFilterClass');
            if (!filter) return;
            
            const currentClass = teacherData.professional.current_class;
            if (currentClass) {
                const classes = currentClass.split(',').map(c => c.trim());
                filter.innerHTML = '<option value="">Toutes les classes</option>';
                classes.forEach(classe => {
                    if (classe) {
                        const option = document.createElement('option');
                        option.value = classe;
                        option.textContent = classe;
                        filter.appendChild(option);
                    }
                });
            }
        }

        function updateSyncedInfoDisplay() {
            const display = document.getElementById('syncedInfoDisplay');
            if (!display) return;
            
            let html = '<h4><i class="fas fa-sync"></i> Informations synchronisées:</h4>';
            
            if (teacherData.personal.last_name || teacherData.personal.first_name) {
                html += `<p><strong>Enseignant:</strong> ${teacherData.personal.last_name} ${teacherData.personal.first_name}</p>`;
            }
            
            if (teacherData.professional.matricule) {
                html += `<p><strong>Matricule:</strong> ${teacherData.professional.matricule}</p>`;
            }
            
            if (teacherData.professional.current_class) {
                html += `<p><strong>Classe(s):</strong> ${teacherData.professional.current_class}</p>`;
            }
            
            if (teacherData.subjects.length > 0) {
                html += '<p><strong>Matière(s):</strong> ';
                teacherData.subjects.forEach((subject, index) => {
                    html += `${subject.name}${subject.type === 'main' ? ' (Principale)' : subject.type === 'secondary' ? ' (Secondaire)' : ''}`;
                    if (index < teacherData.subjects.length - 1) html += ', ';
                });
                html += '</p>';
            }
            
            display.innerHTML = html;
        }

        function addSubjectField() {
            const container = document.getElementById('subjectsContainer');
            const index = container.querySelectorAll('.form-row').length;
            
            const newRow = document.createElement('div');
            newRow.className = 'form-row';
            newRow.innerHTML = `
                <div class="form-col">
                    <div class="form-group">
                        <label><i class="fas fa-book"></i> Matière supplémentaire ${index}</label>
                        <input type="text" class="subject-field" placeholder="Nom de la matière">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> Heures/semaine</label>
                        <input type="number" class="subject-hours-field" min="0" max="20">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.form-row').remove(); syncAllData();">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(newRow);
            syncAllData();
        }

        // Fonction améliorée pour générer l'emploi du temps
        function generateTimetable() {
            const container = document.getElementById('timetableContainer');
            if (!container) return;
            
            // Récupérer les paramètres
            const planningClasses = document.getElementById('planningClasses')?.value || teacherData.professional.current_class || 'Non spécifié';
            const sessionDuration = parseInt(document.getElementById('sessionDuration')?.value) || 55;
            
            // Définir les jours et les horaires selon les spécifications
            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            
            // Horaires selon les spécifications : début à 7h00, séances de 55min, pause 9h45-10h10
            const timeSlots = [
                { start: '7:00', end: '7:55', isBreak: false },
                { start: '7:55', end: '8:50', isBreak: false },
                { start: '8:50', end: '9:45', isBreak: false },
                { start: '9:45', end: '10:10', isBreak: true, label: 'PAUSE' },
                { start: '10:10', end: '11:05', isBreak: false },
                { start: '11:05', end: '12:00', isBreak: false },
                { start: '15:00', end: '15:55', isBreak: false },
                { start: '15:55', end: '16:50', isBreak: false }
            ];
            
            // Récupérer les matières
            const subjects = teacherData.subjects;
            const mainSubject = subjects.find(s => s.type === 'main')?.name || 'Matière principale';
            const secondarySubject = subjects.find(s => s.type === 'secondary')?.name || 'Matière secondaire';
            
            let html = `
                <div class="current-class-display mb-20">
                    <h4><i class="fas fa-info-circle"></i> Informations de planification</h4>
                    <p><strong>Classe(s):</strong> ${planningClasses}</p>
                    <p><strong>Durée des séances:</strong> ${sessionDuration} minutes</p>
                    <p><strong>Total heures/semaine:</strong> ${teacherData.professional.weekly_hours || 0} heures</p>
                </div>
                <div class="timetable-container">
                    <table class="data-table" style="min-width: 800px;">
                        <thead>
                            <tr>
                                <th>Horaires</th>
            `;
            
            // En-têtes des jours
            days.forEach(day => {
                html += `<th>${day}</th>`;
            });
            
            html += `</tr></thead><tbody>`;
            
            // Lignes pour chaque créneau horaire
            timeSlots.forEach((slot, slotIndex) => {
                const timeLabel = slot.isBreak ? 
                    `<strong>${slot.label || 'PAUSE'}</strong><br><small>${slot.start} - ${slot.end}</small>` :
                    `${slot.start}<br>${slot.end}`;
                
                html += `<tr>`;
                html += `<td style="text-align: center; vertical-align: middle; min-width: 100px;">${timeLabel}</td>`;
                
                // Cellules pour chaque jour
                days.forEach((day, dayIndex) => {
                    const cellId = `cell_${dayIndex}_${slotIndex}`;
                    const savedValue = teacherData.teaching.timetable?.[cellId] || '';
                    
                    if (slot.isBreak) {
                        html += `<td class="timetable-cell break" style="text-align: center;">${slot.label || 'PAUSE'}</td>`;
                    } else {
                        html += `
                            <td>
                                <select id="${cellId}" class="timetable-cell-select" 
                                        onchange="updateTimetableCell('${cellId}', this.value)"
                                        style="width: 100%; height: 40px; border: 1px solid #dee2e6; border-radius: 4px; padding: 5px;">
                                    <option value="">-- Sélectionner --</option>
                                    <option value="${mainSubject}" ${savedValue === mainSubject ? 'selected' : ''}>${mainSubject} (Principale)</option>
                        `;
                        
                        if (secondarySubject && secondarySubject !== 'Matière secondaire') {
                            html += `<option value="${secondarySubject}" ${savedValue === secondarySubject ? 'selected' : ''}>${secondarySubject} (Secondaire)</option>`;
                        }
                        
                        // Autres matières supplémentaires
                        subjects.forEach(subject => {
                            if (subject.type === 'additional' && subject.name) {
                                html += `<option value="${subject.name}" ${savedValue === subject.name ? 'selected' : ''}>${subject.name}</option>`;
                            }
                        });
                        
                        html += `
                                    <option value="TP" ${savedValue === 'TP' ? 'selected' : ''}>TP/Laboratoire</option>
                                    <option value="REUNION" ${savedValue === 'REUNION' ? 'selected' : ''}>Réunion</option>
                                    <option value="AUTRE" ${savedValue === 'AUTRE' ? 'selected' : ''}>Autre activité</option>
                                    <option value="LIBRE" ${savedValue === 'LIBRE' ? 'selected' : ''}>Libre</option>
                                </select>
                            </td>
                        `;
                    }
                });
                
                html += `</tr>`;
            });
            
            html += `</tbody></table>`;
            
            // Légende
            html += `
                <div class="mt-20" style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                    <h5><i class="fas fa-key"></i> Légende</h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                        <div><span style="display: inline-block; width: 20px; height: 20px; background: #e3f2fd; border: 1px solid var(--primary-color); margin-right: 5px;"></span> Matière principale</div>
                        <div><span style="display: inline-block; width: 20px; height: 20px; background: #e8f5e9; border: 1px solid var(--success-color); margin-right: 5px;"></span> Matière secondaire</div>
                        <div><span style="display: inline-block; width: 20px; height: 20px; background: #fff3e0; border: 1px solid var(--warning-color); margin-right: 5px;"></span> TP/Laboratoire</div>
                        <div><span style="display: inline-block; width: 20px; height: 20px; background: #f3e5f5; border: 1px solid var(--info-color); margin-right: 5px;"></span> Réunion</div>
                        <div><span style="display: inline-block; width: 20px; height: 20px; background: #f5f5f5; border: 1px solid #dee2e6; margin-right: 5px;"></span> Libre</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Appliquer les styles aux cellules déjà sélectionnées
            Object.keys(teacherData.teaching.timetable || {}).forEach(cellId => {
                const cell = document.getElementById(cellId);
                if (cell) {
                    applyTimetableCellStyle(cellId, cell.value);
                }
            });
        }

        function updateTimetableCell(cellId, value) {
            if (!teacherData.teaching.timetable) {
                teacherData.teaching.timetable = {};
            }
            
            teacherData.teaching.timetable[cellId] = value;
            applyTimetableCellStyle(cellId, value);
            syncAllData();
        }

        function applyTimetableCellStyle(cellId, value) {
            const cell = document.getElementById(cellId);
            if (!cell) return;
            
            // Retirer toutes les classes de style
            cell.classList.remove('main', 'secondary', 'tp', 'meeting', 'free');
            
            // Appliquer le style approprié
            const mainSubject = teacherData.subjects.find(s => s.type === 'main')?.name;
            const secondarySubject = teacherData.subjects.find(s => s.type === 'secondary')?.name;
            
            if (value === mainSubject) {
                cell.classList.add('main');
                cell.style.backgroundColor = '#e3f2fd';
                cell.style.borderColor = 'var(--primary-color)';
            } else if (value === secondarySubject) {
                cell.classList.add('secondary');
                cell.style.backgroundColor = '#e8f5e9';
                cell.style.borderColor = 'var(--success-color)';
            } else if (value === 'TP') {
                cell.classList.add('tp');
                cell.style.backgroundColor = '#fff3e0';
                cell.style.borderColor = 'var(--warning-color)';
            } else if (value === 'REUNION') {
                cell.classList.add('meeting');
                cell.style.backgroundColor = '#f3e5f5';
                cell.style.borderColor = 'var(--info-color)';
            } else if (value === 'LIBRE' || value === '') {
                cell.classList.add('free');
                cell.style.backgroundColor = '#f5f5f5';
                cell.style.borderColor = '#dee2e6';
            } else {
                // Pour les autres matières
                cell.style.backgroundColor = '#e3f2fd';
                cell.style.borderColor = 'var(--primary-color)';
            }
        }

        function saveTimetable() {
            if (!teacherData.teaching.timetable || Object.keys(teacherData.teaching.timetable).length === 0) {
                showNotification('Aucun emploi du temps à sauvegarder', 'warning');
                return;
            }
            
            syncAllData();
            showNotification('Emploi du temps sauvegardé avec succès', 'success');
        }

        function loadTimetableData() {
            // Les données sont chargées automatiquement dans generateTimetable()
            if (teacherData.teaching.timetable && Object.keys(teacherData.teaching.timetable).length > 0) {
                // Appliquer les styles aux cellules existantes
                Object.keys(teacherData.teaching.timetable).forEach(cellId => {
                    const cell = document.getElementById(cellId);
                    if (cell) {
                        applyTimetableCellStyle(cellId, cell.value);
                    }
                });
            }
        }

        function printTimetable() {
            const timetableElement = document.querySelector('.timetable-container');
            if (!timetableElement) {
                showNotification('Générez d\'abord l\'emploi du temps', 'warning');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Emploi du temps - ${teacherData.personal.last_name} ${teacherData.personal.first_name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #3498db; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background-color: #3498db; color: white; padding: 10px; text-align: center; }
                        td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                        .break { background-color: #f8f9fa; font-style: italic; }
                        @media print { body { padding: 0; } }
                    </style>
                </head>
                <body>
                    <h1>Emploi du temps</h1>
                    <p><strong>Enseignant:</strong> ${teacherData.personal.last_name} ${teacherData.personal.first_name}</p>
                    <p><strong>Classe(s):</strong> ${document.getElementById('planningClasses')?.value || teacherData.professional.current_class}</p>
                    <p><strong>Année scolaire:</strong> ${document.getElementById('currentYear').textContent}</p>
                    ${timetableElement.innerHTML}
                    <script>window.print();</script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Les autres fonctions restent similaires mais avec la synchronisation améliorée

        // Gestion des données
        function saveToLocalStorage() {
            try {
                localStorage.setItem('teacherCompleteData', JSON.stringify(teacherData));
                addLog('Données sauvegardées');
            } catch (e) {
                console.error('Erreur de sauvegarde:', e);
                showNotification('Erreur lors de la sauvegarde', 'error');
            }
        }

        function loadSavedData() {
            try {
                const saved = localStorage.getItem('teacherCompleteData');
                if (saved) {
                    const data = JSON.parse(saved);
                    teacherData = {...teacherData, ...data};
                    populateForm();
                    showNotification('Données chargées depuis la sauvegarde', 'success');
                }
            } catch (error) {
                console.error('Erreur de chargement:', error);
            }
        }

        function populateForm() {
            // Établissement
            if (teacherData.establishment) {
                document.getElementById('establishmentName').value = teacherData.establishment.name || '';
                document.getElementById('establishmentType').value = teacherData.establishment.type || '';
                document.getElementById('establishmentAddress').value = teacherData.establishment.address || '';
                document.getElementById('establishmentPhone').value = teacherData.establishment.phone || '';
                document.getElementById('establishmentEmail').value = teacherData.establishment.email || '';
                document.getElementById('establishmentWebsite').value = teacherData.establishment.website || '';
            }
            
            // Personnelles
            if (teacherData.personal) {
                document.getElementById('lastName').value = teacherData.personal.last_name || '';
                document.getElementById('firstName').value = teacherData.personal.first_name || '';
                document.getElementById('gender').value = teacherData.personal.gender || '';
                document.getElementById('birthDate').value = teacherData.personal.birth_date || '';
                document.getElementById('birthMonth').value = teacherData.personal.birth_month || '';
                document.getElementById('birthPlace').value = teacherData.personal.birth_place || '';
                document.getElementById('nationality').value = teacherData.personal.nationality || '';
                document.getElementById('address').value = teacherData.personal.address || '';
                document.getElementById('personalPhone').value = teacherData.personal.personal_phone || '';
                document.getElementById('personalEmail').value = teacherData.personal.personal_email || '';
                document.getElementById('cin').value = teacherData.personal.cin || '';
                document.getElementById('maritalStatus').value = teacherData.personal.marital_status || '';
                document.getElementById('childrenNumber').value = teacherData.personal.children_number || '';
            }
            
            // Professionnelles
            if (teacherData.professional) {
                document.getElementById('matricule').value = teacherData.professional.matricule || '';
                document.getElementById('position').value = teacherData.professional.position || '';
                document.getElementById('grade').value = teacherData.professional.grade || '';
                document.getElementById('professionalCategory').value = teacherData.professional.professional_category || '';
                document.getElementById('engagementDate').value = teacherData.professional.engagement_date || '';
                document.getElementById('regionServiceDate').value = teacherData.professional.region_service_date || '';
                document.getElementById('inspectionServiceDate').value = teacherData.professional.inspection_service_date || '';
                document.getElementById('currentClass').value = teacherData.professional.current_class || '';
                document.getElementById('weeklyHours').value = teacherData.professional.weekly_hours || '';
                
                // Calculer les champs dérivés
                calculateServiceYears('regionServiceDate', 'yearsInRegion');
                calculateServiceYears('inspectionServiceDate', 'yearsInInspection');
                calculateRetirementDate();
            }
            
            // Matières
            if (teacherData.subjects && teacherData.subjects.length > 0) {
                const mainSubject = teacherData.subjects.find(s => s.type === 'main');
                const secondarySubject = teacherData.subjects.find(s => s.type === 'secondary');
                const additionalSubjects = teacherData.subjects.filter(s => s.type === 'additional');
                
                if (mainSubject) document.getElementById('mainSubject').value = mainSubject.name;
                if (secondarySubject) document.getElementById('secondarySubject').value = secondarySubject.name;
                
                // Ajouter les matières supplémentaires
                additionalSubjects.forEach((subject, index) => {
                    if (index === 0) addSubjectField();
                    const rows = document.querySelectorAll('#subjectsContainer .form-row');
                    if (rows.length > index + 1) {
                        const row = rows[index + 1];
                        const subjectInput = row.querySelector('.subject-field');
                        const hoursInput = row.querySelector('.subject-hours-field');
                        if (subjectInput) subjectInput.value = subject.name;
                        if (hoursInput) hoursInput.value = subject.hours;
                    }
                });
            }
            
            // Données de planification
            if (teacherData.teaching.planningClasses) {
                const planningClassesInput = document.getElementById('planningClasses');
                if (planningClassesInput) {
                    planningClassesInput.value = teacherData.teaching.planningClasses;
                }
            }
            
            updateUI();
        }

        function updateUI() {
            updateSchoolName();
            updateSyncedInfoDisplay();
            updateSubjectsSelector();
            updateClassFilters();
            updateDashboard();
            updateBackupHistory();
            updateActivityLogs();
        }

        function updateTabUI(tabId) {
            switch(tabId) {
                case 'tab2':
                    updateSyncedInfoDisplay();
                    loadSubTabData(currentSubTab);
                    break;
                case 'tab7':
                    updateDashboard();
                    break;
            }
        }

        // Les autres fonctions (addNewLesson, loadLessons, etc.) restent similaires
        // mais avec la synchronisation améliorée

        function addNewLesson() {
            const lessonId = `lesson_${Date.now()}`;
            const currentDate = new Date().toISOString().split('T')[0];
            const mainSubject = teacherData.subjects.find(s => s.type === 'main')?.name || '';
            const currentClass = teacherData.professional.current_class || '';
            
            const lesson = {
                id: lessonId,
                title: '',
                date: currentDate,
                duration: 55,
                subject: mainSubject,
                class: currentClass,
                objectives: '',
                content: '',
                materials: '',
                difficulties: '',
                solutions: '',
                createdAt: new Date().toISOString()
            };
            
            if (!teacherData.teaching.lessons) {
                teacherData.teaching.lessons = [];
            }
            
            teacherData.teaching.lessons.push(lesson);
            syncAllData();
            
            // Recharger l'affichage des leçons
            loadLessons();
            showNotification('Nouvelle leçon créée avec les informations synchronisées', 'success');
        }

        function loadLessons() {
            const container = document.getElementById('lessonsContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (teacherData.teaching.lessons && teacherData.teaching.lessons.length > 0) {
                teacherData.teaching.lessons.forEach(lesson => {
                    const lessonElement = document.createElement('div');
                    lessonElement.className = 'lesson-container';
                    lessonElement.innerHTML = `
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label><i class="fas fa-book"></i> Titre de la leçon</label>
                                    <input type="text" value="${lesson.title || ''}" 
                                           onchange="updateLessonField('${lesson.id}', 'title', this.value)" 
                                           placeholder="Titre de la leçon">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label><i class="fas fa-calendar"></i> Date</label>
                                    <input type="date" value="${lesson.date}" 
                                           onchange="updateLessonField('${lesson.id}', 'date', this.value)">
                                </div>
                            </div>
                        </div>
                        <div class="section-actions">
                            <button type="button" class="btn btn-success btn-sm" onclick="saveLesson('${lesson.id}')">
                                <i class="fas fa-save"></i> Enregistrer
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteLesson('${lesson.id}')">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </div>
                    `;
                    container.appendChild(lessonElement);
                });
            }
        }

        function updateLessonField(lessonId, field, value) {
            const lesson = teacherData.teaching.lessons?.find(l => l.id === lessonId);
            if (lesson) {
                lesson[field] = value;
                syncAllData();
            }
        }

        function saveLesson(lessonId) {
            showNotification('Leçon sauvegardée', 'success');
            syncAllData();
        }

        function deleteLesson(lessonId) {
            if (confirm('Voulez-vous vraiment supprimer cette leçon ?')) {
                teacherData.teaching.lessons = teacherData.teaching.lessons?.filter(l => l.id !== lessonId) || [];
                syncAllData();
                loadLessons();
                showNotification('Leçon supprimée', 'success');
            }
        }

        // Dashboard
        function updateDashboard() {
            updateProfileSummary();
            updateRecentActivity();
            updateDetailedStats();
        }

        function updateProfileSummary() {
            const container = document.getElementById('profileSummary');
            if (!container) return;
            
            const age = calculateAge(teacherData.personal.birth_date);
            
            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div>Enseignant</div>
                        <div class="stat-value">${teacherData.personal.first_name?.charAt(0) || ''}. ${teacherData.personal.last_name || ''}</div>
                    </div>
                    <div class="stat-card">
                        <div>Matières</div>
                        <div class="stat-value">${teacherData.subjects.length}</div>
                    </div>
                    <div class="stat-card">
                        <div>Âge</div>
                        <div class="stat-value">${age}</div>
                    </div>
                    <div class="stat-card">
                        <div>Heures/sem.</div>
                        <div class="stat-value">${teacherData.professional.weekly_hours || 0}</div>
                    </div>
                </div>
            `;
        }

        function calculateAge(birthDate) {
            if (!birthDate) return 'N/A';
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        // Les autres fonctions (updateRecentActivity, updateDetailedStats, etc.) 
        // restent similaires avec la synchronisation améliorée

        // Gestion du formulaire
        function handleSubmit(event) {
            event.preventDefault();
            
            if (validateForm()) {
                backupData();
                showNotification('Toutes les données ont été sauvegardées avec succès', 'success');
            } else {
                showNotification('Veuillez remplir tous les champs obligatoires', 'error');
            }
        }

        function validateForm() {
            const requiredFields = [
                'establishmentName',
                'lastName',
                'firstName',
                'birthDate',
                'birthPlace',
                'matricule',
                'mainSubject',
                'position',
                'engagementDate',
                'regionServiceDate',
                'inspectionServiceDate',
                'currentClass'
            ];
            
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && !field.value.trim()) {
                    isValid = false;
                    field.style.borderColor = 'var(--danger-color)';
                    
                    setTimeout(() => {
                        if (field) field.style.borderColor = '';
                    }, 2000);
                }
            });
            
            return isValid;
        }

        // Fonctions utilitaires
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');
            const icon = document.getElementById('notificationIcon');
            
            if (!notification || !messageEl || !icon) return;
            
            messageEl.textContent = message;
            notification.className = 'notification';
            icon.className = 'fas';
            
            switch(type) {
                case 'success':
                    notification.classList.add('show');
                    icon.classList.add('fa-check-circle');
                    break;
                case 'error':
                    notification.classList.add('show', 'error');
                    icon.classList.add('fa-exclamation-circle');
                    break;
                case 'warning':
                    notification.classList.add('show', 'warning');
                    icon.classList.add('fa-exclamation-triangle');
                    break;
                case 'info':
                    notification.classList.add('show', 'info');
                    icon.classList.add('fa-info-circle');
                    break;
            }
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
            
            addLog(message);
        }

        function addLog(message) {
            try {
                const logs = JSON.parse(localStorage.getItem('logs') || '[]');
                logs.push({
                    timestamp: new Date().toISOString(),
                    message: message,
                    tab: currentTab,
                    subtab: currentSubTab
                });
                localStorage.setItem('logs', JSON.stringify(logs.slice(-100)));
                updateActivityLogs();
            } catch (error) {
                console.error('Erreur d\'ajout de log:', error);
            }
        }

        // Initialisation finale
        window.onload = function() {
            setTimeout(() => {
                syncAllData();
            }, 100);
        };

    </script>
</body>
</html>
