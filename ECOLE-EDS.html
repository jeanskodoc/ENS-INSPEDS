<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche Administrative Enseignant - Gestion Pédagogique Complète</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Variables CSS */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #9b59b6;
            --dark-color: #2c3e50;
            --light-color: #f5f5f5;
            --gray-color: #7f8c8d;
            --border-radius: 10px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        /* Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-color);
            padding: 20px;
            color: var(--dark-color);
            line-height: 1.6;
        }

        /* Container principal */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        /* Header */
        header {
            text-align: center;
            padding: 25px 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            position: relative;
        }

        .school-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .school-name {
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .academic-year {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        header h1 {
            color: white;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        /* Navigation */
        .tabs-container {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }

        .tabs {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            min-width: 600px;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-color);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .tab:hover {
            background-color: #e9ecef;
            color: var(--dark-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background-color: white;
        }

        /* Contenu des onglets */
        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        /* Sections */
        .form-section {
            margin-bottom: 30px;
            padding: 25px;
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .form-section h2 {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            margin: -25px -25px 25px -25px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        /* Formulaires */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-col {
            flex: 1;
            min-width: 250px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="file"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Éléments dynamiques */
        .dynamic-item {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            position: relative;
            transition: var(--transition);
        }

        .dynamic-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        /* Matières et pédagogie */
        .subject-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #dee2e6;
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }

        .theme-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .lesson-container, .tp-container, .evaluation-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 18px;
            margin-bottom: 15px;
            border-left: 4px solid var(--info-color);
        }

        .tp-container {
            border-left-color: var(--warning-color);
        }

        .evaluation-container {
            border-left-color: var(--success-color);
        }

        .project-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 18px;
            margin-bottom: 15px;
            border-left: 4px solid var(--info-color);
        }

        .activity-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 18px;
            margin-bottom: 15px;
            border-left: 4px solid var(--warning-color);
        }

        .meeting-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 18px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        /* Boutons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--success-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #d68910;
            transform: translateY(-2px);
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
        }

        .btn-light {
            background-color: #f8f9fa;
            color: var(--dark-color);
            border: 1px solid #dee2e6;
        }

        .btn-light:hover {
            background-color: #e9ecef;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .btn-xs {
            padding: 5px 8px;
            font-size: 0.8rem;
        }

        /* Actions */
        .form-actions {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .tab-actions {
            display: flex;
            justify-content: flex-start;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding: 15px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .section-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Navigation */
        .btn-retour {
            padding: 10px 20px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 0 20px 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .btn-retour:hover {
            background-color: #e0e0e0;
        }

        /* Tableaux */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .data-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        /* Onglets secondaires */
        .sub-tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 25px;
        }

        .sub-tab {
            padding: 12px 25px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-color);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }

        .sub-tab:hover {
            color: var(--dark-color);
        }

        .sub-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        /* Sous-contenus des onglets */
        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        /* Indicateurs */
        .counter {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            font-size: 0.8rem;
            margin-right: 8px;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 5px;
        }

        .badge-primary {
            background-color: #e3f2fd;
            color: var(--primary-color);
        }

        .badge-success {
            background-color: #e8f5e9;
            color: var(--success-color);
        }

        .badge-warning {
            background-color: #fff3e0;
            color: var(--warning-color);
        }

        .badge-danger {
            background-color: #ffebee;
            color: var(--danger-color);
        }

        .badge-info {
            background-color: #f3e5f5;
            color: var(--info-color);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-color);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success-color);
            color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        /* Loader */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }

        .loader.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Charts */
        .chart-placeholder {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .dashboard-card h3 {
            margin-bottom: 15px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            height: 200px;
            margin: 20px 0;
            position: relative;
        }

        /* Bouton Accueil */
        .btn-accueil {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-accueil:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4);
            color: white;
            text-decoration: none;
        }
        
        /* Correction: Ajout du style manquant */
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            position: relative;
            min-width: 200px;
        }
        
        .search-box i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }
        
        .search-box input {
            padding-left: 35px;
        }
        
        /* Correction: Ajout du style pour .timeline */
        .timeline {
            border-left: 2px solid var(--primary-color);
            padding-left: 20px;
            margin-left: 10px;
        }
        
        .timeline-item {
            margin-bottom: 20px;
            position: relative;
        }
        
        .timeline-item:before {
            content: '';
            position: absolute;
            left: -26px;
            top: 5px;
            width: 10px;
            height: 10px;
            background-color: var(--primary-color);
            border-radius: 50%;
        }
        
        /* Style pour la classe courante */
        .current-class-display {
            background: #e8f5e9;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success-color);
        }
        
        .current-class-display h4 {
            color: var(--success-color);
            margin-bottom: 5px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 0;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .form-section {
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions, .tab-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .subject-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .sub-tabs {
                flex-wrap: wrap;
            }
            
            .sub-tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .tab-content {
                padding: 15px;
            }
            
            .form-section {
                padding: 15px;
            }
            
            header {
                padding: 20px;
            }
            
            header h1 {
                font-size: 1.4rem;
            }
            
            .school-info {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Print */
        @media print {
            .btn-retour, .form-actions, button, .tabs-container, .tab-actions,
            .section-actions, .modal, .notification {
                display: none !important;
            }
            
            body {
                background-color: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
            }
            
            .tab-content {
                display: block !important;
                padding: 0;
            }
            
            .form-section {
                break-inside: avoid;
            }
        }

        /* Utilitaires */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-30 {
            margin-bottom: 30px;
        }

        .mt-30 {
            margin-top: 30px;
        }

        .d-flex {
            display: flex;
        }

        .align-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-10 {
            gap: 10px;
        }

        .gap-15 {
            gap: 15px;
        }

        .gap-20 {
            gap: 20px;
        }

        .w-100 {
            width: 100%;
        }

        /* Améliorations spécifiques */
        .rating-stars {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .rating-stars i {
            color: #ffd700;
            cursor: pointer;
        }

        .progress-bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress {
            height: 100%;
            background: var(--success-color);
            transition: width 0.3s;
        }

        .calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin: 20px 0;
        }

        .calendar-day {
            padding: 10px;
            border: 1px solid #e9ecef;
            text-align: center;
            cursor: pointer;
        }

        .calendar-day.active {
            background: var(--primary-color);
            color: white;
        }

        .attachment-list {
            margin: 15px 0;
        }

        .attachment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
    </div>

    <!-- Modal générique -->
    <div class="modal" id="genericModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle"></h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle" id="notificationIcon"></i>
        <span id="notificationMessage"></span>
    </div>

    <!-- Bouton retour -->
    <button class="btn-retour" onclick="history.back()">
        <i class="fas fa-arrow-left"></i> Retour
    </button>

    <!-- Bouton Accueil -->
    <a href="index.html" class="btn btn-accueil">
        <i class="fas fa-home"></i> Accueil
    </a>
    
    <!-- Container principal -->
    <div class="container">
        <header>
            <div class="school-info">
                <div class="school-name">
                    <i class="fas fa-school"></i>
                    <span id="schoolName">Établissement Scolaire</span>
                </div>
                <div class="academic-year">
                    <i class="fas fa-calendar-alt"></i>
                    Année scolaire: <span id="currentYear"></span>
                </div>
            </div>
            <h1><i class="fas fa-id-card"></i> FICHE ADMINISTRATIVE DE L'ENSEIGNANT</h1>
            <p>Système complet de gestion pédagogique et administrative</p>
        </header>

        <!-- Navigation principale -->
        <div class="tabs-container">
            <ul class="tabs">
                <li class="tab active" data-tab="tab1">
                    <i class="fas fa-user-tie"></i> Informations Générales
                </li>
                <li class="tab" data-tab="tab2">
                    <i class="fas fa-chalkboard-teacher"></i> Enseignement & Pédagogie
                </li>
                <li class="tab" data-tab="tab3">
                    <i class="fas fa-chart-line"></i> Évaluations & Statistiques
                </li>
                <li class="tab" data-tab="tab4">
                    <i class="fas fa-project-diagram"></i> Projets & Activités
                </li>
                <li class="tab" data-tab="tab5">
                    <i class="fas fa-database"></i> Données & Archives
                </li>
                <li class="tab" data-tab="tab6">
                    <i class="fas fa-tachometer-alt"></i> Tableau de bord
                </li>
            </ul>
        </div>

        <form id="teacherForm">
            <!-- Onglet 1: Informations Générales -->
            <div id="tab1" class="tab-content active">
                <div class="tab-actions">
                    <button type="button" class="btn btn-info" onclick="exportJSON('tab1')">
                        <i class="fas fa-file-export"></i> Exporter
                    </button>
                    <button type="button" class="btn btn-warning" onclick="importJSON('tab1')">
                        <i class="fas fa-file-import"></i> Importer
                    </button>
                    <button type="button" class="btn btn-light" onclick="generateQRCode()">
                        <i class="fas fa-qrcode"></i> QR Code
                    </button>
                </div>

                <!-- Établissement -->
                <div class="form-section">
                    <h2><i class="fas fa-university"></i> I. INFORMATION DE L'ÉTABLISSEMENT</h2>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="establishmentName"><i class="fas fa-school"></i> Nom de l'établissement *</label>
                                <input type="text" id="establishmentName" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="establishmentType"><i class="fas fa-building"></i> Type d'établissement</label>
                                <select id="establishmentType">
                                    <option value="">Sélectionner</option>
                                    <option value="college">Collège</option>
                                    <option value="lycee">Lycée</option>
                                    <option value="lycee_pro">Lycée Professionnel</option>
                                    <option value="lycee_tech">Lycée Technique</option>
                                    <option value="ecole">École Primaire</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="establishmentAddress"><i class="fas fa-map-marker-alt"></i> Adresse</label>
                                <input type="text" id="establishmentAddress">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="establishmentPhone"><i class="fas fa-phone"></i> Téléphone</label>
                                <input type="tel" id="establishmentPhone">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="establishmentEmail"><i class="fas fa-envelope"></i> Email</label>
                                <input type="email" id="establishmentEmail">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="establishmentWebsite"><i class="fas fa-globe"></i> Site web</label>
                                <input type="text" id="establishmentWebsite">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informations personnelles -->
                <div class="form-section">
                    <h2><i class="fas fa-user"></i> II. INFORMATIONS PERSONNELLES</h2>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="lastName"><i class="fas fa-signature"></i> Nom *</label>
                                <input type="text" id="lastName" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="firstName"><i class="fas fa-user"></i> Prénoms *</label>
                                <input type="text" id="firstName" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="gender"><i class="fas fa-venus-mars"></i> Sexe</label>
                                <select id="gender">
                                    <option value="">Sélectionner</option>
                                    <option value="M">Masculin</option>
                                    <option value="F">Féminin</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="birthDate"><i class="fas fa-birthday-cake"></i> Date de naissance *</label>
                                <input type="date" id="birthDate" required onchange="calculateRetirementDate()">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="birthMonth"><i class="fas fa-calendar"></i> Mois de naissance</label>
                                <select id="birthMonth" onchange="calculateRetirementDate()">
                                    <option value="">Sélectionner</option>
                                    <option value="1">Janvier</option>
                                    <option value="2">Février</option>
                                    <option value="3">Mars</option>
                                    <option value="4">Avril</option>
                                    <option value="5">Mai</option>
                                    <option value="6">Juin</option>
                                    <option value="7">Juillet</option>
                                    <option value="8">Août</option>
                                    <option value="9">Septembre</option>
                                    <option value="10">Octobre</option>
                                    <option value="11">Novembre</option>
                                    <option value="12">Décembre</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="birthPlace"><i class="fas fa-map-marker-alt"></i> Lieu de naissance *</label>
                                <input type="text" id="birthPlace" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="nationality"><i class="fas fa-flag"></i> Nationalité</label>
                                <input type="text" id="nationality">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="address"><i class="fas fa-home"></i> Adresse personnelle</label>
                                <input type="text" id="address">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="personalPhone"><i class="fas fa-mobile-alt"></i> Téléphone personnel</label>
                                <input type="tel" id="personalPhone">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="personalEmail"><i class="fas fa-envelope"></i> Email personnel</label>
                                <input type="email" id="personalEmail">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="cin"><i class="fas fa-id-card"></i> CIN/Passport</label>
                                <input type="text" id="cin">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="maritalStatus"><i class="fas fa-heart"></i> Situation familiale</label>
                                <select id="maritalStatus">
                                    <option value="">Sélectionner</option>
                                    <option value="celibataire">Célibataire</option>
                                    <option value="marie">Marié(e)</option>
                                    <option value="divorce">Divorcé(e)</option>
                                    <option value="veuf">Veuf/Veuve</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="childrenNumber"><i class="fas fa-child"></i> Nombre d'enfants</label>
                                <input type="number" id="childrenNumber" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informations professionnelles -->
                <div class="form-section">
                    <h2><i class="fas fa-briefcase"></i> III. INFORMATIONS PROFESSIONNELLES</h2>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="matricule"><i class="fas fa-id-badge"></i> Numéro matricule *</label>
                                <input type="text" id="matricule" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="position"><i class="fas fa-user-tag"></i> Fonction *</label>
                                <select id="position" required>
                                    <option value="">Sélectionner</option>
                                    <option value="professeur">Professeur</option>
                                    <option value="prof_agrege">Professeur Agrégé</option>
                                    <option value="prof_certifie">Professeur Certifié</option>
                                    <option value="charge_cours">Chargé de Cours</option>
                                    <option value="vacataire">Vacataire</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="grade"><i class="fas fa-award"></i> Grade</label>
                                <input type="text" id="grade">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="professionalCategory"><i class="fas fa-layer-group"></i> Catégorie professionnelle</label>
                                <select id="professionalCategory" onchange="calculateRetirementDate()">
                                    <option value="">Sélectionner</option>
                                    <option value="A1">A1 (Cadres supérieurs)</option>
                                    <option value="A2">A2 (Cadres)</option>
                                    <option value="B">B (Techniciens supérieurs)</option>
                                    <option value="C">C (Techniciens)</option>
                                    <option value="D">D (Adjoints techniques)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="engagementDate"><i class="fas fa-handshake"></i> Date d'engagement *</label>
                                <input type="date" id="engagementDate" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="regionServiceDate"><i class="fas fa-calendar-alt"></i> Date de prise de service dans la région *</label>
                                <input type="date" id="regionServiceDate" required onchange="calculateServiceYears('regionServiceDate', 'yearsInRegion')">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="inspectionServiceDate"><i class="fas fa-calendar-check"></i> Date de prise de service dans l'inspection *</label>
                                <input type="date" id="inspectionServiceDate" required onchange="calculateServiceYears('inspectionServiceDate', 'yearsInInspection')">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="yearsInRegion"><i class="fas fa-history"></i> Années dans la région</label>
                                <input type="number" id="yearsInRegion" readonly>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="yearsInInspection"><i class="fas fa-clock"></i> Années dans l'inspection</label>
                                <input type="number" id="yearsInInspection" readonly>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="retirementDate"><i class="fas fa-umbrella-beach"></i> Date de retraite</label>
                                <input type="date" id="retirementDate" readonly>
                            </div>
                        </div>
                    </div>
                    <!-- Détails du calcul de la retraite -->
                    <div class="form-row">
                        <div class="form-col">
                            <div id="retirementDetails">
                                <!-- Les détails du calcul s'afficheront ici -->
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="currentClass"><i class="fas fa-chalkboard"></i> Classe(s) actuelle(s)</label>
                                <input type="text" id="currentClass" placeholder="Ex: 3ème A, Terminale C...">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="weeklyHours"><i class="fas fa-clock"></i> Heures/semaine</label>
                                <input type="number" id="weeklyHours" min="0" max="40">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Matières enseignées -->
                <div class="form-section">
                    <h2><i class="fas fa-book"></i> IV. MATIÈRES ENSEIGNÉES</h2>
                    <div id="subjectsContainer">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="mainSubject"><i class="fas fa-star"></i> Matière principale *</label>
                                    <input type="text" id="mainSubject" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="secondarySubject"><i class="fas fa-star-half-alt"></i> Matière secondaire</label>
                                    <input type="text" id="secondarySubject">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addSubjectField()">
                        <i class="fas fa-plus"></i> Ajouter une matière supplémentaire
                    </button>
                </div>
            </div>

            <!-- Onglet 2: Enseignement & Pédagogie -->
            <div id="tab2" class="tab-content">
                <!-- Navigation secondaire -->
                <div class="sub-tabs mb-30">
                    <div class="sub-tab active" data-subtab="planning">Planning & Emploi du temps</div>
                    <div class="sub-tab" data-subtab="lessons">Leçons & Séances</div>
                    <div class="sub-tab" data-subtab="tp">TP & Expériences</div>
                    <div class="sub-tab" data-subtab="resources">Ressources & Supports</div>
                </div>

                <div class="tab-actions">
                    <button type="button" class="btn btn-info" onclick="exportJSON('tab2')">
                        <i class="fas fa-file-export"></i> Exporter données pédagogiques
                    </button>
                    <button type="button" class="btn btn-warning" onclick="importJSON('tab2')">
                        <i class="fas fa-file-import"></i> Importer données
                    </button>
                    <button type="button" class="btn btn-light" onclick="generatePlanningPDF()">
                        <i class="fas fa-file-pdf"></i> Générer PDF
                    </button>
                </div>

                <!-- Affichage des informations synchronisées -->
                <div class="form-section">
                    <h2><i class="fas fa-sync-alt"></i> INFORMATIONS SYNCHRONISÉES</h2>
                    <div id="syncedInfoDisplay" class="current-class-display">
                        <!-- Les informations synchronisées s'afficheront ici -->
                    </div>
                </div>

                <!-- Contenu des sous-onglets -->
                <div class="sub-tab-content active" data-subtab="planning">
                    <div class="form-section">
                        <h2><i class="fas fa-calendar-alt"></i> EMPLOI DU TEMPS HEBDOMADAIRE</h2>
                        <div class="form-group">
                            <label><i class="fas fa-info-circle"></i> Sélectionnez la matière et les créneaux</label>
                            <div id="timetableContainer">
                                <!-- L'emploi du temps sera généré dynamiquement -->
                            </div>
                            <button type="button" class="btn btn-secondary mt-20" onclick="generateTimetable()">
                                <i class="fas fa-table"></i> Générer l'emploi du temps
                            </button>
                        </div>
                    </div>
                </div>

                <div class="sub-tab-content" data-subtab="lessons">
                    <div class="form-section">
                        <h2><i class="fas fa-chalkboard"></i> GESTION DES LEÇONS</h2>
                        <div class="filter-bar">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" placeholder="Rechercher une leçon..." id="lessonSearch">
                            </div>
                            <select id="lessonFilterSubject">
                                <option value="">Toutes les matières</option>
                            </select>
                            <select id="lessonFilterClass">
                                <option value="">Toutes les classes</option>
                            </select>
                        </div>
                        <div id="lessonsContainer">
                            <!-- Liste des leçons -->
                        </div>
                        <button type="button" class="btn btn-primary" onclick="addNewLesson()">
                            <i class="fas fa-plus-circle"></i> Nouvelle leçon
                        </button>
                    </div>
                </div>

                <div class="sub-tab-content" data-subtab="tp">
                    <div class="form-section">
                        <h2><i class="fas fa-flask"></i> TRAVAUX PRATIQUES & EXPÉRIENCES</h2>
                        <div id="tpContainer">
                            <!-- TP seront ajoutés ici -->
                        </div>
                        <button type="button" class="btn btn-primary" onclick="addNewTP()">
                            <i class="fas fa-plus-circle"></i> Nouveau TP/Expérience
                        </button>
                    </div>
                </div>

                <div class="sub-tab-content" data-subtab="resources">
                    <div class="form-section">
                        <h2><i class="fas fa-folder-open"></i> RESSOURCES PÉDAGOGIQUES</h2>
                        <div class="form-group">
                            <label><i class="fas fa-upload"></i> Ajouter des ressources</label>
                            <input type="file" id="resourceUpload" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.jpg,.png,.mp4,.mp3">
                            <div class="attachment-list" id="resourcesList">
                                <!-- Liste des ressources -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet 3: Évaluations & Statistiques -->
            <div id="tab3" class="tab-content">
                <div class="tab-actions">
                    <button type="button" class="btn btn-info" onclick="exportJSON('tab3')">
                        <i class="fas fa-file-export"></i> Exporter
                    </button>
                    <button type="button" class="btn btn-warning" onclick="importJSON('tab3')">
                        <i class="fas fa-file-import"></i> Importer
                    </button>
                    <button type="button" class="btn btn-light" onclick="showStatistics()">
                        <i class="fas fa-chart-bar"></i> Statistiques
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="addEvaluation()">
                        <i class="fas fa-plus"></i> Ajouter Évaluation
                    </button>
                </div>

                <!-- Statistiques de synthèse -->
                <div class="form-section">
                    <h2><i class="fas fa-chart-pie"></i> STATISTIQUES DE SYNTHÈSE</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div><i class="fas fa-clipboard-check"></i> Évaluations</div>
                            <div class="stat-value" id="totalEvaluations">0</div>
                            <div>Total effectuées</div>
                        </div>
                        <div class="stat-card">
                            <div><i class="fas fa-users"></i> Élèves évalués</div>
                            <div class="stat-value" id="totalStudents">0</div>
                            <div>Élèves concernés</div>
                        </div>
                        <div class="stat-card">
                            <div><i class="fas fa-percentage"></i> Moyenne générale</div>
                            <div class="stat-value" id="averageScore">0.0</div>
                            <div>/20</div>
                        </div>
                        <div class="stat-card">
                            <div><i class="fas fa-trophy"></i> Meilleure note</div>
                            <div class="stat-value" id="bestScore">0</div>
                            <div>/20</div>
                        </div>
                    </div>
                </div>

                <!-- Graphiques -->
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3><i class="fas fa-chart-line"></i> Performances des élèves</h3>
                        <div class="chart-container">
                            <div class="chart-placeholder" id="performanceChart">
                                Graphique des performances
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <h3><i class="fas fa-tasks"></i> Progression du programme</h3>
                        <div class="chart-container">
                            <div class="chart-placeholder" id="progressChart">
                                Graphique de progression
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtres pour les évaluations -->
                <div class="form-section">
                    <h2><i class="fas fa-filter"></i> FILTRES DE RECHERCHE</h2>
                    <div class="filter-bar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Rechercher une évaluation..." id="evaluationSearch">
                        </div>
                        <select id="evaluationFilterSubject">
                            <option value="">Toutes les matières</option>
                        </select>
                        <select id="evaluationFilterClass">
                            <option value="">Toutes les classes</option>
                        </select>
                        <select id="evaluationFilterType">
                            <option value="">Tous les types</option>
                            <option value="examen">Examen</option>
                            <option value="devoir">Devoir</option>
                            <option value="oral">Oral</option>
                            <option value="tp">TP</option>
                            <option value="projet">Projet</option>
                        </select>
                    </div>
                </div>

                <!-- Liste des évaluations -->
                <div class="form-section">
                    <h2><i class="fas fa-clipboard-check"></i> LISTE DES ÉVALUATIONS</h2>
                    <div id="evaluationsContainer">
                        <!-- Les évaluations seront ajoutées ici dynamiquement -->
                        <div class="text-center" id="noEvaluationsMessage">
                            <p>Aucune évaluation enregistrée</p>
                            <button type="button" class="btn btn-primary mt-20" onclick="addEvaluation()">
                                <i class="fas fa-plus-circle"></i> Créer votre première évaluation
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statistiques détaillées -->
                <div class="form-section">
                    <h2><i class="fas fa-chart-bar"></i> STATISTIQUES DÉTAILLÉES</h2>
                    <div id="detailedEvaluationStats">
                        <!-- Statistiques détaillées seront ajoutées ici -->
                    </div>
                </div>
            </div>

            <!-- Onglet 4: Projets & Activités -->
            <div id="tab4" class="tab-content">
                <div class="tab-actions">
                    <button type="button" class="btn btn-info" onclick="exportJSON('tab4')">
                        <i class="fas fa-file-export"></i> Exporter
                    </button>
                    <button type="button" class="btn btn-warning" onclick="importJSON('tab4')">
                        <i class="fas fa-file-import"></i> Importer
                    </button>
                    <button type="button" class="btn btn-primary" onclick="addProject()">
                        <i class="fas fa-plus"></i> Nouveau projet
                    </button>
                    <button type="button" class="btn btn-warning" onclick="addActivity()">
                        <i class="fas fa-plus"></i> Nouvelle activité
                    </button>
                    <button type="button" class="btn btn-info" onclick="addMeeting()">
                        <i class="fas fa-plus"></i> Nouvelle réunion
                    </button>
                </div>

                <!-- Statistiques des projets et activités -->
                <div class="stats-grid mb-30">
                    <div class="stat-card">
                        <div><i class="fas fa-project-diagram"></i> Projets</div>
                        <div class="stat-value" id="totalProjects">0</div>
                        <div>En cours et terminés</div>
                    </div>
                    <div class="stat-card">
                        <div><i class="fas fa-futbol"></i> Activités</div>
                        <div class="stat-value" id="totalActivities">0</div>
                        <div>Extrascolaires</div>
                    </div>
                    <div class="stat-card">
                        <div><i class="fas fa-users"></i> Réunions</div>
                        <div class="stat-value" id="totalMeetings">0</div>
                        <div>Conseils et réunions</div>
                    </div>
                    <div class="stat-card">
                        <div><i class="fas fa-calendar-check"></i> Total</div>
                        <div class="stat-value" id="totalEngagements">0</div>
                        <div>Engagements</div>
                    </div>
                </div>

                <!-- Navigation secondaire -->
                <div class="sub-tabs mb-30">
                    <div class="sub-tab active" data-subtab="projects">Projets Pédagogiques</div>
                    <div class="sub-tab" data-subtab="activities">Activités Extrascolaires</div>
                    <div class="sub-tab" data-subtab="meetings">Réunions & Conseils</div>
                    <div class="sub-tab" data-subtab="calendar">Calendrier</div>
                </div>

                <!-- Sous-contenu des onglets secondaires -->
                <div class="sub-tab-content active" data-subtab="projects">
                    <div class="form-section">
                        <h2><i class="fas fa-project-diagram"></i> PROJETS PÉDAGOGIQUES</h2>
                        <div class="filter-bar">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" placeholder="Rechercher un projet..." id="projectSearch">
                            </div>
                            <select id="projectFilterStatus">
                                <option value="">Tous les statuts</option>
                                <option value="planning">En planification</option>
                                <option value="in_progress">En cours</option>
                                <option value="completed">Terminé</option>
                                <option value="cancelled">Annulé</option>
                            </select>
                        </div>
                        <div id="projectsContainer">
                            <!-- Les projets seront ajoutés ici -->
                            <div class="text-center" id="noProjectsMessage">
                                <p>Aucun projet enregistré</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sub-tab-content" data-subtab="activities">
                    <div class="form-section">
                        <h2><i class="fas fa-futbol"></i> ACTIVITÉS EXTRASCOLAIRES</h2>
                        <div class="filter-bar">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" placeholder="Rechercher une activité..." id="activitySearch">
                            </div>
                            <select id="activityFilterType">
                                <option value="">Tous les types</option>
                                <option value="sport">Sportive</option>
                                <option value="cultural">Culturelle</option>
                                <option value="scientific">Scientifique</option>
                                <option value="artistic">Artistique</option>
                                <option value="social">Sociale</option>
                            </select>
                        </div>
                        <div id="activitiesContainer">
                            <!-- Les activités seront ajoutées ici -->
                            <div class="text-center" id="noActivitiesMessage">
                                <p>Aucune activité enregistrée</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sub-tab-content" data-subtab="meetings">
                    <div class="form-section">
                        <h2><i class="fas fa-users"></i> RÉUNIONS & CONSEILS</h2>
                        <div class="filter-bar">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" placeholder="Rechercher une réunion..." id="meetingSearch">
                            </div>
                            <select id="meetingFilterType">
                                <option value="">Tous les types</option>
                                <option value="conseil">Conseil de classe</option>
                                <option value="pedagogique">Réunion pédagogique</option>
                                <option value="parents">Réunion parents</option>
                                <option value="administration">Réunion administrative</option>
                                <option value="formation">Réunion de formation</option>
                            </select>
                        </div>
                        <div id="meetingsContainer">
                            <!-- Les réunions seront ajoutées ici -->
                            <div class="text-center" id="noMeetingsMessage">
                                <p>Aucune réunion enregistrée</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sub-tab-content" data-subtab="calendar">
                    <div class="form-section">
                        <h2><i class="fas fa-calendar-alt"></i> CALENDRIER DES ÉVÉNEMENTS</h2>
                        <div id="eventsCalendar">
                            <!-- Calendrier sera généré ici -->
                            <div class="text-center">
                                <p>Calendrier des projets, activités et réunions</p>
                                <div class="calendar-view" id="monthlyCalendar"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet 5: Données & Archives -->
            <div id="tab5" class="tab-content">
                <div class="tab-actions">
                    <button type="button" class="btn btn-info" onclick="backupData()">
                        <i class="fas fa-save"></i> Sauvegarder
                    </button>
                    <button type="button" class="btn btn-warning" onclick="restoreData()">
                        <i class="fas fa-undo"></i> Restaurer
                    </button>
                    <button type="button" class="btn btn-danger" onclick="clearAllData()">
                        <i class="fas fa-trash"></i> Effacer tout
                    </button>
                </div>

                <!-- Import/Export -->
                <div class="form-section">
                    <h2><i class="fas fa-exchange-alt"></i> IMPORT/EXPORT DE DONNÉES</h2>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-file-export"></i> Exporter toutes les données</label>
                                <button type="button" class="btn btn-warning w-100" onclick="exportAllJSON()">
                                    <i class="fas fa-download"></i> Exporter JSON complet
                                </button>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-file-import"></i> Importer des données</label>
                                <input type="file" id="importFile" accept=".json" class="mb-10">
                                <button type="button" class="btn btn-info w-100" onclick="importAllJSON()">
                                    <i class="fas fa-upload"></i> Importer JSON
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sauvegardes -->
                <div class="form-section">
                    <h2><i class="fas fa-history"></i> HISTORIQUE DES SAUVEGARDES</h2>
                    <div id="backupHistory">
                        <!-- Historique -->
                    </div>
                </div>

                <!-- Logs -->
                <div class="form-section">
                    <h2><i class="fas fa-clipboard-list"></i> JOURNAL DES ACTIVITÉS</h2>
                    <div id="activityLogs">
                        <!-- Logs -->
                    </div>
                </div>
            </div>

            <!-- Onglet 6: Tableau de bord -->
            <div id="tab6" class="tab-content">
                <div class="dashboard-grid">
                    <!-- Cartes de synthèse -->
                    <div class="dashboard-card">
                        <h3><i class="fas fa-user-circle"></i> Profil complet</h3>
                        <div id="profileSummary"></div>
                    </div>
                    <div class="dashboard-card">
                        <h3><i class="fas fa-chart-pie"></i> Répartition par matière</h3>
                        <div class="chart-container" id="subjectDistribution"></div>
                    </div>
                    <div class="dashboard-card">
                        <h3><i class="fas fa-calendar-check"></i> Activité récente</h3>
                        <div id="recentActivity"></div>
                    </div>
                    <div class="dashboard-card">
                        <h3><i class="fas fa-bell"></i> Notifications</h3>
                        <div id="notificationsList"></div>
                    </div>
                </div>

                <!-- Statistiques détaillées -->
                <div class="form-section">
                    <h2><i class="fas fa-chart-bar"></i> STATISTIQUES DÉTAILLÉES</h2>
                    <div class="stats-grid" id="detailedStats">
                        <!-- Statistiques -->
                    </div>
                </div>

                <!-- Rapports rapides -->
                <div class="form-section">
                    <h2><i class="fas fa-file-alt"></i> RAPPORTS RAPIDES</h2>
                    <div class="form-row">
                        <div class="form-col">
                            <button type="button" class="btn btn-primary w-100" onclick="generateTeachingReport()">
                                <i class="fas fa-chalkboard-teacher"></i> Rapport d'enseignement
                            </button>
                        </div>
                        <div class="form-col">
                            <button type="button" class="btn btn-success w-100" onclick="generateEvaluationReport()">
                                <i class="fas fa-clipboard-check"></i> Rapport d'évaluation
                            </button>
                        </div>
                        <div class="form-col">
                            <button type="button" class="btn btn-info w-100" onclick="generateActivityReport()">
                                <i class="fas fa-project-diagram"></i> Rapport d'activités
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Règles de départ à la retraite -->
                <div class="form-section" id="retirementRulesSection">
                    <h2><i class="fas fa-umbrella-beach"></i> RÈGLES DE DÉPART À LA RETRAITE</h2>
                    <div style="background: white; padding: 20px; border-radius: 8px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                            <i class="fas fa-info-circle"></i> Tableau des catégories
                        </h4>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Catégorie</th>
                                    <th>Âge de départ</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>A1 & A2</strong></td>
                                    <td><span class="badge badge-info">60 ans</span></td>
                                    <td>Cadres supérieurs et Cadres</td>
                                </tr>
                                <tr>
                                    <td><strong>B & C</strong></td>
                                    <td><span class="badge badge-warning">58 ans</span></td>
                                    <td>Techniciens supérieurs et Techniciens</td>
                                </tr>
                                <tr>
                                    <td><strong>D</strong></td>
                                    <td><span class="badge badge-success">55 ans</span></td>
                                    <td>Adjoints techniques</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                            <h5 style="color: var(--warning-color); margin-bottom: 10px;">
                                <i class="fas fa-calendar-alt"></i> Règles spécifiques pour 58 ans
                            </h5>
                            <ul style="margin-bottom: 0;">
                                <li><strong>Né(e) entre Janvier et Mars:</strong> Départ le 1er Avril</li>
                                <li><strong>Né(e) entre Avril et Septembre:</strong> Départ le 1er Octobre</li>
                                <li><strong>Né(e) entre Octobre et Décembre:</strong> Départ le 1er Janvier suivant</li>
                            </ul>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 5px; border-left: 4px solid var(--success-color);">
                            <h5 style="color: var(--success-color); margin-bottom: 10px;">
                                <i class="fas fa-calculator"></i> Formule de calcul
                            </h5>
                            <p><strong>Date de départ = Année de naissance + Âge selon catégorie</strong></p>
                            <p>Exemple: Né en 1970, catégorie B → 1970 + 58 = 2028</p>
                            <p>Le mois de départ dépend du mois de naissance selon les règles spécifiques ci-dessus.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions globales -->
            <div class="form-actions">
                <button type="button" class="btn btn-light" onclick="printForm()">
                    <i class="fas fa-print"></i> Imprimer
                </button>
                <button type="reset" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Annuler
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Sauvegarder tout
                </button>
            </div>
        </form>
    </div>

    <script>
        // Variables globales pour la synchronisation
        let teacherData = {
            establishment: {},
            personal: {},
            professional: {},
            subjects: [],
            themes: {},
            lessons: [],
            tps: [],
            evaluations: [],
            projects: [],
            activities: [],
            meetings: [],
            resources: [],
            backups: [],
            logs: []
        };

        let currentTab = 'tab1';
        let counters = {
            subject: 0,
            theme: 0,
            lesson: 0,
            tp: 0,
            evaluation: 0,
            project: 0,
            activity: 0,
            meeting: 0
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            // Initialiser l'année scolaire
            const currentYear = new Date().getFullYear();
            document.getElementById('currentYear').textContent = `${currentYear}-${currentYear + 1}`;
            
            // Gestion des onglets principaux
            initTabs();
            
            // Gestion des sous-onglets
            initSubTabs();
            
            // Charger les données sauvegardées
            loadSavedData();
            
            // Initialiser les événements
            initEvents();
            
            // Mettre à jour l'interface
            updateUI();
            
            showNotification('Application chargée avec succès', 'success');
        }

        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
        }

        function initSubTabs() {
            const subTabs = document.querySelectorAll('.sub-tab');
            subTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const subtabId = this.getAttribute('data-subtab');
                    switchSubTab(subtabId);
                });
            });
        }

        function switchTab(tabId) {
            // Désactiver tous les onglets
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Activer l'onglet sélectionné
            const tabElement = document.querySelector(`[data-tab="${tabId}"]`);
            const tabContent = document.getElementById(tabId);
            
            if (tabElement) tabElement.classList.add('active');
            if (tabContent) tabContent.classList.add('active');
            
            currentTab = tabId;
            
            // Mettre à jour l'interface spécifique à l'onglet
            updateTabUI(tabId);
        }

        function switchSubTab(subtabId) {
            // Désactiver tous les sous-onglets
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
            
            // Activer le sous-onglet sélectionné
            const subTabElement = document.querySelector(`.sub-tab[data-subtab="${subtabId}"]`);
            const subTabContent = document.querySelector(`.sub-tab-content[data-subtab="${subtabId}"]`);
            
            if (subTabElement) subTabElement.classList.add('active');
            if (subTabContent) subTabContent.classList.add('active');
            
            // Mettre à jour les informations synchronisées pour l'onglet 2
            if (currentTab === 'tab2') {
                updateSyncedInfoDisplay();
            }
            
            // Si c'est le calendrier, le mettre à jour
            if (subtabId === 'calendar') {
                updateEventsCalendar();
            }
        }

        function initEvents() {
            // Écouter les changements sur les champs importants
            const establishmentName = document.getElementById('establishmentName');
            if (establishmentName) {
                establishmentName.addEventListener('change', updateSchoolName);
                establishmentName.addEventListener('input', updateSchoolName);
            }
            
            const birthDate = document.getElementById('birthDate');
            if (birthDate) {
                birthDate.addEventListener('change', function() {
                    // Synchroniser le mois de naissance avec la date
                    const birthDateValue = new Date(this.value);
                    const birthMonth = birthDateValue.getMonth() + 1;
                    const birthMonthSelect = document.getElementById('birthMonth');
                    if (birthMonthSelect) {
                        birthMonthSelect.value = birthMonth;
                    }
                    calculateRetirementDate();
                });
            }
            
            const birthMonth = document.getElementById('birthMonth');
            if (birthMonth) {
                birthMonth.addEventListener('change', calculateRetirementDate);
            }
            
            const professionalCategory = document.getElementById('professionalCategory');
            if (professionalCategory) {
                professionalCategory.addEventListener('change', calculateRetirementDate);
            }
            
            const regionServiceDate = document.getElementById('regionServiceDate');
            if (regionServiceDate) {
                regionServiceDate.addEventListener('change', () => {
                    calculateServiceYears('regionServiceDate', 'yearsInRegion');
                });
            }
            
            const inspectionServiceDate = document.getElementById('inspectionServiceDate');
            if (inspectionServiceDate) {
                inspectionServiceDate.addEventListener('change', () => {
                    calculateServiceYears('inspectionServiceDate', 'yearsInInspection');
                });
            }
            
            // Gestion du formulaire
            const teacherForm = document.getElementById('teacherForm');
            if (teacherForm) {
                teacherForm.addEventListener('submit', handleSubmit);
                teacherForm.addEventListener('input', syncAllData);
                teacherForm.addEventListener('change', syncAllData);
            }
            
            // Recherche
            const lessonSearch = document.getElementById('lessonSearch');
            if (lessonSearch) {
                lessonSearch.addEventListener('input', filterLessons);
            }
            
            // Recherche dans les évaluations
            const evaluationSearch = document.getElementById('evaluationSearch');
            if (evaluationSearch) {
                evaluationSearch.addEventListener('input', filterEvaluations);
            }
            
            // Recherche dans les projets
            const projectSearch = document.getElementById('projectSearch');
            if (projectSearch) {
                projectSearch.addEventListener('input', filterProjects);
            }
            
            // Recherche dans les activités
            const activitySearch = document.getElementById('activitySearch');
            if (activitySearch) {
                activitySearch.addEventListener('input', filterActivities);
            }
            
            // Recherche dans les réunions
            const meetingSearch = document.getElementById('meetingSearch');
            if (meetingSearch) {
                meetingSearch.addEventListener('input', filterMeetings);
            }
            
            // Filtres des évaluations
            const evaluationFilters = [
                'evaluationFilterSubject',
                'evaluationFilterClass',
                'evaluationFilterType'
            ];
            
            evaluationFilters.forEach(filterId => {
                const filter = document.getElementById(filterId);
                if (filter) {
                    filter.addEventListener('change', filterEvaluations);
                }
            });
            
            // Filtres des projets
            const projectFilterStatus = document.getElementById('projectFilterStatus');
            if (projectFilterStatus) {
                projectFilterStatus.addEventListener('change', filterProjects);
            }
            
            // Filtres des activités
            const activityFilterType = document.getElementById('activityFilterType');
            if (activityFilterType) {
                activityFilterType.addEventListener('change', filterActivities);
            }
            
            // Filtres des réunions
            const meetingFilterType = document.getElementById('meetingFilterType');
            if (meetingFilterType) {
                meetingFilterType.addEventListener('change', filterMeetings);
            }
            
            // Upload de fichiers
            const resourceUpload = document.getElementById('resourceUpload');
            if (resourceUpload) {
                resourceUpload.addEventListener('change', handleResourceUpload);
            }
            
            const importFile = document.getElementById('importFile');
            if (importFile) {
                importFile.addEventListener('change', handleFileSelect);
            }
        }

        // Fonction principale de synchronisation des données
        function syncAllData() {
            // Collecter les données de l'onglet 1
            collectTab1Data();
            
            // Mettre à jour les sélecteurs de matières dans l'onglet 2
            updateSubjectsSelector();
            
            // Mettre à jour l'affichage des informations synchronisées
            updateSyncedInfoDisplay();
            
            // Initialiser les filtres de classe pour les évaluations
            updateClassFilters();
            
            // Initialiser les filtres de matière pour les évaluations
            updateEvaluationFilters();
            
            // Sauvegarder les données dans localStorage
            saveToLocalStorage();
        }

        function collectTab1Data() {
            // Données de l'établissement
            teacherData.establishment = {
                name: document.getElementById('establishmentName')?.value || '',
                type: document.getElementById('establishmentType')?.value || '',
                address: document.getElementById('establishmentAddress')?.value || '',
                phone: document.getElementById('establishmentPhone')?.value || '',
                email: document.getElementById('establishmentEmail')?.value || '',
                website: document.getElementById('establishmentWebsite')?.value || ''
            };
            
            // Données personnelles
            teacherData.personal = {
                last_name: document.getElementById('lastName')?.value || '',
                first_name: document.getElementById('firstName')?.value || '',
                gender: document.getElementById('gender')?.value || '',
                birth_date: document.getElementById('birthDate')?.value || '',
                birth_month: document.getElementById('birthMonth')?.value || '',
                birth_place: document.getElementById('birthPlace')?.value || '',
                nationality: document.getElementById('nationality')?.value || '',
                address: document.getElementById('address')?.value || '',
                personal_phone: document.getElementById('personalPhone')?.value || '',
                personal_email: document.getElementById('personalEmail')?.value || '',
                cin: document.getElementById('cin')?.value || '',
                marital_status: document.getElementById('maritalStatus')?.value || '',
                children_number: document.getElementById('childrenNumber')?.value || ''
            };
            
            // Données professionnelles
            teacherData.professional = {
                matricule: document.getElementById('matricule')?.value || '',
                position: document.getElementById('position')?.value || '',
                grade: document.getElementById('grade')?.value || '',
                professional_category: document.getElementById('professionalCategory')?.value || '',
                engagement_date: document.getElementById('engagementDate')?.value || '',
                region_service_date: document.getElementById('regionServiceDate')?.value || '',
                inspection_service_date: document.getElementById('inspectionServiceDate')?.value || '',
                years_in_region: document.getElementById('yearsInRegion')?.value || '',
                years_in_inspection: document.getElementById('yearsInInspection')?.value || '',
                retirement_date: document.getElementById('retirementDate')?.value || '',
                current_class: document.getElementById('currentClass')?.value || '',
                weekly_hours: document.getElementById('weeklyHours')?.value || ''
            };
            
            // Collecter les matières
            teacherData.subjects = [];
            const mainSubject = document.getElementById('mainSubject')?.value;
            const secondarySubject = document.getElementById('secondarySubject')?.value;
            
            if (mainSubject) {
                teacherData.subjects.push({
                    id: 'main',
                    name: mainSubject,
                    type: 'main',
                    hours: teacherData.professional.weekly_hours || ''
                });
            }
            
            if (secondarySubject) {
                teacherData.subjects.push({
                    id: 'secondary',
                    name: secondarySubject,
                    type: 'secondary',
                    hours: ''
                });
            }
            
            // Collecter les matières supplémentaires
            const subjectRows = document.querySelectorAll('#subjectsContainer .form-row');
            subjectRows.forEach((row, index) => {
                if (index > 0) {
                    const subjectInput = row.querySelector('.subject-field');
                    const hoursInput = row.querySelector('.subject-hours-field');
                    
                    if (subjectInput && subjectInput.value) {
                        teacherData.subjects.push({
                            id: `additional_${index}`,
                            name: subjectInput.value,
                            hours: hoursInput?.value || '',
                            type: 'additional'
                        });
                    }
                }
            });
            
            updateSchoolName();
        }

        function updateSchoolName() {
            const name = document.getElementById('establishmentName').value;
            const schoolNameElement = document.getElementById('schoolName');
            if (name && schoolNameElement) {
                schoolNameElement.textContent = name;
            }
        }

        // Fonction pour mettre à jour l'affichage des informations synchronisées dans l'onglet 2
        function updateSyncedInfoDisplay() {
            const displayContainer = document.getElementById('syncedInfoDisplay');
            if (!displayContainer) return;
            
            let html = '<h4><i class="fas fa-sync"></i> Informations chargées depuis l\'onglet "Informations Générales":</h4>';
            
            // Afficher l'enseignant
            if (teacherData.personal.last_name || teacherData.personal.first_name) {
                html += `<p><strong>Enseignant:</strong> ${teacherData.personal.last_name} ${teacherData.personal.first_name}</p>`;
            }
            
            // Afficher le matricule
            if (teacherData.professional.matricule) {
                html += `<p><strong>Matricule:</strong> ${teacherData.professional.matricule}</p>`;
            }
            
            // Afficher les classes
            if (teacherData.professional.current_class) {
                html += `<p><strong>Classe(s):</strong> ${teacherData.professional.current_class}</p>`;
            }
            
            // Afficher les matières
            if (teacherData.subjects.length > 0) {
                html += '<p><strong>Matière(s):</strong> ';
                const subjectNames = teacherData.subjects.map(subject => 
                    `${subject.name}${subject.type === 'main' ? ' (principale)' : subject.type === 'secondary' ? ' (secondaire)' : ''}`
                );
                html += subjectNames.join(', ') + '</p>';
            }
            
            // Afficher les heures/semaine
            if (teacherData.professional.weekly_hours) {
                html += `<p><strong>Heures/semaine:</strong> ${teacherData.professional.weekly_hours} heures</p>`;
            }
            
            displayContainer.innerHTML = html;
        }

        function calculateRetirementDate() {
            const birthDateInput = document.getElementById('birthDate');
            const birthMonthInput = document.getElementById('birthMonth');
            const professionalCategoryInput = document.getElementById('professionalCategory');
            const retirementDateInput = document.getElementById('retirementDate');
            
            if (!birthDateInput || !birthDateInput.value || !retirementDateInput) {
                return;
            }
            
            const birthDate = new Date(birthDateInput.value);
            let birthMonth = birthDate.getMonth() + 1;
            
            if (birthMonthInput && birthMonthInput.value) {
                birthMonth = parseInt(birthMonthInput.value);
            }
            
            const birthYear = birthDate.getFullYear();
            const professionalCategory = professionalCategoryInput ? professionalCategoryInput.value : '';
            
            let retirementAge = 60;
            
            if (professionalCategory === 'A1' || professionalCategory === 'A2') {
                retirementAge = 60;
            } else if (professionalCategory === 'B' || professionalCategory === 'C') {
                retirementAge = 58;
            } else if (professionalCategory === 'D') {
                retirementAge = 55;
            }
            
            let retirementYear = birthYear + retirementAge;
            let retirementMonth = 1;
            
            if (retirementAge === 58) {
                if (birthMonth >= 1 && birthMonth <= 3) {
                    retirementMonth = 4;
                } else if (birthMonth >= 4 && birthMonth <= 9) {
                    retirementMonth = 10;
                } else {
                    retirementMonth = 1;
                    retirementYear += 1;
                }
            } else if (retirementAge === 55 || retirementAge === 60) {
                retirementMonth = birthMonth + 1;
                if (retirementMonth > 12) {
                    retirementMonth = 1;
                    retirementYear += 1;
                }
            }
            
            const retirementDate = new Date(retirementYear, retirementMonth - 1, 1);
            const formattedDate = retirementDate.toISOString().split('T')[0];
            retirementDateInput.value = formattedDate;
            
            updateRetirementDetails(birthYear, birthMonth, retirementAge, retirementYear, retirementMonth, professionalCategory);
            syncAllData();
        }

        function updateRetirementDetails(birthYear, birthMonth, retirementAge, retirementYear, retirementMonth, professionalCategory) {
            const detailsContainer = document.getElementById('retirementDetails');
            if (!detailsContainer) return;
            
            const monthNames = [
                'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'
            ];
            
            const birthMonthName = monthNames[birthMonth - 1];
            const retirementMonthName = monthNames[retirementMonth - 1];
            
            let detailsHTML = `
                <div class="retirement-info" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px;">
                    <h4 style="margin-bottom: 10px; color: var(--primary-color);">
                        <i class="fas fa-info-circle"></i> Détails du calcul
                    </h4>
                    <div style="font-size: 0.9rem;">
                        <p><strong>Année de naissance:</strong> ${birthYear}</p>
                        <p><strong>Mois de naissance:</strong> ${birthMonthName}</p>
                        <p><strong>Catégorie:</strong> ${professionalCategory || 'Non définie'}</p>
                        <p><strong>Âge de départ:</strong> ${retirementAge} ans</p>
                        <p><strong>Calcul:</strong> ${birthYear} + ${retirementAge} = ${retirementYear}</p>
                        <p><strong>Date de départ:</strong> 1er ${retirementMonthName} ${retirementYear}</p>
                    </div>
                </div>
            `;
            
            if (retirementAge === 58) {
                let ruleText = '';
                if (birthMonth >= 1 && birthMonth <= 3) {
                    ruleText = 'Né(e) entre Janvier et Mars → Départ le 1er Avril';
                } else if (birthMonth >= 4 && birthMonth <= 9) {
                    ruleText = 'Né(e) entre Avril et Septembre → Départ le 1er Octobre';
                } else {
                    ruleText = 'Né(e) entre Octobre et Décembre → Départ le 1er Janvier suivant';
                }
                
                detailsHTML += `
                    <div class="retirement-rules" style="background: #fff3e0; padding: 15px; border-radius: 5px; margin-top: 10px; border-left: 4px solid var(--warning-color);">
                        <h5 style="margin-bottom: 10px; color: var(--warning-color);">
                            <i class="fas fa-exclamation-circle"></i> Règle appliquée
                        </h5>
                        <div style="font-size: 0.85rem;">
                            <p>${ruleText}</p>
                        </div>
                    </div>
                `;
            }
            
            detailsContainer.innerHTML = detailsHTML;
        }

        function calculateServiceYears(dateFieldId, yearsFieldId) {
            const dateField = document.getElementById(dateFieldId);
            const yearsField = document.getElementById(yearsFieldId);
            
            if (dateField && dateField.value && yearsField) {
                const startDate = new Date(dateField.value);
                const today = new Date();
                
                let years = today.getFullYear() - startDate.getFullYear();
                const monthDiff = today.getMonth() - startDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < startDate.getDate())) {
                    years--;
                }
                
                yearsField.value = Math.max(years, 0);
                syncAllData();
            }
        }

        // Mettre à jour le sélecteur de matières dans l'onglet 2
        function updateSubjectsSelector() {
            const selector = document.getElementById('subjectSelector');
            // Supprimé car l'onglet Thèmes a été supprimé
        }

        function updateEvaluationFilters() {
            const subjectFilter = document.getElementById('evaluationFilterSubject');
            if (!subjectFilter) return;
            
            subjectFilter.innerHTML = '<option value="">Toutes les matières</option>';
            
            if (teacherData.subjects && teacherData.subjects.length > 0) {
                teacherData.subjects.forEach(subject => {
                    if (subject.name) {
                        const option = document.createElement('option');
                        option.value = subject.name;
                        option.textContent = subject.name;
                        subjectFilter.appendChild(option);
                    }
                });
            }
        }

        function updateClassFilters() {
            const classFilter = document.getElementById('evaluationFilterClass');
            if (!classFilter) return;
            
            classFilter.innerHTML = '<option value="">Toutes les classes</option>';
            
            if (teacherData.professional && teacherData.professional.current_class) {
                const classes = teacherData.professional.current_class.split(',').map(c => c.trim());
                classes.forEach(classe => {
                    if (classe) {
                        const option = document.createElement('option');
                        option.value = classe;
                        option.textContent = classe;
                        classFilter.appendChild(option);
                    }
                });
            }
        }

        // Fonctions pour ajouter des éléments dynamiques
        function addSubjectField() {
            const container = document.getElementById('subjectsContainer');
            counters.subject++;
            
            const newSubject = document.createElement('div');
            newSubject.className = 'form-row';
            newSubject.innerHTML = `
                <div class="form-col">
                    <div class="form-group">
                        <label><i class="fas fa-book"></i> Matière supplémentaire ${counters.subject}</label>
                        <input type="text" placeholder="Nom de la matière" class="subject-field">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> Heures/semaine</label>
                        <input type="number" min="0" max="20" class="subject-hours-field">
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeSubjectField(this)">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(newSubject);
            syncAllData();
        }

        function removeSubjectField(button) {
            const row = button.closest('.form-row');
            if (row && row !== row.parentElement.firstElementChild) {
                row.remove();
                counters.subject--;
                syncAllData();
            }
        }

        // Fonction pour charger automatiquement les données dans l'onglet 2
        function loadSubjectThemes(subject) {
            // Cette fonction a été supprimée avec l'onglet Thèmes
        }

        function addTheme(subject) {
            // Cette fonction a été supprimée avec l'onglet Thèmes
        }

        // Lors de l'ajout d'une leçon, pré-remplir avec les informations synchronisées
        function addNewLesson() {
            const lessonId = `lesson_${Date.now()}`;
            
            // Récupérer les informations synchronisées
            const currentDate = new Date().toISOString().split('T')[0];
            const defaultSubject = teacherData.subjects.find(s => s.type === 'main')?.name || '';
            const defaultClass = teacherData.professional.current_class || '';
            
            const lessonHTML = `
                <div class="lesson-container" id="${lessonId}">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-book"></i> Titre de la leçon</label>
                                <input type="text" placeholder="Titre de la leçon" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-calendar"></i> Date</label>
                                <input type="date" value="${currentDate}" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-clock"></i> Durée (heures)</label>
                                <input type="number" min="0.5" max="4" step="0.5" value="1">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-book"></i> Matière</label>
                                <input type="text" value="${defaultSubject}" placeholder="Matière">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-users"></i> Classe</label>
                                <input type="text" value="${defaultClass}" placeholder="Ex: 3ème A">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-bullseye"></i> Objectifs pédagogiques</label>
                        <textarea rows="3" placeholder="Objectifs spécifiques de la leçon"></textarea>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-tasks"></i> Déroulement</label>
                        <textarea rows="4" placeholder="Plan détaillé de la séance"></textarea>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-tools"></i> Matériel utilisé</label>
                        <textarea rows="2" placeholder="Matériel et supports pédagogiques"></textarea>
                    </div>
                    <div class="section-actions">
                        <button type="button" class="btn btn-success btn-sm" onclick="saveElement('${lessonId}')">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeElement('${lessonId}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            `;
            
            const lessonsContainer = document.getElementById('lessonsContainer');
            if (lessonsContainer) {
                lessonsContainer.insertAdjacentHTML('beforeend', lessonHTML);
                
                // Ajouter cette leçon aux données
                if (!teacherData.lessons) teacherData.lessons = [];
                teacherData.lessons.push({
                    id: lessonId,
                    title: '',
                    date: currentDate,
                    subject: defaultSubject,
                    class: defaultClass,
                    createdAt: new Date().toISOString()
                });
                
                syncAllData();
                showNotification('Nouvelle leçon créée avec les informations synchronisées', 'success');
            }
        }

        function addNewTP() {
            const tpId = `tp_${Date.now()}`;
            const currentDate = new Date().toISOString().split('T')[0];
            const defaultSubject = teacherData.subjects.find(s => s.type === 'main')?.name || '';
            const defaultClass = teacherData.professional.current_class || '';
            
            const tpHTML = `
                <div class="tp-container" id="${tpId}">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-flask"></i> Titre du TP/Expérience</label>
                                <input type="text" placeholder="Titre de l'expérience" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-calendar"></i> Date</label>
                                <input type="date" value="${currentDate}" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-book"></i> Matière</label>
                                <input type="text" value="${defaultSubject}" placeholder="Matière">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-users"></i> Classe</label>
                                <input type="text" value="${defaultClass}" placeholder="Classe">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-bullseye"></i> Objectifs spécifiques</label>
                        <textarea rows="2" placeholder="Objectifs pédagogiques du TP"></textarea>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-vial"></i> Description de l'expérience</label>
                        <textarea rows="3" placeholder="Protocole expérimental détaillé"></textarea>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-tools"></i> Matériel et équipement</label>
                        <textarea rows="2" placeholder="Liste du matériel nécessaire"></textarea>
                    </div>
                    <div class="section-actions">
                        <button type="button" class="btn btn-success btn-sm" onclick="saveElement('${tpId}')">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeElement('${tpId}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            `;
            
            const tpContainer = document.getElementById('tpContainer');
            if (tpContainer) {
                tpContainer.insertAdjacentHTML('beforeend', tpHTML);
                
                if (!teacherData.tps) teacherData.tps = [];
                teacherData.tps.push({
                    id: tpId,
                    title: '',
                    date: currentDate,
                    subject: defaultSubject,
                    class: defaultClass,
                    createdAt: new Date().toISOString()
                });
                
                syncAllData();
                showNotification('Nouveau TP créé avec les informations synchronisées', 'success');
            }
        }

        // ==================== ONGLET 3: ÉVALUATIONS ====================
        
        function addEvaluation() {
            const evaluationId = `eval_${Date.now()}`;
            const currentDate = new Date().toISOString().split('T')[0];
            
            // Récupérer les informations synchronisées
            const defaultSubject = teacherData.subjects.find(s => s.type === 'main')?.name || '';
            const defaultClass = teacherData.professional.current_class ? 
                teacherData.professional.current_class.split(',')[0].trim() : '';
            
            const evaluationHTML = `
                <div class="evaluation-container" id="${evaluationId}">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-clipboard-check"></i> Type d'évaluation *</label>
                                <select class="eval-type" required>
                                    <option value="">Sélectionner</option>
                                    <option value="examen">Examen</option>
                                    <option value="devoir">Devoir</option>
                                    <option value="oral">Oral</option>
                                    <option value="tp">TP</option>
                                    <option value="projet">Projet</option>
                                    <option value="participation">Participation</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-book"></i> Matière *</label>
                                <input type="text" class="eval-subject" value="${defaultSubject}" placeholder="Matière" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-users"></i> Classe *</label>
                                <input type="text" class="eval-class" value="${defaultClass}" placeholder="Classe" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-calendar"></i> Date *</label>
                                <input type="date" class="eval-date" value="${currentDate}" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-tag"></i> Thème/chapitre</label>
                                <input type="text" class="eval-topic" placeholder="Thème évalué">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-percentage"></i> Coefficient</label>
                                <input type="number" class="eval-coefficient" min="1" max="10" value="1">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-bullseye"></i> Objectifs d'évaluation</label>
                        <textarea class="eval-objectives" rows="2" placeholder="Compétences évaluées..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-user-graduate"></i> Nombre d'élèves évalués</label>
                                <input type="number" class="eval-student-count" min="1" max="50" value="1">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-chart-bar"></i> Moyenne de la classe</label>
                                <input type="number" class="eval-average" min="0" max="20" step="0.1" placeholder="/20">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-trophy"></i> Meilleure note</label>
                                <input type="number" class="eval-best" min="0" max="20" step="0.1" placeholder="/20">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-sticky-note"></i> Commentaires/Remarques</label>
                        <textarea class="eval-comments" rows="3" placeholder="Observations sur l'évaluation..."></textarea>
                    </div>
                    <div class="section-actions">
                        <button type="button" class="btn btn-success btn-sm" onclick="saveEvaluation('${evaluationId}')">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                        <button type="button" class="btn btn-info btn-sm" onclick="duplicateEvaluation('${evaluationId}')">
                            <i class="fas fa-copy"></i> Dupliquer
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeEvaluation('${evaluationId}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            `;
            
            const container = document.getElementById('evaluationsContainer');
            if (container) {
                // Masquer le message "aucune évaluation"
                const noEvalMessage = document.getElementById('noEvaluationsMessage');
                if (noEvalMessage) {
                    noEvalMessage.style.display = 'none';
                }
                
                container.insertAdjacentHTML('afterbegin', evaluationHTML);
                
                // Ajouter aux données
                if (!teacherData.evaluations) teacherData.evaluations = [];
                teacherData.evaluations.push({
                    id: evaluationId,
                    type: '',
                    subject: defaultSubject,
                    class: defaultClass,
                    date: currentDate,
                    createdAt: new Date().toISOString()
                });
                
                counters.evaluation++;
                updateEvaluationStats();
                syncAllData();
                showNotification('Nouvelle évaluation créée', 'success');
            }
        }

        function saveEvaluation(evaluationId) {
            const element = document.getElementById(evaluationId);
            if (!element) return;
            
            // Récupérer les valeurs
            const type = element.querySelector('.eval-type').value;
            const subject = element.querySelector('.eval-subject').value;
            const classe = element.querySelector('.eval-class').value;
            const date = element.querySelector('.eval-date').value;
            const average = element.querySelector('.eval-average').value;
            const best = element.querySelector('.eval-best').value;
            
            // Mettre à jour les données
            const evaluationIndex = teacherData.evaluations.findIndex(e => e.id === evaluationId);
            if (evaluationIndex !== -1) {
                teacherData.evaluations[evaluationIndex] = {
                    ...teacherData.evaluations[evaluationIndex],
                    type: type,
                    subject: subject,
                    class: classe,
                    date: date,
                    average: parseFloat(average) || 0,
                    best: parseFloat(best) || 0,
                    updatedAt: new Date().toISOString()
                };
            }
            
            updateEvaluationStats();
            syncAllData();
            showNotification('Évaluation sauvegardée', 'success');
        }

        function duplicateEvaluation(evaluationId) {
            const original = document.getElementById(evaluationId);
            if (!original) return;
            
            // Créer une nouvelle évaluation avec les mêmes données
            addEvaluation();
            
            // Récupérer la nouvelle évaluation (la dernière ajoutée)
            const newEvaluation = document.querySelector('.evaluation-container:first-child');
            if (newEvaluation && newEvaluation.id !== evaluationId) {
                // Copier les valeurs
                const originalType = original.querySelector('.eval-type').value;
                const originalSubject = original.querySelector('.eval-subject').value;
                const originalClass = original.querySelector('.eval-class').value;
                const originalTopic = original.querySelector('.eval-topic').value;
                
                if (originalType) newEvaluation.querySelector('.eval-type').value = originalType;
                if (originalSubject) newEvaluation.querySelector('.eval-subject').value = originalSubject;
                if (originalClass) newEvaluation.querySelector('.eval-class').value = originalClass;
                if (originalTopic) newEvaluation.querySelector('.eval-topic').value = originalTopic;
                
                showNotification('Évaluation dupliquée', 'success');
            }
        }

        function removeEvaluation(evaluationId) {
            if (confirm('Voulez-vous vraiment supprimer cette évaluation ?')) {
                const element = document.getElementById(evaluationId);
                if (element) {
                    element.remove();
                    
                    // Retirer des données
                    teacherData.evaluations = teacherData.evaluations.filter(e => e.id !== evaluationId);
                    
                    counters.evaluation--;
                    updateEvaluationStats();
                    syncAllData();
                    
                    // Afficher le message "aucune évaluation" si besoin
                    const container = document.getElementById('evaluationsContainer');
                    if (container && container.children.length === 0) {
                        const noEvalMessage = document.getElementById('noEvaluationsMessage');
                        if (noEvalMessage) {
                            noEvalMessage.style.display = 'block';
                        }
                    }
                    
                    showNotification('Évaluation supprimée', 'success');
                }
            }
        }

        function filterEvaluations() {
            const searchTerm = document.getElementById('evaluationSearch').value.toLowerCase();
            const filterSubject = document.getElementById('evaluationFilterSubject').value;
            const filterClass = document.getElementById('evaluationFilterClass').value;
            const filterType = document.getElementById('evaluationFilterType').value;
            
            const evaluations = document.querySelectorAll('.evaluation-container');
            let visibleCount = 0;
            
            evaluations.forEach(evaluation => {
                const subject = evaluation.querySelector('.eval-subject')?.value || '';
                const classe = evaluation.querySelector('.eval-class')?.value || '';
                const type = evaluation.querySelector('.eval-type')?.value || '';
                const text = evaluation.textContent.toLowerCase();
                
                let shouldShow = true;
                
                if (searchTerm && !text.includes(searchTerm)) {
                    shouldShow = false;
                }
                
                if (filterSubject && subject !== filterSubject) {
                    shouldShow = false;
                }
                
                if (filterClass && classe !== filterClass) {
                    shouldShow = false;
                }
                
                if (filterType && type !== filterType) {
                    shouldShow = false;
                }
                
                evaluation.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visibleCount++;
            });
            
            // Afficher le nombre de résultats
            const searchBox = document.getElementById('evaluationSearch');
            if (searchBox && (searchTerm || filterSubject || filterClass || filterType)) {
                const currentParent = searchBox.parentElement;
                const resultCount = document.createElement('div');
                resultCount.className = 'search-result-count';
                resultCount.innerHTML = `<small>${visibleCount} évaluation(s) trouvée(s)</small>`;
                
                // Supprimer l'ancien compteur s'il existe
                const oldCount = currentParent.querySelector('.search-result-count');
                if (oldCount) oldCount.remove();
                
                currentParent.appendChild(resultCount);
            }
        }

        function updateEvaluationStats() {
            // Mettre à jour le compteur total
            document.getElementById('totalEvaluations').textContent = teacherData.evaluations.length;
            
            // Calculer les statistiques
            let totalStudents = 0;
            let totalScore = 0;
            let validScores = 0;
            let bestScore = 0;
            
            teacherData.evaluations.forEach(eval => {
                const studentCount = parseInt(eval.studentCount) || 1;
                totalStudents += studentCount;
                
                if (eval.average && !isNaN(eval.average)) {
                    totalScore += eval.average;
                    validScores++;
                }
                
                if (eval.best && !isNaN(eval.best) && eval.best > bestScore) {
                    bestScore = eval.best;
                }
            });
            
            // Mettre à jour l'affichage
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('bestScore').textContent = bestScore.toFixed(1);
            
            const averageScore = validScores > 0 ? totalScore / validScores : 0;
            document.getElementById('averageScore').textContent = averageScore.toFixed(1);
            
            // Mettre à jour les statistiques détaillées
            updateDetailedEvaluationStats();
        }

        function updateDetailedEvaluationStats() {
            const container = document.getElementById('detailedEvaluationStats');
            if (!container) return;
            
            if (teacherData.evaluations.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune donnée statistique disponible</p>';
                return;
            }
            
            // Grouper par matière
            const bySubject = {};
            const byType = {};
            const byMonth = {};
            
            teacherData.evaluations.forEach(eval => {
                // Par matière
                if (eval.subject) {
                    if (!bySubject[eval.subject]) {
                        bySubject[eval.subject] = { count: 0, total: 0 };
                    }
                    bySubject[eval.subject].count++;
                    if (eval.average) bySubject[eval.subject].total += eval.average;
                }
                
                // Par type
                if (eval.type) {
                    if (!byType[eval.type]) {
                        byType[eval.type] = 0;
                    }
                    byType[eval.type]++;
                }
                
                // Par mois
                if (eval.date) {
                    const month = eval.date.substring(0, 7); // YYYY-MM
                    if (!byMonth[month]) {
                        byMonth[month] = 0;
                    }
                    byMonth[month]++;
                }
            });
            
            let html = '<div class="stats-grid">';
            
            // Statistiques par matière
            html += '<div class="stat-card"><div>Par matière</div><div>';
            Object.entries(bySubject).forEach(([subject, data]) => {
                const avg = data.total / data.count;
                html += `<div>${subject}: ${data.count} éval. (${avg.toFixed(1)}/20)</div>`;
            });
            html += '</div></div>';
            
            // Répartition par type
            html += '<div class="stat-card"><div>Par type</div><div>';
            Object.entries(byType).forEach(([type, count]) => {
                html += `<div>${type}: ${count}</div>`;
            });
            html += '</div></div>';
            
            // Évolution mensuelle
            html += '<div class="stat-card"><div>Évolution</div><div>';
            Object.entries(byMonth).forEach(([month, count]) => {
                html += `<div>${month}: ${count} éval.</div>`;
            });
            html += '</div></div>';
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ==================== ONGLET 4: PROJETS & ACTIVITÉS ====================
        
        function addProject() {
            const projectId = `proj_${Date.now()}`;
            const currentDate = new Date().toISOString().split('T')[0];
            
            const projectHTML = `
                <div class="project-container" id="${projectId}">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-project-diagram"></i> Nom du projet *</label>
                                <input type="text" class="project-name" placeholder="Titre du projet" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-book"></i> Matière concernée</label>
                                <input type="text" class="project-subject" placeholder="Matière">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-tag"></i> Statut</label>
                                <select class="project-status">
                                    <option value="planning">En planification</option>
                                    <option value="in_progress" selected>En cours</option>
                                    <option value="completed">Terminé</option>
                                    <option value="cancelled">Annulé</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-calendar"></i> Date de début</label>
                                <input type="date" class="project-start" value="${currentDate}">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-calendar-check"></i> Date de fin prévue</label>
                                <input type="date" class="project-end">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-users"></i> Classes concernées</label>
                                <input type="text" class="project-classes" placeholder="Classes">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-bullseye"></i> Objectifs pédagogiques</label>
                        <textarea class="project-objectives" rows="2" placeholder="Objectifs du projet..."></textarea>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-tasks"></i> Description/Contenu</label>
                        <textarea class="project-description" rows="3" placeholder="Description détaillée du projet..."></textarea>
                    </div>
                    <div class="section-actions">
                        <button type="button" class="btn btn-success btn-sm" onclick="saveProject('${projectId}')">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeProject('${projectId}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            `;
            
            const container = document.getElementById('projectsContainer');
            if (container) {
                // Masquer le message "aucun projet"
                const noProjectsMessage = document.getElementById('noProjectsMessage');
                if (noProjectsMessage) {
                    noProjectsMessage.style.display = 'none';
                }
                
                container.insertAdjacentHTML('afterbegin', projectHTML);
                
                // Ajouter aux données
                if (!teacherData.projects) teacherData.projects = [];
                teacherData.projects.push({
                    id: projectId,
                    name: '',
                    status: 'in_progress',
                    startDate: currentDate,
                    createdAt: new Date().toISOString()
                });
                
                counters.project++;
                updateProjectsStats();
                syncAllData();
                showNotification('Nouveau projet créé', 'success');
            }
        }

        function saveProject(projectId) {
            const element = document.getElementById(projectId);
            if (!element) return;
            
            const name = element.querySelector('.project-name').value;
            const subject = element.querySelector('.project-subject').value;
            const status = element.querySelector('.project-status').value;
            const startDate = element.querySelector('.project-start').value;
            const endDate = element.querySelector('.project-end').value;
            
            // Mettre à jour les données
            const projectIndex = teacherData.projects.findIndex(p => p.id === projectId);
            if (projectIndex !== -1) {
                teacherData.projects[projectIndex] = {
                    ...teacherData.projects[projectIndex],
                    name: name,
                    subject: subject,
                    status: status,
                    startDate: startDate,
                    endDate: endDate,
                    updatedAt: new Date().toISOString()
                };
            }
            
            updateProjectsStats();
            syncAllData();
            showNotification('Projet sauvegardé', 'success');
        }

        function removeProject(projectId) {
            if (confirm('Voulez-vous vraiment supprimer ce projet ?')) {
                const element = document.getElementById(projectId);
                if (element) {
                    element.remove();
                    
                    // Retirer des données
                    teacherData.projects = teacherData.projects.filter(p => p.id !== projectId);
                    
                    counters.project--;
                    updateProjectsStats();
                    syncAllData();
                    
                    // Afficher le message "aucun projet" si besoin
                    const container = document.getElementById('projectsContainer');
                    if (container && container.children.length === 0) {
                        const noProjectsMessage = document.getElementById('noProjectsMessage');
                        if (noProjectsMessage) {
                            noProjectsMessage.style.display = 'block';
                        }
                    }
                    
                    showNotification('Projet supprimé', 'success');
                }
            }
        }

        function addActivity() {
            const activityId = `act_${Date.now()}`;
            const currentDate = new Date().toISOString().split('T')[0];
            
            const activityHTML = `
                <div class="activity-container" id="${activityId}">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-futbol"></i> Nom de l'activité *</label>
                                <input type="text" class="activity-name" placeholder="Titre de l'activité" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-tag"></i> Type d'activité</label>
                                <select class="activity-type">
                                    <option value="sport">Sportive</option>
                                    <option value="cultural">Culturelle</option>
                                    <option value="scientific">Scientifique</option>
                                    <option value="artistic">Artistique</option>
                                    <option value="social">Sociale</option>
                                    <option value="other">Autre</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-calendar"></i> Date</label>
                                <input type="date" class="activity-date" value="${currentDate}">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-users"></i> Participants</label>
                        <textarea class="activity-participants" rows="2" placeholder="Classes/Élèves participants..."></textarea>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-bullseye"></i> Objectifs</label>
                        <textarea class="activity-objectives" rows="2" placeholder="Objectifs de l'activité..."></textarea>
                    </div>
                    <div class="section-actions">
                        <button type="button" class="btn btn-success btn-sm" onclick="saveActivity('${activityId}')">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeActivity('${activityId}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            `;
            
            const container = document.getElementById('activitiesContainer');
            if (container) {
                // Masquer le message "aucune activité"
                const noActivitiesMessage = document.getElementById('noActivitiesMessage');
                if (noActivitiesMessage) {
                    noActivitiesMessage.style.display = 'none';
                }
                
                container.insertAdjacentHTML('afterbegin', activityHTML);
                
                // Ajouter aux données
                if (!teacherData.activities) teacherData.activities = [];
                teacherData.activities.push({
                    id: activityId,
                    name: '',
                    type: 'sport',
                    date: currentDate,
                    createdAt: new Date().toISOString()
                });
                
                counters.activity++;
                updateProjectsStats();
                syncAllData();
                showNotification('Nouvelle activité créée', 'success');
            }
        }

        function saveActivity(activityId) {
            const element = document.getElementById(activityId);
            if (!element) return;
            
            const name = element.querySelector('.activity-name').value;
            const type = element.querySelector('.activity-type').value;
            const date = element.querySelector('.activity-date').value;
            
            // Mettre à jour les données
            const activityIndex = teacherData.activities.findIndex(a => a.id === activityId);
            if (activityIndex !== -1) {
                teacherData.activities[activityIndex] = {
                    ...teacherData.activities[activityIndex],
                    name: name,
                    type: type,
                    date: date,
                    updatedAt: new Date().toISOString()
                };
            }
            
            updateProjectsStats();
            syncAllData();
            showNotification('Activité sauvegardée', 'success');
        }

        function removeActivity(activityId) {
            if (confirm('Voulez-vous vraiment supprimer cette activité ?')) {
                const element = document.getElementById(activityId);
                if (element) {
                    element.remove();
                    
                    // Retirer des données
                    teacherData.activities = teacherData.activities.filter(a => a.id !== activityId);
                    
                    counters.activity--;
                    updateProjectsStats();
                    syncAllData();
                    
                    // Afficher le message "aucune activité" si besoin
                    const container = document.getElementById('activitiesContainer');
                    if (container && container.children.length === 0) {
                        const noActivitiesMessage = document.getElementById('noActivitiesMessage');
                        if (noActivitiesMessage) {
                            noActivitiesMessage.style.display = 'block';
                        }
                    }
                    
                    showNotification('Activité supprimée', 'success');
                }
            }
        }

        function addMeeting() {
            const meetingId = `meet_${Date.now()}`;
            const currentDate = new Date().toISOString().split('T')[0];
            
            const meetingHTML = `
                <div class="meeting-container" id="${meetingId}">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-users"></i> Type de réunion *</label>
                                <select class="meeting-type" required>
                                    <option value="conseil">Conseil de classe</option>
                                    <option value="pedagogique">Réunion pédagogique</option>
                                    <option value="parents">Réunion parents</option>
                                    <option value="administration">Réunion administrative</option>
                                    <option value="formation">Réunion de formation</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-calendar"></i> Date *</label>
                                <input type="date" class="meeting-date" value="${currentDate}" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-clock"></i> Heure</label>
                                <input type="time" class="meeting-time" value="14:00">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-user-tie"></i> Président de séance</label>
                                <input type="text" class="meeting-president" placeholder="Nom du président">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label><i class="fas fa-user-friends"></i> Participants</label>
                                <input type="text" class="meeting-participants" placeholder="Nombre de participants">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-clipboard-list"></i> Ordre du jour</label>
                        <textarea class="meeting-agenda" rows="3" placeholder="Points à aborder..."></textarea>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-sticky-note"></i> Compte-rendu/Décisions</label>
                        <textarea class="meeting-report" rows="3" placeholder="Décisions prises, actions à mener..."></textarea>
                    </div>
                    <div class="section-actions">
                        <button type="button" class="btn btn-success btn-sm" onclick="saveMeeting('${meetingId}')">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeMeeting('${meetingId}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            `;
            
            const container = document.getElementById('meetingsContainer');
            if (container) {
                // Masquer le message "aucune réunion"
                const noMeetingsMessage = document.getElementById('noMeetingsMessage');
                if (noMeetingsMessage) {
                    noMeetingsMessage.style.display = 'none';
                }
                
                container.insertAdjacentHTML('afterbegin', meetingHTML);
                
                // Ajouter aux données
                if (!teacherData.meetings) teacherData.meetings = [];
                teacherData.meetings.push({
                    id: meetingId,
                    type: 'conseil',
                    date: currentDate,
                    createdAt: new Date().toISOString()
                });
                
                counters.meeting++;
                updateProjectsStats();
                syncAllData();
                showNotification('Nouvelle réunion créée', 'success');
            }
        }

        function saveMeeting(meetingId) {
            const element = document.getElementById(meetingId);
            if (!element) return;
            
            const type = element.querySelector('.meeting-type').value;
            const date = element.querySelector('.meeting-date').value;
            const time = element.querySelector('.meeting-time').value;
            
            // Mettre à jour les données
            const meetingIndex = teacherData.meetings.findIndex(m => m.id === meetingId);
            if (meetingIndex !== -1) {
                teacherData.meetings[meetingIndex] = {
                    ...teacherData.meetings[meetingIndex],
                    type: type,
                    date: date,
                    time: time,
                    updatedAt: new Date().toISOString()
                };
            }
            
            updateProjectsStats();
            syncAllData();
            showNotification('Réunion sauvegardée', 'success');
        }

        function removeMeeting(meetingId) {
            if (confirm('Voulez-vous vraiment supprimer cette réunion ?')) {
                const element = document.getElementById(meetingId);
                if (element) {
                    element.remove();
                    
                    // Retirer des données
                    teacherData.meetings = teacherData.meetings.filter(m => m.id !== meetingId);
                    
                    counters.meeting--;
                    updateProjectsStats();
                    syncAllData();
                    
                    // Afficher le message "aucune réunion" si besoin
                    const container = document.getElementById('meetingsContainer');
                    if (container && container.children.length === 0) {
                        const noMeetingsMessage = document.getElementById('noMeetingsMessage');
                        if (noMeetingsMessage) {
                            noMeetingsMessage.style.display = 'block';
                        }
                    }
                    
                    showNotification('Réunion supprimée', 'success');
                }
            }
        }

        function filterProjects() {
            const searchTerm = document.getElementById('projectSearch').value.toLowerCase();
            const filterStatus = document.getElementById('projectFilterStatus').value;
            
            const projects = document.querySelectorAll('.project-container');
            projects.forEach(project => {
                const name = project.querySelector('.project-name')?.value || '';
                const status = project.querySelector('.project-status')?.value || '';
                const text = project.textContent.toLowerCase();
                
                let shouldShow = true;
                
                if (searchTerm && !text.includes(searchTerm)) {
                    shouldShow = false;
                }
                
                if (filterStatus && status !== filterStatus) {
                    shouldShow = false;
                }
                
                project.style.display = shouldShow ? 'block' : 'none';
            });
        }

        function filterActivities() {
            const searchTerm = document.getElementById('activitySearch').value.toLowerCase();
            const filterType = document.getElementById('activityFilterType').value;
            
            const activities = document.querySelectorAll('.activity-container');
            activities.forEach(activity => {
                const name = activity.querySelector('.activity-name')?.value || '';
                const type = activity.querySelector('.activity-type')?.value || '';
                const text = activity.textContent.toLowerCase();
                
                let shouldShow = true;
                
                if (searchTerm && !text.includes(searchTerm)) {
                    shouldShow = false;
                }
                
                if (filterType && type !== filterType) {
                    shouldShow = false;
                }
                
                activity.style.display = shouldShow ? 'block' : 'none';
            });
        }

        function filterMeetings() {
            const searchTerm = document.getElementById('meetingSearch').value.toLowerCase();
            const filterType = document.getElementById('meetingFilterType').value;
            
            const meetings = document.querySelectorAll('.meeting-container');
            meetings.forEach(meeting => {
                const type = meeting.querySelector('.meeting-type')?.value || '';
                const text = meeting.textContent.toLowerCase();
                
                let shouldShow = true;
                
                if (searchTerm && !text.includes(searchTerm)) {
                    shouldShow = false;
                }
                
                if (filterType && type !== filterType) {
                    shouldShow = false;
                }
                
                meeting.style.display = shouldShow ? 'block' : 'none';
            });
        }

        function updateProjectsStats() {
            // Mettre à jour les compteurs
            document.getElementById('totalProjects').textContent = teacherData.projects?.length || 0;
            document.getElementById('totalActivities').textContent = teacherData.activities?.length || 0;
            document.getElementById('totalMeetings').textContent = teacherData.meetings?.length || 0;
            
            const total = (teacherData.projects?.length || 0) + 
                         (teacherData.activities?.length || 0) + 
                         (teacherData.meetings?.length || 0);
            document.getElementById('totalEngagements').textContent = total;
        }

        function updateEventsCalendar() {
            const container = document.getElementById('monthlyCalendar');
            if (!container) return;
            
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            
            // Créer le calendrier
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            let html = '';
            
            // En-têtes des jours
            const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            dayNames.forEach(day => {
                html += `<div class="calendar-day" style="font-weight: bold;">${day}</div>`;
            });
            
            // Jours vides au début
            const firstDayOfWeek = firstDay.getDay();
            for (let i = 0; i < firstDayOfWeek; i++) {
                html += `<div class="calendar-day"></div>`;
            }
            
            // Jours du mois
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const events = [];
                
                // Vérifier les projets
                if (teacherData.projects) {
                    teacherData.projects.forEach(project => {
                        if (project.startDate === dateStr || project.endDate === dateStr) {
                            events.push({type: 'project', name: project.name});
                        }
                    });
                }
                
                // Vérifier les activités
                if (teacherData.activities) {
                    teacherData.activities.forEach(activity => {
                        if (activity.date === dateStr) {
                            events.push({type: 'activity', name: activity.name});
                        }
                    });
                }
                
                // Vérifier les réunions
                if (teacherData.meetings) {
                    teacherData.meetings.forEach(meeting => {
                        if (meeting.date === dateStr) {
                            events.push({type: 'meeting', name: `Réunion ${meeting.type}`});
                        }
                    });
                }
                
                let dayContent = `<div>${day}</div>`;
                if (events.length > 0) {
                    dayContent += `<div style="font-size: 0.7em; color: var(--primary-color);">${events.length} évènement(s)</div>`;
                }
                
                const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                const dayClass = isToday ? 'calendar-day active' : 'calendar-day';
                
                html += `<div class="${dayClass}" title="${events.map(e => e.name).join(', ')}">${dayContent}</div>`;
            }
            
            container.innerHTML = html;
        }

        // Fonctions utilitaires
        function saveElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                showNotification('Élément sauvegardé avec succès', 'success');
                syncAllData();
            }
        }

        function removeElement(elementId) {
            if (confirm('Voulez-vous vraiment supprimer cet élément ?')) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.remove();
                    showNotification('Élément supprimé avec succès', 'success');
                    syncAllData();
                }
            }
        }

        // Gestion des données dans localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('teacherCompleteData', JSON.stringify(teacherData));
                
                // Ajouter un log
                addLog('Données sauvegardées dans localStorage');
            } catch (e) {
                console.error('Erreur lors de la sauvegarde dans localStorage:', e);
                showNotification('Erreur lors de la sauvegarde des données', 'error');
            }
        }

        function loadSavedData() {
            try {
                const saved = localStorage.getItem('teacherCompleteData');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    // Fusionner avec les données actuelles
                    teacherData = {...teacherData, ...data};
                    
                    // Restaurer les champs principaux
                    if (teacherData.establishment) {
                        document.getElementById('establishmentName').value = teacherData.establishment.name || '';
                        document.getElementById('establishmentType').value = teacherData.establishment.type || '';
                        document.getElementById('establishmentAddress').value = teacherData.establishment.address || '';
                        document.getElementById('establishmentPhone').value = teacherData.establishment.phone || '';
                        document.getElementById('establishmentEmail').value = teacherData.establishment.email || '';
                        document.getElementById('establishmentWebsite').value = teacherData.establishment.website || '';
                    }
                    
                    if (teacherData.personal) {
                        document.getElementById('lastName').value = teacherData.personal.last_name || '';
                        document.getElementById('firstName').value = teacherData.personal.first_name || '';
                        document.getElementById('gender').value = teacherData.personal.gender || '';
                        document.getElementById('birthDate').value = teacherData.personal.birth_date || '';
                        document.getElementById('birthMonth').value = teacherData.personal.birth_month || '';
                        document.getElementById('birthPlace').value = teacherData.personal.birth_place || '';
                    }
                    
                    if (teacherData.professional) {
                        document.getElementById('matricule').value = teacherData.professional.matricule || '';
                        document.getElementById('position').value = teacherData.professional.position || '';
                        document.getElementById('grade').value = teacherData.professional.grade || '';
                        document.getElementById('professionalCategory').value = teacherData.professional.professional_category || '';
                        document.getElementById('engagementDate').value = teacherData.professional.engagement_date || '';
                        document.getElementById('regionServiceDate').value = teacherData.professional.region_service_date || '';
                        document.getElementById('inspectionServiceDate').value = teacherData.professional.inspection_service_date || '';
                        document.getElementById('currentClass').value = teacherData.professional.current_class || '';
                        document.getElementById('weeklyHours').value = teacherData.professional.weekly_hours || '';
                    }
                    
                    if (teacherData.subjects && teacherData.subjects.length > 0) {
                        const mainSubject = teacherData.subjects.find(s => s.type === 'main');
                        const secondarySubject = teacherData.subjects.find(s => s.type === 'secondary');
                        
                        if (mainSubject) {
                            document.getElementById('mainSubject').value = mainSubject.name;
                        }
                        
                        if (secondarySubject) {
                            document.getElementById('secondarySubject').value = secondarySubject.name;
                        }
                        
                        // Ajouter les matières supplémentaires
                        const additionalSubjects = teacherData.subjects.filter(s => s.type === 'additional');
                        additionalSubjects.forEach((subject, index) => {
                            if (index === 0) addSubjectField();
                            const rows = document.querySelectorAll('#subjectsContainer .form-row');
                            if (rows.length > index + 1) {
                                const row = rows[index + 1];
                                const subjectInput = row.querySelector('.subject-field');
                                const hoursInput = row.querySelector('.subject-hours-field');
                                if (subjectInput) subjectInput.value = subject.name;
                                if (hoursInput) hoursInput.value = subject.hours;
                            }
                        });
                    }
                    
                    updateSchoolName();
                    calculateRetirementDate();
                    updateSyncedInfoDisplay();
                    
                    // Restaurer les évaluations
                    if (teacherData.evaluations && teacherData.evaluations.length > 0) {
                        counters.evaluation = teacherData.evaluations.length;
                        // Pour une restauration complète, il faudrait recréer le HTML des évaluations
                    }
                    
                    // Restaurer les projets
                    if (teacherData.projects && teacherData.projects.length > 0) {
                        counters.project = teacherData.projects.length;
                    }
                    
                    // Restaurer les activités
                    if (teacherData.activities && teacherData.activities.length > 0) {
                        counters.activity = teacherData.activities.length;
                    }
                    
                    // Restaurer les réunions
                    if (teacherData.meetings && teacherData.meetings.length > 0) {
                        counters.meeting = teacherData.meetings.length;
                    }
                    
                    updateEvaluationStats();
                    updateProjectsStats();
                    
                    showNotification('Données chargées depuis la sauvegarde', 'success');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                showNotification('Erreur lors du chargement des données', 'error');
            }
        }

        // Mise à jour de l'interface
        function updateUI() {
            updateSchoolName();
            updateBackupHistory();
            updateActivityLogs();
            updateDashboard();
            updateEvaluationStats();
            updateProjectsStats();
            updateEvaluationFilters();
            updateClassFilters();
        }

        function updateTabUI(tabId) {
            switch(tabId) {
                case 'tab2':
                    updateSyncedInfoDisplay();
                    break;
                case 'tab3':
                    updateEvaluationStats();
                    updateEvaluationFilters();
                    updateClassFilters();
                    break;
                case 'tab4':
                    updateProjectsStats();
                    updateEventsCalendar();
                    break;
                case 'tab6':
                    updateDashboard();
                    break;
            }
        }

        // Fonction pour générer un emploi du temps basé sur les matières synchronisées
        function generateTimetable() {
            const container = document.getElementById('timetableContainer');
            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            const hours = ['7h00-7h55', '7h55-8h50', '8h50-9h45', '10h10-11h05', '11h05-12h00', '15h-16h', '16h-17h'];
            
            // Récupérer les matières synchronisées
            const subjects = teacherData.subjects;
            const mainSubject = subjects.find(s => s.type === 'main')?.name || 'Matière principale';
            const secondarySubject = subjects.find(s => s.type === 'secondary')?.name || 'Matière secondaire';
            
            let timetableHTML = `
                <div class="form-group mb-20">
                    <label><i class="fas fa-cog"></i> Emploi du temps basé sur les matières synchronisées</label>
                    <div class="current-class-display">
                        <p><strong>Matière principale:</strong> ${mainSubject}</p>
                        ${secondarySubject ? `<p><strong>Matière secondaire:</strong> ${secondarySubject}</p>` : ''}
                        ${teacherData.professional.weekly_hours ? `<p><strong>Total heures/semaine:</strong> ${teacherData.professional.weekly_hours} heures</p>` : ''}
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Heures/Jours</th>
            `;
            
            for (let i = 0; i < 6; i++) {
                timetableHTML += `<th>${days[i]}</th>`;
            }
            
            timetableHTML += `</tr></thead><tbody>`;
            
            for (let i = 0; i < hours.length; i++) {
                timetableHTML += `<tr><td>${hours[i]}</td>`;
                
                for (let j = 0; j < 6; j++) {
                    timetableHTML += `
                        <td>
                            <select class="timetable-cell" data-day="${j}" data-hour="${i}">
                                <option value="">-- Vide --</option>
                                <option value="main">${mainSubject}</option>
                                ${secondarySubject ? `<option value="secondary">${secondarySubject}</option>` : ''}
                                <option value="other">Autre matière</option>
                                <option value="tp">TP/Labo</option>
                                <option value="meeting">Réunion</option>
                                <option value="free">Disponible</option>
                            </select>
                        </td>
                    `;
                }
                
                timetableHTML += `</tr>`;
            }
            
            timetableHTML += `</tbody></table>`;
            
            container.innerHTML = timetableHTML;
            
            document.querySelectorAll('.timetable-cell').forEach(cell => {
                cell.addEventListener('change', function() {
                    updateTimetableCell(this);
                    syncAllData();
                });
            });
        }

        function updateTimetableCell(cell) {
            const value = cell.value;
            
            switch(value) {
                case 'main':
                    cell.style.backgroundColor = '#e3f2fd';
                    break;
                case 'secondary':
                    cell.style.backgroundColor = '#e8f5e9';
                    break;
                case 'tp':
                    cell.style.backgroundColor = '#fff3e0';
                    break;
                case 'meeting':
                    cell.style.backgroundColor = '#f3e5f5';
                    break;
                case 'free':
                    cell.style.backgroundColor = '#f5f5f5';
                    break;
                default:
                    cell.style.backgroundColor = '';
            }
        }

        // Gestion du formulaire principal
        function handleSubmit(event) {
            event.preventDefault();
            
            if (!validateForm()) {
                showNotification('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            backupData();
            showNotification('Toutes les données ont été sauvegardées avec succès', 'success');
        }

        function validateForm() {
            const requiredFields = [
                'establishmentName',
                'lastName',
                'firstName',
                'birthDate',
                'birthPlace',
                'matricule',
                'mainSubject',
                'position',
                'engagementDate',
                'regionServiceDate',
                'inspectionServiceDate'
            ];
            
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && !field.value.trim()) {
                    isValid = false;
                    field.style.borderColor = 'var(--danger-color)';
                    
                    setTimeout(() => {
                        if (field) {
                            field.style.borderColor = '';
                        }
                    }, 2000);
                }
            });
            
            return isValid;
        }

        // Fonctions de notification et logs
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');
            const icon = document.getElementById('notificationIcon');
            
            if (!notification || !messageEl || !icon) return;
            
            messageEl.textContent = message;
            notification.className = 'notification';
            icon.className = 'fas';
            
            switch(type) {
                case 'success':
                    notification.classList.add('show');
                    icon.classList.add('fa-check-circle');
                    break;
                case 'error':
                    notification.classList.add('show', 'error');
                    icon.classList.add('fa-exclamation-circle');
                    break;
                case 'warning':
                    notification.classList.add('show', 'warning');
                    icon.classList.add('fa-exclamation-triangle');
                    break;
                case 'info':
                    notification.classList.add('show', 'info');
                    icon.classList.add('fa-info-circle');
                    break;
            }
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
            
            addLog(message);
        }

        function addLog(message) {
            try {
                const logs = JSON.parse(localStorage.getItem('logs') || '[]');
                logs.push({
                    timestamp: new Date().toISOString(),
                    message: message,
                    tab: currentTab
                });
                localStorage.setItem('logs', JSON.stringify(logs.slice(-50)));
            } catch (error) {
                console.error('Erreur lors de l\'ajout du log:', error);
            }
        }

        function updateBackupHistory() {
            const container = document.getElementById('backupHistory');
            if (!container) return;
            
            try {
                const backups = JSON.parse(localStorage.getItem('backups') || '[]');
                
                if (backups.length === 0) {
                    container.innerHTML = '<p class="text-center">Aucune sauvegarde disponible</p>';
                    return;
                }
                
                let html = '<table class="data-table"><thead><tr><th>Date</th><th>Taille</th><th>Actions</th></tr></thead><tbody>';
                
                backups.slice().reverse().forEach((backup, index) => {
                    const date = new Date(backup.timestamp);
                    const size = JSON.stringify(backup).length;
                    
                    html += `
                        <tr>
                            <td>${date.toLocaleString()}</td>
                            <td>${formatFileSize(size)}</td>
                            <td>
                                <button type="button" class="btn btn-xs btn-info" onclick="restoreBackup(${backups.length - 1 - index})">
                                    <i class="fas fa-undo"></i> Restaurer
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<p class="text-center">Erreur lors du chargement de l\'historique</p>';
                console.error(error);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function backupData() {
            const backup = {
                timestamp: new Date().toISOString(),
                data: teacherData
            };
            
            try {
                const backups = JSON.parse(localStorage.getItem('backups') || '[]');
                backups.push(backup);
                localStorage.setItem('backups', JSON.stringify(backups.slice(-10)));
                
                showNotification('Sauvegarde effectuée avec succès', 'success');
                updateBackupHistory();
            } catch (error) {
                showNotification('Erreur lors de la sauvegarde', 'error');
                console.error(error);
            }
        }

        // Fonctions pour les modaux et notifications
        function openModal(title, content) {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const modal = document.getElementById('genericModal');
            
            if (modalTitle && modalContent && modal) {
                modalTitle.textContent = title;
                modalContent.innerHTML = content;
                modal.classList.add('active');
            }
        }

        function closeModal() {
            const modal = document.getElementById('genericModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function showStatistics() {
            openModal('Statistiques détaillées', `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div>Évaluations totales</div>
                        <div class="stat-value">${teacherData.evaluations?.length || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div>Projets en cours</div>
                        <div class="stat-value">${teacherData.projects?.filter(p => p.status === 'in_progress').length || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div>Activités ce mois</div>
                        <div class="stat-value">${getCurrentMonthEvents()}</div>
                    </div>
                </div>
                <div class="mt-20">
                    <h4>Répartition des évaluations par type</h4>
                    <div id="modalChart"></div>
                </div>
            `);
        }

        function getCurrentMonthEvents() {
            const today = new Date();
            const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            
            let count = 0;
            
            if (teacherData.activities) {
                count += teacherData.activities.filter(a => a.date?.startsWith(currentMonth)).length;
            }
            
            if (teacherData.meetings) {
                count += teacherData.meetings.filter(m => m.date?.startsWith(currentMonth)).length;
            }
            
            return count;
        }

        // Fonctions d'export/import
        function exportJSON(tab) {
            let data = {};
            switch(tab) {
                case 'tab1':
                    data = { 
                        establishment: teacherData.establishment,
                        personal: teacherData.personal,
                        professional: teacherData.professional,
                        subjects: teacherData.subjects
                    };
                    break;
                case 'tab2':
                    data = { 
                        themes: teacherData.themes,
                        lessons: teacherData.lessons,
                        tps: teacherData.tps
                    };
                    break;
                case 'tab3':
                    data = { evaluations: teacherData.evaluations };
                    break;
                case 'tab4':
                    data = { 
                        projects: teacherData.projects,
                        activities: teacherData.activities,
                        meetings: teacherData.meetings
                    };
                    break;
            }
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `donnees_${tab}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showNotification('Export terminé', 'success');
        }

        function importJSON(tab) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        switch(tab) {
                            case 'tab1':
                                if (data.establishment) {
                                    teacherData.establishment = data.establishment;
                                    // Mettre à jour les champs du formulaire
                                    document.getElementById('establishmentName').value = data.establishment.name || '';
                                    document.getElementById('establishmentType').value = data.establishment.type || '';
                                    document.getElementById('establishmentAddress').value = data.establishment.address || '';
                                    document.getElementById('establishmentPhone').value = data.establishment.phone || '';
                                    document.getElementById('establishmentEmail').value = data.establishment.email || '';
                                    document.getElementById('establishmentWebsite').value = data.establishment.website || '';
                                }
                                if (data.personal) {
                                    teacherData.personal = data.personal;
                                }
                                if (data.professional) {
                                    teacherData.professional = data.professional;
                                }
                                if (data.subjects) {
                                    teacherData.subjects = data.subjects;
                                }
                                break;
                            case 'tab3':
                                if (data.evaluations) {
                                    teacherData.evaluations = data.evaluations;
                                    counters.evaluation = data.evaluations.length;
                                    updateEvaluationStats();
                                }
                                break;
                            case 'tab4':
                                if (data.projects) {
                                    teacherData.projects = data.projects;
                                    counters.project = data.projects.length;
                                }
                                if (data.activities) {
                                    teacherData.activities = data.activities;
                                    counters.activity = data.activities.length;
                                }
                                if (data.meetings) {
                                    teacherData.meetings = data.meetings;
                                    counters.meeting = data.meetings.length;
                                }
                                updateProjectsStats();
                                break;
                        }
                        
                        syncAllData();
                        showNotification('Import terminé avec succès', 'success');
                    } catch (error) {
                        showNotification('Erreur lors de l\'import du fichier', 'error');
                        console.error(error);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function exportAllJSON() {
            const dataStr = JSON.stringify(teacherData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `donnees_completes_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showNotification('Export complet terminé', 'success');
        }

        function importAllJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        teacherData = data;
                        loadSavedData();
                        showNotification('Import complet terminé avec succès', 'success');
                    } catch (error) {
                        showNotification('Erreur lors de l\'import du fichier', 'error');
                        console.error(error);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Fonction pour le dashboard
        function updateDashboard() {
            updateProfileSummary();
            updateRecentActivity();
            updateNotifications();
            updateDetailedStats();
        }

        function updateProfileSummary() {
            const container = document.getElementById('profileSummary');
            if (!container) return;
            
            const html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div>Nom complet</div>
                        <div class="stat-value">${teacherData.personal.last_name || ''} ${teacherData.personal.first_name || ''}</div>
                    </div>
                    <div class="stat-card">
                        <div>Matières</div>
                        <div class="stat-value">${teacherData.subjects.length}</div>
                    </div>
                    <div class="stat-card">
                        <div>Classes</div>
                        <div class="stat-value">${teacherData.professional.current_class ? teacherData.professional.current_class.split(',').length : 0}</div>
                    </div>
                    <div class="stat-card">
                        <div>Âge</div>
                        <div class="stat-value">${calculateAge(teacherData.personal.birth_date)}</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function calculateAge(birthDate) {
            if (!birthDate) return 'N/A';
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        function filterLessons() {
            const searchTerm = document.getElementById('lessonSearch').value.toLowerCase();
            const filterSubject = document.getElementById('lessonFilterSubject').value;
            const filterClass = document.getElementById('lessonFilterClass').value;
            
            const lessons = document.querySelectorAll('.lesson-container');
            
            lessons.forEach(lesson => {
                const text = lesson.textContent.toLowerCase();
                const subject = lesson.querySelector('input[type="text"][placeholder="Matière"]')?.value || '';
                const classe = lesson.querySelector('input[type="text"][placeholder="Ex: 3ème A"]')?.value || '';
                
                let shouldShow = true;
                
                if (searchTerm && !text.includes(searchTerm)) {
                    shouldShow = false;
                }
                
                if (filterSubject && subject !== filterSubject) {
                    shouldShow = false;
                }
                
                if (filterClass && !classe.includes(filterClass)) {
                    shouldShow = false;
                }
                
                lesson.style.display = shouldShow ? 'block' : 'none';
            });
        }

        // Fonction pour gérer le téléchargement de ressources
        function handleResourceUpload(event) {
            const files = event.target.files;
            const container = document.getElementById('resourcesList');
            
            if (!container) return;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const resourceId = `resource_${Date.now()}_${i}`;
                
                const resourceHTML = `
                    <div class="attachment-item" id="${resourceId}">
                        <div>
                            <i class="fas fa-file"></i>
                            <span>${file.name}</span>
                            <small>(${formatFileSize(file.size)})</small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-xs btn-light" onclick="previewResource('${resourceId}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-xs btn-danger" onclick="removeElement('${resourceId}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', resourceHTML);
                
                // Ajouter aux données
                if (!teacherData.resources) teacherData.resources = [];
                teacherData.resources.push({
                    id: resourceId,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploadedAt: new Date().toISOString()
                });
            }
            
            showNotification(`${files.length} ressource(s) ajoutée(s)`, 'success');
            syncAllData();
        }

        // Fonctions utilitaires restantes
        function printForm() {
            window.print();
        }

        function generateQRCode() {
            openModal('QR Code', `
                <div class="text-center">
                    <p>Fonctionnalité QR Code - À implémenter</p>
                    <p>Cette fonctionnalité générerait un QR code avec les informations de l'enseignant</p>
                </div>
            `);
        }

        function generatePlanningPDF() {
            openModal('Générer PDF', `
                <div class="text-center">
                    <p>Fonctionnalité PDF - À implémenter</p>
                    <p>Cette fonctionnalité générerait un PDF de l'emploi du temps</p>
                </div>
            `);
        }

        function clearAllData() {
            if (confirm('Voulez-vous vraiment effacer toutes les données ? Cette action est irréversible.')) {
                localStorage.clear();
                teacherData = {
                    establishment: {},
                    personal: {},
                    professional: {},
                    subjects: [],
                    themes: {},
                    lessons: [],
                    tps: [],
                    evaluations: [],
                    projects: [],
                    activities: [],
                    meetings: [],
                    backups: [],
                    logs: []
                };
                
                // Réinitialiser le formulaire
                document.getElementById('teacherForm').reset();
                updateUI();
                showNotification('Toutes les données ont été effacées', 'success');
            }
        }

        // Initialisation finale
        window.onload = function() {
            // S'assurer que tout est chargé
            setTimeout(() => {
                syncAllData();
            }, 500);
        };

    </script>
</body>
</html>
